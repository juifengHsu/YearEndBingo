<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å°¾ç‰™å¤§è³“æœ - æœ€çµ‚å¼·åŒ–ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --secondary: #ffc107; --bg: #f8f9fa; --success: #2e7d32; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); text-align: center; color: #333; overflow-x: hidden; }
        .page { display: none !important; padding: 20px; box-sizing: border-box; animation: fadeIn 0.4s; }
        .page.active { display: block !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* è³“æœç›¤ */
        .grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 6px; max-width: 350px; margin: 15px auto; 
            background: #fff; padding: 10px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .cell { 
            aspect-ratio: 1; border: 1px solid #eee; display: flex; 
            align-items: center; justify-content: center; 
            font-size: 1.4rem; font-weight: bold; border-radius: 8px;
            background: #fff; transition: all 0.2s;
        }
        .cell.selected { background: var(--secondary); color: #b71c1c; transform: scale(0.95); }
        .cell.bingo-line { background: var(--primary); color: white; animation: pulse 1s infinite; }

        button { 
            padding: 15px 25px; font-size: 1.1rem; border: none; border-radius: 30px; 
            background: var(--primary); color: white; cursor: pointer; margin: 8px 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 250px; margin-bottom: 10px; font-size: 1rem; }

        #draw-number { font-size: 5.5rem; color: var(--primary); font-weight: bold; min-height: 120px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        
        /* çµ±è¨ˆè¡¨ */
        .stats-container { background: white; padding: 15px; border-radius: 10px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stats-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .stats-table th, .stats-table td { border: 1px solid #eee; padding: 12px 2px; font-size: 0.85rem; }
        .stats-table th { background: #fdfdfd; color: #777; font-weight: normal; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div onclick="handleAdminClick()" style="position:fixed; top:0; left:0; width:50px; height:50px; z-index:9999;"></div>

    <div id="page-login" class="page active">
        <h1 style="color:var(--primary); margin-top: 20vh;">ğŸ§§ 2025 å°¾ç‰™è³“æœ</h1>
        <p>è«‹è¼¸å…¥å§“åé–‹å§‹éŠæˆ²</p>
        <input type="text" id="username" placeholder="æ‚¨çš„å§“å (ä¸å¯é‡è¤‡)">
        <br>
        <button onclick="joinGame()">ç¢ºèªé€²å…¥</button>
    </div>

    <div id="page-game" class="page">
        <div id="user-info" style="font-size:0.9rem; color:#888;"></div>
        <div id="draw-number">READY</div>
        <div id="status-text" style="font-weight:bold; color:var(--primary);">è«‹é»æ“Šéš¨æ©Ÿæ›è™Ÿä¸¦ä¿å­˜</div>
        
        <div class="grid" id="bingo-grid"></div>

        <div id="setup-controls">
            <button onclick="generateBoard()">éš¨æ©Ÿæ›è™Ÿ</button>
            <button onclick="lockBoard()" style="background:var(--success)">ä¿å­˜è™Ÿç¢¼ (å”¯ä¸€æ ¡é©—)</button>
        </div>

        <div id="lucky-panel" style="display:none; background:#fff9c4; padding:20px; border-radius:15px; border:3px dashed #f9a825; margin-top:20px;">
            <h3 style="margin:0; color:#ef6c00;">ğŸŒŸ è½‰é‹æ™‚åˆ»ï¼</h3>
            <p>æ‚¨ç›®å‰æ‰‹æ°£æœ€å·®ï¼Œè«‹æŒ‡å®šä¸€å€‹å¹¸é‹è™Ÿç¢¼ï¼š</p>
            <input type="number" id="lucky-input" min="1" max="25" style="width:80px; text-align:center; font-size:1.5rem;">
            <br>
            <button onclick="submitLuckyNumber()" style="background:#f9a825">é–‹å‡ºé€™å€‹è™Ÿç¢¼ï¼</button>
        </div>
    </div>

    <div id="page-admin" class="page">
        <h2 style="background: #333; color: white; padding: 15px; margin: -20px -20px 20px -20px;">ç®¡ç†è€…æ§åˆ¶å°</h2>
        
        <div style="display:flex; justify-content: space-around; margin: 15px 0;">
            <div>åœ¨ç·š: <span id="player-count" style="color:red; font-weight:bold;">0</span></div>
            <div>ç¸½è¨»å†Š: <span id="total-reg">0</span></div>
        </div>

        <div class="stats-container">
            <div style="font-size:0.8rem; color:#999; margin-bottom:10px;">æœ€å¤§é€£çºŒè™Ÿç¢¼æ•¸ (åˆ†ä½ˆäººæ•¸)</div>
            <table class="stats-table">
                <thead>
                    <tr><th>1å€‹</th><th>2å€‹</th><th>3å€‹</th><th>4å€‹</th><th style="color:red">è³“æœ</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="stat-1" class="stat-val">0</td>
                        <td id="stat-2" class="stat-val">0</td>
                        <td id="stat-3" class="stat-val">0</td>
                        <td id="stat-4" class="stat-val">0</td>
                        <td id="stat-5" class="stat-val">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top:20px;">
            <button id="btn-draw" onclick="drawRandom()">ğŸ² éš¨æ©ŸæŠ½å–ä¸‹ä¸€è™Ÿ</button>
            <button id="btn-lucky" onclick="pickLuckyUser()" style="background:#ef6c00">ğŸ¯ æŠ½å¹¸é‹å…’é¸è™Ÿ</button>
        </div>
        
        <div id="admin-msg" style="margin-top:15px; color:#666; font-size:0.9rem;"></div>
        
        <hr style="margin:30px 0; border:0; border-top:1px solid #ddd;">
        <button onclick="resetGame()" style="background:#555; font-size: 0.8rem; padding: 10px 20px;">é‡ç½®éŠæˆ² (æ¸…ç©ºæ‰€æœ‰è³‡æ–™)</button>
    </div>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
            authDomain: "yearendbingo.firebaseapp.com",
            projectId: "yearendbingo",
            storageBucket: "yearendbingo.firebasestorage.app",
            messagingSenderId: "563353011392",
            appId: "1:563353011392:web:717976a176bc22a04d5925",
            measurementId: "G-M6EVYSPNJ9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const GAME_DOC = "current_game";

        let myName = "";
        let myBoard = [];
        let isLocked = false;
        let drawnHistory = [];
        let rollingInterval = null;
        let adminClickCount = 0;
        let lastClickTime = 0;

        const winConditions = [
            [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24], // æ©«
            [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24], // è±
            [0,6,12,18,24],[4,8,12,16,20] // æ–œ
        ];

        // --- æ ¸å¿ƒç®—æ³•ï¼šè¨ˆç®—æœ€å¤§é€£çºŒå‘½ä¸­é•·åº¦ ---
        function calculateMaxConsecutive(board, history) {
            let maxGlobal = 0;
            winConditions.forEach(indices => {
                let currentStreak = 0;
                let maxInLine = 0;
                indices.forEach(idx => {
                    if (history.includes(board[idx])) {
                        currentStreak++;
                        if (currentStreak > maxInLine) maxInLine = currentStreak;
                    } else {
                        currentStreak = 0;
                    }
                });
                if (maxInLine > maxGlobal) maxGlobal = maxInLine;
            });
            return maxGlobal;
        }

        // --- ç®¡ç†å“¡æ¬Šé™è§¸ç™¼ ---
        function handleAdminClick() {
            const now = Date.now();
            if (now - lastClickTime > 2000) adminClickCount = 0;
            adminClickCount++;
            lastClickTime = now;
            if (adminClickCount >= 5) {
                const pin = prompt("è«‹è¼¸å…¥ç®¡ç†è€… PINï¼š");
                if (pin === "2025") switchPage('page-admin');
                adminClickCount = 0;
            }
        }

        // --- ç©å®¶è¡Œç‚ºé‚è¼¯ ---
        async function joinGame() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return alert("è«‹è¼¸å…¥å§“å");
            
            // æª¢æŸ¥å§“åæ˜¯å¦å·²è¢«ä½”ç”¨
            const doc = await db.collection("players").doc(nameInput).get();
            if (doc.exists && !confirm("æ­¤å§“åå·²å­˜åœ¨ï¼Œæ˜¯å¦é‡æ–°é€£ç·šï¼Ÿ")) return;

            myName = nameInput;
            document.getElementById('user-info').innerText = `ç©å®¶ï¼š${myName}`;
            switchPage('page-game');
            
            await db.collection("players").doc(myName).set({
                name: myName,
                lastSeen: Date.now(),
                locked: false,
                maxConsecutive: 0
            }, { merge: true });

            generateBoard();
            setInterval(heartbeat, 15000);
        }

        function heartbeat() {
            if (myName) db.collection("players").doc(myName).update({ lastSeen: Date.now() }).catch(()=>{});
        }

        function generateBoard() {
            if (isLocked) return;
            const nums = Array.from({length: 25}, (_, i) => i + 1);
            myBoard = nums.sort(() => Math.random() - 0.5);
            renderBoard();
        }

        function renderBoard() {
            const container = document.getElementById('bingo-grid');
            container.innerHTML = "";
            myBoard.forEach((num) => {
                const cell = document.createElement('div');
                cell.className = 'cell' + (drawnHistory.includes(num) ? ' selected' : '');
                cell.innerText = num;
                container.appendChild(cell);
            });
            checkBingoVisual();
        }

        function checkBingoVisual() {
            let winCount = 0;
            winConditions.forEach(c => {
                if (c.every(idx => drawnHistory.includes(myBoard[idx]))) {
                    winCount++;
                    c.forEach(idx => document.getElementById('bingo-grid').children[idx].classList.add('bingo-line'));
                }
            });
            if (winCount > 0) document.getElementById('status-text').innerText = `ğŸ‰ è³“æœï¼é”æˆ ${winCount} æ¢é€£ç·šï¼`;
        }

        async function lockBoard() {
            // å”¯ä¸€æ€§æ ¡é©—
            const boardStr = myBoard.join(',');
            const snap = await db.collection("players").where("boardStr", "==", boardStr).get();
            if (!snap.empty) {
                alert("ç›¤é¢èˆ‡ä»–äººé‡è¤‡ï¼Œç³»çµ±å·²è‡ªå‹•é‡æ–°æ´—ç‰Œï¼");
                return generateBoard();
            }

            if (!confirm("ä¿å­˜å¾Œä¸å¯æ›´æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            isLocked = true;
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('status-text').innerText = "ç­‰å¾…é–‹çä¸­...";
            
            await db.collection("players").doc(myName).update({ 
                board: myBoard, 
                boardStr: boardStr,
                locked: true,
                maxConsecutive: calculateMaxConsecutive(myBoard, drawnHistory)
            });
        }

        // --- å…¨å±€ç›£è½èˆ‡åŒæ­¥ ---
        function initGlobalMonitor() {
            db.collection("game_state").doc(GAME_DOC).onSnapshot(doc => {
                const data = doc.data();
                if (!data) return;
                drawnHistory = data.history || [];

                if (data.isRolling) {
                    startRollingEffect();
                } else {
                    stopRollingEffect();
                    const lastNum = drawnHistory[drawnHistory.length - 1];
                    if (lastNum) document.getElementById('draw-number').innerText = lastNum;
                    renderBoard();
                    // æ›´æ–°è‡ªå·±çš„æœ€æ–°é€²åº¦
                    if (isLocked) {
                        const score = calculateMaxConsecutive(myBoard, drawnHistory);
                        db.collection("players").doc(myName).update({ maxConsecutive: score });
                    }
                }
                
                // å¹¸é‹å…’é¡¯ç¤º
                document.getElementById('lucky-panel').style.display = (data.luckyUser === myName && myName !== "") ? 'block' : 'none';
            });

            // ç®¡ç†ç«¯æ•¸æ“šç›£è½
            db.collection("players").onSnapshot(snap => {
                const now = Date.now();
                let online = 0;
                let stats = { 1:0, 2:0, 3:0, 4:0, 5:0 };
                
                snap.forEach(doc => {
                    const p = doc.data();
                    if (p.lastSeen && (now - p.lastSeen < 120000)) online++;
                    if (p.locked && p.maxConsecutive) {
                        stats[p.maxConsecutive >= 5 ? 5 : p.maxConsecutive]++;
                    }
                });

                if (document.getElementById('player-count')) {
                    document.getElementById('player-count').innerText = online;
                    document.getElementById('total-reg').innerText = snap.size;
                    for (let i=1; i<=5; i++) document.getElementById(`stat-${i}`).innerText = stats[i];
                }
            });
        }

        // --- ç®¡ç†è€…è¡Œç‚º ---
        async function drawRandom() {
            document.getElementById('btn-draw').disabled = true;
            await db.collection("game_state").doc(GAME_DOC).update({ isRolling: true, luckyUser: "" });
            
            setTimeout(async () => {
                const rem = Array.from({length: 25}, (_, i) => i + 1).filter(n => !drawnHistory.includes(n));
                if (rem.length === 0) return alert("å…¨éƒ¨æŠ½å®Œå›‰ï¼");
                const pick = rem[Math.floor(Math.random() * rem.length)];
                
                await db.collection("game_state").doc(GAME_DOC).update({
                    history: firebase.firestore.FieldValue.arrayUnion(pick),
                    isRolling: false
                });
                document.getElementById('btn-draw').disabled = false;
            }, 2500);
        }

        async function pickLuckyUser() {
            // è£œå„Ÿæ©Ÿåˆ¶ï¼šé¸å‡º MaxConsecutive æœ€å°çš„å‰ 15 å
            const snap = await db.collection("players").where("locked", "==", true).get();
            let players = [];
            snap.forEach(doc => players.push(doc.data()));
            
            if (players.length === 0) return alert("å°šç„¡ç©å®¶é–å®šç›¤é¢");

            // æŒ‰åˆ†æ•¸å¾å°åˆ°å¤§æ’åº
            players.sort((a, b) => a.maxConsecutive - b.maxConsecutive);
            
            // å–å‰ 15 å (è‹¥ä¸è¶³å‰‡å–å…¨éƒ¨)
            const poolSize = Math.min(players.length, 15);
            const pool = players.slice(0, poolSize);
            
            const lucky = pool[Math.floor(Math.random() * pool.length)];
            
            await db.collection("game_state").doc(GAME_DOC).update({ luckyUser: lucky.name });
            document.getElementById('admin-msg').innerText = `å·²é¸ä¸­å¹¸é‹å…’ï¼š${lucky.name} (ç›®å‰é€²åº¦: ${lucky.maxConsecutive})`;
        }

        async function submitLuckyNumber() {
            const val = parseInt(document.getElementById('lucky-input').value);
            if (isNaN(val) || val < 1 || val > 25) return alert("è«‹è¼¸å…¥ 1-25 ä¹‹é–“çš„æ•¸å­—");
            if (drawnHistory.includes(val)) return alert("é€™è™Ÿç¢¼é–‹éäº†å–”ï¼");
            
            await db.collection("game_state").doc(GAME_DOC).update({
                history: firebase.firestore.FieldValue.arrayUnion(val),
                luckyUser: ""
            });
            document.getElementById('lucky-input').value = "";
        }

        async function resetGame() {
            if (!confirm("ç¢ºå®šè¦é‡ç½®ï¼Ÿè³‡æ–™æœƒå…¨ç©ºï¼")) return;
            if (!confirm("çœŸçš„ç¢ºå®šï¼Ÿé€™æ˜¯æœ€å¾Œä¸€æ¬¡è©¢å•ï¼")) return;
            const batch = db.batch();
            const pSnap = await db.collection("players").get();
            pSnap.forEach(d => batch.delete(d.ref));
            batch.set(db.collection("game_state").doc(GAME_DOC), { history: [], isRolling: false, luckyUser: "" });
            await batch.commit();
            location.reload();
        }

        // --- UI å·¥å…· ---
        function switchPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startRollingEffect() {
            if (rollingInterval) return;
            rollingInterval = setInterval(() => {
                document.getElementById('draw-number').innerText = Math.floor(Math.random() * 25) + 1;
            }, 80);
        }

        function stopRollingEffect() {
            clearInterval(rollingInterval);
            rollingInterval = null;
        }

        window.onload = () => {
            switchPage('page-login');
            initGlobalMonitor();
        };
    </script>
</body>
</html>
