<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>2025 å°¾ç‰™è³“æœ - ç®¡ç†å¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .card { background: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .big-btn { width: 100%; padding: 20px; font-size: 1.5rem; cursor: pointer; border: none; border-radius: 5px; margin-bottom: 10px; }
        .draw-btn { background: #e74c3c; color: white; }
        .lucky-btn { background: #f1c40f; color: #2c3e50; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: #1a252f; padding: 10px; text-align: center; border-radius: 5px; }
        .stat-val { font-size: 1.8rem; font-weight: bold; color: #3498db; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #455a64; padding: 10px; text-align: left; }
        .history-tag { display: inline-block; background: #3498db; padding: 5px 10px; border-radius: 20px; margin: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ§§ 2025 è³“æœç®¡ç†ä¸­å¿ƒ</h1>
    
    <div class="dashboard">
        <div class="card">
            <h2>éŠæˆ²æ§åˆ¶</h2>
            <button class="big-btn draw-btn" onclick="drawNumber()">ğŸ² éš¨æ©ŸæŠ½è™Ÿ</button>
            <button class="big-btn lucky-btn" onclick="pickLuckyPlayer()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
            <hr>
            <h3>é–‹çæ­·å²</h3>
            <div id="history-list"></div>
            <button onclick="resetGame()" style="margin-top:20px; background:none; color:#95a5a6; border:1px solid #95a5a6;">é‡ç½®éŠæˆ²</button>
        </div>

        <div class="card">
            <h2>å³æ™‚æˆ°æ³</h2>
            <div class="stat-grid">
                <div class="stat-box">åœ¨ç·š / ç¸½äººæ•¸<br><span class="stat-val" id="count-online">0</span> / <span id="count-total">0</span></div>
                <div class="stat-box">å·²é–å®šç›¤é¢<br><span class="stat-val" id="count-locked">0</span></div>
            </div>
            
            <h3>åˆ†æ•¸åˆ†ä½ˆ (Max Consecutive)</h3>
            <div id="score-distribution">è¼‰å…¥ä¸­...</div>

            <h3>å¾…è™•ç†é¸è™Ÿ (Pending)</h3>
            <div id="pending-list">ç„¡</div>

            <div style="margin-top:20px;">
                <label><input type="checkbox" id="show-list-toggle" onchange="togglePlayerList()"> é¡¯ç¤ºå®Œæ•´ç©å®¶åå–®</label>
            </div>
            <table id="player-table" style="display:none;">
                <thead><tr><th>å§“å</th><th>åˆ†æ•¸</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="player-list-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // é…ç½®åŒç©å®¶ç«¯
        // Import the functions you need from the SDKs you need               
          // Your web app's Firebase configuration
          // For Firebase JS SDK v7.20.0 and later, measurementId is optional
          const firebaseConfig = {
            apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
            authDomain: "yearendbingo.firebaseapp.com",
            projectId: "yearendbingo",
            storageBucket: "yearendbingo.firebasestorage.app",
            messagingSenderId: "563353011392",
            appId: "1:563353011392:web:717976a176bc22a04d5925",
            measurementId: "G-M6EVYSPNJ9"
          };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allPlayers = [];
        let gameHistory = [];

        // ç›£è½å…¨åŸŸç‹€æ…‹
        db.collection("game_state").doc("current_game").onSnapshot(doc => {
            const data = doc.data();
            gameHistory = data.history || [];
            document.getElementById('history-list').innerHTML = gameHistory.map(n => `<span class="history-tag">${n}</span>`).join('');
        });

        // ç›£è½æ‰€æœ‰ç©å®¶ (ç”¨æ–¼çµ±è¨ˆ)
        db.collection("players").onSnapshot(snapshot => {
            allPlayers = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            updateStats();
        });

        // ç›£è½ Pending Choices (å¹¸é‹å…’é¸è™Ÿ)
        db.collection("pending_choices").onSnapshot(snapshot => {
            const list = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            const container = document.getElementById('pending-list');
            if(list.length === 0) {
                container.innerHTML = "ç­‰å¾…ç©å®¶è¼¸å…¥...";
            } else {
                container.innerHTML = list.map(p => `
                    <div style="background:#2ecc71; color:white; padding:10px; margin-bottom:5px; border-radius:5px;">
                        ${p.playerName} é¸äº† <b>${p.number}</b> 
                        <button onclick="approveNumber('${p.id}', ${p.number})">ç¢ºèªå¯«å…¥</button>
                    </div>
                `).join('');
            }
        });

        function updateStats() {
            const total = allPlayers.length;
            const locked = allPlayers.filter(p => p.locked).length;
            const now = Date.now();
            const online = allPlayers.filter(p => (now - (p.lastSeen?.toMillis?.() || 0)) < 30000).length;

            document.getElementById('count-total').innerText = total;
            document.getElementById('count-locked').innerText = locked;
            document.getElementById('count-online').innerText = online;

            // åˆ†æ•¸åˆ†ä½ˆ
            const dist = {1:0, 2:0, 3:0, 4:0, 5:0};
            allPlayers.forEach(p => { if(p.maxConsecutive) dist[p.maxConsecutive]++ });
            document.getElementById('score-distribution').innerHTML = Object.entries(dist).map(([s, c]) => 
                `[${s}é€£]: ${c}äºº `).join(' | ');

            // æ¸²æŸ“åˆ—è¡¨
            const tbody = document.getElementById('player-list-body');
            tbody.innerHTML = allPlayers.sort((a,b) => b.maxConsecutive - a.maxConsecutive).map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.maxConsecutive || 0}</td>
                    <td>${p.locked ? 'âœ…' : 'â³'}</td>
                </tr>
            `).join('');
        }

        async function drawNumber() {
            // éš¨æ©Ÿç”¢ç”Ÿ 1-25 ä¸”ä¸åœ¨ history ä¸­çš„è™Ÿç¢¼
            const available = Array.from({length:25}, (_, i) => i+1).filter(n => !gameHistory.includes(n));
            if(available.length === 0) return alert("å…¨éƒ¨æŠ½å®Œäº†ï¼");
            
            const newNum = available[Math.floor(Math.random() * available.length)];
            
            const ref = db.collection("game_state").doc("current_game");
            await ref.update({ isRolling: true });
            
            setTimeout(async () => {
                await ref.update({
                    history: firebase.firestore.FieldValue.arrayUnion(newNum),
                    isRolling: false,
                    luckyUser: "" // æ¸…é™¤å¹¸é‹å…’ç‹€æ…‹
                });
            }, 2000);
        }

        async function pickLuckyPlayer() {
            const pool = allPlayers.filter(p => p.locked).sort((a,b) => a.maxConsecutive - b.maxConsecutive).slice(0, 15);
            if(pool.length === 0) return alert("ç›®å‰æ²’æœ‰é–å®šç›¤é¢çš„ç©å®¶");
            
            const lucky = pool[Math.floor(Math.random() * pool.length)];
            await db.collection("game_state").doc("current_game").update({
                luckyUser: lucky.name
            });
            alert("æŠ½ä¸­å¹¸é‹å…’: " + lucky.name);
        }

        async function approveNumber(uid, num) {
            const ref = db.collection("game_state").doc("current_game");
            await ref.update({
                history: firebase.firestore.FieldValue.arrayUnion(num),
                luckyUser: ""
            });
            await db.collection("pending_choices").doc(uid).delete();
        }

        function togglePlayerList() {
            const show = document.getElementById('show-list-toggle').checked;
            document.getElementById('player-table').style.display = show ? 'table' : 'none';
        }

        async function resetGame() {
            if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰äººçš„è³‡æ–™èˆ‡è™Ÿç¢¼å—ï¼Ÿ")) return;
            // æ³¨æ„ï¼šé€™è£¡åƒ…é‡ç½® historyï¼Œæ­£å¼ç’°å¢ƒéœ€æ‰¹æ¬¡é‡ç½® players è³‡æ–™
            await db.collection("game_state").doc("current_game").set({
                history: [],
                isRolling: false,
                luckyUser: ""
            });
        }
    </script>
</body>
</html>
