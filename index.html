<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± (ç®¡ç†å„ªåŒ–ç‰ˆ) v0.09</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
:root { --primary:#d32f2f; --accent:#ffb300; --bg:#f6f7fb; --card:#ffffff; --success:#2e7d32; --dark:#2c3e50; }
body { margin:0; font-family:system-ui, -apple-system, sans-serif; background:var(--bg); color:#222; }
.container { max-width:1100px; margin:0 auto; padding:15px; }
.layout { display:grid; grid-template-columns: 1fr 340px; gap:20px; }
@media (max-width: 850px) { .layout { grid-template-columns: 1fr; } }
.player-card { background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); text-align:center; min-height: 400px; }
.big-number { font-size:5rem; font-weight:800; color:var(--primary); height:110px; line-height:110px; margin:10px 0; }
.grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:6px; max-width:400px; margin:0 auto; }
.cell { aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border:1px solid #eee; border-radius:8px; font-size:1.3rem; font-weight:bold; }
.cell.selected { background:#fff3e0; color:#e65100; }
.cell.bingo-line { background:var(--success) !important; color:white !important; animation:pulse 1s infinite; }
.admin-panel { display:flex; flex-direction:column; gap:15px; }
.admin-card { background:var(--dark); color:white; padding:15px; border-radius:12px; }
.stat-group { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
.line-stat-group { display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-bottom:10px; }
.stat-box { background:rgba(255,255,255,0.1); padding:8px 5px; border-radius:8px; text-align:center; }
.stat-val { font-size:1.2rem; font-weight:bold; color:var(--accent); display:block; }
.stat-label { font-size: 0.75rem; opacity: 0.8; }
.bingo-alert-list { background:white; color:#333; border-radius:8px; padding:10px; max-height:200px; overflow-y:auto; }
.alert-item { color:var(--primary); font-weight:bold; padding:4px 0; border-bottom:1px solid #eee; font-size:0.9rem; display:flex; justify-content:space-between; }
button { padding:12px; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; }
button:disabled { background:#ccc; }
input { padding:10px; border:1px solid #ddd; border-radius:8px; width:100%; margin-bottom:10px; box-sizing:border-box; }
@keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.03)} 100% {transform:scale(1)} }
</style>
</head>
<body>
<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h1 onclick="triggerAdmin()" style="margin:0; color:var(--primary); cursor:pointer;">ğŸ§§ 2025 è³“æœç³»çµ± v0.09</h1>
    <div id="user-info" style="font-weight:bold;"></div>
  </div>

  <div class="layout">
    <div class="player-card" id="main-content-area">
      <div id="login-form">
        <input type="text" id="player-name" placeholder="è¼¸å…¥çœŸå¯¦å§“åé€²å ´">
        <button onclick="doPlayerLogin()" style="width:100%">é€²å…¥éŠæˆ²</button>
      </div>

      <div id="game-ui" style="display:none;">
        <div id="draw-display" class="big-number">READY</div>
        <div id="bingo-status" style="height:25px; font-weight:bold; color:var(--success); margin-bottom:10px;"></div>
        <div id="bingo-grid" class="grid"></div>
        <div id="setup-btns" style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
          <button onclick="reRollBoard()" id="reroll-btn" style="background:#6c757d;">ğŸ² æ›è™Ÿç¢¼</button>
          <button onclick="confirmBoard()" id="lock-btn" style="background:var(--success);">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>

    <div id="admin-sidebar" class="admin-panel" style="display:none;">
      <div class="admin-card">
        <div class="stat-group">
          <div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="stat-label">åœ¨ç·š</span></div>
          <div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="stat-label">ç¸½äººæ•¸</span></div>
        </div>

        <div style="font-size:0.8rem; margin-bottom:5px; opacity:0.8;">æœ€å¤§ç›¸é„°é€£è™Ÿäººæ•¸ (åˆ†ä½ˆ)ï¼š</div>
        <div class="line-stat-group">
          <div class="stat-box"><span id="cnt-5" class="stat-val">0</span><span class="stat-label">5+é€£</span></div>
          <div class="stat-box"><span id="cnt-4" class="stat-val">0</span><span class="stat-label">4é€£</span></div>
          <div class="stat-box"><span id="cnt-3" class="stat-val">0</span><span class="stat-label">3é€£</span></div>
          <div class="stat-box"><span id="cnt-2" class="stat-val">0</span><span class="stat-label">2é€£</span></div>
        </div>

        <div style="text-align:center; margin:10px 0; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
          <div style="font-size:0.8rem; opacity:0.7;">åŒæ­¥é–‹çè™Ÿ</div>
          <div id="admin-sync-num" style="font-size:2.5rem; font-weight:bold; color:var(--accent);">--</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <button onclick="drawNewNumber()" style="background:#e67e22;">ğŸ² æŠ½è™Ÿ</button>
          <button onclick="pickLucky()" style="background:var(--accent); color:#333;">ğŸŒŸ å¹¸é‹å…’</button>
        </div>
      </div>

      <div class="admin-card">
        <div style="font-size:0.9rem; margin-bottom:8px; font-weight:bold;">ğŸ“¢ å³æ™‚è³“æœåå–®</div>
        <div id="bingo-alerts" class="bingo-alert-list">
          <div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>
        </div>
      </div>

      <div class="admin-card" style="background:#444;">
        <div style="font-size:0.8rem; margin-bottom:10px;">å¾…æ ¸é¸è™Ÿ: <span id="pending-count">0</span></div>
        <div id="pending-choices"></div>
      </div>

      <button onclick="handleReset()" style="background:#c0392b; width:100%;">âš ï¸ é‡ç½®éŠæˆ²</button>
      <button onclick="location.reload()" style="background:#6c757d; width:100%; margin-top:5px; font-size:0.8rem;">é€€å‡ºä¸¦é‡æ•´</button>
    </div>
  </div>
</div>

<div id="admin-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:999;">
  <div style="background:white; padding:25px; border-radius:15px; width:300px;">
    <h3>ç®¡ç†å“¡ç™»å…¥</h3>
    <input type="email" id="admin-email" placeholder="Email">
    <input type="password" id="admin-pwd" placeholder="Password">
    <button onclick="doAdminLogin()" style="width:100%;">ç™»å…¥</button>
    <button onclick="document.getElementById('admin-modal').style.display='none'" style="width:100%; margin-top:5px; background:#999;">å–æ¶ˆ</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false, boardStr:"", maxConsecutive:0, version:1 };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
const lines = [
  [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
  [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
  [0,6,12,18,24],[4,8,12,16,20]
];

async function doPlayerLogin() {
  const name = document.getElementById('player-name').value.trim();
  if(!name) return alert("è«‹è¼¸å…¥å§“å");
  const cred = await auth.signInAnonymously();
  currentUser = cred.user;
  const docRef = db.collection("players").doc(currentUser.uid);
  const snap = await docRef.get();
  if(snap.exists) {
    myData = snap.data();
    myData.board = myData.board || shuffleArray();
    myData.boardStr = myData.boardStr || myData.board.join(',');
    myData.maxConsecutive = myData.maxConsecutive || 0;
    myData.version = myData.version || 1;
  } else {
    const board = shuffleArray();
    const boardStr = board.join(',');
    myData = { name: name, board: board, boardStr: boardStr, locked: false, maxConsecutive: 0, version: 1, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await docRef.set(myData);
  }
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('game-ui').style.display = 'block';
  document.getElementById('user-info').innerText = myData.name;
  startApp();
}

function triggerAdmin() {
  window.adminClicks = (window.adminClicks || 0) + 1;
  if(window.adminClicks >= 5) {
    document.getElementById('admin-modal').style.display = 'flex';
    window.adminClicks = 0;
  }
}

async function doAdminLogin() {
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) {
      document.getElementById('admin-modal').style.display = 'none';
      // éš±è—å·¦å´ç©å®¶å€åŸŸï¼ˆä¸è¦†è“‹ innerHTMLï¼‰ï¼Œåªä¿ç•™å³å´
      document.getElementById('main-content-area').style.display = 'none';
      document.getElementById('admin-sidebar').style.display = 'flex';
      document.getElementById('user-info').innerText = "ç®¡ç†è€…æ¨¡å¼";
      currentUser = cred.user;
      startApp();
    } else {
      alert("éç®¡ç†è€…å¸³è™Ÿ");
    }
  } catch(e) { alert("ç™»å…¥å¤±æ•—"); }
}

function startApp() {
  // game_state ç›£è½ï¼šç„¡æ¢ä»¶æ›´æ–°æŠ½è™Ÿé¡¯ç¤º
  db.collection("game_state").doc("current_game").onSnapshot(async doc => {
    const data = doc.data();
    if(!data) return;
    gameHistory = data.history || [];
    // ç„¡æ¢ä»¶æ›´æ–°é¡¯ç¤ºï¼ˆå³ä½¿ç©å®¶å·²é–å®šï¼‰
    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    const drawEl = document.getElementById('draw-display');
    const adminSync = document.getElementById('admin-sync-num');
    if(drawEl) drawEl.innerText = data.isRolling ? "..." : last;
    if(adminSync) adminSync.innerText = data.isRolling ? "..." : last;

    if(data.isRolling) {
      if(!rollingTimer) rollingTimer = setInterval(() => {
        const rand = Math.floor(Math.random()*25)+1;
        if(drawEl) drawEl.innerText = rand;
        if(adminSync) adminSync.innerText = rand;
      }, 80);
    } else {
      clearInterval(rollingTimer); rollingTimer = null;
      // åªåšæ ¼å­æ¸²æŸ“ï¼ˆè‹¥å­˜åœ¨ï¼‰
      renderGrid();
      if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    // å¹¸é‹å…’å½ˆçª—ï¼ˆè‹¥è¢«é¸ä¸­ä¸”ä¸æ˜¯ç®¡ç†è€…ï¼‰
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && auth.currentUser && auth.currentUser.uid !== ALLOWED_UID) {
      const num = prompt("ä½ æ˜¯å¹¸é‹å…’ï¼è«‹è¼¸å…¥ 1-25 é–‹çè™Ÿç¢¼ï¼š");
      if(num) {
        await db.collection("pending_choices").add({
          number: parseInt(num),
          playerName: myData.name,
          uid: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection("audit_logs").add({ action: "submit_pending_choice", detail: { uid: currentUser.uid, name: myData.name, number: parseInt(num) }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
  });

  db.collection("players").onSnapshot(snap => {
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    allPlayersCache = list;
    document.getElementById('count-total').innerText = list.length;
    const now = Date.now();
    const online = list.filter(p => p.lastSeen && (now - (p.lastSeen.toMillis ? p.lastSeen.toMillis() : new Date(p.lastSeen).getTime())) < 30000).length;
    document.getElementById('count-online').innerText = online;
    if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) updateConnectedStats();
  });

  if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) {
    db.collection("pending_choices").onSnapshot(snap => {
      const div = document.getElementById('pending-choices');
      div.innerHTML = snap.docs.map(d => {
        const p = d.data();
        return `<div style="padding:5px; border-bottom:1px solid #555;">${p.playerName}: ${p.number}
          <button onclick="confirmLucky('${d.id}', ${p.number})" style="padding:2px 5px; font-size:0.7rem;">é–‹è™Ÿ</button></div>`;
      }).join('');
      document.getElementById('pending-count').innerText = snap.size;
    });

    db.collection("bingo_events").orderBy("timestamp","desc").limit(20).onSnapshot(snap => {
      const container = document.getElementById('bingo-alerts');
      if(snap.empty) { container.innerHTML = '<div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>'; return; }
      container.innerHTML = snap.docs.map(d => {
        const data = d.data();
        const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
        return `<div class="alert-item"><span>ğŸ‰ ${data.name}</span> <span style="font-size:0.7rem; color:#666;">${timeStr}</span></div>`;
      }).join('');
    });
  }

  // heartbeat
  setInterval(() => {
    if(currentUser && !currentUser.email) {
      db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
    }
  }, 15000);

  // ç•¶ gameHistory æ›´æ–°æ™‚ï¼Œç‚ºæ‰€æœ‰å·²é–å®šç©å®¶è¨ˆç®— maxConsecutive ä¸¦å›å¯«
  db.collection("game_state").doc("current_game").onSnapshot(async doc => {
    const data = doc.data();
    if(!data) return;
    const history = data.history || [];
    const lockedPlayers = allPlayersCache.filter(p => p.locked);
    if(lockedPlayers.length) {
      const batch = db.batch();
      lockedPlayers.forEach(p => {
        const maxC = calcMaxConsecutiveByLines(p.board || [], history);
        const ref = db.collection("players").doc(p.id);
        batch.update(ref, { maxConsecutive: maxC, version: (p.version || 1) + 1 });
      });
      await batch.commit();
    }
  });
}

function renderGrid() {
  const grid = document.getElementById('bingo-grid');
  // è‹¥ grid ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚ç®¡ç†è€…éš±è—å·¦å´ï¼‰ï¼Œåªæ›´æ–°
