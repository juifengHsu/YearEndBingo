<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>2025 å°¾ç‰™è³“æœç³»çµ± (ä¿®æ­£ç‰ˆ)</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary:#d32f2f; --accent:#ffb300; --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280; --success:#2e7d32; --dark:#2c3e50; }
        * { box-sizing:border-box; }
        body { margin:0; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:#222; -webkit-user-select:none; user-select:none; }
        
        .container { max-width:1200px; margin:0 auto; padding:16px; }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
        .brand h1 { margin:0; font-size:1.5rem; color:var(--primary); cursor:pointer; }
        .info-badges { display:flex; gap:8px; flex-wrap:wrap; }
        .badge { background:var(--card); padding:5px 10px; border-radius:20px; font-size:0.85rem; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .admin-indicator { background:var(--accent); color:#000; padding:5px 10px; border-radius:5px; font-weight:bold; display:none; }

        /* ä¸»ä½ˆå±€ */
        .layout { display:grid; grid-template-columns: 1fr 350px; gap:20px; }
        
        /* ç©å®¶å€ */
        .player-panel { background:var(--card); padding:20px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.05); text-align:center; }
        .big-number { font-size:5rem; font-weight:800; color:var(--primary); margin:10px 0; min-height:100px; line-height:100px; text-shadow:2px 2px 0px #eee; }
        
        .grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:6px; max-width:400px; margin:0 auto; }
        .cell { aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:#f0f0f0; border-radius:8px; font-size:1.2rem; font-weight:bold; position:relative; }
        .cell.selected { background:#ffecb3; color:#d35400; }
        /* ä¿®æ­£é» 1: é€£ç·šæ¨£å¼ */
        .cell.bingo-line { background:var(--success) !important; color:#fff !important; animation:pulse 1s infinite; box-shadow:0 0 10px rgba(46, 125, 50, 0.5); }

        /* æ§åˆ¶æŒ‰éˆ• */
        .controls { display:flex; gap:10px; justify-content:center; margin-top:20px; }
        .btn { padding:12px 20px; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; font-size:1rem; transition:0.2s; }
        .btn:active { transform:scale(0.95); }
        .btn.secondary { background:#607d8b; }
        .btn:disabled { background:#ddd; cursor:not-allowed; }

        /* ç®¡ç†å€ */
        .admin-panel { display:flex; flex-direction:column; gap:15px; }
        .admin-card { background:var(--dark); color:white; padding:15px; border-radius:12px; }
        .admin-big-number { font-size:3rem; font-weight:bold; color:var(--accent); text-align:center; margin:10px 0; background:rgba(0,0,0,0.2); border-radius:8px; }
        
        .list-container { background:white; border-radius:12px; padding:10px; max-height:300px; overflow-y:auto; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
        .list-item { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; font-size:0.9rem; }
        .list-item.bingo { background:#e8f5e9; color:var(--success); font-weight:bold; }
        .list-item.weak { background:#fff3e0; color:#e65100; }

        /* å½ˆçª— */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(3px); }
        .modal-content { background:white; padding:25px; border-radius:16px; width:90%; max-width:350px; text-align:center; }
        input { width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px; font-size:1rem; text-align:center; }

        @keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.05); } 100% { transform:scale(1); } }
        @media(max-width: 800px) { .layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">
            <h1 onclick="handleAdminClick()">ğŸ§§ 2025 å°¾ç‰™è³“æœ</h1>
        </div>
        <div class="info-badges">
            <div id="online-badge" class="badge">åœ¨ç·š: 0</div>
            <div id="reg-badge" class="badge">è¨»å†Š: 0</div>
            <div id="admin-indicator" class="admin-indicator">ç®¡ç†å“¡æ¨¡å¼</div>
        </div>
    </div>

    <div class="layout">
        <div class="player-panel">
            <div id="display-name" style="color:var(--muted); margin-bottom:5px;">æœªç™»å…¥</div>
            
            <div id="login-section">
                <input type="text" id="username-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                <button class="btn" onclick="playerLogin()" style="width:100%">é€²å…¥éŠæˆ²</button>
                <div style="font-size:0.8rem; color:#888; margin-top:10px;">(è‹¥è¦ç®¡ç†ï¼Œè«‹é»æ“Šå·¦ä¸Šæ¨™é¡Œ 5 æ¬¡)</div>
            </div>

            <div id="game-section" style="display:none;">
                <div id="current-draw" class="big-number">READY</div>
                <div id="status-text" style="color:var(--success); font-weight:bold; height:24px;"></div>
                
                <div id="bingo-grid" class="grid"></div>

                <div class="controls" id="setup-controls">
                    <button class="btn secondary" onclick="generateBoard()">ğŸ² æ›è™Ÿç¢¼</button>
                    <button class="btn" onclick="lockBoard()">ğŸ”’ é–å®šç›¤é¢</button>
                </div>
            </div>
        </div>

        <div id="admin-panel" class="admin-panel" style="display:none;">
            <div class="admin-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ç›®å‰è™Ÿç¢¼</span>
                    <span style="font-size:0.8rem; opacity:0.7">åŒæ­¥é¡¯ç¤º</span>
                </div>
                <div id="admin-big-number" class="admin-big-number">--</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn" style="background:#e67e22" onclick="drawNumber()">éš¨æ©ŸæŠ½è™Ÿ</button>
                    <button class="btn" style="background:#f1c40f; color:#000" onclick="pickLuckyPlayer()">æŠ½å¹¸é‹å…’</button>
                </div>
            </div>

            <div class="list-container">
                <div style="font-weight:bold; color:var(--primary); margin-bottom:5px; border-bottom:2px solid #eee;">ğŸ‰ è³“æœåå–® (å³æ™‚)</div>
                <div id="admin-bingo-list"></div>
            </div>

            <div class="list-container">
                <div style="font-weight:bold; color:#e65100; margin-bottom:5px;">â³ å¾…å¯©æ ¸é¸è™Ÿ</div>
                <div id="pending-list"></div>
            </div>

            <div class="admin-card" style="font-size:0.85rem;">
                å·²é–‹è™Ÿç¢¼: <span id="admin-history"></span>
            </div>
            
            <button class="btn secondary" onclick="resetGame()" style="font-size:0.8rem; padding:8px;">âš ï¸ é‡ç½®éŠæˆ²</button>
        </div>
    </div>
</div>

<div id="lucky-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--accent);">ğŸŒŸ å¤©é¸ä¹‹äººï¼</h2>
        <p>è«‹è¼¸å…¥ 1-25 è™Ÿï¼š</p>
        <input type="number" id="lucky-num-input" min="1" max="25">
        <button class="btn" onclick="submitLuckyChoice()">é€å‡ºè™Ÿç¢¼</button>
    </div>
</div>

<div id="admin-login-modal" class="modal">
    <div class="modal-content">
        <h3>ç®¡ç†å“¡ç™»å…¥</h3>
        <input type="email" id="admin-email" placeholder="Email">
        <input type="password" id="admin-pwd" placeholder="Password">
        <button class="btn" onclick="adminLogin()">ç™»å…¥</button>
        <button class="btn secondary" onclick="document.getElementById('admin-login-modal').style.display='none'" style="margin-top:10px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
        authDomain: "yearendbingo.firebaseapp.com",
        projectId: "yearendbingo",
        storageBucket: "yearendbingo.firebasestorage.app",
        messagingSenderId: "563353011392",
        appId: "1:563353011392:web:717976a176bc22a04d5925",
        measurementId: "G-M6EVYSPNJ9"
    };
    
    // è«‹å°‡æ‚¨çš„ç®¡ç†å“¡ UID å¡«å…¥æ­¤è™•
    const ALLOWED_ADMIN_UIDS = ["z6bA9TzIhPUqXBxSyoIlZGBETwy1"];

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ç‹€æ…‹è®Šæ•¸
    let currentUser = null;
    let myData = { name: "", board: [], locked: false };
    let gameHistory = [];
    let rollingInterval = null;
    let adminClickCount = 0;
    const winLines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];

    // --- 2. ç©å®¶ç™»å…¥ ---
    async function playerLogin() {
        const name = document.getElementById('username-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        
        try {
            await auth.signOut(); // æ¸…é™¤èˆŠç‹€æ…‹
            const cred = await auth.signInAnonymously();
            currentUser = cred.user;
            await loadPlayerData(currentUser.uid, name);
            
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            startListeners();
            startHeartbeat();
        } catch(e) {
            alert("ç™»å…¥å¤±æ•—: " + e.message);
        }
    }

    async function loadPlayerData(uid, name) {
        const docRef = db.collection("players").doc(uid);
        const snap = await docRef.get();
        if(snap.exists) {
            const d = snap.data();
            myData = { name: d.name, board: d.board, locked: d.locked };
        } else {
            myData = { name: name, board: genRandomBoard(), locked: false };
            await docRef.set({ ...myData, maxConsecutive: 0, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
        }
        document.getElementById('display-name').innerText = myData.name;
        renderBoard();
    }

    function genRandomBoard() {
        return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    }

    // --- 3. éŠæˆ²é‚è¼¯ ---
    function renderBoard() {
        const grid = document.getElementById('bingo-grid');
        grid.innerHTML = "";
        
        // ä¿®æ­£é» 1: é€£ç·šè¨ˆç®—
        let winCount = 0;
        const winningIndices = new Set();
        if(myData.board.length === 25) {
            winLines.forEach(line => {
                if(line.every(i => gameHistory.includes(myData.board[i]))) {
                    winCount++;
                    line.forEach(i => winningIndices.add(i));
                }
            });
        }

        myData.board.forEach((num, idx) => {
            const div = document.createElement('div');
            div.className = 'cell';
            if(gameHistory.includes(num)) div.classList.add('selected');
            if(winningIndices.has(idx)) div.classList.add('bingo-line');
            div.innerText = num;
            grid.appendChild(div);
        });

        const statusText = document.getElementById('status-text');
        if(winCount > 0) statusText.innerText = `ğŸ‰ è³“æœï¼é”æˆ ${winCount} æ¢é€£ç·šï¼`;
        else statusText.innerText = myData.locked ? "ç­‰å¾…é–‹ç..." : "è«‹å…ˆé–å®šç›¤é¢";

        document.getElementById('setup-controls').style.display = myData.locked ? 'none' : 'flex';
    }

    async function lockBoard() {
        if(!confirm("ç¢ºå®šé–å®šï¼Ÿç„¡æ³•æ›´æ”¹å–”ï¼")) return;
        const bStr = myData.board.join(',');
        
        // ç°¡å–®å”¯ä¸€æ€§æª¢æŸ¥
        const snap = await db.collection("players").where("boardStr","==",bStr).get();
        if(!snap.empty && snap.docs[0].id !== currentUser.uid) {
            alert("æ­¤ç›¤é¢å·²è¢«ä½¿ç”¨ï¼Œè«‹é‡æ–°éš¨æ©Ÿï¼");
            return generateBoard();
        }

        await db.collection("players").doc(currentUser.uid).update({
            board: myData.board, boardStr: bStr, locked: true
        });
        myData.locked = true;
        renderBoard();
    }

    function generateBoard() {
        if(myData.locked) return;
        myData.board = genRandomBoard();
        renderBoard();
    }

    // --- 4. ç›£è½èˆ‡åŒæ­¥ ---
    function startListeners() {
        // Game State ç›£è½
        db.collection("game_state").doc("current_game").onSnapshot(doc => {
            if(!doc.exists) return;
            const data = doc.data();
            gameHistory = data.history || [];
            const lastNum = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";

            // ä¿®æ­£é» 3: ç®¡ç†ç«¯åŒæ­¥å‹•ç•«
            if(data.isRolling) {
                if(!rollingInterval) rollingInterval = setInterval(()=> {
                    const n = Math.floor(Math.random()*25)+1;
                    document.getElementById('current-draw').innerText = n;
                    document.getElementById('admin-big-number').innerText = n; // ç®¡ç†è€…åŒæ­¥
                }, 80);
            } else {
                clearInterval(rollingInterval); rollingInterval = null;
                document.getElementById('current-draw').innerText = lastNum;
                document.getElementById('admin-big-number').innerText = lastNum; // ç®¡ç†è€…åŒæ­¥
                renderBoard();
                
                // æ¯æ¬¡é–‹çå®Œï¼Œæ›´æ–°è‡ªå·±çš„åˆ†æ•¸
                if(myData.locked && currentUser) updateMyScore();
            }

            // å¹¸é‹å…’å½ˆçª—
            if(data.luckyUser && data.luckyUser === myData.name && myData.locked && !data.isRolling) {
                document.getElementById('lucky-modal').style.display = 'flex';
            } else {
                document.getElementById('lucky-modal').style.display = 'none';
            }

            // ç®¡ç†æ­·å²
            document.getElementById('admin-history').innerText = gameHistory.join(', ');
        });

        // ä¿®æ­£é» 4: äººæ•¸èˆ‡è³“æœäº‹ä»¶ç›£è½ (æ”¾åœ¨ä¸€èµ·)
        db.collection("players").onSnapshot(snap => {
            const players = snap.docs.map(d => d.data());
            const now = Date.now();
            const online = players.filter(p => (now - (p.lastSeen?.toMillis?.() || 0)) < 30000).length;
            
            document.getElementById('online-badge').innerText = `åœ¨ç·š: ${online}`;
            document.getElementById('reg-badge').innerText = `è¨»å†Š: ${players.length}`;
        });

        // ç›£è½è³“æœäº‹ä»¶ (ç®¡ç†è€…ç”¨)
        db.collection("bingo_events").orderBy("timestamp", "desc").limit(20).onSnapshot(snap => {
            const list = snap.docs.map(d => d.data());
            document.getElementById('admin-bingo-list').innerHTML = list.map(e => 
                `<div class="list-item bingo">${e.name} é”æˆ ${e.maxConsecutive} é€£ç·š!</div>`
            ).join('');
        });

        // ç›£è½ Pending
        db.collection("pending_choices").onSnapshot(snap => {
            const list = snap.docs.map(d => ({id:d.id, ...d.data()}));
            document.getElementById('pending-list').innerHTML = list.map(p => 
                `<div class="list-item">${p.playerName} é¸ ${p.number} <button onclick="approveLucky(${p.number}, '${p.id}')">ç¢ºèª</button></div>`
            ).join('');
        });
    }

    function updateMyScore() {
        let maxC = 0;
        // ç°¡å–®è¨ˆç®—ï¼šé€™è£¡ç®—çš„æ˜¯é€£ç·šæ•¸(0-12)ï¼Œéé€£çºŒé•·åº¦ï¼Œä¾ä½¿ç”¨è€…éœ€æ±‚ä¿®æ­£
        // è‹¥è¦æ”¹å›é€£çºŒé•·åº¦ï¼Œè«‹æ›¿æ›æ­¤å‡½æ•¸é‚è¼¯
        let lines = 0;
        winLines.forEach(l => { if(l.every(i => gameHistory.includes(myData.board[i]))) lines++; });
        
        db.collection("players").doc(currentUser.uid).update({ maxConsecutive: lines }).catch(()=>{});
        
        // ä¿®æ­£é» 3: è³“æœé€šçŸ¥
        if(lines >= 1) { // åªè¦æœ‰é€£ç·šå°±é€šçŸ¥
            db.collection("bingo_events").add({
                name: myData.name, maxConsecutive: lines, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    }

    // --- 5. ç®¡ç†è€…åŠŸèƒ½ ---
    function handleAdminClick() {
        adminClickCount++;
        setTimeout(()=>adminClickCount=0, 3000);
        if(adminClickCount >= 5) document.getElementById('admin-login-modal').style.display = 'flex';
    }

    async function adminLogin() {
        const email = document.getElementById('admin-email').value;
        const pwd = document.getElementById('admin-pwd').value;
        try {
            await auth.signInWithEmailAndPassword(email, pwd);
            if(ALLOWED_ADMIN_UIDS.includes(auth.currentUser.uid)) {
                document.getElementById('admin-panel').style.display = 'flex';
                document.getElementById('admin-login-modal').style.display = 'none';
                document.getElementById('admin-indicator').style.display = 'block';
                // ä¹Ÿè¦å•Ÿå‹•ç›£è½ï¼Œä¸ç„¶ç®¡ç†è€…çœ‹ä¸åˆ°æ•¸æ“š
                startListeners(); 
            } else {
                alert("éç®¡ç†å“¡å¸³è™Ÿ");
                auth.signOut();
            }
        } catch(e) { alert("ç™»å…¥å¤±æ•—"); }
    }

    async function drawNumber() {
        const ref = db.collection("game_state").doc("current_game");
        const snap = await ref.get();
        const h = snap.exists ? snap.data().history : [];
        const avail = Array.from({length:25},(_,i)=>i+1).filter(n=>!h.includes(n));
        if(!avail.length) return alert("æŠ½å®Œ");
        
        const next = avail[Math.floor(Math.random()*avail.length)];
        await ref.update({ isRolling: true });
        setTimeout(() => {
            ref.update({ isRolling:false, history: firebase.firestore.FieldValue.arrayUnion(next), luckyUser:"" });
        }, 2500);
    }

    async function approveLucky(num, id) {
        await db.collection("game_state").doc("current_game").update({
            history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser:""
        });
        await db.collection("pending_choices").doc(id).delete();
    }

    async function pickLuckyPlayer() {
        const snap = await db.collection("players").where("locked","==",true).get();
        const players = snap.docs.map(d => d.data());
        // é‚è¼¯ï¼šæ‰¾åˆ†æ•¸æœ€ä½çš„
        players.sort((a,b) => (a.maxConsecutive||0) - (b.maxConsecutive||0));
        const pool = players.slice(0, 15);
        if(!pool.length) return alert("ç„¡äººé–å®š");
        const lucky = pool[Math.floor(Math.random()*pool.length)];
        await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name });
    }

    async function submitLuckyChoice() {
        const n = parseInt(document.getElementById('lucky-num-input').value);
        if(!n || n<1 || n>25 || gameHistory.includes(n)) return alert("ç„¡æ•ˆè™Ÿç¢¼");
        await db.collection("pending_choices").add({
            playerName: myData.name, number: n, uid: currentUser.uid
        });
        document.getElementById('lucky-modal').style.display = 'none';
        alert("å·²é€å‡º");
    }

    async function resetGame() {
        if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) return;
        const b = db.batch();
        const ps = await db.collection("players").get();
        ps.forEach(d => b.delete(d.ref));
        // æ¸…ç©ºè³“æœäº‹ä»¶
        const es = await db.collection("bingo_events").get();
        es.forEach(d => b.delete(d.ref));
        
        b.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, luckyUser:"" });
        await b.commit();
        location.reload();
    }

    function startHeartbeat() {
        setInterval(() => {
            if(currentUser) db.collection("players").doc(currentUser.uid).update({
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(()=>{});
        }, 15000);
    }
</script>
</body>
</html>
