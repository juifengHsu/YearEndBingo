<!DOCTYPE html>
<html class="light" lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.1</title>

    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #f45925;
            --primary-dark: #d64010;
            --bg: #f8f6f5;
            --surface: #ffffff;
            --text-dark: #1c110d;
            --muted: #6b7280;
            --success: #22c55e;
            --shadow: 0 4px 12px rgba(244, 89, 37, 0.2);
            --radius-lg: 1.5rem;
            --radius-full: 9999px;
        }

        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            font-family: 'Spline Sans', 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text-dark);
            line-height: 1.5;
            min-height: 100-vh;
        }

        /* å¯¬åº¦å„ªåŒ–ï¼šå–æ¶ˆ 980px é™åˆ¶ */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 2px solid #f4eae7;
            margin-bottom: 24px;
        }

        .title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-dark);
            background: #f4eae7;
            padding: 8px 20px;
            border-radius: var(--radius-full);
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid #f4eae7;
        }

        .hidden { display: none !important; }

        /* æŒ‰éˆ•å¤§å‹åŒ– */
        .btn {
            padding: 16px 32px;
            border-radius: var(--radius-full);
            border: none;
            font-weight: 700;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn.primary {
            background: var(--primary);
            color: #fff;
            box-shadow: var(--shadow);
        }

        .btn.primary:hover { transform: translateY(-2px); background: var(--primary-dark); }

        .btn.ghost {
            background: #f4eae7;
            color: var(--text-dark);
        }

        .btn.danger {
            background: #ef4444;
            color: #fff;
        }

        /* è³“æœæ ¼å¤§å‹åŒ– */
        .grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            max-width: 600px;
            margin: 24px auto;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border-radius: var(--radius-lg);
            border: 2px solid #f4eae7;
            font-weight: 800;
            font-size: 2.5rem; /* å­—é«”åŠ å¤§ */
            color: var(--text-dark);
            transition: all 0.2s;
            cursor: default;
        }

        .cell.selected {
            background: #fef2ef;
            color: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .cell.bingo-line {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            animation: pulse 900ms infinite;
            box-shadow: 0 0 20px rgba(244, 89, 37, 0.4);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        /* æ­·å²è™Ÿç¢¼çƒ */
        .history-ball {
            display: inline-block;
            width: 45px;
            height: 45px;
            line-height: 45px;
            background: #f4eae7;
            color: var(--text-dark);
            border-radius: 50%;
            margin: 5px;
            text-align: center;
            font-weight: 800;
            font-size: 1.25rem;
        }

        /* æ•¸å­—é¡¯ç¤ºå€åŸŸ */
        #draw-display, #admin-sync-num {
            font-size: 6rem;
            font-weight: 900;
            color: var(--primary);
            margin: 20px 0;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }

        /* æ§åˆ¶å°æ¨£å¼ */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .stat-box {
            background: #fcf9f8;
            padding: 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid #f4eae7;
        }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--primary); display: block; }

        .status-log {
            max-height: 200px;
            overflow: auto;
            padding: 15px;
            border-radius: 12px;
            background: #1c110d;
            color: #d1d5db;
            font-family: monospace;
            font-size: 0.9rem;
            text-align: left;
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(28, 17, 13, 0.85);
            backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 999;
        }
        .modal-content {
            background: white; padding: 40px; border-radius: 2rem; width: 90%; max-width: 450px;
            text-align: center;
        }

        /* è¼¸å…¥æ¡†åŠ å¤§ */
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 18px; font-size: 1.25rem; border-radius: 12px;
            border: 2px solid #f4eae7; margin-bottom: 15px;
        }

        @media (max-width: 640px) {
            .cell { font-size: 1.75rem; }
            #draw-display { font-size: 4rem; }
        }
    </style>
</head>
<body>

<div id="admin-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="font-size: 1.5rem; margin-bottom: 20px;">ç®¡ç†è€…ç™»å…¥</h3>
        <input id="admin-email" type="email" placeholder="Email">
        <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼">
        <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç¢ºèªç™»å…¥</button>
        <button class="btn ghost" style="width:100%;margin-top:12px;" onclick="closeAdminModal()">å–æ¶ˆ</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ±</div>
        <div id="user-info" class="user-info">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="view-login" class="card hidden">
        <h3 style="font-size: 1.5rem; margin-bottom: 20px;">æ­¡è¿åƒåŠ å°¾ç‰™è³“æœ</h3>
        <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" />
        <button class="btn primary" style="width:100%;margin-top:12px" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
    </div>

    <div id="view-player" class="hidden">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-weight:800; font-size: 1.5rem;" id="player-name-display"></div>
                    <div id="lock-status-label" style="font-size:1.1rem; color:var(--muted); font-weight:600;"></div>
                </div>
                <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
            </div>
            
            <div style="text-align:center;margin-top:20px">
                <div style="font-size: 1.1rem; color: var(--muted); font-weight: 700;">æœ€æ–°é–‹å‡ºè™Ÿç¢¼</div>
                <div id="draw-display">READY</div>
                <div id="bingo-status" style="height:35px;color:var(--primary);font-weight:800;font-size:1.5rem;margin-bottom:10px;"></div>
                
                <div id="bingo-grid" class="grid"></div>
                
                <div id="setup-btns" style="margin-top:30px;display:flex;gap:15px;justify-content:center">
                    <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
                    <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-admin" class="hidden">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <div style="font-weight:800; font-size: 1.5rem;">ç®¡ç†è€…æ§åˆ¶å° <span id="admin-lock-indicator" style="font-size:1rem;padding:6px 12px;background:#eee;border-radius:8px">æœªé–å®š</span></div>
                <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box"><span id="count-online" class="stat-val">0</span><span>åœ¨ç·šäººæ•¸</span></div>
                <div class="stat-box"><span id="count-total" class="stat-val">0</span><span>ç¸½åƒèˆ‡è€…</span></div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:20px">
                <div class="stat-box"><span id="cnt-5" class="stat-val">0</span><span>5é€£</span></div>
                <div class="stat-box"><span id="cnt-4" class="stat-val">0</span><span>4é€£</span></div>
                <div class="stat-box"><span id="cnt-3" class="stat-val">0</span><span>3é€£</span></div>
                <div class="stat-box"><span id="cnt-2" class="stat-val">0</span><span>2é€£</span></div>
            </div>

            <div style="margin-top:24px; text-align:center; background:#fef2ef; padding:30px; border-radius:24px; border:2px dashed var(--primary)">
                <div style="font-size:1.2rem; font-weight:700; color:var(--text-dark)">æœ€æ–°é–‹çè™Ÿ / æ­·å²æ¸…å–®</div>
                <div id="admin-sync-num">--</div>
                <div id="drawn-history-list" style="margin-top:15px; border-top:2px solid #f4eae7; padding-top:20px"></div>
            </div>

            <div style="margin-top:24px; display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ (è‡ªå‹•é–å®š)</button>
                <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶å…¨å“¡é–å®š</button>
                <button class="btn" style="background:#ffb300; color: #1c110d" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
                <button class="btn danger" onclick="removeAllPlayers()">ğŸ§¹ ç§»é™¤æ‰€æœ‰ä½¿ç”¨è€…</button>
                <button class="btn ghost" style="grid-column: span 2; border:2px solid #f4eae7" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²ç‹€æ…‹ (æ¢å¾©æ›è™ŸåŠŸèƒ½)</button>
            </div>

            <div class="card" style="margin-top:24px; border: 1px solid #f4eae7">
                <div style="font-weight:800; font-size:1.1rem; margin-bottom:10px">ğŸ“¢ å³æ™‚å‹•æ…‹</div>
                <div id="pending-choices" style="max-height:120px; overflow:auto; font-size:1.1rem; color:var(--primary); font-weight:700"></div>
                <div id="bingo-alerts" style="max-height:120px; overflow:auto; font-size:1.1rem; color:var(--success); font-weight:700"></div>
            </div>
            
            <div id="status-log" class="status-log"></div>
        </div>
    </div>
</div>

<script>
// --- Firebase è¨­å®š --- [cite: 559-571]
const firebaseConfig = {
    apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
    authDomain: "yearendbingo.firebaseapp.com",
    projectId: "yearendbingo",
    storageBucket: "yearendbingo.firebasestorage.app",
    messagingSenderId: "563353011392",
    appId: "1:563353011392:web:717976a176bc22a04d5925",
    measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;

// ... (å…¶é¤˜æ‰€æœ‰ doAdminLogin, renderGrid, drawNewNumber ç­‰å‡½å¼è«‹ç…§ Index-0105.docx åŸæ¨£è²¼ä¸Š) ...
// (ç‚ºç¯€çœé•·åº¦ï¼Œæ­¤è™•çœç•¥èˆ‡åŸæ–‡å®Œå…¨ç›¸åŒçš„ JS ç¨‹å¼ç¢¼ç‰‡æ®µ)
// ... 

// [è¤‡è£½ Index-0105.docx ç¬¬ 578 è¡Œåˆ°ç¬¬ 823 è¡Œçš„æ‰€æœ‰ JavaScript å…§å®¹æ’å…¥æ–¼æ­¤]
function logStatus(msg) {
const el = document.getElementById('status-log');
if(!el) return;
el.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
}
function triggerAdmin() {
window.ac = (window.ac || 0) + 1;
if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }
async function doAdminLogin(){
const email = document.getElementById('admin-email').value;
const pwd = document.getElementById('admin-pwd').value;
try {
const cred = await auth.signInWithEmailAndPassword(email, pwd);
if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ"); }
else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
} catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}
auth.onAuthStateChanged(async user => {
currentUser = user;
if(!user){ showView('login'); return; }
if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
const snap = await db.collection("players").doc(user.uid).get();
if(snap.exists){ myData = snap.data(); } 
else {
const name = document.getElementById('player-name').value || "è¨ªå®¢";
myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
await db.collection("players").doc(user.uid).set(myData);
}
document.getElementById('user-info').innerText = myData.name;
document.getElementById('player-name-display').innerText = myData.name;
showView('player'); startApp();
});
async function doPlayerLogin(){
if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
await auth.signInAnonymously();
}
function showView(name){
document.getElementById('view-login').classList.add('hidden');
document.getElementById('view-player').classList.add('hidden');
document.getElementById('view-admin').classList.add('hidden');
document.getElementById('view-'+name).classList.remove('hidden');
}
function startApp(){
db.collection("game_state").doc("current_game").onSnapshot(doc => {
const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
gameHistory = data.history || [];
isAllLockedGlobal = data.isAllLocked || false;
if(document.getElementById('admin-lock-indicator')) {
document.getElementById('admin-lock-indicator').innerText = isAllLockedGlobal ? "âœ… å·²é–å®š" : "ğŸ”“ æœªé–å®š";
document.getElementById('admin-lock-indicator').style.background = isAllLockedGlobal ? "#c8e6c9" : "#eee";
}
const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="history-ball">${n}</span>`).join('') || "ç­‰å¾…é–‹è™Ÿ";
if(data.isRolling){
if(!rollingTimer) rollingTimer = setInterval(()=> {
const r = Math.floor(Math.random()*25)+1;
document.getElementById('draw-display').innerText = r;
if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = r;
}, 80);
} else {
clearInterval(rollingTimer); rollingTimer=null;
document.getElementById('draw-display').innerText = last;
if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = last;
renderGrid();
if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
}
if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
let valid = false; let num;
while(!valid) {
const input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹è™Ÿç¢¼ (1-25)ï¼š\n(æ³¨æ„ï¼šä¸èƒ½é‡è¤‡æŠ½éçš„è™Ÿç¢¼)`);
if(input === null) break;
num = parseInt(input);
if(isNaN(num) || num < 1 || num > 25) { alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥ 1 åˆ° 25 ä¹‹é–“çš„æ•¸å­—ã€‚"); } 
else if(gameHistory.includes(num)) { alert(`éŒ¯èª¤ï¼š${num} å·²ç¶“è¢«æŠ½éå›‰ã€‚`); } 
else { valid = true; }
}
if(valid) {
db.collection("pending_choices").doc(currentUser.uid).set({ playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
db.collection("game_state").doc("current_game").update({ luckyUser: "" });
}
}
});
db.collection("players").onSnapshot(snap => {
allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
document.getElementById('count-total').innerText = allPlayersCache.length;
if(currentUser.uid !== ALLOWED_UID){
const me = allPlayersCache.find(p => p.id === currentUser.uid);
if(me && me.locked !== myData.locked) { myData.locked = me.locked; renderGrid(); }
}
});
if(currentUser.uid === ALLOWED_UID){
db.collection("pending_choices").orderBy("timestamp","desc").onSnapshot(snap => {
document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div>â“ ${d.data().playerName} é¸äº† ${d.data().number} <button onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
});
db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ <b>${d.data().name}</b> è³“æœäº†ï¼</div>`).join('');
});
}
}
function renderGrid(){
const grid = document.getElementById('bingo-grid');
if(!grid) return;
grid.innerHTML = '';
const winIdx = new Set();
const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
let winLineCount = 0;
lines.forEach(line => {
if(line.every(idx => gameHistory.includes(myData.board[idx]))) { line.forEach(i=>winIdx.add(i)); winLineCount++; }
});
myData.board.forEach((num,i)=>{
const div = document.createElement('div');
div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
div.innerText = num;
grid.appendChild(div);
});
if(winLineCount > 0 && myData.locked) {
document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
}
document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­...";
}
function calculateMaxConsecutive(board, history) {
const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
let globalMax = 0;
lines.forEach(line => {
let currentMax = 0; let streak = 0;
line.forEach(index => {
if(history.includes(board[index])) { streak++; if(streak > currentMax) currentMax = streak; } else { streak = 0; }
});
if(currentMax > globalMax) globalMax = currentMax;
});
return globalMax;
}
function updateConnectedStats(){
const counts = {5:0,4:0,3:0,2:0};
allPlayersCache.forEach(p=>{
if(!p.board || !p.locked) return;
const max = calculateMaxConsecutive(p.board, gameHistory);
if(max >= 5) counts[5]++; else if(max === 4) counts[4]++; else if(max === 3) counts[3]++; else if(max === 2) counts[2]++;
});
document.getElementById('cnt-5').innerText = counts[5]; document.getElementById('cnt-4').innerText = counts[4];
document.getElementById('cnt-3').innerText = counts[3]; document.getElementById('cnt-2').innerText = counts[2];
}
async function forceLockAll() {
const batch = db.batch();
allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
await batch.commit();
await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}
async function drawNewNumber(){
const ref = db.collection("game_state").doc("current_game");
if(!isAllLockedGlobal) await forceLockAll();
const snap = await ref.get(); const hist = snap.data().history || [];
const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
if(!pool.length) return alert("æŠ½å®Œå›‰");
await ref.update({ isRolling:true });
setTimeout(async ()=>{
const p = pool[Math.floor(Math.random()*pool.length)];
await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false, luckyUser: "" });
}, 1200);
}
async function removeAllPlayers() {
if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…å—ï¼Ÿ")) return;
const batch = db.batch();
allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
await batch.commit(); location.reload();
}
async function handleReset(){
if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿé€™æœƒæ¢å¾©æ‰€æœ‰äººçš„æ›è™ŸåŠŸèƒ½ã€‚")) return;
const batch = db.batch();
allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
const colls = ["pending_choices","bingo_events"];
for(const c of colls){ const s = await db.collection(c).get(); s.forEach(d=>batch.delete(d.ref)); }
batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
await batch.commit(); location.reload();
}
async function confirmLucky(id, num) {
await db.collection("game_state").doc("current_game").update({ history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
await db.collection("pending_choices").doc(id).delete();
}
async function pickLucky() {
if(allPlayersCache.length === 0) return alert("æ²’äººåƒèˆ‡");
const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
alert("å¹¸é‹å…’æ˜¯ï¼š" + lucky);
}
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
await db.collection("players").doc(currentUser.uid).update({ locked:true });
myData.locked = true; renderGrid();
}
function doSignOut(){ auth.signOut(); location.reload(); }
setInterval(() => {
if(currentUser && currentUser.uid !== ALLOWED_UID) {
db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
}
}, 15000);
</script>
</body>
</html>
