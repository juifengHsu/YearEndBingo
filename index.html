<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å°¾ç‰™å¤§è³“æœ - ç©å®¶ç«¯</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --secondary: #ffc107; --bg: #f8f9fa; --success: #2e7d32; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); text-align: center; color: #333; -webkit-user-select: none; user-select: none; }
        
        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page { display: none !important; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .page.active { display: flex !important; flex-direction: column; align-items: center; justify-content: flex-start; }

        /* ç™»å…¥é  */
        .login-container { margin-top: 20vh; width: 100%; max-width: 320px; }
        h1 { color: var(--primary); font-size: 2.5rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        /* éŠæˆ²é  */
        .header-info { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 0 0 15px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .user-badge { font-weight: bold; color: #555; font-size: 0.9rem; }
        
        .big-number { font-size: 6rem; color: var(--primary); font-weight: 800; line-height: 1.2; min-height: 120px; text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.1); margin: 10px 0; }
        .status-bar { font-size: 1rem; color: var(--success); font-weight: bold; margin-bottom: 10px; min-height: 24px; }

        /* è³“æœç›¤ (éŸ¿æ‡‰å¼) */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; max-width: 360px; background: #fff; padding: 10px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .cell { aspect-ratio: 1; border: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; border-radius: 8px; background: #fafafa; transition: all 0.2s; position: relative; }
        .cell.selected { background: var(--secondary); color: #b71c1c; border-color: var(--secondary); transform: scale(0.96); box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
        .cell.bingo-line { background: var(--primary) !important; color: white !important; animation: pulse 1s infinite; }

        /* æ“ä½œå€ */
        .controls { margin-top: 20px; width: 100%; max-width: 360px; display: flex; gap: 10px; justify-content: center; }
        button { flex: 1; padding: 14px; font-size: 1rem; border: none; border-radius: 12px; background: var(--primary); color: white; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: transform 0.1s; }
        button:active { transform: translateY(2px); box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        button.secondary { background: #546e7a; }
        button:disabled { background: #e0e0e0; color: #999; box-shadow: none; cursor: not-allowed; }
        
        input { padding: 14px; border-radius: 10px; border: 2px solid #eee; width: 80%; font-size: 1.1rem; text-align: center; margin-bottom: 15px; outline: none; transition: border 0.3s; }
        input:focus { border-color: var(--secondary); }

        /* å¹¸é‹å…’å½ˆçª— */
        #lucky-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; border: 4px solid var(--secondary); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-container">
            <h1>ğŸ§§ 2025<br>å°¾ç‰™è³“æœ</h1>
            <p style="color: #666; margin-bottom: 30px;">è«‹è¼¸å…¥æ‚¨çš„å§“ååŠ å…¥æˆ°å±€</p>
            <input type="text" id="username-input" placeholder="çœŸå¯¦å§“å (ä¾‹å¦‚: é™³å°æ˜)">
            <button onclick="handleLogin()">é€²å…¥éŠæˆ²</button>
            <div id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9rem;"></div>
        </div>
    </div>

    <div id="page-game" class="page">
        <div class="header-info">
            <div class="user-badge">ğŸ‘¤ <span id="display-name">è¼‰å…¥ä¸­...</span></div>
            <div style="font-size: 0.8rem; color: #888;">é€£ç·š: <span id="conn-status" style="color:green">â—</span></div>
        </div>

        <div class="big-number" id="current-draw">READY</div>
        <div class="status-bar" id="status-text">è«‹å…ˆé–å®šè™Ÿç¢¼</div>
        
        <div class="grid" id="bingo-grid"></div>

        <div class="controls" id="setup-controls">
            <button class="secondary" onclick="generateBoard()">ğŸ² éš¨æ©Ÿæ›è™Ÿ</button>
            <button onclick="lockBoard()" style="background: var(--success);">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
    </div>

    <div id="lucky-modal">
        <div class="modal-content">
            <h2 style="color: #e65100; margin-top: 0;">ğŸŒŸ å¤©é¸ä¹‹äººï¼</h2>
            <p>æ­å–œæ‚¨è¢«é¸ä¸­ï¼<br>è«‹è¼¸å…¥ä¸‹ä¸€å€‹é–‹çè™Ÿç¢¼ (1-25)</p>
            <input type="number" id="lucky-num-input" min="1" max="25" inputmode="numeric">
            <button onclick="submitLuckyChoice()" style="background: var(--secondary); color: #b71c1c;">é€å‡ºè™Ÿç¢¼</button>
            <p style="font-size: 0.8rem; color: #999; margin-top: 10px;">è«‹å‹¿è¼¸å…¥å·²é–‹éçš„è™Ÿç¢¼</p>
        </div>
    </div>

    <script>
        // --- 1. Firebase Configuration (è«‹æ›¿æ›ç‚ºæ‚¨çš„çœŸå¯¦è¨­å®š) ---
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456",
            appId: "1:123..."
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ç‹€æ…‹è®Šæ•¸
        let currentUser = null;
        let myData = { board: [], locked: false, name: "" };
        let gameHistory = [];
        let rollingInterval = null;
        
        // è³“æœé€£ç·šç´¢å¼• (0-24)
        const winLines = [
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24], // æ©«
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24], // è±
            [0,6,12,18,24], [4,8,12,16,20] // æ–œ
        ];

        // --- 2. ç™»å…¥èˆ‡åˆå§‹åŒ–æµç¨‹ ---
        
        // æª¢æŸ¥ LocalStorage æ˜¯å¦æœ‰èˆŠçš„å§“å
        window.onload = () => {
            const savedName = localStorage.getItem('bingo_username');
            if (savedName) document.getElementById('username-input').value = savedName;
        };

        async function handleLogin() {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return showLoginError("è«‹è¼¸å…¥å§“å");
            
            // é–å®šæŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
            const btn = document.querySelector('#page-login button');
            btn.disabled = true;
            btn.innerText = "é€£ç·šä¸­...";

            try {
                // 1. åŒ¿åç™»å…¥å–å¾— UID
                const userCred = await auth.signInAnonymously();
                currentUser = userCred.user;
                
                // 2. å„²å­˜å§“ååˆ°æœ¬åœ°
                localStorage.setItem('bingo_username', name);
                myData.name = name;

                // 3. æª¢æŸ¥ Firestore æ˜¯å¦å·²æœ‰è©²ç©å®¶è³‡æ–™ (æ–·ç·šé‡é€£)
                const docRef = db.collection("players").doc(currentUser.uid);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    // è€ç©å®¶ï¼šè¼‰å…¥è³‡æ–™
                    const data = docSnap.data();
                    myData = { ...myData, ...data };
                    console.log("æ¢å¾©ç©å®¶è³‡æ–™:", myData);
                } else {
                    // æ–°ç©å®¶ï¼šåˆå§‹åŒ– (ä½†ä¸å¯«å…¥ boardï¼Œç›´åˆ°é–å®š)
                    myData.board = generateRandomBoard();
                    myData.locked = false;
                    // å…ˆå¯«å…¥åŸºæœ¬è³‡æ–™ä»¥ä¾¿ç®¡ç†ç«¯çµ±è¨ˆè¨»å†Šäººæ•¸
                    await docRef.set({
                        name: name,
                        locked: false,
                        maxConsecutive: 0,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                }

                // 4. é€²å…¥éŠæˆ²ä»‹é¢
                enterGame();

            } catch (error) {
                console.error(error);
                showLoginError("ç™»å…¥å¤±æ•—: " + error.message);
                btn.disabled = false;
                btn.innerText = "é€²å…¥éŠæˆ²";
            }
        }

        function showLoginError(msg) {
            document.getElementById('login-msg').innerText = msg;
        }

        function enterGame() {
            document.getElementById('display-name').innerText = myData.name;
            switchPage('page-game');
            renderBoard();
            updateUIState();
            startListeners(); // å•Ÿå‹•ç›£è½
            startHeartbeat(); // å•Ÿå‹•å¿ƒè·³
        }

        // --- 3. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---

        function generateRandomBoard() {
            // ç”¢ç”Ÿ 1-25 äº‚æ•¸é™£åˆ—
            return Array.from({length: 25}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        }

        function generateBoard() {
            if (myData.locked) return; // å·²é–å®šä¸èƒ½æ›
            myData.board = generateRandomBoard();
            renderBoard();
        }

        // é–å®šç›¤é¢ (åŒ…å« Transaction å”¯ä¸€æ€§æª¢æŸ¥)
        async function lockBoard() {
            if (!confirm("ç¢ºå®šè¦ä½¿ç”¨é€™çµ„è™Ÿç¢¼å—ï¼Ÿ\né–å®šå¾Œå°‡ç„¡æ³•æ›´æ”¹ï¼")) return;

            const btn = document.getElementById('btn-lock');
            btn.disabled = true;
            btn.innerText = "æª¢æŸ¥ä¸­...";

            const boardStr = myData.board.join(',');
            const playerRef = db.collection("players").doc(currentUser.uid);

            try {
                await db.runTransaction(async (transaction) => {
                    // 1. æª¢æŸ¥å…¨åŸŸæ˜¯å¦æœ‰ç›¸åŒ boardStr
                    // æ³¨æ„ï¼šFirestore æ²’æœ‰ç›´æ¥ unique constraintï¼Œéœ€é€é query æª¢æŸ¥
                    // åœ¨é«˜ä½µç™¼ä¸‹ query å¯èƒ½æœ‰å»¶é²ï¼Œä½†å°å°¾ç‰™è¦æ¨¡é€šå¸¸è¶³å¤ 
                    const duplicateCheck = await db.collection("players")
                        .where("boardStr", "==", boardStr)
                        .get();

                    // æ’é™¤è‡ªå·± (å¦‚æœä¹‹å‰ä¿å­˜éä½†æœªé–å®š)
                    const others = duplicateCheck.docs.filter(d => d.id !== currentUser.uid);

                    if (others.length > 0) {
                        throw "DuplicateBoard";
                    }

                    // 2. å¯«å…¥è³‡æ–™ä¸¦é–å®š
                    transaction.update(playerRef, {
                        board: myData.board,
                        boardStr: boardStr,
                        locked: true,
                        maxConsecutive: calculateMaxConsecutive(myData.board, gameHistory) // åˆå§‹åˆ†æ•¸
                    });
                });

                // æˆåŠŸ
                myData.locked = true;
                updateUIState();
                alert("ç›¤é¢å·²é–å®šï¼ç¥æ‚¨ä¸­å¤§çï¼");

            } catch (e) {
                btn.disabled = false;
                btn.innerText = "ğŸ”’ é–å®šç›¤é¢";
                if (e === "DuplicateBoard") {
                    alert("å¤ªå·§äº†ï¼é€™çµ„è™Ÿç¢¼å‰›å¥½æœ‰äººé¸èµ°äº†ã€‚\nç³»çµ±å°‡ç‚ºæ‚¨é‡æ–°ç”¢ç”Ÿä¸€çµ„ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
                    generateBoard();
                } else {
                    console.error(e);
                    alert("ä¿å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚");
                }
            }
        }

        // --- 4. ç›£è½èˆ‡å³æ™‚äº’å‹• ---

        function startListeners() {
            // A. ç›£è½éŠæˆ²ç‹€æ…‹ (é–‹çè™Ÿç¢¼ã€å‹•ç•«ç‹€æ…‹ã€å¹¸é‹å…’)
            db.collection("game_state").doc("current_game")
                .onSnapshot((doc) => {
                    if (!doc.exists) return;
                    const data = doc.data();
                    
                    // 1. è™•ç†é–‹çæ­·å²
                    const newHistory = data.history || [];
                    if (JSON.stringify(newHistory) !== JSON.stringify(gameHistory)) {
                        gameHistory = newHistory;
                        // ç•¶è™Ÿç¢¼è®Šå‹•ï¼Œè‹¥å·²é–å®šï¼Œè¨ˆç®—æ–°åˆ†æ•¸ä¸¦å›å‚³
                        if (myData.locked) {
                            const newScore = calculateMaxConsecutive(myData.board, gameHistory);
                            // åªæœ‰åˆ†æ•¸æ”¹è®Šæ‰å¯«å…¥ï¼Œç¯€çœå¯«å…¥æ¬¡æ•¸
                            db.collection("players").doc(currentUser.uid).update({
                                maxConsecutive: newScore
                            }).catch(e => console.log("åˆ†æ•¸æ›´æ–°å¤±æ•—", e));
                        }
                    }

                    // 2. è™•ç†è·‘è™Ÿå‹•ç•«
                    if (data.isRolling) {
                        startRollingAnim();
                    } else {
                        stopRollingAnim();
                        // é¡¯ç¤ºæœ€å¾Œä¸€è™Ÿ
                        const lastNum = gameHistory.length > 0 ? gameHistory[gameHistory.length - 1] : "READY";
                        document.getElementById('current-draw').innerText = lastNum;
                        renderBoard(); // é‡ç¹ªæ ¼å­é¡è‰²
                    }

                    // 3. è™•ç†å¹¸é‹å…’ (Check Name match + Locked status)
                    // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ Name æ¯”å°æ˜¯ç‚ºäº†é…åˆç®¡ç†ç«¯é¡¯ç¤ºï¼Œè‹¥éœ€åš´è¬¹å¯ç”¨ UID
                    if (data.luckyUser === myData.name && myData.locked && !data.isRolling) {
                        showLuckyModal();
                    } else {
                        closeLuckyModal();
                    }
                });
        }

        // æœ€å¤§é€£è²«é•·åº¦ç®—æ³•
        function calculateMaxConsecutive(board, history) {
            let maxScore = 0;
            
            winLines.forEach(line => {
                let currentStreak = 0;
                let lineMax = 0;
                
                line.forEach(index => {
                    const num = board[index];
                    if (history.includes(num)) {
                        currentStreak++;
                        if (currentStreak > lineMax) lineMax = currentStreak;
                    } else {
                        currentStreak = 0;
                    }
                });
                
                if (lineMax > maxScore) maxScore = lineMax;
            });
            
            return maxScore; // å›å‚³ 0-5
        }

        // å¿ƒè·³æ©Ÿåˆ¶ (Heartbeat)
        function startHeartbeat() {
            setInterval(() => {
                if (currentUser) {
                    db.collection("players").doc(currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.warn("Heartbeat fail", e));
                }
            }, 15000); // æ¯ 15 ç§’
        }

        // --- 5. å¹¸é‹å…’é¸è™Ÿæäº¤ ---

        function showLuckyModal() {
            document.getElementById('lucky-modal').style.display = 'flex';
        }

        function closeLuckyModal() {
            document.getElementById('lucky-modal').style.display = 'none';
        }

        async function submitLuckyChoice() {
            const input = document.getElementById('lucky-num-input');
            const val = parseInt(input.value);

            // å‰ç«¯é©—è­‰
            if (isNaN(val) || val < 1 || val > 25) {
                return alert("è«‹è¼¸å…¥ 1-25 ä¹‹é–“çš„æ•¸å­—");
            }
            if (gameHistory.includes(val)) {
                return alert(`è™Ÿç¢¼ ${val} å·²ç¶“é–‹éäº†ï¼è«‹æ›ä¸€å€‹ã€‚`);
            }

            // å¯«å…¥ Pending Choices
            try {
                await db.collection("pending_choices").doc(currentUser.uid).set({
                    userId: currentUser.uid,
                    playerName: myData.name,
                    number: val,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("è™Ÿç¢¼å·²é€å‡ºï¼è«‹ç­‰å¾…å¤§è¢å¹•é–‹çï¼");
                closeLuckyModal(); // æš«æ™‚é—œé–‰ï¼Œç­‰å¾…ç®¡ç†å“¡è™•ç†
            } catch (e) {
                console.error(e);
                alert("é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦");
            }
        }

        // --- 6. UI æ¸²æŸ“èˆ‡å‹•ç•« ---

        function updateUIState() {
            const controls = document.getElementById('setup-controls');
            const statusText = document.getElementById('status-text');
            
            if (myData.locked) {
                controls.style.display = 'none'; // éš±è—æ›è™ŸæŒ‰éˆ•
                statusText.innerText = "ç›¤é¢å·²é–å®šï¼Œç¥æ‚¨ä¸­çï¼";
            } else {
                controls.style.display = 'flex';
                statusText.innerText = "è«‹èª¿æ•´è™Ÿç¢¼ä¸¦é»æ“Šé–å®š";
            }
        }

        function renderBoard() {
            const grid = document.getElementById('bingo-grid');
            grid.innerHTML = "";
            
            // æª¢æŸ¥æ˜¯å¦ä¸­ç (è¦–è¦ºç”¨)
            let winCount = 0;
            const winningIndices = new Set();
            
            if (myData.board.length === 25) {
                winLines.forEach(line => {
                    if (line.every(idx => gameHistory.includes(myData.board[idx]))) {
                        winCount++;
                        line.forEach(idx => winningIndices.add(idx));
                    }
                });
            }

            if (winCount > 0) {
                document.getElementById('status-text').innerText = `ğŸ‰ è³“æœï¼é”æˆ ${winCount} æ¢é€£ç·šï¼`;
            }

            myData.board.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = num;
                
                // æ¨™è¨˜å·²é–‹å‡º
                if (gameHistory.includes(num)) {
                    cell.classList.add('selected');
                }
                
                // æ¨™è¨˜é€£ç·š
                if (winningIndices.has(index)) {
                    cell.classList.add('bingo-line');
                }
                
                grid.appendChild(cell);
            });
        }

        function startRollingAnim() {
            if (rollingInterval) return;
            const el = document.getElementById('current-draw');
            el.style.color = "#999";
            rollingInterval = setInterval(() => {
                el.innerText = Math.floor(Math.random() * 25) + 1;
            }, 80);
        }

        function stopRollingAnim() {
            if (rollingInterval) {
                clearInterval(rollingInterval);
                rollingInterval = null;
                document.getElementById('current-draw').style.color = "var(--primary)";
            }
        }

        function switchPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
