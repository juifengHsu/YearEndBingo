<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>2025 å°¾ç‰™è³“æœç³»çµ±</title>

<!-- Firebase compat libs (å¯ç”¨æ–¼ GitHub Pages æ¸¬è©¦) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root { --primary: #d32f2f; --secondary: #ffc107; --bg: #f8f9fa; --success: #2e7d32; --dark: #2c3e50; }
body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); text-align: center; color: #333; user-select: none; }
.page { display: none !important; padding: 20px; box-sizing: border-box; min-height: 100vh; }
.page.active { display: flex !important; flex-direction: column; align-items: center; }
.login-container { margin-top: 15vh; width: 100%; max-width: 320px; }
h1 { color: var(--primary); font-size: 2.5rem; cursor: pointer; }
.grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; max-width: 360px; background: #fff; padding: 10px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
.cell { aspect-ratio: 1; border: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; border-radius: 8px; background: #fafafa; }
.cell.selected { background: var(--secondary); color: #b71c1c; }
.cell.bingo-line { background: var(--primary) !important; color: white !important; animation: pulse 1s infinite; }
.big-number { font-size: 5rem; color: var(--primary); font-weight: 800; margin: 10px 0; min-height: 100px; }
#page-admin { background: var(--dark); color: white; text-align: left; align-items: stretch; }
.admin-card { background: #34495e; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
button { padding: 12px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
input { padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; width: 80%; text-align: center; }
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
.small-muted { font-size: 0.9rem; color: #ddd; }
.pending-item { display:flex; gap:8px; align-items:center; margin:6px 0; }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="page-login" class="page active">
  <div class="login-container">
    <h1 onclick="handleAdminClick()">ğŸ§§ 2025<br>å°¾ç‰™è³“æœ</h1>
    <input type="text" id="username-input" placeholder="è«‹è¼¸å…¥å§“å" />
    <button id="btn-login" onclick="handleLogin()" style="width: 85%;">é€²å…¥éŠæˆ²</button>
    <div style="margin-top:12px;" class="small-muted">åŒ¿åç™»å…¥ï¼Œè«‹è¼¸å…¥é¡¯ç¤ºç”¨å§“å</div>
  </div>
</div>

<!-- PLAYER PAGE -->
<div id="page-game" class="page">
  <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
    <span id="display-name">è¼‰å…¥ä¸­...</span>
    <span id="status-tag">ğŸŸ¢ åœ¨ç·š</span>
  </div>

  <div class="big-number" id="current-draw">READY</div>

  <div id="status-text" style="font-weight:bold; margin-bottom:10px; color:var(--success);">è«‹å…ˆé–å®šè™Ÿç¢¼</div>

  <div class="grid" id="bingo-grid"></div>

  <div id="setup-controls" style="margin-top:15px; display:flex; gap:10px;">
    <button onclick="generateBoard()" style="background:#546e7a;">ğŸ² æ›è™Ÿç¢¼</button>
    <button onclick="lockBoard()" id="btn-lock-real" style="background:var(--success);">ğŸ”’ é–å®šç›¤é¢</button>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="page-admin" class="page">
  <h2 style="color:white;">âš™ï¸ ç®¡ç†å¾Œå°</h2>

  <div class="admin-card">
    <button onclick="drawNumber()" style="width:100%; background:#e67e22; margin-bottom:10px;">ğŸ² éš¨æ©ŸæŠ½è™Ÿ</button>
    <button onclick="pickLuckyPlayer()" style="width:100%; background:var(--secondary); color:#333;">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
  </div>

  <div class="admin-card">å·²æŠ½è™Ÿç¢¼: <div id="admin-history" style="margin-top:8px; color:#fff;"></div></div>

  <div id="admin-pending-area" class="admin-card" style="display:none; border:2px solid var(--secondary);">
    <strong>å¾…å¯©æ ¸é¸è™Ÿ:</strong>
    <div id="pending-list" style="margin-top:8px;"></div>
  </div>

  <div class="admin-card">
    <strong>çµ±è¨ˆ</strong>
    <div id="stats-area" style="margin-top:8px; color:#fff;"></div>
  </div>

  <button onclick="location.reload()" style="background:#c0392b;">ç™»å‡º/è¿”å›</button>
</div>

<!-- LUCKY MODAL -->
<div id="lucky-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:99;">
  <div style="background:white; padding:20px; border-radius:15px; width:80%; color:#333;">
    <h3>ğŸŒŸ å¤©é¸ä¹‹äººï¼</h3>
    <p>è«‹è¼¸å…¥ä¸‹ä¸€å€‹é–‹çè™Ÿç¢¼ (1-25)ï¼š</p>
    <input type="number" id="lucky-num-input" min="1" max="25" />
    <button onclick="submitLuckyChoice()" style="width:100%;">é€å‡ºè™Ÿç¢¼</button>
  </div>
</div>

<script>
/* =========================
   Firebase config (è«‹ç¢ºèªæ˜¯å¦ç‚ºä½ çš„å°ˆæ¡ˆ)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* =========================
   å…¨åŸŸè®Šæ•¸
   ========================= */
let currentUser = null;
let myData = { name: "", board: [], locked: false, boardStr: "", maxConsecutive: 0, version: 0 };
let gameHistory = [];
let adminClickCount = 0;
let adminClickTimer = null;
let rollingInterval = null;
let heartbeatTimer = null;
const ADMIN_PIN = "2025"; // èˆ‡éœ€æ±‚æ›¸ä¸€è‡´çš„ PIN

/* =========================
   ç™»å…¥èˆ‡åˆå§‹åŒ–
   ========================= */
async function handleLogin() {
  const name = document.getElementById('username-input').value.trim();
  if(!name) return alert("è«‹è¼¸å…¥å§“å");
  document.getElementById('btn-login').disabled = true;
  try {
    const userCred = await auth.signInAnonymously();
    currentUser = userCred.user;
    myData.name = name;

    // è®€å–æˆ–å»ºç«‹ players/{uid}
    const docRef = db.collection("players").doc(currentUser.uid);
    const docSnap = await docRef.get();
    if(docSnap.exists) {
      const d = docSnap.data();
      myData.board = d.board || Array.from({length:25},(_,i)=>i+1);
      myData.locked = !!d.locked;
      myData.boardStr = d.boardStr || (myData.board.join(','));
      myData.maxConsecutive = d.maxConsecutive || 0;
      myData.version = d.version || 0;
      myData.name = d.name || myData.name;
      // è‹¥å‰ç«¯è¼¸å…¥çš„ name èˆ‡è³‡æ–™åº«ä¸åŒï¼Œæ›´æ–°é¡¯ç¤ºåç¨±ï¼ˆä½†ä¸è¦†å¯«å…¶ä»–æ¬„ä½ï¼‰
      if(d.name !== myData.name) {
        await docRef.update({ name: myData.name }).catch(()=>{});
      }
    } else {
      // æ–°ç©å®¶ï¼šå»ºç«‹æ–‡ä»¶ï¼ˆä¸ä½¿ç”¨ transactionï¼Œå› ç‚º board_index æœƒåœ¨é–å®šæ™‚å»ºç«‹ï¼‰
      myData.board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
      myData.boardStr = myData.board.join(',');
      await docRef.set({
        name: myData.name,
        board: myData.board,
        boardStr: myData.boardStr,
        locked: false,
        maxConsecutive: 0,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        version: 1
      });
      myData.version = 1;
    }

    document.getElementById('display-name').innerText = myData.name;
    switchPage('page-game');
    startListeners();
    renderBoard();

    // å¿ƒè·³ï¼šæ¯ 15 ç§’æ›´æ–° lastSeenï¼ˆéœ€æ±‚æ›¸ç‚º 15sï¼‰
    if(heartbeatTimer) clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(() => {
      if(currentUser) {
        db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
      }
    }, 15000);

  } catch(e) {
    alert("ç™»å…¥å¤±æ•—: " + (e.message || e));
    document.getElementById('btn-login').disabled = false;
  }
}

/* =========================
   ç›£è½å™¨èˆ‡å³æ™‚è™•ç†
   ========================= */
function startListeners() {
  // game_state ç›£è½
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.exists ? doc.data() : null;
    if(!data) {
      gameHistory = [];
      document.getElementById('current-draw').innerText = "READY";
      return;
    }

    gameHistory = data.history || [];

    // isRolling å‹•ç•«
    if(data.isRolling) {
      if(!rollingInterval) {
        rollingInterval = setInterval(()=> {
          document.getElementById('current-draw').innerText = Math.floor(Math.random()*25)+1;
        }, 80);
      }
    } else {
      if(rollingInterval) {
        clearInterval(rollingInterval);
        rollingInterval = null;
      }
      document.getElementById('current-draw').innerText = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
      renderBoard();
    }

    // è‹¥ç©å®¶å·²é–å®šï¼Œè¨ˆç®— maxConsecutive ä¸¦å›å¯«ï¼ˆéé˜»å¡ï¼‰
    if(currentUser && myData.locked) {
      try {
        const maxLen = calculateMaxConsecutive(myData.board, gameHistory);
        if(maxLen !== myData.maxConsecutive) {
          myData.maxConsecutive = maxLen;
          db.collection("players").doc(currentUser.uid).update({ maxConsecutive: maxLen }).catch(()=>{});
        }
      } catch(e) { /* å¿½ç•¥è¨ˆç®—éŒ¯èª¤ */ }
    }

    // é¡¯ç¤º lucky modalï¼ˆåå­—å®Œå…¨æ¯”å°ä¸”ç©å®¶å·²é–å®šä¸”é isRollingï¼‰
    if(myData.name && data.luckyUser && data.luckyUser === myData.name && myData.locked && !data.isRolling) {
      document.getElementById('lucky-modal').style.display = 'flex';
    } else {
      document.getElementById('lucky-modal').style.display = 'none';
    }
  });

  // pending_choices ç›£è½ï¼ˆç®¡ç†ç«¯æœƒé¡¯ç¤ºï¼‰
  db.collection("pending_choices").onSnapshot(snap => {
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    document.getElementById('admin-pending-area').style.display = list.length ? 'block' : 'none';
    document.getElementById('pending-list').innerHTML = list.map(p => {
      return `<div class="pending-item"><div style="flex:1;color:#fff">${escapeHtml(p.playerName)}: ${p.number}</div>
        <div><button style="background:#27ae60;color:#fff;padding:6px;border-radius:6px;" onclick="approveLucky(${p.number},'${p.id}')">ç¢ºèª</button></div>
        <div><button style="background:#c0392b;color:#fff;padding:6px;border-radius:6px;" onclick="rejectPending('${p.id}')">æ‹’çµ•</button></div>
      </div>`;
    }).join('');
  });

  // admin: game_state history é¡¯ç¤º
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const h = doc.exists ? (doc.data().history || []) : [];
    document.getElementById('admin-history').innerText = h.join(', ');
  });

  // admin: players çµ±è¨ˆï¼ˆç°¡å–®ç¤ºç¯„ï¼‰
  db.collection("players").onSnapshot(snap => {
    const counts = [0,0,0,0,0,0]; // index = consecutive length
    snap.docs.forEach(d => {
      const v = d.data().maxConsecutive || 0;
      if(v >=0 && v <=5) counts[v]++;
    });
    document.getElementById('stats-area').innerHTML = 'é€£çºŒå‘½ä¸­åˆ†ä½ˆ: ' + counts.map((c,i)=>`${i}:${c}`).join(' | ');
  });
}

/* =========================
   UI èˆ‡ç›¤é¢æ¸²æŸ“
   ========================= */
function renderBoard() {
  const grid = document.getElementById('bingo-grid');
  grid.innerHTML = "";
  if(!myData.board || myData.board.length !== 25) {
    // è‹¥ board ä¸å®Œæ•´ï¼Œå…ˆç”¢ç”Ÿä¸€çµ„
    myData.board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    myData.boardStr = myData.board.join(',');
  }
  myData.board.forEach(num => {
    const div = document.createElement('div');
    const selected = gameHistory.includes(num);
    div.className = 'cell' + (selected ? ' selected' : '');
    div.innerText = num;
    grid.appendChild(div);
  });

  document.getElementById('setup-controls').style.display = myData.locked ? 'none' : 'flex';
  if(myData.locked) {
    document.getElementById('status-text').innerText = "ç›¤é¢å·²é–å®šï¼Œç¥ä¸­çï¼";
    document.getElementById('status-text').style.color = "var(--primary)";
  } else {
    document.getElementById('status-text').innerText = "è«‹å…ˆé–å®šè™Ÿç¢¼";
    document.getElementById('status-text').style.color = "var(--success)";
  }
}

/* ç”¢ç”Ÿæ–°ç›¤ */
function generateBoard() {
  myData.board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
  myData.boardStr = myData.board.join(',');
  renderBoard();
}

/* =========================
   é–å®šç›¤é¢ï¼ˆä½¿ç”¨ Transaction æª¢æŸ¥å”¯ä¸€æ€§ï¼‰
   ========================= */
async function lockBoard() {
  if(!currentUser) return alert("è«‹å…ˆç™»å…¥");
  if(!confirm("é–å®šå¾Œä¸å¯æ›´æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;

  const bStr = myData.board.join(',');
  const boardIndexRef = db.collection("board_index").doc(encodeKey(bStr));
  const playerRef = db.collection("players").doc(currentUser.uid);
  const auditRef = db.collection("audit_logs").doc();

  try {
    await db.runTransaction(async tx => {
      const idxSnap = await tx.get(boardIndexRef);
      if(idxSnap.exists) {
        throw new Error("ç›¤é¢é‡è¤‡");
      }
      // 1) å»ºç«‹ board_index
      tx.set(boardIndexRef, { uid: currentUser.uid, boardStr: bStr, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      // 2) æ›´æ–° players docï¼ˆåŒ…å« boardStr èˆ‡ lockedï¼‰
      const playerSnap = await tx.get(playerRef);
      const newVersion = (playerSnap.exists && playerSnap.data().version) ? playerSnap.data().version + 1 : 1;
      tx.update(playerRef, {
        board: myData.board,
        boardStr: bStr,
        locked: true,
        version: newVersion,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
      // 3) å¯©è¨ˆæ—¥èªŒ
      tx.set(auditRef, {
        action: "lock_board",
        detail: { uid: currentUser.uid, name: myData.name, boardStr: bStr },
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    myData.locked = true;
    myData.boardStr = bStr;
    renderBoard();
    alert("é–å®šæˆåŠŸ");
  } catch(e) {
    if(e.message === "ç›¤é¢é‡è¤‡") {
      alert("ç›¤é¢é‡è¤‡ï¼Œè«‹é‡æ–°æ›è™Ÿ");
    } else {
      alert("é–å®šå¤±æ•—: " + (e.message || e));
    }
  }
}

/* =========================
   å¹¸é‹å…’é€å‡ºè™Ÿç¢¼ï¼ˆç©å®¶ç«¯ï¼‰
   ========================= */
async function submitLuckyChoice() {
  if(!currentUser) return alert("è«‹å…ˆç™»å…¥");
  const num = parseInt(document.getElementById('lucky-num-input').value);
  if(isNaN(num) || num < 1 || num > 25) return alert("è«‹è¼¸å…¥ 1-25 çš„è™Ÿç¢¼");
  if(gameHistory.includes(num)) return alert("è™Ÿç¢¼å·²é–‹é");

  try {
    await db.collection("pending_choices").doc(currentUser.uid).set({
      playerName: myData.name,
      number: num,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    // å¯©è¨ˆæ—¥èªŒï¼ˆé transactionï¼‰
    db.collection("audit_logs").add({
      action: "submit_pending_choice",
      detail: { uid: currentUser.uid, name: myData.name, number: num },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(()=>{});
    alert("å·²é€å‡ºï¼Œç­‰å¾…é–‹ç");
    document.getElementById('lucky-modal').style.display = 'none';
  } catch(e) {
    alert("é€å‡ºå¤±æ•—: " + (e.message || e));
  }
}

/* ç®¡ç†ç«¯æ‹’çµ• pending */
async function rejectPending(id) {
  if(!confirm("ç¢ºå®šè¦æ‹’çµ•æ­¤é¸è™Ÿï¼Ÿ")) return;
  try {
    await db.collection("pending_choices").doc(id).delete();
    db.collection("audit_logs").add({
      action: "reject_pending_choice",
      detail: { id },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(()=>{});
  } catch(e) { alert("æ‹’çµ•å¤±æ•—"); }
}

/* =========================
   ç®¡ç†ç«¯ï¼šå¯©æ ¸ pending_choicesï¼ˆä½¿ç”¨ Transaction æª¢æŸ¥æ˜¯å¦å·²é–‹éï¼‰
   ========================= */
async function approveLucky(num, pendingId) {
  if(!confirm("ç¢ºèªè¦æŠŠ " + num + " å¯«å…¥é–‹çç´€éŒ„ï¼Ÿ")) return;
  const gameRef = db.collection("game_state").doc("current_game");
  const pendingRef = db.collection("pending_choices").doc(pendingId);
  const auditRef = db.collection("audit_logs").doc();

  try {
    await db.runTransaction(async tx => {
      const gameSnap = await tx.get(gameRef);
      const history = gameSnap.exists ? (gameSnap.data().history || []) : [];
      if(history.includes(num)) throw new Error("already_drawn");
      // push number ä¸¦æ¸…ç©º luckyUser
      tx.update(gameRef, {
        history: firebase.firestore.FieldValue.arrayUnion(num),
        luckyUser: ""
      });
      // åˆªé™¤ pending
      tx.delete(pendingRef);
      // å¯©è¨ˆæ—¥èªŒ
      tx.set(auditRef, {
        action: "approve_pending_choice",
        detail: { number: num, pendingId },
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    alert("å·²ç¢ºèªä¸¦å¯«å…¥é–‹çç´€éŒ„");
  } catch(e) {
    if(e.message === "already_drawn") {
      alert("è©²è™Ÿç¢¼å·²è¢«å…¶ä»–äººå…ˆé–‹å‡ºï¼Œæ“ä½œå–æ¶ˆ");
      // å˜—è©¦åˆªé™¤ pendingï¼ˆè‹¥å­˜åœ¨ï¼‰
      db.collection("pending_choices").doc(pendingId).delete().catch(()=>{});
    } else {
      alert("å¯©æ ¸å¤±æ•—: " + (e.message || e));
    }
  }
}

/* =========================
   æŠ½è™Ÿï¼ˆç®¡ç†ç«¯ï¼‰
   ========================= */
async function drawNumber() {
  const ref = db.collection("game_state").doc("current_game");
  const auditRef = db.collection("audit_logs").doc();

  try {
    const snap = await ref.get();
    const h = snap.exists ? (snap.data().history || []) : [];
    const avail = Array.from({length:25},(_,i)=>i+1).filter(n=>!h.includes(n));
    if(avail.length === 0) return alert("æ‰€æœ‰è™Ÿç¢¼å·²é–‹å®Œ");
    const newNum = avail[Math.floor(Math.random()*avail.length)];

    // set isRolling true -> wait -> push number (transaction not strictly necessary here but we use update)
    await ref.update({ isRolling: true });
    // å¯©è¨ˆï¼šè¨˜éŒ„é–‹å§‹æŠ½è™Ÿ
    await db.collection("audit_logs").add({
      action: "start_draw",
      detail: { newNum, triggeredBy: "admin" },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    setTimeout(async () => {
      try {
        await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(newNum), isRolling: false, luckyUser: "" });
        await db.collection("audit_logs").add({
          action: "draw_number",
          detail: { number: newNum },
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch(e) {
        console.error("å¯«å…¥é–‹çå¤±æ•—", e);
      }
    }, 3000);
  } catch(e) {
    alert("æŠ½è™Ÿå¤±æ•—: " + (e.message || e));
  }
}

/* =========================
   æŠ½å¹¸é‹å…’ï¼ˆç®¡ç†ç«¯ï¼‰
   ç¯©é¸ locked=true ä¸” maxConsecutive æœ€å°çš„å‰ 15 å
   ========================= */
async function pickLuckyPlayer() {
  try {
    const snap = await db.collection("players").where("locked","==",true).get();
    const players = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
    if(players.length === 0) return alert("å°šç„¡ç©å®¶é–å®šç›¤é¢");

    // ä¾ maxConsecutive æ’åºï¼ˆå°åˆ°å¤§ï¼‰ï¼Œå–å‰ 15 å
    players.sort((a,b) => (a.maxConsecutive || 0) - (b.maxConsecutive || 0));
    const candidates = players.slice(0, Math.min(15, players.length));
    const lucky = candidates[Math.floor(Math.random()*candidates.length)];

    await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name || lucky.uid });
    await db.collection("audit_logs").add({
      action: "pick_lucky_player",
      detail: { uid: lucky.uid, name: lucky.name },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("å·²é¸å‡ºå¹¸é‹å€™é¸äºº: " + (lucky.name || lucky.uid));
  } catch(e) {
    alert("æŠ½å¹¸é‹å…’å¤±æ•—: " + (e.message || e));
  }
}

/* =========================
   å·¥å…·å‡½å¼ï¼šè¨ˆç®— maxConsecutive
   ========================= */
function calculateMaxConsecutive(board, history) {
  // å»º 5x5
  const grid = [];
  for(let i=0;i<5;i++) grid[i] = board.slice(i*5, i*5+5);

  let maxLen = 0;
  // æ©«
  for(let r=0;r<5;r++) maxLen = Math.max(maxLen, longestStreak(grid[r], history));
  // ç›´
  for(let c=0;c<5;c++) {
    const col = [];
    for(let r=0;r<5;r++) col.push(grid[r][c]);
    maxLen = Math.max(maxLen, longestStreak(col, history));
  }
  // æ–œ
  const diag1 = [], diag2 = [];
  for(let i=0;i<5;i++) { diag1.push(grid[i][i]); diag2.push(grid[i][4-i]); }
  maxLen = Math.max(maxLen, longestStreak(diag1, history));
  maxLen = Math.max(maxLen, longestStreak(diag2, history));

  return maxLen;
}
function longestStreak(line, history) {
  let streak = 0, maxStreak = 0;
  for(const num of line) {
    if(history.includes(num)) { streak++; maxStreak = Math.max(maxStreak, streak); }
    else streak = 0;
  }
  return maxStreak;
}

/* =========================
   ç®¡ç†è€…éš±è—å…¥å£ï¼ˆ3 ç§’å…§ 5 æ¬¡é»æ“Šï¼‰
   ========================= */
function handleAdminClick() {
  adminClickCount++;
  if(adminClickTimer) clearTimeout(adminClickTimer);
  adminClickTimer = setTimeout(()=> { adminClickCount = 0; }, 3000); // 3 ç§’å…§é‡ç½®
  if(adminClickCount >= 5) {
    adminClickCount = 0;
    if(prompt("è«‹è¼¸å…¥ç®¡ç† PINï¼ˆæ•¸å­—ï¼‰:") === ADMIN_PIN) {
      startAdmin();
    } else {
      alert("PIN éŒ¯èª¤");
    }
  }
}

/* é€²å…¥ç®¡ç†é é¢ */
function startAdmin() {
  switchPage('page-admin');
  // ç›£è½å·²åœ¨ startListeners ä¸­è¨»å†Š
}

/* =========================
   å°å·¥å…·ï¼šç·¨ç¢¼ keyã€escapeHtmlã€switchPage
   ========================= */
function encodeKey(s) {
  // boardStr å¯èƒ½åŒ…å«é€—è™Ÿï¼Œä½¿ç”¨ encodeURIComponent ä»¥é¿å…éæ³• doc id
  return encodeURIComponent(s);
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}
function switchPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* =========================
   å°ä¿®æ­£ï¼šé¿å…æœªç™»å…¥æ™‚å‘¼å«
   ========================= */
auth.onAuthStateChanged(user => {
  currentUser = user || null;
  if(!user) {
    // è‹¥ç™»å‡ºï¼Œå›åˆ° login
    switchPage('page-login');
    if(heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; }
  }
});

/* =========================
   é˜²æ­¢é é¢é—œé–‰æ™‚éºç•™ interval
   ========================= */
window.addEventListener('beforeunload', () => {
  if(rollingInterval) clearInterval(rollingInterval);
  if(heartbeatTimer) clearInterval(heartbeatTimer);
});
</script>

</body>
</html>
