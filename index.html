<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.1</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --primary:#b71c1c;
  --accent:#ffb300;
  --bg:#f4f6f8;
  --card:#fff;
  --muted:#6b7280;
  --success:#2e7d32;
  --danger:#c62828;
  --shadow:0 6px 18px rgba(16,24,40,0.06);
  --radius:12px;
  --base-font:16px;
}

/* å…¨å±€é‡è¨­èˆ‡å¯è®€æ€§å„ªåŒ– */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, "Noto Sans TC", "Microsoft JhengHei", system-ui;
  background:var(--bg);
  color:#111;
  font-size:var(--base-font);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.35;
}

/* å®¹å™¨æ”¹ç‚ºæµå¼å¯¬åº¦ä¸¦ä¿ç•™æœ€å¤§å¯¬åº¦ */
.container{
  width:calc(100% - 36px);
  max-width:980px;
  margin:18px auto;
  padding:18px;
}

/* æ¨™é ­èˆ‡ä½¿ç”¨è€…è³‡è¨Š */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
  flex-wrap:wrap;
}

.title{
  font-size:1.25rem;
  color:var(--primary);
  cursor:pointer;
  user-select:none;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:8px;
}

/* ä½¿ç”¨è€…è³‡è¨Šç½®æ–¼å³å´ï¼Œæ–¼çª„è¢å¹•æ›è¡Œç½®åº• */
.user-info{
  font-weight:600;
  color:var(--muted);
  font-size:0.95rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:50%;
}

/* å¡ç‰‡æ¨£å¼ */
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:12px;
}

/* éš±è—é¡åˆ¥ */
.hidden{display:none}

/* æŒ‰éˆ•èª¿æ•´ç‚ºè§¸æ§å‹å¥½å¤§å° */
.btn{
  padding:12px 14px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
  font-size:0.95rem;
  min-height:44px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.btn.primary{background:var(--primary);color:#fff}
.btn.ghost{background:#f3f4f6;color:#111;border:1px solid #e6e9ee}
.btn.danger{background:var(--danger);color:#fff}

/* çµ±è¨ˆæ ¼å­æ”¹ç‚ºè‡ªé©æ‡‰ */
.stat-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;
}

.stat-box{
  background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);
  padding:12px;
  border-radius:10px;
  text-align:center;
  min-height:64px;
}

.stat-val{
  font-weight:800;
  color:var(--accent);
  display:block;
  font-size:1.1rem;
}

/* æ—¥èªŒå€å¡Š */
.status-log{
  max-height:180px;
  overflow:auto;
  padding:10px;
  border-radius:8px;
  background:#0f172a;
  color:#fff;
  font-size:0.85rem;
}

/* æ­·å²çƒ */
.history-ball{
  display:inline-block;
  width:32px;
  height:32px;
  line-height:32px;
  background:var(--primary);
  color:white;
  border-radius:50%;
  margin:3px;
  text-align:center;
  font-weight:bold;
  font-size:0.85rem;
}

/* è³“æœæ ¼å­å®¹å™¨ï¼šå¯¬åº¦è‡ªé©æ‡‰ï¼Œæ ¼å­å¤§å°ä»¥å¯¬åº¦æ±ºå®š */
.grid{
  display:grid;
  gap:8px;
  max-width:100%;
  margin:10px auto;
  grid-template-columns:repeat(5,1fr);
}

/* å–®æ ¼æ¨£å¼ */
.cell{
  aspect-ratio:1;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fbfdff;
  border-radius:10px;
  border:1px solid #eef2f7;
  font-weight:800;
  font-size:1.2rem;
  user-select:none;
  transition:transform .12s ease, background .12s ease;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
}

.cell.selected{background:#fff7e6;color:#b25600}
.cell.bingo-line{background:var(--success);color:#fff;animation:pulse 900ms infinite}

@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

/* Modal è¦†è“‹å±¤æ”¹ç‚ºå½ˆæ€§ç½®ä¸­ï¼ŒJS æ§åˆ¶é¡¯ç¤ºæ™‚æœƒæ”¹è®Š display */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
  padding:20px;
}

.modal-content{
  background:white;
  padding:20px;
  border-radius:16px;
  width:100%;
  max-width:420px;
}

/* å°å…ƒä»¶å¾®èª¿ */
.header .title{font-size:1.15rem}
#draw-display{font-variant-numeric:tabular-nums}
#bingo-status{height:26px;color:var(--success);font-weight:700}
#setup-btns{margin-top:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* ç®¡ç†é¢æ¿çµ±è¨ˆå€å¡Šåœ¨å°è¢å¹•ä¹Ÿèƒ½æ›è¡Œ */
#view-admin .stat-box{padding:10px}

/* èª¿æ•´è¼¸å…¥æ¬„èˆ‡æŒ‰éˆ•åœ¨çª„è¢å¹•çš„å¯¬åº¦ */
input[type="text"], input[type="email"], input[type="password"]{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid #ddd;
  font-size:0.95rem;
}

/* å°è¢å¹•èˆ‡ä¸­ç­‰è¢å¹•çš„éŸ¿æ‡‰å¼è¦å‰‡ */
@media (max-width:1024px){
  :root{ --base-font:15px; }
  .title{font-size:1.1rem}
  .user-info{max-width:45%}
  .cell{font-size:1.05rem}
}

/* å¹³æ¿èˆ‡å°ç­†é›» */
@media (max-width:800px){
  :root{ --base-font:15px; }
  .grid{grid-template-columns:repeat(4,1fr)}
  .cell{font-size:1.05rem}
  .user-info{max-width:40%}
  .modal-content{max-width:360px}
}

/* æ‰‹æ©Ÿç›´å‘ */
@media (max-width:520px){
  :root{ --base-font:14px; }
  .header{align-items:flex-start}
  .user-info{max-width:100%;order:2;font-size:0.9rem}
  .title{order:1;font-size:1rem}
  .stat-grid{grid-template-columns:repeat(2,1fr)}
  .grid{grid-template-columns:repeat(3,1fr); gap:6px}
  .cell{font-size:1rem;border-radius:8px}
  .btn{font-size:0.95rem;padding:10px 12px;min-height:40px}
  .history-ball{width:28px;height:28px;line-height:28px;font-size:0.8rem}
  .status-log{font-size:0.8rem;max-height:140px}
  #setup-btns{justify-content:stretch}
}

/* æ¥µå°è£ç½®æˆ–çª„è¦–çª— */
@media (max-width:360px){
  :root{ --base-font:13px; }
  .grid{grid-template-columns:repeat(2,1fr)}
  .cell{font-size:0.95rem}
  .stat-grid{grid-template-columns:1fr}
  .user-info{font-size:0.85rem}
}

/* å¯é¸ï¼šè®“è¢«é¸æ ¼å­åœ¨è§¸æ§æ™‚æœ‰æ›´æ˜é¡¯å›é¥‹ */
.cell:active{transform:scale(0.995)}
</style>
</head>
<body>
<div id="admin-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd">
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
    <button class="btn ghost" style="width:100%;margin-top:8px;" onclick="closeAdminModal()">å–æ¶ˆ</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ± v2.9.1 auto fit</div>
    <div id="user-info" class="user-info">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="view-login" class="card hidden">
    <h3>ç©å®¶ç™»å…¥</h3>
    <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd" />
    <button class="btn primary" style="width:100%;margin-top:12px" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between">
        <div>
          <div style="font-weight:700" id="player-name-display"></div>
          <div id="lock-status-label" style="font-size:0.8rem;color:var(--muted)"></div>
        </div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>

      <div style="text-align:center;margin-top:10px">
        <div id="draw-display" style="font-size:4rem;font-weight:800;color:var(--primary);height:100px;line-height:100px">READY</div>
        <div id="bingo-status" style="height:26px;color:var(--success);font-weight:700"></div>
        <div id="bingo-grid" class="grid"></div>
        <div id="setup-btns" style="margin-top:15px;display:flex;gap:10px;justify-content:center">
          <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">ç®¡ç†è€…æ§åˆ¶å° <span id="admin-lock-indicator" style="font-size:0.7rem;padding:2px 6px;background:#eee;border-radius:4px">æœªé–å®š</span></div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>

      <div class="stat-grid" style="margin-top:12px">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><span>åœ¨ç·š</span></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><span>ç¸½äººæ•¸</span></div>
      </div>

      <div style="display:flex;gap:5px;margin-top:10px;flex-wrap:wrap">
        <div class="stat-box" style="flex:1"><span id="cnt-5" class="stat-val">0</span><span style="font-size:0.7rem">5æ ¼é€£ç·š</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-4" class="stat-val">0</span><span style="font-size:0.7rem">4æ ¼é€£ç·š</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-3" class="stat-val">0</span><span style="font-size:0.7rem">3æ ¼é€£ç·š</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-2" class="stat-val">0</span><span style="font-size:0.7rem">2æ ¼é€£ç·š</span></div>
      </div>

      <div style="margin-top:10px;text-align:center;background:#fff8e1;padding:10px;border-radius:10px">
        <div style="font-size:0.8rem">æœ€æ–°é–‹çè™Ÿ / å·²é–‹æ¸…å–®</div>
        <div id="admin-sync-num" style="font-size:2.2rem;font-weight:800;color:var(--primary)">--</div>
        <div id="drawn-history-list" style="margin-top:5px;border-top:1px dashed #ddd;padding-top:5px"></div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ (è‡ªå‹•é–å®š)</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶å…¨å“¡é–å®š</button>
        <button class="btn" style="background:var(--accent)" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
        <button class="btn danger" onclick="removeAllPlayers()">ğŸ§¹ ç§»é™¤æ‰€æœ‰ä½¿ç”¨è€…</button>
        <button class="btn ghost" style="grid-column: span 2; border:1px solid #ddd" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²ç‹€æ…‹ (æ¢å¾©æ›è™Ÿ)</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:700;font-size:0.9rem">ğŸ“¢ è³“æœèˆ‡é¸è™Ÿé€šçŸ¥</div>
        <div id="pending-choices" style="max-height:100px;overflow:auto;font-size:0.85rem;color:var(--primary)"></div>
        <div id="bingo-alerts" style="max-height:100px;overflow:auto;font-size:0.85rem;color:var(--success)"></div>
      </div>

      <div class="card"><div id="status-log" class="status-log"></div></div>
    </div>
  </div>
</div>

<script>
// --- Firebase è¨­å®š (è«‹ç¢ºä¿èˆ‡æ‚¨çš„å°ˆæ¡ˆä¸€è‡´) ---
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;

function logStatus(msg) {
  const el = document.getElementById('status-log');
  if(!el) return;
  el.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
}

function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
}

function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ"); }
    else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){
    myData = snap.data();
  } else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  document.getElementById('player-name-display').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
    gameHistory = data.history || [];
    isAllLockedGlobal = data.isAllLocked || false;
    if(document.getElementById('admin-lock-indicator')) {
      document.getElementById('admin-lock-indicator').innerText = isAllLockedGlobal ? "âœ… å·²é–å®š" : "ğŸ”“ æœªé–å®š";
      document.getElementById('admin-lock-indicator').style.background = isAllLockedGlobal ? "#c8e6c9" : "#eee";
    }
    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="history-ball">${n}</span>`).join('') || "ç­‰å¾…é–‹è™Ÿ";
    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const r = Math.floor(Math.random()*25)+1;
        document.getElementById('draw-display').innerText = r;
        if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = r;
      }, 80);
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      document.getElementById('draw-display').innerText = last;
      if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = last;
      renderGrid();
      if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    // --- å¹¸é‹å…’åŠŸèƒ½ä¿®æ­£ï¼šå¢åŠ é©—è­‰é‚è¼¯ ---
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
      let valid = false;
      let num;
      while(!valid) {
        const input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹è™Ÿç¢¼ (1-25)ï¼š\n(æ³¨æ„ï¼šä¸èƒ½é‡è¤‡æŠ½éçš„è™Ÿç¢¼)`);
        if(input === null) break; // ç©å®¶æŒ‰å–æ¶ˆ
        num = parseInt(input);
        if(isNaN(num) || num < 1 || num > 25) {
          alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥ 1 åˆ° 25 ä¹‹é–“çš„æ•¸å­—ã€‚");
        } else if(gameHistory.includes(num)) {
          alert(`${num} å·²ç¶“è¢«æŠ½éå›‰ï¼Œè«‹æ›ä¸€å€‹ã€‚`);
        } else {
          valid = true;
        }
      }
      if(valid) {
        db.collection("pending_choices").doc(currentUser.uid).set({
          playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection("game_state").doc("current_game").update({ luckyUser: "" });
      }
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    document.getElementById('count-total').innerText = allPlayersCache.length;
    if(currentUser.uid !== ALLOWED_UID){
      const me = allPlayersCache.find(p => p.id === currentUser.uid);
      if(me && me.locked !== myData.locked) {
        myData.locked = me.locked;
        renderGrid();
      }
    }
  });

  if(currentUser.uid === ALLOWED_UID){
    db.collection("pending_choices").orderBy("timestamp","desc").onSnapshot(snap => {
      document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div>â“ ${d.data().playerName} é¸äº† ${d.data().number} <button onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
    });
    db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
      document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ <b>${d.data().name}</b> è³“æœäº†ï¼</div>`).join('');
    });
  }
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  const lines = [
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];
  let winLineCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
      line.forEach(i=>winIdx.add(i));
      winLineCount++;
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winLineCount > 0 && myData.locked) {
    document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  }
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
  document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­...";
}

// --- ç®—æ³•ä¿®å¾©ï¼šè¨ˆç®— 12 æ¢ç·šä¸­æœ€é•·çš„ã€Œé€£çºŒå‘½ä¸­ã€æ ¼æ•¸ ---
function calculateMaxConsecutive(board, history) {
  const lines = [
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];
  let globalMax = 0;
  lines.forEach(line => {
    let currentMax = 0;
    let streak = 0;
    line.forEach(index => {
      if(history.includes(board[index])) {
        streak++;
        if(streak > currentMax) currentMax = streak;
      } else {
        streak = 0;
      }
    });
    if(currentMax > globalMax) globalMax = currentMax;
  });
  return globalMax;
}

function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const max = calculateMaxConsecutive(p.board, gameHistory);
    if(max >= 5) counts[5]++;
    else if(max === 4) counts[4]++;
    else if(max === 3) counts[3]++;
    else if(max === 2) counts[2]++;
  });
  document.getElementById('cnt-5').innerText = counts[5];
  document.getElementById('cnt-4').innerText = counts[4];
  document.getElementById('cnt-3').innerText = counts[3];
  document.getElementById('cnt-2').innerText = counts[2];
}

/* å…¶ä»–ç®¡ç†åŠŸèƒ½èˆ‡é‡ç½®é‚è¼¯ (ä¿æŒ v2.9 å„ªåŒ–) */
async function forceLockAll() {
  logStatus("æ­£åœ¨åŸ·è¡Œå…¨å“¡é–å®š...");
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}

async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll();
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false, luckyUser: "" });
  }, 1200);
}

async function removeAllPlayers() {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…å—ï¼Ÿ")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
  await batch.commit();
  location.reload();
}

async function handleReset(){
  if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿé€™æœƒæ¢å¾©æ‰€æœ‰äººçš„æ›è™ŸåŠŸèƒ½ã€‚")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  const colls = ["pending_choices","bingo_events"];
  for(const c of colls){
    const s = await db.collection(c).get();
    s.forEach(d=>batch.delete(d.ref));
  }
  batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
  await batch.commit();
  location.reload();
}

async function confirmLucky(id, num) {
  await db.collection("game_state").doc("current_game").update({ history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
  await db.collection("pending_choices").doc(id).delete();
}

async function pickLucky() {
  if(allPlayersCache.length === 0) return alert("æ²’äººåƒèˆ‡");
  const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
  await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
  alert("å¹¸é‹å…’æ˜¯ï¼š" + lucky);
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }

async function confirmBoard(){
  if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}

function doSignOut(){ auth.signOut(); location.reload(); }

setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
}, 15000);
</script>
</body>
</html>
