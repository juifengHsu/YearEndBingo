<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± (é€£è™Ÿçµ±è¨ˆç‰ˆ)</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root { --primary:#d32f2f; --accent:#ffb300; --bg:#f6f7fb; --card:#ffffff; --success:#2e7d32; --dark:#2c3e50; }
body { margin:0; font-family:system-ui, -apple-system, sans-serif; background:var(--bg); color:#222; }
.container { max-width:1100px; margin:0 auto; padding:15px; }

/* ä½ˆå±€ */
.layout { display:grid; grid-template-columns: 1fr 340px; gap:20px; }
@media (max-width: 850px) { .layout { grid-template-columns: 1fr; } }

/* éŠæˆ²æ¿ */
.player-card { background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); text-align:center; min-height: 400px; }
.big-number { font-size:5rem; font-weight:800; color:var(--primary); height:110px; line-height:110px; margin:10px 0; }

.grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:6px; max-width:400px; margin:0 auto; }
.cell { aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border:1px solid #eee; border-radius:8px; font-size:1.3rem; font-weight:bold; }
.cell.selected { background:#fff3e0; color:#e65100; }
/* é€£ç·šæ¨™ç¤º */
.cell.bingo-line { background:var(--success) !important; color:white !important; animation:pulse 1s infinite; }

/* ç®¡ç†è€…é¢æ¿ */
.admin-panel { display:flex; flex-direction:column; gap:15px; }
.admin-card { background:var(--dark); color:white; padding:15px; border-radius:12px; }
.stat-group { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
/* æ–°å¢ï¼šé€£ç·šæ•¸çµ±è¨ˆçš„å°æ ¼å­ */
.line-stat-group { display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-bottom:10px; }
.stat-box { background:rgba(255,255,255,0.1); padding:8px 5px; border-radius:8px; text-align:center; }
.stat-val { font-size:1.2rem; font-weight:bold; color:var(--accent); display:block; }
.stat-label { font-size: 0.75rem; opacity: 0.8; }

.bingo-alert-list { background:white; color:#333; border-radius:8px; padding:10px; max-height:200px; overflow-y:auto; }
.alert-item { color:var(--primary); font-weight:bold; padding:4px 0; border-bottom:1px solid #eee; font-size:0.9rem; display:flex; justify-content:space-between; }

button { padding:12px; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; }
button:disabled { background:#ccc; }
input { padding:10px; border:1px solid #ddd; border-radius:8px; width:100%; margin-bottom:10px; box-sizing:border-box; }

@keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.03)} 100% {transform:scale(1)} }
</style>
</head>
<body>

<div class="container">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
<h1 onclick="triggerAdmin()" style="margin:0; color:var(--primary); cursor:pointer;">ğŸ§§ 2025 è³“æœç³»çµ± 006</h1>
<div id="user-info" style="font-weight:bold;"></div>
</div>

<div class="layout">
<div class="player-card">
<div id="login-form">
<input type="text" id="player-name" placeholder="è¼¸å…¥çœŸå¯¦å§“åé€²å ´">
<button onclick="doPlayerLogin()" style="width:100%">é€²å…¥éŠæˆ²</button>
</div>

<div id="game-ui" style="display:none;">
<div id="draw-display" class="big-number">READY</div>
<div id="bingo-status" style="height:25px; font-weight:bold; color:var(--success); margin-bottom:10px;"></div>
<div id="bingo-grid" class="grid"></div>

<div id="setup-btns" style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
<button onclick="reRollBoard()" style="background:#6c757d;">ğŸ² æ›è™Ÿç¢¼</button>
<button onclick="confirmBoard()" style="background:var(--success);">ğŸ”’ é–å®šç›¤é¢</button>
</div>
</div>
</div>

<div id="admin-sidebar" class="admin-panel" style="display:none;">
<div class="admin-card">
<div class="stat-group">
<div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="stat-label">åœ¨ç·š</span></div>
<div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="stat-label">ç¸½äººæ•¸</span></div>
</div>

<div style="font-size:0.8rem; margin-bottom:5px; opacity:0.8;">æœ€å¤§ç›¸é„°é€£è™Ÿäººæ•¸ (åˆ†ä½ˆ)ï¼š</div>
<div class="line-stat-group">
<div class="stat-box"><span id="cnt-5" class="stat-val">0</span><span class="stat-label">5+é€£</span></div>
<div class="stat-box"><span id="cnt-4" class="stat-val">0</span><span class="stat-label">4é€£</span></div>
<div class="stat-box"><span id="cnt-3" class="stat-val">0</span><span class="stat-label">3é€£</span></div>
<div class="stat-box"><span id="cnt-2" class="stat-val">0</span><span class="stat-label">2é€£</span></div>
</div>

<div style="text-align:center; margin:10px 0; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
<div style="font-size:0.8rem; opacity:0.7;">åŒæ­¥é–‹çè™Ÿ</div>
<div id="admin-sync-num" style="font-size:2.5rem; font-weight:bold; color:var(--accent);">--</div>
</div>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
<button onclick="drawNewNumber()" style="background:#e67e22;">ğŸ² æŠ½è™Ÿ</button>
<button onclick="pickLucky()" style="background:var(--accent); color:#333;">ğŸŒŸ å¹¸é‹å…’</button>
</div>
</div>

<div class="admin-card">
<div style="font-size:0.9rem; margin-bottom:8px; font-weight:bold;">ğŸ“¢ æœ€æ–°è³“æœåå–®</div>
<div id="bingo-alerts" class="bingo-alert-list">
<div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>
</div>
</div>

<div class="admin-card" style="background:#444;">
<div style="font-size:0.8rem; margin-bottom:10px;">å¾…æ ¸é¸è™Ÿ: <span id="pending-count">0</span></div>
<div id="pending-choices"></div>
</div>

<button onclick="handleReset()" style="background:#c0392b; width:100%;">âš ï¸ é‡ç½®éŠæˆ²</button>
<button onclick="location.reload()" style="background:#6c757d; width:100%; margin-top:5px; font-size:0.8rem;">é€€å‡ºä¸¦é‡æ•´</button>
</div>
</div>
</div>

<div id="admin-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:999;">
<div style="background:white; padding:25px; border-radius:15px; width:300px;">
<h3>ç®¡ç†å“¡ç™»å…¥</h3>
<input type="email" id="admin-email" placeholder="Email">
<input type="password" id="admin-pwd" placeholder="Password">
<button onclick="doAdminLogin()" style="width:100%;">ç™»å…¥</button>
<button onclick="document.getElementById('admin-modal').style.display='none'" style="width:100%; margin-top:5px; background:#999;">å–æ¶ˆ</button>
</div>
</div>

<script>
// --- åˆå§‹åŒ– Firebase ---
const firebaseConfig = {
apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
authDomain: "yearendbingo.firebaseapp.com",
projectId: "yearendbingo",
storageBucket: "yearendbingo.firebasestorage.app",
messagingSenderId: "563353011392",
appId: "1:563353011392:web:717976a176bc22a04d5925",
measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = []; // ç”¨æ–¼è¨ˆç®—æ•¸æ“š
let rollingTimer = null;
const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];

// --- ç™»å…¥é‚è¼¯ ---
async function doPlayerLogin() {
const name = document.getElementById('player-name').value.trim();
if(!name) return alert("è«‹è¼¸å…¥å§“å");
const cred = await auth.signInAnonymously();
currentUser = cred.user;

const snap = await db.collection("players").doc(currentUser.uid).get();
if(snap.exists) {
myData = snap.data();
} else {
myData = { name: name, board: shuffleArray(), locked: false };
await db.collection("players").doc(currentUser.uid).set(myData);
}

document.getElementById('login-form').style.display = 'none';
document.getElementById('game-ui').style.display = 'block';
document.getElementById('user-info').innerText = myData.name;
startApp();
}

function triggerAdmin() {
let count = window.adminClicks || 0;
count++;
window.adminClicks = count;
if(count >= 5) {
document.getElementById('admin-modal').style.display = 'flex';
window.adminClicks = 0;
}
}

async function doAdminLogin() {
const email = document.getElementById('admin-email').value;
const pwd = document.getElementById('admin-pwd').value;
try {
const cred = await auth.signInWithEmailAndPassword(email, pwd);
if(cred.user.uid === ALLOWED_UID) {
document.getElementById('admin-modal').style.display = 'none';
document.getElementById('login-form').style.display = 'none';
document.getElementById('admin-sidebar').style.display = 'flex';
document.getElementById('user-info').innerText = "ç®¡ç†è€…æ¨¡å¼";
startApp();
}
} catch(e) { alert("ç™»å…¥å¤±æ•—"); }
}

// --- æ ¸å¿ƒéŠæˆ²æµç¨‹ ---
function startApp() {
// 1. ç›£è½éŠæˆ²ç‹€æ…‹
db.collection("game_state").doc("current_game").onSnapshot(doc => {
const data = doc.data();
if(!data) return;
gameHistory = data.history || [];

if(data.isRolling) {
if(!rollingTimer) rollingTimer = setInterval(() => {
const rand = Math.floor(Math.random()*25)+1;
document.getElementById('draw-display').innerText = rand;
document.getElementById('admin-sync-num').innerText = rand;
}, 80);
} else {
clearInterval(rollingTimer); rollingTimer = null;
const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
document.getElementById('draw-display').innerText = last;
document.getElementById('admin-sync-num').innerText = last;
renderGrid();
// ç®¡ç†è€…æ›´æ–°çµ±è¨ˆ
if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) updateConnectedStats();
}

// ä¿®æ­£ï¼šæª¢æŸ¥ luckyUser æ˜¯å¦ç‚ºç©º
if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling) {
const num = prompt("ä½ æ˜¯å¹¸é‹å…’ï¼è«‹è¼¸å…¥ 1-25 é–‹çè™Ÿç¢¼ï¼š");
if(num) db.collection("pending_choices").add({ name:myData.name, num: parseInt(num) });
}
});

// 2. ç›£è½åœ¨ç·šç©å®¶ (ç”¨æ–¼è¨ˆç®—åˆ†ä½ˆ)
db.collection("players").onSnapshot(snap => {
const list = snap.docs.map(d => d.data());
allPlayersCache = list; 

document.getElementById('count-total').innerText = list.length;
const now = Date.now();
const online = list.filter(p => p.lastSeen && (now - p.lastSeen.toMillis()) < 30000).length;
document.getElementById('count-online').innerText = online;

if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) updateConnectedStats();
});

// 3. ç®¡ç†è€…å°ˆç”¨
if(auth.currentUser.uid === ALLOWED_UID) {
db.collection("pending_choices").onSnapshot(snap => {
const div = document.getElementById('pending-choices');
div.innerHTML = snap.docs.map(d => {
const p = d.data();
return `<div style="padding:5px; border-bottom:1px solid #555;">${p.name}: ${p.num}
<button onclick="confirmLucky('${d.id}', ${p.num})" style="padding:2px 5px; font-size:0.7rem;">é–‹è™Ÿ</button></div>`;
}).join('');
document.getElementById('pending-count').innerText = snap.size;
});

db.collection("bingo_events").orderBy("timestamp","desc").limit(20).onSnapshot(snap => {
const container = document.getElementById('bingo-alerts');
if(snap.empty) {
container.innerHTML = '<div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>';
return;
}
container.innerHTML = snap.docs.map(d => {
const data = d.data();
const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
return `<div class="alert-item"><span>ğŸ‰ ${data.name}</span> <span style="font-size:0.7rem; color:#666;">${timeStr}</span></div>`;
}).join('');
});
}

setInterval(() => {
if(currentUser && !currentUser.email) {
db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
}
}, 15000);
}

// --- ä»‹é¢æ¸²æŸ“ ---
function renderGrid() {
const grid = document.getElementById('bingo-grid');
grid.innerHTML = "";
const winIdx = new Set();
let winCount = 0;

// è¨ˆç®—é€£ç·š (åƒ…ç”¨æ–¼ç©å®¶ç«¯é¡¯ç¤ºè³“æœç‹€æ…‹)
lines.forEach(line => {
if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
winCount++;
line.forEach(idx => winIdx.add(idx));
}
});

myData.board.forEach((num, i) => {
const div = document.createElement('div');
div.className = 'cell';
if(gameHistory.includes(num)) div.classList.add('selected');
if(winIdx.has(i)) div.classList.add('bingo-line');
div.innerText = num;
grid.appendChild(div);
});

if(winCount > 0) {
document.getElementById('bingo-status').innerText = `å·²é€£æˆ ${winCount} æ¢ç·šï¼`;
if(myData.locked) {
db.collection("bingo_events").doc(currentUser.uid).set({
name: myData.name,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
}
}
document.getElementById('setup-btns').style.display = myData.locked ? 'none' : 'flex';
}

// --- æ–°åŠŸèƒ½ï¼šè¨ˆç®—æœ€å¤§ç›¸é„°å€å¡Š ---
function calculateMaxConnected(board, history) {
// 1. æ‰¾å‡ºæ‰€æœ‰è¢«é¸ä¸­çš„ç´¢å¼•
const marked = new Set();
board.forEach((num, idx) => {
if(history.includes(num)) marked.add(idx);
});

if(marked.size === 0) return 0;

let maxGroupSize = 0;
const visited = new Set();

// 2. éæ­·æ¯ä¸€å€‹æ ¼å­ï¼Œå¦‚æœæ˜¯é¸ä¸­ä¸”æœªè¨ªå•ï¼Œé–‹å§‹æ“´æ•£æœå°‹(BFS)
for(let i=0; i<25; i++) {
if(marked.has(i) && !visited.has(i)) {
let currentGroupSize = 0;
const stack = [i];
visited.add(i);

while(stack.length > 0) {
const curr = stack.pop();
currentGroupSize++;

// æª¢æŸ¥ä¸Šä¸‹å·¦å³é„°å±…
const r = Math.floor(curr / 5);
const c = curr % 5;

// ä¸Š (idx - 5)
if(r > 0) checkNeighbor(curr - 5);
// ä¸‹ (idx + 5)
if(r < 4) checkNeighbor(curr + 5);
// å·¦ (idx - 1)
if(c > 0) checkNeighbor(curr - 1);
// å³ (idx + 1)
if(c < 4) checkNeighbor(curr + 1);
}

if(currentGroupSize > maxGroupSize) maxGroupSize = currentGroupSize;
}
}

function checkNeighbor(targetIdx) {
if(marked.has(targetIdx) && !visited.has(targetIdx)) {
visited.add(targetIdx);
stack.push(targetIdx);
}
}

return maxGroupSize;
}

function updateConnectedStats() {
const counts = { 5:0, 4:0, 3:0, 2:0 };

allPlayersCache.forEach(p => {
if(!p.board || !p.locked) return; // åªç®—é–å®šç©å®¶

const maxConn = calculateMaxConnected(p.board, gameHistory);

if(maxConn >= 5) counts[5]++;
else if(maxConn === 4) counts[4]++;
else if(maxConn === 3) counts[3]++;
else if(maxConn === 2) counts[2]++;
});

document.getElementById('cnt-5').innerText = counts[5];
document.getElementById('cnt-4').innerText = counts[4];
document.getElementById('cnt-3').innerText = counts[3];
document.getElementById('cnt-2').innerText = counts[2];
}

// --- ç®¡ç†è€…åŠŸèƒ½ ---
async function drawNewNumber() {
const ref = db.collection("game_state").doc("current_game");
const snap = await ref.get();
const history = snap.data()?.history || [];
const pool = Array.from({length:25},(_,i)=>i+1).filter(n => !history.includes(n));
if(!pool.length) return alert("å·²æŠ½å®Œ");

await ref.update({ isRolling: true });
setTimeout(async () => {
const pick = pool[Math.floor(Math.random()*pool.length)];
await ref.update({ isRolling: false, history: firebase.firestore.FieldValue.arrayUnion(pick), luckyUser: "" });
}, 2000);
}

async function handleReset() {
if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡åˆªé™¤æ‰€æœ‰ç©å®¶èˆ‡ç´€éŒ„ï¼")) return;
try {
const batch = db.batch();
const ps = await db.collection("players").get(); ps.forEach(d => batch.delete(d.ref));
const pcs = await db.collection("pending_choices").get(); pcs.forEach(d => batch.delete(d.ref));
const bes = await db.collection("bingo_events").get(); bes.forEach(d => batch.delete(d.ref));
batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, luckyUser:"" });
await batch.commit();
alert("æˆåŠŸé‡ç½®ï¼");
location.reload();
} catch(e) { alert("é‡ç½®å¤±æ•—: " + e.message); }
}

async function confirmLucky(id, num) {
await db.collection("game_state").doc("current_game").update({
history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: ""
});
await db.collection("pending_choices").doc(id).delete();
}

async function pickLucky() {
const snap = await db.collection("players").where("locked","==",true).get();
if(snap.empty) return alert("é‚„æ²’æœ‰äººé–å®šç›¤é¢");
const lucky = snap.docs[Math.floor(Math.random()*snap.size)].data().name;
await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
alert("å¤©é¸ä¹‹äººå·²æŠ½ä¸­ï¼š" + lucky);
}

// --- å·¥å…· ---
function shuffleArray() { return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard() { myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard() {
if(!confirm("é–å®šå¾Œä¸èƒ½æ›´æ›è™Ÿç¢¼ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
await db.collection("players").doc(currentUser.uid).update({ locked:true, board: myData.board });
myData.locked = true;
renderGrid();
}
</script>
</body>
</html>
