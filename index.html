<!DOCTYPE html>
<html class="light" lang="zh-Hant">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.1</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f45925",
                        "primary-dark": "#d64010",
                        "background-light": "#f8f6f5",
                        "background-dark": "#221410",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2f1f1a",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "Noto Sans TC", "sans-serif"],
                        "body": ["Spline Sans", "Noto Sans TC", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "1.5rem", "xl": "2rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Spline Sans', 'Noto Sans TC', sans-serif; }
        .bingo-cell {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; font-weight: 700; font-size: 1.25rem;
            transition: all 0.2s; cursor: pointer; background-color: #f4eae7; color: #1c110d;
        }
        .bingo-cell.selected { background-color: #ffb300; color: white; transform: scale(1.05); }
        .bingo-cell.bingo-line { 
            background-color: #f45925; color: white; 
            box-shadow: 0 4px 12px rgba(244, 89, 37, 0.4);
            animation: pulse 900ms infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 999; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#1c110d] dark:text-[#fcf9f8] flex flex-col">

<div id="admin-modal" class="modal-overlay">
    <div class="bg-white dark:bg-surface-dark p-8 rounded-xl w-80 shadow-2xl">
        <h3 class="text-xl font-bold mb-4">ç®¡ç†è€…ç™»å…¥</h3>
        <input id="admin-email" type="email" placeholder="Email" class="w-full p-3 mb-3 rounded-lg border dark:bg-black/20 dark:border-gray-700">
        <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" class="w-full p-3 mb-4 rounded-lg border dark:bg-black/20 dark:border-gray-700">
        <button class="w-full py-3 bg-primary text-white rounded-lg font-bold mb-2" onclick="doAdminLogin()">ç™»å…¥</button>
        <button class="w-full py-3 bg-gray-200 dark:bg-gray-700 rounded-lg font-bold" onclick="closeAdminModal()">å–æ¶ˆ</button>
    </div>
</div>

<header class="sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-[#f4eae7] dark:border-[#3a2822]">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3 cursor-pointer" onclick="triggerAdmin()">
            <div class="size-8 rounded-full bg-primary flex items-center justify-center text-white">
                <span class="material-symbols-outlined text-[20px]">grid_on</span>
            </div>
            <h1 class="text-xl font-bold tracking-tight">2025 è³“æœç³»çµ±</h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="user-info" class="text-sm font-medium text-gray-500">è¼‰å…¥ä¸­...</div>
            <button onclick="doSignOut()" class="px-4 py-1.5 rounded-full text-sm font-medium bg-[#f4eae7] dark:bg-[#3a2822]">ç™»å‡º</button>
        </div>
    </div>
</header>

<main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">
    <div class="mb-8 bg-white dark:bg-surface-dark rounded-xl p-6 shadow-sm border border-[#f4eae7] dark:border-[#3a2822] flex flex-col md:flex-row items-center justify-between gap-6 relative overflow-hidden">
        <div class="flex items-center gap-6 z-10">
            <div class="flex flex-col">
                <span class="text-sm font-medium text-gray-500 uppercase tracking-wider">æœ€æ–°é–‹çè™Ÿ</span>
                <div id="draw-display" class="text-5xl font-black text-primary font-display">READY</div>
            </div>
            <div class="h-12 w-px bg-gray-200 dark:bg-gray-700"></div>
            <div class="flex flex-col">
                <span class="text-sm font-medium text-gray-500 uppercase tracking-wider">é€£ç·šç‹€æ…‹</span>
                <span id="bingo-status" class="text-xl font-bold text-green-500">ç­‰å¾…ä¸­</span>
            </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto z-10">
            <span class="text-xs font-medium text-gray-500 uppercase">æ­·å²ç´€éŒ„</span>
            <div id="drawn-history-list" class="flex gap-2 overflow-x-auto hide-scroll pb-2"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div id="view-player" class="lg:col-span-7 xl:col-span-8">
            <div id="view-login" class="bg-white dark:bg-surface-dark rounded-xl p-8 shadow-lg text-center hidden">
                <h3 class="text-2xl font-bold mb-6">ç©å®¶ç™»å…¥</h3>
                <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" class="w-full max-w-sm p-4 rounded-xl border mb-4 dark:bg-black/20" />
                <button class="w-full max-w-sm py-4 bg-primary text-white rounded-xl font-bold text-lg" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
            </div>

            <div id="player-board-card" class="bg-white dark:bg-surface-dark rounded-xl shadow-lg border border-[#f4eae7] dark:border-[#3a2822] overflow-hidden">
                <div class="bg-primary/5 p-4 border-b flex justify-between items-center">
                    <h2 class="font-bold flex items-center gap-2"><span id="player-name-display"></span> çš„ç›¤é¢</h2>
                    <span id="lock-status-label" class="text-xs font-bold px-2 py-1 rounded bg-white text-primary">è¨­å®šä¸­</span>
                </div>
                <div class="p-6">
                    <div id="bingo-grid" class="grid grid-cols-5 gap-3 max-w-[450px] mx-auto"></div>
                </div>
                <div id="setup-btns" class="p-4 bg-gray-50 dark:bg-black/20 border-t flex gap-4 justify-center">
                    <button class="px-6 py-3 rounded-full bg-white border font-bold text-sm" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
                    <button class="px-6 py-3 rounded-full bg-primary text-white font-bold text-sm shadow-lg" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="lg:col-span-5 xl:col-span-4 flex flex-col gap-6 hidden">
            <div class="bg-[#1c110d] text-white rounded-xl p-6 shadow-xl relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">admin_panel_settings</span> æ§åˆ¶å°
                        <span id="admin-lock-indicator" class="ml-auto text-xs px-2 py-1 rounded bg-gray-700">æœªé–å®š</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white/10 p-4 rounded-xl text-center">
                            <span id="count-online" class="text-2xl font-bold block">0</span><span class="text-xs text-gray-400">åœ¨ç·š</span>
                        </div>
                        <div class="bg-white/10 p-4 rounded-xl text-center">
                            <span id="count-total" class="text-2xl font-bold block">0</span><span class="text-xs text-gray-400">ç¸½äººæ•¸</span>
                        </div>
                    </div>
                    <button class="w-full py-4 bg-primary hover:bg-primary-dark rounded-xl font-bold text-lg mb-3 shadow-lg flex items-center justify-center gap-2" onclick="drawNewNumber()">
                        <span class="material-symbols-outlined">casino</span> æŠ½è™Ÿ (è‡ªå‹•é–å®š)
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="py-2 bg-gray-700 rounded-lg text-sm" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶é–å®š</button>
                        <button class="py-2 bg-amber-500 rounded-lg text-sm" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
                    </div>
                    <button class="w-full mt-4 py-2 border border-red-500/50 text-red-400 rounded-lg text-xs" onclick="removeAllPlayers()">ğŸ§¹ ç§»é™¤æ‰€æœ‰ç©å®¶</button>
                    <button class="w-full mt-2 py-2 border border-white/10 text-gray-400 rounded-lg text-xs" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²</button>
                </div>
            </div>

            <div class="bg-white dark:bg-surface-dark rounded-xl p-4 shadow-sm border border-[#f4eae7]">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">é€£ç·šçµ±è¨ˆ</h3>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <div><span id="cnt-5" class="font-bold text-primary block">0</span><span class="text-[10px]">5é€£</span></div>
                    <div><span id="cnt-4" class="font-bold block">0</span><span class="text-[10px]">4é€£</span></div>
                    <div><span id="cnt-3" class="font-bold block">0</span><span class="text-[10px]">3é€£</span></div>
                    <div><span id="cnt-2" class="font-bold block">0</span><span class="text-[10px]">2é€£</span></div>
                </div>
            </div>

            <div class="bg-white dark:bg-surface-dark rounded-xl p-4 shadow-sm border border-[#f4eae7] flex-grow">
                <h3 class="text-sm font-bold mb-3">é€šçŸ¥è¨Šæ¯</h3>
                <div id="pending-choices" class="text-xs text-primary mb-2"></div>
                <div id="bingo-alerts" class="text-xs text-green-600"></div>
                <div id="status-log" class="mt-4 text-[10px] font-mono h-32 overflow-auto bg-gray-900 text-green-400 p-2 rounded"></div>
            </div>
        </div>
    </div>
</main>

<footer class="mt-8 border-t py-6 text-center">
    <p class="text-sm text-gray-500">Â© 2025 Bingo Master System. v2.9.1</p>
</footer>

<script>
    // --- Firebase Configuration (Same as Index-0105) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
        authDomain: "yearendbingo.firebaseapp.com",
        projectId: "yearendbingo",
        storageBucket: "yearendbingo.firebasestorage.app",
        messagingSenderId: "563353011392",
        appId: "1:563353011392:web:717976a176bc22a04d5925",
        measurementId: "G-M6EVYSPNJ9"
    };
    const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let myData = { name:"", board:[], locked:false };
    let gameHistory = [];
    let allPlayersCache = [];
    let rollingTimer = null;
    let isAllLockedGlobal = false;

    // --- Core Logic from Index-0105 ---
    function logStatus(msg) {
        const el = document.getElementById('status-log');
        if(!el) return;
        el.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
    }

    function triggerAdmin() {
        window.ac = (window.ac || 0) + 1;
        if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
    }
    function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

    async function doAdminLogin(){
        const email = document.getElementById('admin-email').value;
        const pwd = document.getElementById('admin-pwd').value;
        try {
            const cred = await auth.signInWithEmailAndPassword(email, pwd);
            if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ"); }
            else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
        } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
    }

    auth.onAuthStateChanged(async user => {
        currentUser = user;
        if(!user){ showView('login'); return; }
        if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }

        const snap = await db.collection("players").doc(user.uid).get();
        if(snap.exists){
            myData = snap.data();
        } else {
            const name = document.getElementById('player-name').value || "è¨ªå®¢";
            myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
            await db.collection("players").doc(user.uid).set(myData);
        }
        document.getElementById('user-info').innerText = myData.name;
        document.getElementById('player-name-display').innerText = myData.name;
        showView('player');
        startApp();
    });

    async function doPlayerLogin(){
        if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
        await auth.signInAnonymously();
    }

    function showView(name){
        document.getElementById('view-login').style.display = (name === 'login') ? 'block' : 'none';
        document.getElementById('view-player').style.display = (name === 'player' || name === 'login') ? 'block' : 'none';
        document.getElementById('view-admin').classList.toggle('hidden', name !== 'admin');
        if(name === 'player') document.getElementById('player-board-card').classList.remove('hidden');
    }

    function startApp(){
        db.collection("game_state").doc("current_game").onSnapshot(doc => {
            const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
            gameHistory = data.history || [];
            isAllLockedGlobal = data.isAllLocked || false;

            if(document.getElementById('admin-lock-indicator')) {
                document.getElementById('admin-lock-indicator').innerText = isAllLockedGlobal ? "âœ… å·²é–å®š" : "ğŸ”“ æœªé–å®š";
                document.getElementById('admin-lock-indicator').className = isAllLockedGlobal ? "ml-auto text-xs px-2 py-1 rounded bg-green-600" : "ml-auto text-xs px-2 py-1 rounded bg-gray-700";
            }

            const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
            document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="flex-shrink-0 size-8 rounded-full bg-primary flex items-center justify-center font-bold text-xs text-white">${n}</span>`).join('') || "ç­‰å¾…é–‹è™Ÿ";

            if(data.isRolling){
                if(!rollingTimer) rollingTimer = setInterval(()=> {
                    const r = Math.floor(Math.random()*25)+1;
                    document.getElementById('draw-display').innerText = r;
                }, 80);
            } else {
                clearInterval(rollingTimer); rollingTimer=null;
                document.getElementById('draw-display').innerText = last;
                renderGrid();
                if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
            }

            if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
                handleLuckyChoice(data.luckyUser);
            }
        });

        db.collection("players").onSnapshot(snap => {
            allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(document.getElementById('count-total')) document.getElementById('count-total').innerText = allPlayersCache.length;
            if(currentUser.uid !== ALLOWED_UID){
                const me = allPlayersCache.find(p => p.id === currentUser.uid);
                if(me && me.locked !== myData.locked) {
                    myData.locked = me.locked;
                    renderGrid();
                }
            }
        });

        if(currentUser.uid === ALLOWED_UID){
            db.collection("pending_choices").orderBy("timestamp","desc").onSnapshot(snap => {
                document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div class="p-1 border-b border-white/5">â“ ${d.data().playerName} é¸äº† ${d.data().number} <button class="text-amber-400 ml-2" onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
            });
            db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
                document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div class="p-1">ğŸ‰ <b>${d.data().name}</b> è³“æœäº†ï¼</div>`).join('');
            });
        }
    }

    async function handleLuckyChoice(name) {
        let valid = false;
        let num;
        while(!valid) {
            const input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹è™Ÿç¢¼ (1-25)ï¼š`);
            if(input === null) break;
            num = parseInt(input);
            if(isNaN(num) || num < 1 || num > 25) alert("è«‹è¼¸å…¥ 1-25 æ•¸å­—");
            else if(gameHistory.includes(num)) alert("æ­¤è™Ÿç¢¼å·²é–‹é");
            else valid = true;
        }
        if(valid) {
            await db.collection("pending_choices").doc(currentUser.uid).set({
                playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection("game_state").doc("current_game").update({ luckyUser: "" });
        }
    }

    function renderGrid(){
        const grid = document.getElementById('bingo-grid');
        if(!grid) return;
        grid.innerHTML = '';
        const winIdx = new Set();
        const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        let winLineCount = 0;
        lines.forEach(line => {
            if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
                line.forEach(i=>winIdx.add(i));
                winLineCount++;
            }
        });
        myData.board.forEach((num,i)=>{
            const div = document.createElement('div');
            div.className = 'bingo-cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
            div.innerText = num;
            grid.appendChild(div);
        });
        if(winLineCount > 0 && myData.locked) {
            document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
            db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }
        document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
        document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­...";
    }

    function calculateMaxConsecutive(board, history) {
        const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        let globalMax = 0;
        lines.forEach(line => {
            let currentMax = 0, streak = 0;
            line.forEach(index => {
                if(history.includes(board[index])) { streak++; if(streak > currentMax) currentMax = streak; }
                else streak = 0;
            });
            if(currentMax > globalMax) globalMax = currentMax;
        });
        return globalMax;
    }

    function updateConnectedStats(){
        const counts = {5:0,4:0,3:0,2:0};
        allPlayersCache.forEach(p=>{
            if(!p.board || !p.locked) return;
            const max = calculateMaxConsecutive(p.board, gameHistory);
            if(max >= 5) counts[5]++;
            else if(max === 4) counts[4]++;
            else if(max === 3) counts[3]++;
            else if(max === 2) counts[2]++;
        });
        document.getElementById('cnt-5').innerText = counts[5];
        document.getElementById('cnt-4').innerText = counts[4];
        document.getElementById('cnt-3').innerText = counts[3];
        document.getElementById('cnt-2').innerText = counts[2];
    }

    async function forceLockAll() {
        logStatus("æ­£åœ¨åŸ·è¡Œå…¨å“¡é–å®š...");
        const batch = db.batch();
        allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
        await batch.commit();
        await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
    }

    async function drawNewNumber(){
        const ref = db.collection("game_state").doc("current_game");
        if(!isAllLockedGlobal) await forceLockAll();
        const snap = await ref.get();
        const hist = snap.data().history || [];
        const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
        if(!pool.length) return alert("æŠ½å®Œå›‰");
        await ref.update({ isRolling:true });
        setTimeout(async ()=>{
            const p = pool[Math.floor(Math.random()*pool.length)];
            await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false, luckyUser: "" });
        }, 1200);
    }

    async function removeAllPlayers() {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…å—ï¼Ÿ")) return;
        const batch = db.batch();
        allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
        await batch.commit();
        location.reload();
    }

    async function handleReset(){
        if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ")) return;
        const batch = db.batch();
        allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
        const colls = ["pending_choices","bingo_events"];
        for(const c of colls){
            const s = await db.collection(c).get();
            s.forEach(d=>batch.delete(d.ref));
        }
        batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
        await batch.commit();
        location.reload();
    }

    async function confirmLucky(id, num) {
        await db.collection("game_state").doc("current_game").update({ history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
        await db.collection("pending_choices").doc(id).delete();
    }

    async function pickLucky() {
        if(allPlayersCache.length === 0) return alert("æ²’äººåƒèˆ‡");
        const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
        await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
        alert("å¹¸é‹å…’æ˜¯ï¼š" + lucky);
    }

    function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
    function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
    async function confirmBoard(){
        if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
        await db.collection("players").doc(currentUser.uid).update({ locked:true });
        myData.locked = true; renderGrid();
    }
    function doSignOut(){ auth.signOut(); location.reload(); }
    setInterval(() => {
        if(currentUser && currentUser.uid !== ALLOWED_UID) {
            db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
        }
    }, 15000);
</script>
</body>
</html>
