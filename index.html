<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.3</title>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --primary: #f45925;
  --primary-dark: #d64010;
  --bg: #f8f6f5;
  --card: #ffffff;
  --text-main: #1c110d;
  --muted: #6b7280;
  --success: #2e7d32;
  --danger: #d64010;
  --special: #673ab7;
  --shadow: 0 4px 12px rgba(244, 89, 37, 0.15);
  --radius: 1rem;
}

* { box-sizing: border-box; }
html, body { font-size: 26px; }

body {
  margin: 0;
  font-family: 'Spline Sans', 'Noto Sans TC', system-ui, sans-serif;
  background-color: var(--bg);
  color: var(--text-main);
  line-height: 1.5;
}

.container {
  max-width: 960px;
  padding: 24px 16px;
  margin: 0 auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding: 10px 0;
}

/* ä¿®æ”¹ï¼šTitle å­—è™Ÿå°ä¸€è™Ÿ (å¾ 1.8rem æ”¹ç‚º 1.5rem) */
.title {
  font-size: 1.5rem;
  font-weight: 900;
  color: var(--primary);
  letter-spacing: -0.04em;
  cursor: pointer;
  user-select: none;
}

.user-info {
  font-weight: 500;
  color: var(--muted);
  font-size: 0.9rem;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #f4eae7;
  padding: 24px;
  margin-bottom: 20px;
}

.hidden { display: none; }
  
#view-login h3 {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--primary);
  text-align: center;
  margin-bottom: 30px;
} 
  
.btn {
  padding: 12px 20px;
  border-radius: 9999px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  font-size: 1.4rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn.primary {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 4px 12px rgba(244, 89, 37, 0.3);
}

.btn.primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.btn.ghost {
  background: #fff;
  color: var(--text-main);
  border: 1px solid #e5e7eb;
}

.btn.ghost:hover {
  background: #f9fafb;
}

.btn.danger {
  background: #fee2e2;
  color: #b91c1c;
}

.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.stat-box {
  background: #fdfaf9;
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  border: 1px solid #f4eae7;
}

.stat-val {
  font-weight: 800;
  color: var(--primary);
  display: block;
  font-size: 1.5rem;
}

.status-log {
  max-height: 180px;
  overflow: auto;
  padding: 12px;
  border-radius: 12px;
  background: #2f1f1a;
  color: #fcf9f8;
  font-size: 0.85rem;
}

.history-ball {
  display: inline-block;
  width: 40px;
  height: 40px;
  line-height: 40px;
  background: #f4eae7;
  color: var(--text-main);
  border-radius: 50%;
  margin: 4px;
  text-align: center;
  font-weight: 700;
  font-size: 1rem;
}

.grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px; 
  width: 100%;
  justify-content: center;
  margin: 15px 0;
}
.cell {
  width: calc((100% - 32px) / 5);
  aspect-ratio: 1 / 1; 
  background: #f4eae7;
  color: var(--text-main);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1.2rem; 
  line-height: 1;
  text-align: center;
  user-select: none;
  transition: background 0.2s, transform 0.1s;
}

.cell.selected {
  background-color: var(--primary);
  color: white;
  transform: scale(1.02); 
  box-shadow: 0 2px 6px rgba(244, 89, 37, 0.3);
}

.cell.bingo-line {
  background: #2e7d32;
  color: #fff;
  animation: pulse 900ms infinite;
  box-shadow: 0 0 15px rgba(46, 125, 50, 0.4);
}

@keyframes pulse {
  0% { transform: scale(1.05); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1.05); }
}

/* ä¿®æ”¹ï¼šæŠ½è™Ÿé¡¯ç¤ºå­—æ¨£å°ä¸€è™Ÿ (å¾ 4.5rem ä¸‹é™) */
#draw-display {
  font-size: 3.5rem;
  font-weight: 900;
  color: var(--primary);
  height: 110px;
  line-height: 110px;
  text-align: center;
  overflow: hidden;
  white-space: nowrap;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(28, 17, 13, 0.8);
  backdrop-blur: 4px;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.modal-content {
  background: white;
  padding: 32px;
  border-radius: 20px;
  width: 95vw;
  max-width: 400px;
  box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
}

input {
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  font-size: 1.4rem;
}

.special-winner-tag {
  display: inline-block;
  background: #ede7f6;
  color: var(--special);
  padding: 4px 12px;
  border-radius: 99px;
  font-size: 0.9rem;
  margin: 4px;
  font-weight: 700;
  border: 1px solid #d1c4e9;
}

@media (max-width: 600px) {
  .grid { gap: 6px; }
  .cell { width: calc((100% - 24px) / 5); font-size: 1.1rem; }
}
</style>
</head>

<body>
  <div id="admin-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼">
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
    <button class="btn ghost" style="width:100%;margin-top:8px;" onclick="closeAdminModal()">å–æ¶ˆ</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ± v2.9.3.1</div>
    <div id="user-info" class="user-info">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="view-login" class="card hidden">
    <h3>ç©å®¶ç™»å…¥</h3>
    <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" />
    <button class="btn primary" style="width:100%;margin-top:12px" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="player-name-display" style="font-weight:700;font-size:1.1rem"></div>
          <div id="lock-status-label" style="font-size:0.95rem;color:var(--muted)"></div>
        </div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>

      <div style="text-align:center;margin-top:12px">
        <div id="draw-display">READY</div>
        <div id="bingo-status" style="margin-top:6px; font-weight: 800; color: var(--success);"></div>
        
        <div id="drawer-zone" style="display:none; margin-top:15px; padding:15px; border:2px dashed var(--primary); border-radius:12px; background:#fff5f2;">
          <div style="font-weight:800; color:var(--primary); margin-bottom:8px;">ğŸ”¥ è¼ªåˆ°ä½ æŠ½è™Ÿäº†ï¼</div>
          <button id="btn-player-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŒ‰æ­¤æŠ½è™Ÿ</button>
        </div>

        <div id="bingo-grid" class="grid" aria-label="è³“æœç›¤"></div>
        
        <div id="player-special-box" style="margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:none;">
            <div style="font-size:0.8rem; color:var(--muted); margin-bottom:8px;">ğŸ ç‰¹åˆ¥çå¾—çåå–®</div>
            <div id="player-special-winners"></div>
        </div>

        <div id="setup-btns" style="margin-top:15px;display:flex;gap:10px;justify-content:center">
          <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">ç®¡ç†è€…æ§åˆ¶å° <span id="admin-lock-indicator" style="font-size:0.8rem;padding:4px 8px;background:#eee;border-radius:6px">æœªé–å®š</span></div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>

      <div class="stat-grid" style="margin-top:12px">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><span>åœ¨ç·š</span></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><span>ç¸½äººæ•¸</span></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <div class="stat-box" style="flex:1;min-width:120px"><span id="cnt-5" class="stat-val">0</span><span style="font-size:0.8rem">5æ ¼é€£ç·š</span></div>
        <div class="stat-box" style="flex:1;min-width:120px"><span id="cnt-4" class="stat-val">0</span><span style="font-size:0.8rem">4æ ¼é€£ç·š</span></div>
        <div class="stat-box" style="flex:1;min-width:120px"><span id="cnt-3" class="stat-val">0</span><span style="font-size:0.8rem">3æ ¼é€£ç·š</span></div>
        <div class="stat-box" style="flex:1;min-width:120px"><span id="cnt-2" class="stat-val">0</span><span style="font-size:0.8rem">2æ ¼é€£ç·š</span></div>
      </div>

      <div style="margin-top:12px;text-align:center;background:#fff8e1;padding:12px;border-radius:10px">
        <div style="font-size:0.9rem">æœ€æ–°é–‹ç / ç‰¹åˆ¥ç</div>
        <div id="admin-sync-num" style="font-weight:800;margin-top:6px; font-size: 2.5rem; color: var(--primary);">--</div>
        <div id="admin-special-winners" style="margin-top:8px; color:var(--special); font-weight:700; font-size:0.9rem;"></div>
        <div id="drawn-history-list" style="margin-top:8px;border-top:1px dashed #ddd;padding-top:8px"></div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
        <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ (è‡ªå‹•é–å®š)</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶å…¨å“¡é–å®š</button>
        <button class="btn" style="background:#ffb300; color: white;" onclick="pickLucky()">ğŸŒŸ å¹¸é‹å…’é¸è™Ÿ</button>
        <button class="btn" style="background:var(--special); color: white;" onclick="drawSpecialPrize()">ğŸ æŠ½ç‰¹åˆ¥ç</button>
        <button class="btn" style="background:#00796b; color: white;" onclick="assignRandomDrawer()">ğŸ¯ æŒ‡å®šä¸‹ä¸€ä½æŠ½è™Ÿè€…</button>
        <button class="btn danger" onclick="removeAllPlayers()">ğŸ§¹ ç§»é™¤æ‰€æœ‰ä½¿ç”¨è€…</button>
        <button class="btn ghost" style="grid-column: span 2; border:1px solid #ddd" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²ç‹€æ…‹ (æ¢å¾©æ›è™Ÿ)</button>
      </div>

      <div class="card" style="margin-top:12px; border-color: #f4eae7;">
        <div style="font-weight:700;font-size:0.95rem">ğŸ“¢ è³“æœèˆ‡é¸è™Ÿé€šçŸ¥</div>
        <div id="pending-choices" style="max-height:120px;overflow:auto;font-size:0.95rem;color:var(--primary);margin-top:8px"></div>
        <div id="bingo-alerts" style="max-height:120px;overflow:auto;font-size:0.95rem;color:var(--success);margin-top:8px"></div>
      </div>

      <div class="card"><div id="status-log" class="status-log" aria-live="polite"></div></div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let specialWinners = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;

function logStatus(msg) {
  const el = document.getElementById('status-log');
  if(!el) return;
  el.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
}

function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ"); }
    else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){
    myData = snap.data();
  } else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  document.getElementById('player-name-display').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

// ä¿®æ”¹ï¼šæ›´æ–°æŠ½è™Ÿé¡¯ç¤ºå­—ç´š
function updateDrawDisplay(text) {
  const el = document.getElementById('draw-display');
  if(!el) return;
  el.innerText = text;
  if (text.toString().length > 3) {
    el.style.fontSize = "1.8rem";
  } else if (text.toString().length > 2) {
    el.style.fontSize = "2.2rem";
  } else {
    el.style.fontSize = window.innerWidth <= 600 ? "4.5rem" : "3.5rem";
  }
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"", isPickingLucky:false, specialWinners: [], authorizedDrawer: "", usedDrawers: [] };
    gameHistory = data.history || [];
    specialWinners = data.specialWinners || [];
    isAllLockedGlobal = data.isAllLocked || false;
    
    if(document.getElementById('admin-lock-indicator')) {
      document.getElementById('admin-lock-indicator').innerText = isAllLockedGlobal ? "âœ… å·²é–å®š" : "ğŸ”“ æœªé–å®š";
      document.getElementById('admin-lock-indicator').style.background = isAllLockedGlobal ? "#c8e6c9" : "#eee";
    }

    // ä¿®æ”¹ï¼šç‰¹åˆ¥çé¡¯ç¤ºé‚è¼¯ (ç„¡åå–®æ™‚éš±è—)
    const specialHtml = specialWinners.map(w => `<span class="special-winner-tag">ğŸ ${w}</span>`).join('');
    if(document.getElementById('admin-special-winners')) document.getElementById('admin-special-winners').innerHTML = specialHtml;
    
    if(document.getElementById('player-special-winners')) {
        document.getElementById('player-special-winners').innerHTML = specialHtml;
        // ä¿®æ”¹ï¼šå¦‚æœæœ‰å¾—çäººæ‰é¡¯ç¤ºå€å¡Š
        document.getElementById('player-special-box').style.display = specialWinners.length > 0 ? 'block' : 'none';
    }

    const drawerZone = document.getElementById('drawer-zone');
    if (drawerZone) {
      if (data.authorizedDrawer === myData.name && !data.isRolling) {
        drawerZone.style.display = 'block';
      } else {
        drawerZone.style.display = 'none';
      }
    }

    const finalValue = data.luckyUser ? data.luckyUser : (gameHistory.length ? gameHistory[gameHistory.length-1] : "READY");
    document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="history-ball">${n}</span>`).join('') || "ç­‰å¾…é–‹è™Ÿ";
    
    if(data.isRolling){
      if(!rollingTimer) {
        rollingTimer = setInterval(()=> {
          let temp;
          if (data.isPickingLucky) {
             if (allPlayersCache.length > 0) {
               temp = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
             } else { temp = "æŠ½çä¸­"; }
          } else { temp = Math.floor(Math.random()*25)+1; }
          updateDrawDisplay(temp);
          if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = temp;
        }, 80);
      }
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      updateDrawDisplay(finalValue);
      if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = finalValue;
      renderGrid();
      if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && !data.isPickingSpecial && currentUser.uid !== ALLOWED_UID) {
      if (specialWinners.includes(data.luckyUser)) return; 
      
      let valid = false; let num;
      while(!valid) {
        const input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹è™Ÿç¢¼ (1-25)ï¼š`);
        if(input === null) break;
        num = parseInt(input);
        if(isNaN(num) || num < 1 || num > 25) alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥ 1 åˆ° 25 ä¹‹é–“çš„æ•¸å­—ã€‚");
        else if(gameHistory.includes(num)) alert(`${num} å·²ç¶“è¢«æŠ½éå›‰ã€‚`);
        else valid = true;
      }
      if(valid) {
        db.collection("pending_choices").doc(currentUser.uid).set({
          playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection("game_state").doc("current_game").update({ luckyUser: "" });
      }
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    
    if (currentUser.uid === ALLOWED_UID) {
      const now = Date.now();
      const onlinePlayers = allPlayersCache.filter(p => {
        if (!p.lastSeen) return false;
        const last = p.lastSeen.toMillis ? p.lastSeen.toMillis() : 0;
        return (now - last) < 300000;
      });
      document.getElementById('count-online').innerText = onlinePlayers.length;
      document.getElementById('count-total').innerText = allPlayersCache.length;
      updateConnectedStats();
    }

    if(currentUser.uid !== ALLOWED_UID){
      const me = allPlayersCache.find(p => p.id === currentUser.uid);
      if(me && me.locked !== myData.locked) {
        myData.locked = me.locked;
        renderGrid();
      }
    }
  });

  if(currentUser.uid === ALLOWED_UID){
    db.collection("pending_choices").orderBy("timestamp","desc").onSnapshot(snap => {
      document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div>â“ ${d.data().playerName} é¸äº† ${d.data().number} <button onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
    });
    db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
      document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ <b>${d.data().name}</b> è³“æœäº†ï¼</div>`).join('');
    });
  }
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  const lines = [
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];
  let winLineCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
      line.forEach(i=>winIdx.add(i));
      winLineCount++;
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  
  // ä¿®æ”¹ï¼šè‹¥é‡ç½®å¾Œ gameHistory ç‚ºç©ºï¼Œå¼·åˆ¶æ¸…ç©ºé€£ç·šå­—æ¨£
  if(winLineCount > 0 && myData.locked && gameHistory.length > 0) {
    document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  } else {
    document.getElementById('bingo-status').innerText = "";
  }
  
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
  document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­...";
}

function calculateMaxConsecutive(board, history) {
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  let max = 0;
  lines.forEach(line => {
    let hits = 0;
    line.forEach(idx => { if(history.includes(board[idx])) hits++; });
    if(hits > max) max = hits;
  });
  return max;
}

function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const max = calculateMaxConsecutive(p.board, gameHistory);
    if(max >= 5) counts[5]++;
    else if(max === 4) counts[4]++;
    else if(max === 3) counts[3]++;
    else if(max === 2) counts[2]++;
  });
  if(document.getElementById('cnt-5')) document.getElementById('cnt-5').innerText = counts[5];
  if(document.getElementById('cnt-4')) document.getElementById('cnt-4').innerText = counts[4];
  if(document.getElementById('cnt-3')) document.getElementById('cnt-3').innerText = counts[3];
  if(document.getElementById('cnt-2')) document.getElementById('cnt-2').innerText = counts[2];
}

async function forceLockAll() {
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}

async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll();
  const snap = await ref.get();
  const data = snap.data();
  const hist = data.history || [];
  const currentDrawer = data.authorizedDrawer; 
  
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  
  await ref.update({ isRolling: true, isPickingLucky: false, luckyUser: "" });
  
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    const updateObj = { 
      history: firebase.firestore.FieldValue.arrayUnion(p), 
      isRolling: false,
      authorizedDrawer: "" 
    };
    if (currentDrawer) {
      updateObj.usedDrawers = firebase.firestore.FieldValue.arrayUnion(currentDrawer);
    }
    await ref.update(updateObj);
  }, 1200);
}

async function assignRandomDrawer() {
  const ref = db.collection("game_state").doc("current_game");
  const snap = await ref.get();
  const state = snap.data();
  const usedDrawers = state.usedDrawers || [];

  const now = Date.now();
  const pool = allPlayersCache.filter(p => {
    const last = p.lastSeen?.toMillis ? p.lastSeen.toMillis() : 0;
    return (now - last) < 300000 && !usedDrawers.includes(p.name);
  });

  if (pool.length === 0) return alert("æ²’æœ‰ç¬¦åˆè³‡æ ¼çš„åœ¨ç·šäººå“¡ï¼ˆæˆ–éƒ½å·²æŠ½éï¼‰");

  const luckyOne = pool[Math.floor(Math.random() * pool.length)].name;
  
  await ref.update({ 
    authorizedDrawer: luckyOne,
    luckyUser: "ğŸ° æŒ‡å®šæŠ½è™Ÿè€…ï¼š" + luckyOne 
  });
  logStatus("ğŸ¯ å·²æŒ‡å®š " + luckyOne + " åŸ·è¡Œä¸‹æ¬¡æŠ½è™Ÿ");
}

async function drawSpecialPrize() {
  const now = Date.now();
  const pool = allPlayersCache.filter(p => {
    const last = p.lastSeen?.toMillis ? p.lastSeen.toMillis() : 0;
    const isOnline = (now - last) < 300000;
    return isOnline && !specialWinners.includes(p.name);
  });

  if(pool.length === 0) return alert("æ²’æœ‰ç¬¦åˆè³‡æ ¼çš„åœ¨ç·šäººå“¡ï¼ˆæˆ–éƒ½å·²ä¸­çï¼‰");

  const ref = db.collection("game_state").doc("current_game");
  await ref.update({ isRolling: true, isPickingLucky: true, luckyUser: "" });

  setTimeout(async () => {
    const winner = pool[Math.floor(Math.random()*pool.length)].name;
    await ref.update({ 
        isRolling: false, 
        isPickingLucky: false, 
        luckyUser: "ğŸ ç‰¹åˆ¥çï¼š" + winner,
        specialWinners: firebase.firestore.FieldValue.arrayUnion(winner)
    });
    logStatus("ğŸ æŠ½å‡ºäº†ç‰¹åˆ¥çï¼š" + winner);
  }, 2500);
}

// ä¿®æ”¹ï¼šé‡ç½®é‚è¼¯åŠ å…¥é€£ç·šè³‡è¨Šæ¸…é™¤
async function handleReset(){
  if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ(åŒ…å«é‡ç½®ç‰¹åˆ¥çèˆ‡æŠ½è™Ÿè€…åå–®)")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  
  // ä¿®æ”¹ï¼šç¢ºå¯¦æ¸…é™¤æ‰€æœ‰é€šçŸ¥èˆ‡é€£ç·šäº‹ä»¶
  const colls = ["pending_choices","bingo_events"];
  for(const c of colls){
    const s = await db.collection(c).get();
    s.forEach(d=>batch.delete(d.ref));
  }
  
  batch.set(db.collection("game_state").doc("current_game"), { 
    history:[], 
    isRolling:false, 
    isAllLocked:false, 
    luckyUser:"", 
    isPickingLucky:false, 
    specialWinners: [],
    authorizedDrawer: "",
    usedDrawers: []
  });
  await batch.commit();
  location.reload();
}

async function confirmLucky(id, num) {
  await db.collection("game_state").doc("current_game").update({ history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
  await db.collection("pending_choices").doc(id).delete();
}

async function pickLucky() {
  if(allPlayersCache.length === 0) return alert("æ²’äººåœ¨ç·š");
  const ref = db.collection("game_state").doc("current_game");
  await ref.update({ isRolling: true, isPickingLucky: true, luckyUser: "" });
  setTimeout(async () => {
    const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
    await ref.update({ isRolling: false, isPickingLucky: false, luckyUser: lucky });
    logStatus("ğŸŒŸ æŠ½å‡ºäº†å¹¸é‹å…’ï¼š" + lucky);
  }, 2500);
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}
function doSignOut(){ auth.signOut(); location.reload(); }

// ä¿®æ”¹ï¼šåˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…æ™‚å¼·åˆ¶ç™»å‡º
async function removeAllPlayers() {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…å—ï¼Ÿé€™å°‡æœƒè®“æ‚¨ç™»å‡ºã€‚")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
  await batch.commit();
  await auth.signOut(); // å¼·åˆ¶ç™»å‡º
  location.reload(); // å›åˆ°ç™»å…¥ç•«é¢
}

setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
}, 10000);
</script>
</body>
</html>
