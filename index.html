<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>2025 å°¾ç‰™å¤§å­—ç‰ˆè³“æœç³»çµ±</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --primary: #f45925; /* æ¡ç”¨ new 9 çš„äº®æ©˜è‰²  */
  --primary-dark: #d64010;
  --bg: #f8f6f5;
  --card: #ffffff;
  --text: #1c110d;
  --muted: #6b7280;
  --success: #2e7d32;
  --danger: #c62828;
  --shadow: 0 10px 25px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  margin: 0; 
  font-family: 'Noto Sans TC', system-ui, sans-serif; 
  background: var(--bg); 
  color: var(--text);
  line-height: 1.4;
}

/* å…¨è¢å¹•ä½ˆå±€ï¼šç§»é™¤ max-width é™åˆ¶ï¼Œæ©«å‘æ™‚æœ€å¤§ 980px  */
.container { 
  width: 100%; 
  margin: 0 auto; 
  padding: 12px;
  min-height: 100vh;
}
@media (min-width: 980px) and (orientation: landscape) {
  .container { max-width: 980px; }
}

/* æ¨™é¡Œèˆ‡è³‡è¨Š */
.header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; }
.title { font-size: 1.5rem; font-weight: 900; color: var(--primary); }
.user-info { font-size: 1.1rem; font-weight: 700; color: var(--muted); }

/* å¡ç‰‡èˆ‡å¤§æŒ‰éˆ• */
.card { 
  background: var(--card); 
  border-radius: 20px; 
  box-shadow: var(--shadow); 
  padding: 24px; 
  margin-bottom: 16px; 
}
.btn { 
  display: block; 
  width: 100%; 
  padding: 20px; /* åŠ é«˜é»æ“Šå€åŸŸ */
  border-radius: 16px; 
  border: none; 
  font-size: 1.25rem; /* å­—é«”åŠ å¤§ */
  font-weight: 800; 
  cursor: pointer; 
  transition: transform 0.1s;
}
.btn:active { transform: scale(0.96); }
.btn.primary { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(244, 89, 37, 0.4); }
.btn.ghost { background: #eee; color: #333; }
.btn.danger { background: var(--danger); color: #fff; }

/* ç™»å…¥è¼¸å…¥æ¡† */
input { 
  width: 100%; 
  padding: 18px; 
  font-size: 1.3rem; 
  border: 3px solid #eee; 
  border-radius: 12px; 
  margin-bottom: 15px; 
}

/* è³“æœæ•¸å­—ç¶²æ ¼ [cite: 420, 474] */
.grid { 
  display: grid; 
  grid-template-columns: repeat(5, 1fr); 
  gap: 10px; 
  width: 100%;
  margin: 20px 0;
}
.cell { 
  aspect-ratio: 1; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: #fff; 
  border-radius: 50%; /* åœ“åœˆè¨­è¨ˆ */
  border: 2px solid #eee; 
  font-weight: 900; 
  font-size: 1.6rem; /* æ•¸å­—ç‰¹å¤§ */
  transition: all 0.2s;
}
.cell.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
.cell.bingo-line { background: #ffd700; color: #000; animation: pulse 1s infinite; border-color: #ffb300; }

/* è¶…å¤§é–‹çæ•¸å­—  */
#draw-display, #admin-sync-num { 
  font-size: 6rem; /* æ¥µå¤§åŒ– */
  font-weight: 900; 
  color: var(--primary); 
  text-align: center; 
  margin: 10px 0;
  text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
}

.history-ball { 
  display: inline-block; 
  width: 45px; height: 45px; line-height: 45px; 
  background: #f4eae7; color: #333; 
  border-radius: 50%; margin: 5px; 
  text-align: center; font-weight: 800; font-size: 1.1rem; 
}

.hidden { display: none; }
@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }

/* ç®¡ç†ä»‹é¢å„ªåŒ– */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
.stat-box { background: #f0f0f0; padding: 15px; border-radius: 15px; text-align: center; }
.stat-val { font-size: 1.8rem; font-weight: 900; color: var(--primary); display: block; }
</style>
</head>
<body>

<div id="admin-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px;">
  <div class="card" style="width:100%;max-width:400px;">
    <h2 style="margin-top:0">ç®¡ç†å“¡ç™»å…¥</h2>
    <input id="admin-email" type="email" placeholder="ç®¡ç†ä¿¡ç®±">
    <input id="admin-pwd" type="password" placeholder="ç®¡ç†å¯†ç¢¼">
    <button class="btn primary" onclick="doAdminLogin()">ç™»å…¥ç®¡ç†å¾Œå°</button>
    <button class="btn ghost" style="margin-top:10px" onclick="closeAdminModal()">å–æ¶ˆ</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœ</div>
    <div id="user-info" class="user-info">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="view-login" class="card hidden">
    <h1 style="text-align:center;font-size:2rem">æ­¡è¿åƒåŠ å°¾ç‰™ï¼</h1>
    <p style="text-align:center;color:var(--muted);font-weight:700">è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“åé€²å…¥éŠæˆ²</p>
    <input id="player-name" type="text" placeholder="æ‚¨çš„å§“å" />
    <button class="btn primary" onclick="doPlayerLogin()">é–‹å§‹è³“æœï¼</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card" style="text-align:center">
      <div id="lock-status-label" style="font-size:1.2rem;font-weight:800;margin-bottom:5px"></div>
      <div id="draw-display">READY</div>
      <div id="bingo-status" style="font-size:1.5rem;color:var(--success);font-weight:900;min-height:2rem"></div>
      
      <div id="bingo-grid" class="grid"></div>

      <div id="setup-btns" style="display:flex;gap:15px;margin-top:20px">
        <button class="btn ghost" onclick="reRollBoard()" style="flex:1">ğŸ² æ›è™Ÿç¢¼</button>
        <button class="btn primary" onclick="confirmBoard()" style="flex:1.5">ğŸ”’ é–å®šè™Ÿç¢¼</button>
      </div>
      <button class="btn ghost" style="margin-top:30px;padding:12px;font-size:1rem" onclick="doSignOut()">å®‰å…¨ç™»å‡º</button>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 15px 0">ç®¡ç†è€…æ§åˆ¶å°</h2>
      <div class="stat-grid">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><span>åœ¨ç·š</span></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><span>ç¸½äººæ•¸</span></div>
      </div>
      
      <div style="background:#fff8e1;padding:15px;border-radius:20px;text-align:center;margin-bottom:20px">
        <div style="font-weight:800">æœ€æ–°è™Ÿç¢¼</div>
        <div id="admin-sync-num">--</div>
        <div id="drawn-history-list" style="margin-top:10px"></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr;gap:15px">
        <button id="btn-draw" class="btn primary" style="padding:30px;font-size:1.5rem" onclick="drawNewNumber()">ğŸ² æŠ½ä¸‹ä¸€å€‹è™Ÿç¢¼</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶å…¨å“¡é–å®š</button>
        <button class="btn" style="background:#ffb300;color:black" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’é¸è™Ÿ</button>
        <button class="btn danger" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ² (æ¢å¾©æ›è™Ÿ)</button>
        <button class="btn ghost" onclick="doSignOut()">é€€å‡ºç®¡ç†</button>
      </div>
    </div>
  </div>
</div>

<script>
// ä½¿ç”¨ Index-0105 å…§çš„ Firebase é…ç½®èˆ‡é‚è¼¯ [cite: 559, 571]
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1"; [cite: 568]

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;

// é‚è¼¯éƒ¨åˆ†å»¶ç”¨ Index-0105 å®Œæ•´åŠŸèƒ½ [cite: 572-824]
function triggerAdmin() { 
  window.ac = (window.ac || 0) + 1; 
  if(window.ac >= 5) { document.getElementById('admin-modal').classList.remove('hidden'); window.ac = 0; } 
}
function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); }
    else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }

  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){ myData = snap.data(); } 
  else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isAllLocked:false };
    gameHistory = data.history || [];
    isAllLockedGlobal = data.isAllLocked || false;

    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="history-ball">${n}</span>`).join('');

    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const r = Math.floor(Math.random()*25)+1;
        document.getElementById('draw-display').innerText = r;
        if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = r;
      }, 80);
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      document.getElementById('draw-display').innerText = last;
      if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = last;
      renderGrid();
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    document.getElementById('count-total').innerText = allPlayersCache.length;
    const online = allPlayersCache.filter(p => p.lastSeen && (Date.now() - p.lastSeen.toDate()) < 30000).length;
    document.getElementById('count-online').innerText = online;
  });
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  let winLineCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
      line.forEach(i=>winIdx.add(i));
      winLineCount++;
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winLineCount > 0 && myData.locked) {
    document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  }
  document.getElementById('setup-btns').classList.toggle('hidden', (myData.locked || isAllLockedGlobal));
  document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è«‹è¨­å®šæ‚¨çš„è™Ÿç¢¼";
}

// æŠ½è™Ÿèˆ‡é‡ç½®åŠŸèƒ½... (å…¶é¤˜èˆ‡ Index-0105 ç›¸åŒ)
async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll();
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false });
  }, 1200);
}

async function forceLockAll() {
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}

async function handleReset(){
  if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  await db.collection("game_state").doc("current_game").set({ history:[], isRolling:false, isAllLocked:false });
  await batch.commit();
  location.reload();
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  if(!confirm("é–å®šå¾Œä¸èƒ½å†æ”¹è™Ÿç¢¼ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}
function doSignOut(){ auth.signOut(); location.reload(); }
function pickLucky(){ 
  const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
  alert("å¹¸é‹å…’æ˜¯ï¼š" + lucky); 
}
</script>
</body>
</html>
