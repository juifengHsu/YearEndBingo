<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.2</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{
  --primary:#b71c1c; --accent:#ffb300; --bg:#f4f6f8; --card:#fff;
  --muted:#6b7280; --success:#2e7d32; --danger:#c62828; --shadow:0 6px 18px rgba(16,24,40,0.06);
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Noto Sans TC", system-ui;background:var(--bg);color:#111}
.container{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.title{font-size:1.25rem;color:var(--primary);cursor:pointer;user-select:none;font-weight:800}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.hidden{display:none}
.btn{padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer;transition:0.2s}
.btn:active{transform:scale(0.95)}
.btn.primary{background:var(--primary);color:#fff}
.btn.ghost{background:#f3f4f6;color:#111}
.btn.danger{background:var(--danger);color:#fff}

/* æŠ½è™Ÿæ»¾å‹•å‹•ç•« */
@keyframes bounce { from { transform: scale(1); } to { transform: scale(1.1); } }
.rolling-anim { animation: bounce 0.1s infinite alternate; }

.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-box{background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);padding:10px;border-radius:10px;text-align:center}
.stat-val{font-weight:800;color:var(--accent);display:block;font-size:1.1rem}

/* è³“æœç›¤é¢æ¨£å¼å„ªåŒ– */
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:420px;margin:10px auto}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:10px;border:1px solid #eef2f7;font-weight:700;font-size:1.2rem;position:relative;overflow:hidden}

/* è™Ÿç¢¼é¸ä¸­æ™‚çš„æµå…‰å‹•ç•« */
.cell.selected { background:#fff7e6; color:#b25600; border-color:var(--accent); }
.cell.selected::after {
  content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
  transform: rotate(45deg); animation: shine 3s infinite;
}
@keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }

/* è³“æœé€£ç·šé–ƒçˆ */
.cell.bingo-line{background:var(--success) !important;color:#fff !important;animation:pulse 0.8s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}

.status-log{max-height:150px;overflow:auto;padding:10px;border-radius:8px;background:#0f172a;color:#fff;font-size:0.8rem}
.history-ball{display:inline-block;width:28px;height:28px;line-height:28px;background:var(--primary);color:white;border-radius:50%;margin:2px;text-align:center;font-weight:bold;font-size:0.8rem}
</style>
</head>
<body>

<audio id="audio-bingo" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>

<div id="admin-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:999">
  <div class="modal-content" style="background:white;padding:24px;border-radius:16px;width:320px">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd">
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
    <button class="btn ghost" style="width:100%;margin-top:8px;" onclick="closeAdminModal()">å–æ¶ˆ</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ± v2.9.2</div>
    <div id="user-info" class="user-info">é€£ç·šä¸­...</div>
  </div>

  <div id="view-login" class="card hidden">
    <h3>ç©å®¶ç™»å…¥</h3>
    <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd" />
    <button class="btn primary" style="width:100%;margin-top:12px" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between">
        <div><div style="font-weight:700" id="player-name-display"></div><div id="lock-status-label" style="font-size:0.8rem;color:var(--muted)"></div></div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      <div style="text-align:center;margin-top:10px">
        <div id="draw-display" style="font-size:4rem;font-weight:800;color:var(--primary);height:100px;line-height:100px">READY</div>
        <div id="bingo-status" style="height:26px;color:var(--success);font-weight:800;font-size:1.1rem"></div>
        <div id="bingo-grid" class="grid"></div>
        <div id="setup-btns" style="margin-top:15px;display:flex;gap:10px;justify-content:center">
          <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">ç®¡ç†è€…æ§åˆ¶å° <span id="admin-lock-indicator"></span></div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      <div class="stat-grid" style="margin-top:12px">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><span>åœ¨ç·š</span></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><span>ç¸½äººæ•¸</span></div>
      </div>
      <div style="display:flex;gap:5px;margin-top:10px">
        <div class="stat-box" style="flex:1"><span id="cnt-5" class="stat-val">0</span><span style="font-size:0.7rem">5æ ¼é€£</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-4" class="stat-val">0</span><span style="font-size:0.7rem">4æ ¼é€£</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-3" class="stat-val">0</span><span style="font-size:0.7rem">3æ ¼é€£</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-2" class="stat-val">0</span><span style="font-size:0.7rem">2æ ¼é€£</span></div>
      </div>
      <div style="margin-top:10px;text-align:center;background:#fff8e1;padding:10px;border-radius:10px">
        <div id="admin-sync-num" style="font-size:2.5rem;font-weight:800;color:var(--primary)">--</div>
        <div id="drawn-history-list" style="margin-top:5px;font-size:0.8rem"></div>
      </div>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ (è‡ªå‹•é–å®š)</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶å…¨å“¡é–å®š</button>
        <button class="btn" style="background:var(--accent)" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
        <button class="btn danger" onclick="removeAllPlayers()">ğŸ§¹ ç§»é™¤æ‰€æœ‰ä½¿ç”¨è€…</button>
        <button class="btn ghost" style="grid-column: span 2; border:1px solid #ddd" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²ç‹€æ…‹</button>
      </div>
      <div class="card" style="margin-top:12px;background:#f8f9fa">
          <div id="bingo-alerts" style="max-height:100px;overflow:auto;font-size:0.85rem;color:var(--success);font-weight:700"></div>
      </div>
      <div class="card"><div id="status-log" class="status-log"></div></div>
    </div>
  </div>
</div>

<script>
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null, myData = { name:"", board:[], locked:false }, gameHistory = [], allPlayersCache = [], rollingTimer = null, isAllLockedGlobal = false;
let alreadyBingoed = false; // ç”¨æ–¼æ§åˆ¶å–®å ´æ¯”è³½åªè§¸ç™¼ä¸€æ¬¡éŸ³æ•ˆèˆ‡ç¢ç´™

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
    gameHistory = data.history || [];
    isAllLockedGlobal = data.isAllLocked || false;
    
    const drawEl = document.getElementById('draw-display');
    const adminDrawEl = document.getElementById('admin-sync-num');

    if(data.isRolling){
      drawEl.classList.add('rolling-anim');
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const r = Math.floor(Math.random()*25)+1;
        drawEl.innerText = r;
        if(adminDrawEl) adminDrawEl.innerText = r;
      }, 80);
    } else {
      drawEl.classList.remove('rolling-anim');
      clearInterval(rollingTimer); rollingTimer=null;
      const lastNum = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
      drawEl.innerText = lastNum;
      if(adminDrawEl) adminDrawEl.innerText = lastNum;
      renderGrid();
      if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    // å¹¸é‹å…’é‚è¼¯ä¿®å¾©
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
       handleLuckyInput();
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    document.getElementById('count-total').innerText = allPlayersCache.length;
    if(currentUser.uid !== ALLOWED_UID){
      const me = allPlayersCache.find(p => p.id === currentUser.uid);
      if(me) { myData = me; renderGrid(); }
    }
  });

  // ç®¡ç†ç«¯é€šçŸ¥
  if(currentUser.uid === ALLOWED_UID){
    db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
      document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ æ­å–œï¼ç©å®¶ ã€${d.data().name}ã€‘ è³“æœé€£ç·šï¼</div>`).join('');
    });
  }
}

function handleLuckyInput() {
    let input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¤©é¸ä¹‹äººï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹å°šæœªé–‹å‡ºçš„è™Ÿç¢¼ (1-25)ï¼š`);
    if(input === null) return;
    let num = parseInt(input);
    if(!isNaN(num) && num >= 1 && num <= 25 && !gameHistory.includes(num)) {
        db.collection("pending_choices").doc(currentUser.uid).set({
            playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection("game_state").doc("current_game").update({ luckyUser: "" });
    } else {
        alert("ç„¡æ•ˆè™Ÿç¢¼æˆ–å·²ç¶“é–‹éå›‰ï¼");
        handleLuckyInput();
    }
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  const winIdx = new Set();
  let winLineCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
        line.forEach(i=>winIdx.add(i));
        winLineCount++;
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });

  // --- è§¸ç™¼æ…¶ç¥ç‰¹æ•ˆèˆ‡éŸ³æ•ˆ ---
  if(winLineCount > 0 && (myData.locked || isAllLockedGlobal)) {
    document.getElementById('bingo-status').innerText = `ğŸŠ å·²é”æˆ ${winLineCount} æ¢è³“æœé€£ç·šï¼ ğŸŠ`;
    if(!alreadyBingoed) {
        triggerCelebration();
        db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        alreadyBingoed = true;
    }
  }
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
  document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­...";
}

function triggerCelebration() {
    // æ’­æ”¾éŸ³æ¨‚
    const audio = document.getElementById('audio-bingo');
    audio.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾è¢«ç€è¦½å™¨é˜»æ””ï¼Œéœ€é»æ“Šé é¢ä¸€æ¬¡ã€‚"));
    // å™´ç™¼ç¢ç´™
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#d32f2f', '#ffb300', '#2e7d32']
    });
}

// v2.9.1 ä¿®å¾©çš„ç®—æ³•ï¼šè¨ˆç®— 12 æ¢ç·šä¸­æœ€é•·çš„ã€Œé€£çºŒå‘½ä¸­ã€
function calculateMaxConsecutive(board, history) {
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  let globalMax = 0;
  lines.forEach(line => {
    let currentMax = 0, streak = 0;
    line.forEach(index => {
      if(history.includes(board[index])) { streak++; currentMax = Math.max(currentMax, streak); }
      else { streak = 0; }
    });
    globalMax = Math.max(globalMax, currentMax);
  });
  return globalMax;
}

function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const max = calculateMaxConsecutive(p.board, gameHistory);
    if(max >= 5) counts[5]++; else if(max >= 2) counts[max]++;
  });
  document.getElementById('cnt-5').innerText = counts[5];
  document.getElementById('cnt-4').innerText = counts[4];
  document.getElementById('cnt-3').innerText = counts[3];
  document.getElementById('cnt-2').innerText = counts[2];
}

/* åŸºç¤åŠŸèƒ½ */
async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll();
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("å…¨éƒ¨æŠ½å®Œå›‰ï¼");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false, luckyUser: "" });
  }, 1500);
}

async function handleReset(){
  if(!confirm("ç¢ºå®šè¦å…¨é¢é‡ç½®å—ï¼Ÿ")) return;
  alreadyBingoed = false; // é‡ç½®è³“æœè§¸ç™¼ç‹€æ…‹
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
  const bes = await db.collection("bingo_events").get();
  bes.forEach(d => batch.delete(d.ref));
  await batch.commit();
  location.reload();
}

// å…¶ä»– doSignOut, shuffleArray, reRollBoard, confirmBoard ç­‰å‡½æ•¸èˆ‡ v2.9.1 ç›¸åŒï¼Œè«‹ä¿ç•™ã€‚
function doSignOut(){ auth.signOut(); location.reload(); }
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  if(!confirm("é–å®šå¾Œä¸èƒ½æ›è™Ÿï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
}
function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }
async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try { await auth.signInWithEmailAndPassword(email, pwd); closeAdminModal(); } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}
async function forceLockAll(){
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}
async function removeAllPlayers(){
    if(!confirm("ç§»é™¤æ‰€æœ‰ç©å®¶ï¼Ÿ")) return;
    const batch = db.batch();
    allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
    await batch.commit();
}
async function pickLucky(){
    if(!allPlayersCache.length) return alert("æ²’äºº");
    const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
    await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
    alert("å¤©é¸ä¹‹äººæ˜¯ï¼š" + lucky);
}
async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}
function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}
auth.onAuthStateChanged(user => {
  currentUser = user;
  if(!user) showView('login');
  else if(user.uid === ALLOWED_UID) { showView('admin'); startApp(); }
  else { showView('player'); startApp(); }
});
setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
}, 15000);
</script>
</body>
</html>
