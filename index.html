<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ±</title>

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root { --primary:#d32f2f; --accent:#ffb300; --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280; --success:#2e7d32; --dark:#2c3e50; }
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#222}
.container{max-width:980px;margin:20px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.brand h1{margin:0;font-size:1.4rem;color:var(--primary);cursor:pointer}
.info-badges{display:flex;gap:8px;align-items:center}
.badge{background:var(--card);padding:6px 10px;border-radius:999px;box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:700}
.admin-indicator{background:var(--accent);color:#111;padding:6px 10px;border-radius:8px;font-weight:700}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#fafafa;font-weight:800;font-size:1.1rem}
.cell.selected{background:var(--accent);color:#7b2b2b}
.controls{display:flex;gap:8px;justify-content:center;margin-top:12px}
.btn{padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
.btn.secondary{background:#546e7a}
.small{padding:8px 10px;font-size:0.9rem}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:120}
.modal .card{background:#fff;padding:18px;border-radius:12px;width:320px;max-width:92%}
.admin-login-input{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px}
.row{display:flex;gap:12px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
.side-panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.layout{display:grid;grid-template-columns:1fr 320px;gap:12px}
.admin-card{background:#34495e;color:#fff;padding:12px;border-radius:10px}
.small-muted{color:var(--muted);font-size:0.9rem}
.footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
.players-list{max-height:240px;overflow:auto;padding:6px}
.player-row{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px dashed #eee}
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px}
.admin-bingo-list{max-height:160px;overflow:auto;padding:6px;color:#fff}
@media(max-width:880px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="brand">
      <h1 onclick="handleAdminClick()">ğŸ§§ 2025 å°¾ç‰™è³“æœ</h1>
      <div class="small-muted">æ´»å‹•å‰ç«¯</div>
    </div>

    <div class="info-badges">
      <div id="version-badge" class="badge">ç‰ˆæ¬¡: v0.0.0</div>
      <div id="online-count" class="badge">åœ¨ç·š: 0</div>
      <div id="registered-count" class="badge">è¨»å†Š: 0</div>
      <div id="admin-badge" class="admin-indicator" style="display:none">ç®¡ç†æ¨¡å¼</div>
    </div>
  </div>

  <!-- login -->
  <div id="page-login" class="side-panel">
    <div class="col" style="align-items:center">
      <input id="username-input" placeholder="è«‹è¼¸å…¥æš±ç¨±ï¼ˆç©å®¶ï¼‰" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd" />
      <button id="btn-login" class="btn" style="width:100%" onclick="handleLogin()">ä»¥åŒ¿åç©å®¶ç™»å…¥</button>
      <div class="small-muted">è‹¥è¦ç®¡ç†è«‹é»å·¦ä¸Šæ¨™é¡Œ 5 æ¬¡ï¼ˆ3 ç§’å…§ï¼‰ä¸¦ä»¥ç®¡ç†å¸³è™Ÿç™»å…¥</div>
    </div>
  </div>

  <div class="layout" style="margin-top:12px">
    <div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
        <div id="current-draw" class="badge" style="font-size:2rem;padding:18px 28px;background:var(--card);box-shadow:0 8px 20px rgba(0,0,0,0.06)">READY</div>
        <div id="status-text" class="small-muted">è«‹å…ˆé–å®šç›¤é¢</div>
      </div>

      <div style="margin-top:12px">
        <div id="display-name" class="small-muted" style="margin-bottom:8px">æœªç™»å…¥</div>
        <div id="bingo-grid" class="grid" aria-hidden="false"></div>

        <div class="controls" id="setup-controls">
          <button class="btn secondary" onclick="generateBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button class="btn" id="btn-lock-real" onclick="lockBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="side-panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">ç®¡ç†è³‡è¨Š</div>
          <div class="small-muted" id="last-updated">-</div>
        </div>

        <div class="admin-card" style="margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div>å·²æŠ½è™Ÿç¢¼</div>
            <div id="admin-history" style="color:#fff"></div>
          </div>
        </div>

        <div class="admin-card" style="margin-bottom:8px">
          <div style="font-weight:700;margin-bottom:6px">å¾…å¯©æ ¸é¸è™Ÿ</div>
          <div id="pending-list" class="players-list"></div>
        </div>

        <div class="admin-card" style="margin-bottom:8px">
          <div style="font-weight:700;margin-bottom:6px">è³“æœé€šçŸ¥</div>
          <div id="admin-bingo-list" class="admin-bingo-list"></div>
        </div>

        <div class="side-panel" style="margin-top:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="font-weight:700">ç©å®¶æ¸…å–®</div>
            <div id="players-count" class="small-muted">0</div>
          </div>
          <div id="players-list" class="players-list"></div>
        </div>

      </div>
    </div>
  </div>

  <div class="footer">
    <div class="small-muted">è«‹ç¢ºèª Firebase config èˆ‡ Security Rules å·²æ­£ç¢ºè¨­å®š</div>
  </div>
</div>

<!-- LUCKY MODAL -->
<div id="lucky-modal" class="modal">
  <div class="card">
    <h3>ğŸŒŸ å¤©é¸ä¹‹äºº</h3>
    <p>è«‹è¼¸å…¥ä¸‹ä¸€å€‹é–‹çè™Ÿç¢¼ (1-25)</p>
    <input id="lucky-num-input" type="number" min="1" max="25" class="admin-login-input" />
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="submitLuckyChoice()">é€å‡º</button>
      <button class="btn secondary" onclick="document.getElementById('lucky-modal').style.display='none'">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="admin-login-modal" class="modal">
  <div class="card">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="ç®¡ç†è€… Email" class="admin-login-input" />
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" class="admin-login-input" />
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="adminSignIn()">ç™»å…¥</button>
      <button class="btn secondary" onclick="closeAdminLogin()">å–æ¶ˆ</button>
    </div>
    <div id="admin-login-msg" class="small-muted" style="margin-top:8px;color:#c0392b"></div>
  </div>
</div>

<script>
/* =========================
   è¨­å®šï¼šè«‹æ›¿æ› firebaseConfig èˆ‡ ALLOWED_ADMIN_UIDSã€APP_VERSION
   ========================= */
const APP_VERSION = "v1.0.0"; // é¡¯ç¤ºç‰ˆæ¬¡
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_ADMIN_UIDS = ["z6bA9TzIhPUqXBxSyoIlZGBETwy1"]; // èˆ‡ Rules ä¿æŒä¸€è‡´
const ONLINE_THRESHOLD_MS = 30000;
const ONLINE_WARNING_MS = 60000;

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* =========================
   å…¨åŸŸè®Šæ•¸
   ========================= */
let currentUser = null;
let myData = { name:"", board:[], locked:false, boardStr:"", maxConsecutive:0, version:0 };
let gameHistory = [];
let rollingInterval = null;
let heartbeatTimer = null;
let adminClickCount = 0;
let adminClickTimeout = null;

/* åˆå§‹åŒ–ç‰ˆæ¬¡é¡¯ç¤º */
document.getElementById('version-badge').innerText = 'ç‰ˆæ¬¡: ' + APP_VERSION;

/* =========================
   è¼‰å…¥ç©å®¶è³‡æ–™ï¼ˆåªå½±éŸ¿ç•¶å‰ä½¿ç”¨è€…ï¼‰
   ========================= */
async function loadPlayerData(uid, displayNameIfMissing) {
  if(!uid) return;
  const docRef = db.collection("players").doc(uid);
  const docSnap = await docRef.get();
  if(docSnap.exists) {
    const d = docSnap.data();
    myData = {
      name: d.name || displayNameIfMissing || "",
      board: d.board || Array.from({length:25},(_,i)=>i+1),
      boardStr: d.boardStr || (d.board ? d.board.join(',') : ""),
      locked: !!d.locked,
      maxConsecutive: d.maxConsecutive || 0,
      version: d.version || 0
    };
  } else {
    const board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    myData = { name: displayNameIfMissing || "", board, boardStr: board.join(','), locked:false, maxConsecutive:0, version:1 };
    await docRef.set({
      name: myData.name,
      board: myData.board,
      boardStr: myData.boardStr,
      locked: false,
      maxConsecutive: 0,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      version: 1
    });
  }
  // ç«‹å³æ›´æ–° lastSeen
  await db.collection('players').doc(uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  document.getElementById('display-name').innerText = myData.name || 'ç©å®¶';
  renderBoard();
}

/* =========================
   ç©å®¶åŒ¿åç™»å…¥æµç¨‹
   ========================= */
async function handleLogin() {
  const name = document.getElementById('username-input').value.trim();
  if(!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
  document.getElementById('btn-login').disabled = true;
  try {
    if(auth.currentUser && !auth.currentUser.isAnonymous) {
      await auth.signOut();
    }
    if(!auth.currentUser || !auth.currentUser.isAnonymous) {
      await auth.signInAnonymously();
    }
    currentUser = auth.currentUser;
    await loadPlayerData(currentUser.uid, name);
    switchPageToGame();
    startListeners(); // å•Ÿå‹•ç›£è½ï¼ˆè‹¥å°šæœªï¼‰
    // heartbeat
    if(heartbeatTimer) clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(() => {
      if(currentUser && currentUser.isAnonymous) {
        db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
      }
    }, 15000);
  } catch(e) {
    alert("ç™»å…¥å¤±æ•—: " + (e.message || e));
    document.getElementById('btn-login').disabled = false;
  }
}

/* =========================
   UI åˆ‡æ›
   ========================= */
function switchPageToGame() {
  document.getElementById('page-login').style.display = 'none';
  document.getElementById('display-name').innerText = myData.name || 'ç©å®¶';
  document.getElementById('setup-controls').style.display = myData.locked ? 'none' : 'flex';
}
function switchPageToLogin() {
  document.getElementById('page-login').style.display = 'block';
  document.getElementById('admin-badge').style.display = 'none';
}

/* =========================
   ç›£è½å™¨èˆ‡å³æ™‚è™•ç†ï¼ˆåŒ…å« players èˆ‡ game_stateï¼‰
   ========================= */
let listenersStarted = false;
function startListeners() {
  if(listenersStarted) return;
  listenersStarted = true;

  // game_state ç›£è½
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.exists ? doc.data() : null;
    if(!data) {
      gameHistory = [];
      document.getElementById('current-draw').innerText = "READY";
      return;
    }
    gameHistory = data.history || [];
    const pending = data.pendingNumber != null ? data.pendingNumber : null;
    const isAdminClient = currentUser && ALLOWED_ADMIN_UIDS.includes(currentUser.uid);

    // pending / isRolling é¡¯ç¤º
    if(data.isRolling) {
      if(isAdminClient && pending != null) {
        if(rollingInterval) { clearInterval(rollingInterval); rollingInterval = null; }
        document.getElementById('current-draw').innerText = pending;
      } else {
        if(!rollingInterval) {
          rollingInterval = setInterval(()=> {
            document.getElementById('current-draw').innerText = Math.floor(Math.random()*25)+1;
          }, 80);
        }
      }
    } else {
      if(rollingInterval) { clearInterval(rollingInterval); rollingInterval = null; }
      document.getElementById('current-draw').innerText = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
      renderBoard();
    }

    // lucky modal
    if(myData.name && data.luckyUser && data.luckyUser === myData.name && myData.locked && !data.isRolling) {
      document.getElementById('lucky-modal').style.display = 'flex';
    } else {
      document.getElementById('lucky-modal').style.display = 'none';
    }

    // admin history display
    document.getElementById('admin-history').innerText = (data.history || []).join(', ');
    document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();
  });

  // pending_choices ç›£è½
  db.collection("pending_choices").onSnapshot(snap => {
    const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    document.getElementById('pending-list').innerHTML = list.map(p => {
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;color:#fff">
        <div>${escapeHtml(p.playerName)}: ${p.number}</div>
        <div style="display:flex;gap:6px">
          <button class="small" style="background:#27ae60;color:#fff;border-radius:6px" onclick="approveLucky(${p.number},'${p.id}')">ç¢ºèª</button>
          <button class="small" style="background:#c0392b;color:#fff;border-radius:6px" onclick="rejectPending('${p.id}')">æ‹’çµ•</button>
        </div>
      </div>`;
    }).join('');
  });

  // bingo_events ç›£è½ï¼ˆç®¡ç†ç«¯ï¼‰
  db.collection("bingo_events").orderBy('timestamp','desc').onSnapshot(snap => {
    const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    document.getElementById('admin-bingo-list').innerHTML = list.map(e => {
      const t = e.timestamp && e.timestamp.toDate ? e.timestamp.toDate().toLocaleString() : '';
      return `<div style="padding:6px 0">${escapeHtml(e.name)} (${e.uid}) - ${e.maxConsecutive} - ${t}</div>`;
    }).join('');
  });

  // players é›†åˆç›£è½ï¼ˆè¨»å†Šèˆ‡åœ¨ç·šï¼‰
  db.collection("players").onSnapshot(snap => {
    const now = Date.now();
    let online = 0;
    const rows = snap.docs.map(d => {
      const data = d.data();
      const ts = data.lastSeen && data.lastSeen.toMillis ? data.lastSeen.toMillis() : (data.lastSeen ? new Date(data.lastSeen).getTime() : 0);
      const diff = now - ts;
      const status = diff < ONLINE_THRESHOLD_MS ? 'online' : (diff < ONLINE_WARNING_MS ? 'idle' : 'offline');
      if(status === 'online') online++;
      return { id:d.id, name:data.name || d.id, status, lastSeen:ts };
    });

    // æ›´æ–° UI
    document.getElementById('online-count').innerText = 'åœ¨ç·š: ' + online;
    document.getElementById('registered-count').innerText = 'è¨»å†Š: ' + snap.size;
    document.getElementById('players-count').innerText = snap.size;

    // players list
    document.getElementById('players-list').innerHTML = rows.map(r => {
      const color = r.status === 'online' ? '#2ecc71' : (r.status === 'idle' ? '#f1c40f' : '#95a5a6');
      return `<div class="player-row"><div>${escapeHtml(r.name)}</div><div style="display:flex;align-items:center"><span class="status-dot" style="background:${color}"></span><span class="small-muted">${r.status}</span></div></div>`;
    }).join('');
  });
}

/* =========================
   UI èˆ‡ç›¤é¢æ¸²æŸ“
   ========================= */
function renderBoard() {
  const grid = document.getElementById('bingo-grid');
  grid.innerHTML = "";
  if(!myData.board || myData.board.length !== 25) {
    myData.board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    myData.boardStr = myData.board.join(',');
  }
  myData.board.forEach(num => {
    const div = document.createElement('div');
    div.className = 'cell' + (gameHistory.includes(num) ? ' selected' : '');
    div.innerText = num;
    grid.appendChild(div);
  });
  document.getElementById('setup-controls').style.display = myData.locked ? 'none' : 'flex';
  document.getElementById('status-text').innerText = myData.locked ? 'ç›¤é¢å·²é–å®šï¼Œç¥ä¸­çï¼' : 'è«‹å…ˆé–å®šè™Ÿç¢¼';
}

/* ç”¢ç”Ÿæ–°ç›¤ */
function generateBoard() {
  myData.board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
  myData.boardStr = myData.board.join(',');
  renderBoard();
}

/* =========================
   é–å®šç›¤é¢ï¼ˆå…ˆæª¢æŸ¥ board_indexï¼Œå† transactionï¼Œå«æ¨‚è§€é–ï¼‰
   ========================= */
async function lockBoard() {
  if(!currentUser || !currentUser.isAnonymous) {
    alert("è«‹å…ˆä»¥ç©å®¶èº«ä»½ï¼ˆåŒ¿åï¼‰ç™»å…¥å†é–å®šç›¤é¢ã€‚è‹¥æ‚¨æ˜¯ç®¡ç†è€…ï¼Œè«‹åœ¨å¦ä¸€å€‹ç€è¦½å™¨æˆ–ç„¡ç—•è¦–çª—ç™»å…¥ç®¡ç†å¸³è™Ÿä»¥é¿å…è¦†è“‹ç©å®¶è³‡æ–™ã€‚");
    return;
  }
  if(!confirm("é–å®šå¾Œä¸å¯æ›´æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;

  const bStr = myData.board.join(',');
  const boardIndexRef = db.collection("board_index").doc(encodeKey(bStr));
  const playerRef = db.collection("players").doc(currentUser.uid);
  const auditRef = db.collection("audit_logs").doc();

  try {
    const idxSnap = await boardIndexRef.get();
    if(idxSnap.exists) {
      return alert("ç›¤é¢é‡è¤‡ï¼Œè«‹é‡æ–°æ›è™Ÿ");
    }

    await db.runTransaction(async tx => {
      const playerSnap = await tx.get(playerRef);
      const currentVersion = playerSnap.exists ? (playerSnap.data().version || 0) : 0;
      const idxSnapTx = await tx.get(boardIndexRef);
      if(idxSnapTx.exists) throw new Error("board_exists");
      const knownVersion = myData.version || 0;
      if(currentVersion !== knownVersion) throw new Error("version_mismatch");

      tx.set(boardIndexRef, { uid: currentUser.uid, boardStr: bStr, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      tx.update(playerRef, {
        board: myData.board,
        boardStr: bStr,
        locked: true,
        version: currentVersion + 1,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
      tx.set(auditRef, {
        action: "lock_board",
        detail: { uid: currentUser.uid, name: myData.name, boardStr: bStr },
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    myData.locked = true;
    myData.boardStr = bStr;
    myData.version = (myData.version || 0) + 1;
    renderBoard();
    alert("é–å®šæˆåŠŸ");
  } catch(e) {
    if(e.message === "board_exists") alert("ç›¤é¢å·²è¢«å…¶ä»–ç©å®¶å…ˆé–å®šï¼Œè«‹é‡æ–°æ›è™Ÿ");
    else if(e.message === "version_mismatch") alert("è³‡æ–™ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œè«‹é‡æ–°è¼‰å…¥æˆ–é‡è©¦");
    else alert("é–å®šå¤±æ•—: " + (e.message || e));
  }
}

/* =========================
   å¹¸é‹å…’é€å‡ºè™Ÿç¢¼ï¼ˆç©å®¶ç«¯ï¼‰
   ========================= */
async function submitLuckyChoice() {
  if(!currentUser || !currentUser.isAnonymous) return alert("è«‹å…ˆä»¥ç©å®¶èº«ä»½ç™»å…¥");
  const num = parseInt(document.getElementById('lucky-num-input').value);
  if(isNaN(num) || num < 1 || num > 25) return alert("è«‹è¼¸å…¥ 1-25 çš„è™Ÿç¢¼");
  if(gameHistory.includes(num)) return alert("è™Ÿç¢¼å·²é–‹é");

  try {
    await db.collection("pending_choices").doc(currentUser.uid).set({
      playerName: myData.name,
      number: num,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    db.collection("audit_logs").add({
      action: "submit_pending_choice",
      detail: { uid: currentUser.uid, name: myData.name, number: num },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(()=>{});
    alert("å·²é€å‡ºï¼Œç­‰å¾…é–‹ç");
    document.getElementById('lucky-modal').style.display = 'none';
  } catch(e) {
    alert("é€å‡ºå¤±æ•—: " + (e.message || e));
  }
}

/* ç®¡ç†ç«¯æ‹’çµ• pending */
async function rejectPending(id) {
  if(!confirm("ç¢ºå®šè¦æ‹’çµ•æ­¤é¸è™Ÿï¼Ÿ")) return;
  try {
    await db.collection("pending_choices").doc(id).delete();
    db.collection("audit_logs").add({
      action: "reject_pending_choice",
      detail: { id },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(()=>{});
  } catch(e) { alert("æ‹’çµ•å¤±æ•—"); }
}

/* ç®¡ç†ç«¯å¯©æ ¸ pendingï¼ˆtransactionï¼‰ */
async function approveLucky(num, pendingId) {
  if(!confirm("ç¢ºèªè¦æŠŠ " + num + " å¯«å…¥é–‹çç´€éŒ„ï¼Ÿ")) return;
  const gameRef = db.collection("game_state").doc("current_game");
  const pendingRef = db.collection("pending_choices").doc(pendingId);
  const auditRef = db.collection("audit_logs").doc();

  try {
    await db.runTransaction(async tx => {
      const gameSnap = await tx.get(gameRef);
      const history = gameSnap.exists ? (gameSnap.data().history || []) : [];
      if(history.includes(num)) throw new Error("already_drawn");
      tx.update(gameRef, {
        history: firebase.firestore.FieldValue.arrayUnion(num),
        luckyUser: ""
      });
      tx.delete(pendingRef);
      tx.set(auditRef, {
        action: "approve_pending_choice",
        detail: { number: num, pendingId },
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    alert("å·²ç¢ºèªä¸¦å¯«å…¥é–‹çç´€éŒ„");
  } catch(e) {
    if(e.message === "already_drawn") {
      alert("è©²è™Ÿç¢¼å·²è¢«å…¶ä»–äººå…ˆé–‹å‡ºï¼Œæ“ä½œå–æ¶ˆ");
      db.collection("pending_choices").doc(pendingId).delete().catch(()=>{});
    } else {
      alert("å¯©æ ¸å¤±æ•—: " + (e.message || e));
    }
  }
}

/* =========================
   æŠ½è™Ÿï¼ˆæ–¹æ¡ˆ Bï¼špendingNumber + transactionï¼‰
   ========================= */
async function drawNumber() {
  const ref = db.collection("game_state").doc("current_game");
  try {
    const snap = await ref.get();
    const h = snap.exists ? (snap.data().history || []) : [];
    const avail = Array.from({length:25},(_,i)=>i+1).filter(n=>!h.includes(n));
    if(avail.length === 0) return alert("æ‰€æœ‰è™Ÿç¢¼å·²é–‹å®Œ");
    const newNum = avail[Math.floor(Math.random()*avail.length)];

    // 1) å…ˆå¯«å…¥ pendingNumber èˆ‡ isRollingï¼ˆç„¡ preconditionï¼‰
    await ref.update({ isRolling: true, pendingNumber: newNum });

    // 2) å¯©è¨ˆé–‹å§‹
    await db.collection("audit_logs").add({
      action: "start_draw",
      detail: { newNum },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 3) ç­‰å¾…å‹•ç•«æ™‚é–“ï¼ˆç®¡ç†ç«¯æœƒçœ‹åˆ° pendingNumberï¼‰
    await new Promise(r => setTimeout(r, 3000));

    // 4) transaction å˜—è©¦æŠŠ pendingNumber æ¨å…¥ history
    try {
      await db.runTransaction(async tx => {
        const g = await tx.get(ref);
        const h2 = g.exists ? (g.data().history || []) : [];
        if(h2.includes(newNum)) {
          tx.update(ref, { isRolling: false, pendingNumber: firebase.firestore.FieldValue.delete(), luckyUser: "" });
        } else {
          tx.update(ref, {
            history: firebase.firestore.FieldValue.arrayUnion(newNum),
            isRolling: false,
            pendingNumber: firebase.firestore.FieldValue.delete(),
            luckyUser: ""
          });
        }
        tx.set(db.collection("audit_logs").doc(), {
          action: "draw_number",
          detail: { number: newNum },
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
    } catch (txErr) {
      console.warn('transaction failed, clearing pendingNumber', txErr);
      await ref.update({ isRolling: false, pendingNumber: firebase.firestore.FieldValue.delete(), luckyUser: "" }).catch(()=>{});
      throw txErr;
    }
  } catch(e) {
    console.error('drawNumber error', e);
    alert('æŠ½è™Ÿå¤±æ•—: ' + (e.message || e));
  }
}

/* =========================
   æŠ½å¹¸é‹å…’ï¼ˆç®¡ç†ç«¯ï¼‰
   ========================= */
async function pickLuckyPlayer() {
  try {
    const snap = await db.collection("players").where("locked","==",true).get();
    const players = snap.docs.map(d => ({ uid:d.id, ...d.data() }));
    if(players.length === 0) return alert("å°šç„¡ç©å®¶é–å®šç›¤é¢");
    players.sort((a,b) => (a.maxConsecutive || 0) - (b.maxConsecutive || 0));
    const candidates = players.slice(0, Math.min(15, players.length));
    const lucky = candidates[Math.floor(Math.random()*candidates.length)];
    await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name || lucky.uid });
    await db.collection("audit_logs").add({
      action: "pick_lucky_player",
      detail: { uid: lucky.uid, name: lucky.name },
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("å·²é¸å‡ºå¹¸é‹å€™é¸äºº: " + (lucky.name || lucky.uid));
  } catch(e) {
    alert("æŠ½å¹¸é‹å…’å¤±æ•—: " + (e.message || e));
  }
}

/* =========================
   è¨ˆç®— maxConsecutive èˆ‡è³“æœé€šçŸ¥
   ========================= */
function calculateMaxConsecutive(board, history) {
  const grid = [];
  for(let i=0;i<5;i++) grid[i] = board.slice(i*5, i*5+5);
  let maxLen = 0;
  for(let r=0;r<5;r++) maxLen = Math.max(maxLen, longestStreak(grid[r], history));
  for(let c=0;c<5;c++){ const col=[]; for(let r=0;r<5;r++) col.push(grid[r][c]); maxLen = Math.max(maxLen, longestStreak(col, history)); }
  const diag1=[], diag2=[]; for(let i=0;i<5;i++){ diag1.push(grid[i][i]); diag2.push(grid[i][4-i]); }
  maxLen = Math.max(maxLen, longestStreak(diag1, history)); maxLen = Math.max(maxLen, longestStreak(diag2, history));
  return maxLen;
}
function longestStreak(line, history) {
  let streak=0,maxStreak=0;
  for(const num of line){ if(history.includes(num)){ streak++; maxStreak=Math.max(maxStreak,streak);} else streak=0; }
  return maxStreak;
}
async function notifyBingoIfNeeded(uid, name, boardStr, maxConsecutive) {
  if(maxConsecutive >= 5) {
    const eventRef = db.collection('bingo_events').doc(uid);
    await eventRef.set({
      uid, name, boardStr, maxConsecutive,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true }).catch(()=>{});
    db.collection('audit_logs').add({
      action:'bingo_declared',
      detail:{uid,name,maxConsecutive,boardStr},
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(()=>{});
  }
}

/* =========================
   ç®¡ç†è€…ç™»å…¥ï¼ˆEmail/Passwordï¼‰èˆ‡ UID ç™½åå–®æª¢æŸ¥
   ========================= */
function handleAdminClick() {
  adminClickCount++;
  if(adminClickTimeout) clearTimeout(adminClickTimeout);
  adminClickTimeout = setTimeout(()=>{ adminClickCount=0; adminClickTimeout=null; }, 3000);
  if(adminClickCount >= 5) {
    adminClickCount = 0;
    if(adminClickTimeout){ clearTimeout(adminClickTimeout); adminClickTimeout=null; }
    document.getElementById('admin-login-modal').style.display = 'flex';
  }
}
function closeAdminLogin() {
  document.getElementById('admin-login-modal').style.display = 'none';
  document.getElementById('admin-login-msg').innerText = '';
  document.getElementById('admin-email').value = '';
  document.getElementById('admin-pwd').value = '';
}
async function adminSignIn() {
  const email = document.getElementById('admin-email').value.trim();
  const pwd = document.getElementById('admin-pwd').value;
  const msgEl = document.getElementById('admin-login-msg'); msgEl.innerText = '';
  if(!email || !pwd){ msgEl.innerText='è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼'; return; }
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    const user = cred.user;
    if(!user) throw new Error('ç™»å…¥å¤±æ•—');
    if(ALLOWED_ADMIN_UIDS.includes(user.uid)) {
      closeAdminLogin();
      startAdminAfterAuth(user);
      return;
    } else {
      await auth.signOut();
      msgEl.innerText = 'æ­¤å¸³è™Ÿéç®¡ç†è€…ï¼Œè«‹ä½¿ç”¨ç®¡ç†è€…å¸³è™Ÿç™»å…¥';
      return;
    }
  } catch(e) {
    console.error('adminSignIn error', e);
    if(e.code === 'auth/user-not-found') msgEl.innerText='æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ';
    else if(e.code === 'auth/wrong-password') msgEl.innerText='å¯†ç¢¼éŒ¯èª¤';
    else if(e.code === 'auth/invalid-email') msgEl.innerText='Email æ ¼å¼éŒ¯èª¤';
    else msgEl.innerText = 'ç™»å…¥å¤±æ•—: ' + (e.message || e);
  }
}
function startAdminAfterAuth(user) {
  document.getElementById('admin-badge').style.display = ALLOWED_ADMIN_UIDS.includes(user.uid) ? 'inline-block' : 'none';
  // é€²å…¥ç®¡ç†é ï¼ˆç®¡ç†é  UI å·²åœ¨å³å´ï¼‰
  // ç¢ºä¿ listeners å·²å•Ÿå‹•
  startListeners();
  // show admin controls visually
  alert('ç®¡ç†è€…ç™»å…¥æˆåŠŸ');
}
async function adminSignOut() {
  try { await auth.signOut(); } catch(e){ console.warn(e); }
  document.getElementById('admin-badge').style.display = 'none';
  switchPageToLogin();
}

/* =========================
   å·¥å…·å‡½å¼
   ========================= */
function encodeKey(s){ return encodeURIComponent(s); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* =========================
   Auth state ç›£è½èˆ‡åˆå§‹åŒ–
   ========================= */
auth.onAuthStateChanged(async user => {
  currentUser = user || null;
  console.log('Auth state changed:', user ? (user.uid + ' anonymous:' + user.isAnonymous) : 'signed out');
  if(!user) {
    switchPageToLogin();
    if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; }
    return;
  }
  // è‹¥ç‚ºåŒ¿åä½¿ç”¨è€…ï¼Œè¼‰å…¥è³‡æ–™ï¼ˆè‹¥å°šæœªï¼‰
  if(user.isAnonymous) {
    if(!myData || !myData.board || myData.board.length !== 25) {
      await loadPlayerData(user.uid, document.getElementById('username-input')?.value || "");
    }
    // å•Ÿå‹• listeners èˆ‡ heartbeat
    startListeners();
    if(heartbeatTimer) clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(() => {
      if(currentUser && currentUser.isAnonymous) {
        db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
      }
    }, 15000);
  } else {
    // éåŒ¿åï¼ˆç®¡ç†è€…ï¼‰ç™»å…¥æ™‚ï¼Œä¸è¦è‡ªå‹•å»ºç«‹æˆ–ä¿®æ”¹ players/{uid}
    document.getElementById('admin-badge').style.display = ALLOWED_ADMIN_UIDS.includes(user.uid) ? 'inline-block' : 'none';
    startListeners();
  }
});

/* =========================
   æ¸…ç†
   ========================= */
window.addEventListener('beforeunload', () => {
  if(rollingInterval) clearInterval(rollingInterval);
  if(heartbeatTimer) clearInterval(heartbeatTimer);
});

/* =========================
   å•Ÿå‹• players listener ä»¥é¡¯ç¤ºè¨»å†Šèˆ‡åœ¨ç·šï¼ˆç«‹å³å‘¼å«ï¼‰
   ========================= */
startListeners();
</script>
</body>
</html>
