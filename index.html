<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.7</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#b71c1c; --accent:#ffb300; --bg:#f4f6f8; --card:#fff;
  --muted:#6b7280; --success:#2e7d32; --danger:#c62828; --shadow:0 6px 18px rgba(16,24,40,0.06);
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Noto Sans TC", "Microsoft JhengHei", system-ui;background:var(--bg);color:#111}
.container{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.title{font-size:1.25rem;color:var(--primary);cursor:pointer;user-select:none}
.user-info{font-weight:600;color:var(--muted)}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.hidden{display:none}
.btn{padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff}
.btn.ghost{background:#f3f4f6;color:#111}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-box{background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);padding:10px;border-radius:10px;text-align:center}
.stat-val{font-weight:800;color:var(--accent);display:block;font-size:1.1rem}
.pending-list{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:#fff}
.status-log{max-height:200px;overflow:auto;padding:10px;border-radius:8px;background:#0f172a;color:#fff;font-size:0.9rem}
.status-item{padding:6px;border-bottom:1px solid rgba(255,255,255,0.06)}
.status-success{color:#b7f5c6}
.history-ball{display:inline-block;width:32px;height:32px;line-height:32px;background:var(--primary);color:white;border-radius:50%;margin:4px;text-align:center;font-weight:bold;font-size:0.9rem}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:420px;margin:10px auto}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:#fbfdff;border-radius:10px;border:1px solid #eef2f7;font-weight:700}
.cell.selected{background:#fff7e6;color:#b25600}
.cell.bingo-line{background:var(--success);color:#fff;animation:pulse 900ms infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
.small{font-size:0.85rem;color:var(--muted)}
/* å½ˆçª—æ¨£å¼ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:white;padding:24px;border-radius:16px;width:320px}
</style>
</head>
<body>

<div id="admin-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 style="margin-top:0">ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd">
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
    <button class="btn ghost" style="width:100%;margin-top:8px;" onclick="closeAdminModal()">å–æ¶ˆ</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ± v2.7</div>
    <div id="user-info" class="user-info">æœªç™»å…¥</div>
  </div>

  <div id="view-login" class="card">
    <h3>ç©å®¶ç™»å…¥</h3>
    <div style="max-width:400px">
      <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥å§“åé€²å…¥éŠæˆ²" style="width:100%;padding:12px;border-radius:8px;border:1px solid #e6e9ee" />
      <div style="height:12px"></div>
      <button class="btn primary" style="width:100%" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
    </div>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-weight:700" id="player-name-display"></div><div class="small">ç©å®¶</div></div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      <div style="margin-top:12px;text-align:center">
        <div id="draw-display" style="font-size:3.6rem;font-weight:800;color:var(--primary);height:90px;line-height:90px">READY</div>
        <div id="bingo-status" class="small" style="height:26px;margin-bottom:8px;color:var(--success);font-weight:700"></div>
        <div id="bingo-grid" class="grid"></div>
        <div id="setup-btns" style="margin-top:12px;display:flex;gap:10px;justify-content:center">
          <button id="btn-reroll" class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button id="btn-lock" class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-weight:700">ç®¡ç†è€…æ§åˆ¶å°</div><div class="small">ADMIN</div></div>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>

      <div style="margin-top:12px" class="stat-grid">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="small">åœ¨ç·š</span></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="small">ç¸½äººæ•¸</span></div>
      </div>

      <div style="margin-top:10px" class="small">æœ€å¤§é€£è™Ÿäººæ•¸åˆ†ä½ˆ</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="stat-box" style="flex:1"><span id="cnt-5" class="stat-val">0</span><span class="small">5+</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-4" class="stat-val">0</span><span class="small">4</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-3" class="stat-val">0</span><span class="small">3</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-2" class="stat-val">0</span><span class="small">2</span></div>
      </div>

      <div style="margin-top:12px;text-align:center;background:#fff8e1;padding:12px;border-radius:10px">
        <div class="small">æœ€æ–°è™Ÿç¢¼</div>
        <div id="admin-sync-num" style="font-size:2.2rem;font-weight:800;color:var(--primary)">--</div>
      </div>

      <div class="card" style="margin-top:12px; background:#f9fafb">
        <div style="font-weight:700;margin-bottom:8px">ğŸ”¢ å·²æŠ½éè™Ÿç¢¼æ¸…å–®</div>
        <div id="drawn-history-list" style="min-height:40px"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="btn-draw" class="btn primary" style="flex:1" onclick="drawNewNumber()">ğŸ² éš¨æ©ŸæŠ½è™Ÿ</button>
        <button id="btn-pick" class="btn" style="flex:1;background:var(--accent);color:#000" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
        <button class="btn ghost" onclick="handleReset()">âš ï¸ é‡ç½®</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:700;margin-bottom:8px">ğŸ“¢ è³“æœåå–® / å¾…æ ¸é¸è™Ÿ</div>
        <div id="pending-choices" class="pending-list" style="margin-bottom:10px"></div>
        <div id="bingo-alerts" class="pending-list"></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">ç³»çµ±ç´€éŒ„</div>
        <div id="status-log" class="status-log"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* Firebase åˆå§‹åŒ– (ä¿æŒèˆ‡æ‚¨æä¾›çš„é…ç½®ä¸€è‡´) */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let adminClickCount = 0;

/* --- éš±è—å¼å…¥å£é‚è¼¯ --- */
function triggerAdmin() {
  adminClickCount++;
  if(adminClickCount >= 5) {
    document.getElementById('admin-modal').style.display = 'flex';
    adminClickCount = 0;
  }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) {
      closeAdminModal();
      logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ");
    } else { alert("éç®¡ç†å“¡å¸³è™Ÿ"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

/* --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ --- */
auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
  
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){ myData = snap.data(); } 
  else {
    const name = document.getElementById('player-name').value || "ç©å®¶";
    const board = shuffleArray();
    myData = { name, board, locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  document.getElementById('player-name-display').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[] };
    gameHistory = data.history || [];
    
    // æ›´æ–°è™Ÿç¢¼æ­·å²æ¸…å–® (ç®¡ç†å“¡ä»‹é¢)
    updateHistoryUI(gameHistory);

    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const r = Math.floor(Math.random()*25)+1;
        document.getElementById('draw-display').innerText = r;
        if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = r;
      }, 80);
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      document.getElementById('draw-display').innerText = last;
      if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = last;
      renderGrid();
      if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => d.data());
    document.getElementById('count-total').innerText = allPlayersCache.length;
    if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
  });

  if(currentUser.uid === ALLOWED_UID){
    db.collection("pending_choices").onSnapshot(snap => {
      document.getElementById('pending-choices').innerHTML = snap.docs.map(d => {
        const p = d.data();
        return `<div style="padding:6px;border-bottom:1px solid #eee;display:flex;justify-content:space-between">
          <span><b>${p.playerName}</b> é¸äº† ${p.number}</span>
          <button class="btn ghost" style="padding:2px 8px" onclick="confirmLucky('${d.id}', ${p.number})">ç¢ºèª</button>
        </div>`;
      }).join('');
    });
    db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
      document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ ${d.data().name} è³“æœï¼</div>`).join('');
    });
  }
}

// æ›´æ–°å·²æŠ½éè™Ÿç¢¼çš„ UI
function updateHistoryUI(history) {
  const container = document.getElementById('drawn-history-list');
  if(!container) return;
  if(!history.length) { container.innerHTML = '<span class="small">å°šç„¡æŠ½è™Ÿç´€éŒ„</span>'; return; }
  container.innerHTML = history.map(n => `<span class="history-ball">${n}</span>`).join('');
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) line.forEach(i=>winIdx.add(i));
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  document.getElementById('setup-btns').style.display = myData.locked ? 'none' : 'flex';
}

/* ç®¡ç†å“¡åŠŸèƒ½ */
async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false });
  }, 1500);
}

async function handleReset(){
  if(!confirm("é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿ")) return;
  const batch = db.batch();
  const colls = ["players","pending_choices","bingo_events"];
  for(const c of colls){
    const s = await db.collection(c).get();
    s.forEach(d=>batch.delete(d.ref));
  }
  batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false });
  await batch.commit();
  location.reload();
}

function doSignOut(){ auth.signOut(); location.reload(); }
function logStatus(msg){ 
  const el = document.getElementById('status-log');
  if(el) el.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
}
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true, board:myData.board });
  myData.locked = true; renderGrid();
}
// å·¥å…·ï¼šé€£è™Ÿçµ±è¨ˆ (æ²¿ç”¨ v2.6 æ¼”ç®—æ³•)
function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const max = calculateMaxConnected(p.board, gameHistory);
    if(max>=5) counts[5]++; else if(max>=2) counts[max]++;
  });
  if(document.getElementById('cnt-5')) {
    document.getElementById('cnt-5').innerText = counts[5];
    document.getElementById('cnt-4').innerText = counts[4];
    document.getElementById('cnt-3').innerText = counts[3];
    document.getElementById('cnt-2').innerText = counts[2];
  }
}
function calculateMaxConnected(board, history){
  const marked = new Set();
  board.forEach((n,i)=>{ if(history.includes(n)) marked.add(i); });
  if(!marked.size) return 0;
  let max=0; const visited=new Set();
  for(let i=0;i<25;i++){
    if(marked.has(i) && !visited.has(i)){
      let c=0, stack=[i]; visited.add(i);
      while(stack.length){
        const curr=stack.pop(); c++;
        const r=Math.floor(curr/5), col=curr%5;
        [curr-5, curr+5, curr-1, curr+1].forEach((n,idx)=>{
          if(n>=0 && n<25 && !(idx==2 && col==0) && !(idx==3 && col==4) && marked.has(n) && !visited.has(n)){
            visited.add(n); stack.push(n);
          }
        });
      }
      if(c>max) max=c;
    }
  }
  return max;
}
</script>
</body>
</html>
