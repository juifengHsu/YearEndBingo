<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.3</title>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --primary: #f45925;
  --primary-dark: #d64010;
  --bg: #f8f6f5;
  --card: #ffffff;
  --text-main: #1c110d;
  --muted: #6b7280;
  --success: #2e7d32;
  --special: #673ab7;
  --radius: 1rem;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; font-family: 'Spline Sans', 'Noto Sans TC', sans-serif;
  background-color: var(--bg); color: var(--text-main); line-height: 1.5;
}

.container { max-width: 600px; margin: 0 auto; padding: 16px; }

.card {
  background: var(--card); border-radius: var(--radius);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #f4eae7;
  padding: 20px; margin-bottom: 20px;
}

.hidden { display: none !important; }

/* ä¿®æ­£å¾Œçš„ .cell æ’ç‰ˆ */
.grid {
  display: flex; flex-wrap: wrap; gap: 8px; width: 100%;
  justify-content: center; margin: 15px 0;
}
.cell {
  width: calc((100% - 32px) / 5);
  aspect-ratio: 1 / 1;
  background: #f4eae7; color: var(--text-main); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 1.2rem; user-select: none;
}
.cell.selected { background-color: var(--primary); color: white; }
.cell.bingo-line { background: var(--success); color: white; }

#draw-display {
  font-size: 3.5rem; font-weight: 900; color: var(--primary);
  height: 100px; line-height: 100px; text-align: center; overflow: hidden;
}

.btn {
  padding: 12px 20px; border-radius: 99px; border: none;
  font-weight: 700; cursor: pointer; font-size: 1rem;
  transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center;
}
.btn.primary { background: var(--primary); color: #fff; width: 100%; }
.btn.ghost { background: #fff; color: var(--text-main); border: 1px solid #ddd; }
.btn.special { background: var(--special); color: white; }

.stat-box { background: #fdfaf9; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #f4eae7; flex: 1; }
.stat-val { font-weight: 800; color: var(--primary); font-size: 1.2rem; display: block; }

input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 1rem; }

.special-winner-tag {
  display: inline-block; background: #ede7f6; color: var(--special);
  padding: 4px 10px; border-radius: 99px; font-size: 0.8rem; margin: 2px; font-weight: 700;
}

@media (max-width: 400px) {
  .cell { font-size: 1rem; }
  .grid { gap: 6px; }
  .cell { width: calc((100% - 24px) / 5); }
}
</style>
</head>

<body>
<div id="admin-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:999">
  <div class="card" style="width:90%;max-width:350px;">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼">
    <button class="btn primary" onclick="doAdminLogin()">ç™»å…¥</button>
    <button class="btn ghost" style="width:100%;margin-top:8px" onclick="closeAdminModal()">å–æ¶ˆ</button>
  </div>
</div>

<div class="container">
  <div class="header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
    <div onclick="triggerAdmin()" style="font-weight:900;color:var(--primary);cursor:pointer">ğŸ§§ 2025 è³“æœ v2.9.3</div>
    <div id="user-info" style="font-size:0.8rem;color:var(--muted)"></div>
  </div>

  <div id="view-login" class="card hidden">
    <h3 style="text-align:center;color:var(--primary)">ç©å®¶ç™»å…¥</h3>
    <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" />
    <button class="btn primary" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div id="player-name-display" style="font-weight:700"></div>
        <button class="btn ghost" style="padding:4px 12px;font-size:0.8rem" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      
      <div style="text-align:center;margin-top:15px">
        <div id="draw-display">READY</div>
        
        <div id="player-draw-zone" class="hidden" style="margin: 15px 0; background: #fff8e1; padding: 15px; border-radius: 15px; border: 2px dashed #ffb300;">
            <div style="font-weight: 800; color: #f57c00; margin-bottom: 8px;">ğŸ”¥ è¼ªåˆ°ä½ æŠ½è™Ÿäº†ï¼</div>
            <button class="btn primary" onclick="drawNewNumber()">ğŸ² å¹«å¤§å®¶æŠ½ä¸€å€‹è™Ÿç¢¼</button>
        </div>

        <div id="bingo-status" style="color:var(--success);font-weight:700;margin-bottom:10px"></div>
        <div id="bingo-grid" class="grid"></div>
        
        <div id="player-special-box" style="display:none;border-top:1px solid #eee;margin-top:15px;padding-top:10px">
            <div style="font-size:0.75rem;color:var(--muted)">ğŸ ç‰¹åˆ¥çå¾—çåå–®</div>
            <div id="player-special-winners"></div>
        </div>

        <div id="setup-btns" style="display:flex;gap:10px;margin-top:15px">
          <button class="btn ghost" style="flex:1" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button class="btn primary" style="flex:2" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:10px">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span>åœ¨ç·š</div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span>ç¸½æ•¸</div>
      </div>

      <div style="text-align:center;background:#fff8e1;padding:15px;border-radius:15px;margin:15px 0">
        <div id="admin-sync-num" style="font-size:2.5rem;font-weight:900;color:var(--primary)">--</div>
        <div id="admin-special-winners"></div>
        <div id="drawn-history-list" style="margin-top:10px;font-size:0.8rem"></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button class="btn primary" onclick="drawNewNumber()">ğŸ² ç®¡ç†è€…æŠ½è™Ÿ</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å…¨å“¡é–å®š</button>
        <button class="btn" style="background:#ffb300;color:white" onclick="pickRandomUserToDraw()">ğŸŒŸ é¸äººæŠ½è™Ÿ</button>
        <button class="btn special" onclick="drawSpecialPrize()">ğŸ æŠ½ç‰¹åˆ¥ç</button>
        <button class="btn danger" style="grid-column:span 2;background:#ffebee;color:#c62828" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ² (å«æ¸…ç©ºæ­·å²)</button>
      </div>
      
      <div style="margin-top:15px;font-size:0.8rem;color:var(--muted)">
          <div id="pending-choices"></div>
          <div id="bingo-alerts" style="color:var(--success)"></div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let specialWinners = [];
let pickedHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;
let currentPickerUid = "";

function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) { document.getElementById('admin-modal').style.display='flex'; window.ac=0; }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display='none'; }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) closeAdminModal();
    else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists) myData = snap.data();
  else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  document.getElementById('player-name-display').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

function updateDrawDisplay(text) {
  const el = document.getElementById('draw-display');
  el.innerText = text;
  el.style.fontSize = text.toString().length > 5 ? "1.8rem" : "3.5rem";
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || {};
    gameHistory = data.history || [];
    specialWinners = data.specialWinners || [];
    pickedHistory = data.pickedHistory || [];
    isAllLockedGlobal = data.isAllLocked || false;
    currentPickerUid = data.pickerUid || "";

    // é¡¯ç¤ºç‰¹åˆ¥ç
    const specialHtml = specialWinners.map(w => `<span class="special-winner-tag">ğŸ ${w}</span>`).join('');
    if(document.getElementById('admin-special-winners')) document.getElementById('admin-special-winners').innerHTML = specialHtml;
    if(document.getElementById('player-special-winners')) {
        document.getElementById('player-special-winners').innerHTML = specialHtml;
        document.getElementById('player-special-box').style.display = specialWinners.length > 0 ? 'block' : 'none';
    }

    // æª¢æŸ¥ç›®å‰æ˜¯ä¸æ˜¯è©²æˆ‘æŠ½è™Ÿ
    const pickerZone = document.getElementById('player-draw-zone');
    if(pickerZone) {
        if(currentPickerUid === currentUser.uid) pickerZone.classList.remove('hidden');
        else pickerZone.classList.add('hidden');
    }

    const finalValue = data.luckyUser ? data.luckyUser : (gameHistory.length ? gameHistory[gameHistory.length-1] : "READY");
    
    if(data.isRolling){
      if(!rollingTimer) {
        rollingTimer = setInterval(()=> {
          let temp = data.isPickingLucky ? (allPlayersCache.length > 0 ? allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name : "...") : Math.floor(Math.random()*25)+1;
          updateDrawDisplay(temp);
          if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = temp;
        }, 80);
      }
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      updateDrawDisplay(finalValue);
      if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = finalValue;
      renderGrid();
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    const now = Date.now();
    const online = allPlayersCache.filter(p => p.lastSeen && (now - p.lastSeen.toMillis()) < 300000);
    if(document.getElementById('count-online')) document.getElementById('count-online').innerText = online.length;
    if(document.getElementById('count-total')) document.getElementById('count-total').innerText = allPlayersCache.length;
  });
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  const winIdx = new Set();
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) line.forEach(i=>winIdx.add(i));
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
}

async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("å…¨éƒ¨æŠ½å®Œå›‰ï¼");

  await ref.update({ isRolling: true, isPickingLucky: false, luckyUser: "" });
  
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    // æŠ½å®Œå¾Œï¼Œæ¸…ç©º pickerUidï¼Œè®“æŒ‰éˆ•æ¶ˆå¤±
    await ref.update({ 
        history: firebase.firestore.FieldValue.arrayUnion(p), 
        isRolling: false,
        pickerUid: "" 
    });
  }, 1500);
}

// éš¨æ©Ÿé¸ä¸€å€‹ã€Œåœ¨ç·šä¸”æ²’è¢«é¸éã€çš„äººä¾†æŠ½è™Ÿ
async function pickRandomUserToDraw() {
  const now = Date.now();
  const pool = allPlayersCache.filter(p => {
    const isOnline = p.lastSeen && (now - p.lastSeen.toMillis()) < 300000;
    return isOnline && !pickedHistory.includes(p.id) && p.id !== ALLOWED_UID;
  });

  if(pool.length === 0) return alert("æ²’æœ‰ç¬¦åˆè³‡æ ¼çš„åœ¨ç·šäººå“¡ï¼ˆæˆ–å…¨éƒ½æŠ½éä¸€æ¬¡äº†ï¼‰");

  const ref = db.collection("game_state").doc("current_game");
  await ref.update({ isRolling: true, isPickingLucky: true, luckyUser: "" });

  setTimeout(async () => {
    const winner = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ 
        isRolling: false, 
        isPickingLucky: false, 
        luckyUser: "ğŸŒŸ è«‹ " + winner.name + " æŠ½è™Ÿ",
        pickerUid: winner.id,
        pickedHistory: firebase.firestore.FieldValue.arrayUnion(winner.id)
    });
  }, 2000);
}

async function drawSpecialPrize() {
  const now = Date.now();
  const pool = allPlayersCache.filter(p => {
    const isOnline = p.lastSeen && (now - p.lastSeen.toMillis()) < 300000;
    return isOnline && !specialWinners.includes(p.name);
  });
  if(pool.length === 0) return alert("ç„¡äººå¯æŠ½");
  const ref = db.collection("game_state").doc("current_game");
  await ref.update({ isRolling: true, isPickingLucky: true, luckyUser: "" });
  setTimeout(async () => {
    const winner = pool[Math.floor(Math.random()*pool.length)].name;
    await ref.update({ isRolling: false, isPickingLucky: false, luckyUser: "ğŸ ç‰¹åˆ¥çï¼š" + winner, specialWinners: firebase.firestore.FieldValue.arrayUnion(winner) });
  }, 2000);
}

async function forceLockAll() {
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}

async function handleReset(){
  if(!confirm("é‡ç½®å°‡æ¸…ç©ºæ‰€æœ‰å¾—çç´€éŒ„ã€æŠ½è™Ÿç´€éŒ„èˆ‡é¸äººç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  batch.set(db.collection("game_state").doc("current_game"), { 
    history:[], isRolling:false, isAllLocked:false, luckyUser:"", 
    specialWinners: [], pickedHistory: [], pickerUid: "" 
  });
  await batch.commit();
  location.reload();
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  if(!confirm("é–å®šå¾Œä¸èƒ½æ›è™Ÿç¢¼ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}
function doSignOut(){ auth.signOut(); location.reload(); }

setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
}, 10000);
</script>
</body>
</html>
