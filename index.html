<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å°¾ç‰™è³“æœç³»çµ± 0.01</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --secondary: #ffc107; --bg: #f8f9fa; --success: #2e7d32; --dark: #2c3e50; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); text-align: center; color: #333; user-select: none; }
        
        /* é€šç”¨é é¢æ§åˆ¶ */
        .page { display: none !important; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .page.active { display: flex !important; flex-direction: column; align-items: center; }

        /* --- ç©å®¶æ¨£å¼ --- */
        .login-container { margin-top: 15vh; width: 100%; max-width: 320px; }
        h1 { color: var(--primary); font-size: 2.5rem; cursor: pointer; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; width: 100%; max-width: 360px; background: #fff; padding: 10px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .cell { aspect-ratio: 1; border: 1px solid #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; border-radius: 8px; background: #fafafa; }
        .cell.selected { background: var(--secondary); color: #b71c1c; }
        .cell.bingo-line { background: var(--primary) !important; color: white !important; animation: pulse 1s infinite; }
        .big-number { font-size: 5rem; color: var(--primary); font-weight: 800; margin: 10px 0; }
        
        /* --- ç®¡ç†ç«¯å°ˆå±¬æ¨£å¼ --- */
        #page-admin { background: var(--dark); color: white; text-align: left; align-items: stretch; }
        .admin-card { background: #34495e; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .history-tag { display: inline-block; background: #3498db; padding: 4px 8px; border-radius: 4px; margin: 2px; font-size: 0.8rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { padding: 8px; border-bottom: 1px solid #455a64; text-align: left; }

        /* æŒ‰éˆ•èˆ‡è¼¸å…¥ */
        button { padding: 12px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; width: 80%; text-align: center; }

        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>

    <div id="page-login" class="page active">
        <div class="login-container">
            <h1 onclick="handleAdminClick()">ğŸ§§ 2025<br>å°¾ç‰™è³“æœ</h1>
            <input type="text" id="username-input" placeholder="è«‹è¼¸å…¥å§“å">
            <button id="btn-login" onclick="handleLogin()" style="width: 85%;">é€²å…¥éŠæˆ²</button>
            <div id="login-msg" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>

    <div id="page-game" class="page">
        <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="display-name">è¼‰å…¥ä¸­...</span>
            <span id="status-tag">ğŸŸ¢ åœ¨ç·š</span>
        </div>
        <div class="big-number" id="current-draw">READY</div>
        <div id="status-text" style="font-weight:bold; margin-bottom:10px; color:var(--success);">ç­‰å¾…é–‹ç</div>
        <div class="grid" id="bingo-grid"></div>
        <div id="setup-controls" style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="generateBoard()" style="background:#546e7a;">ğŸ² æ›è™Ÿç¢¼</button>
            <button onclick="lockBoard()" style="background:var(--success);">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
    </div>

    <div id="page-admin" class="page">
        <h2>âš™ï¸ è³“æœå¤§è…¦ (ç®¡ç†å“¡)</h2>
        <div class="admin-card">
            <button onclick="drawNumber()" style="width:100%; background:#e67e22; margin-bottom:10px;">ğŸ² éš¨æ©ŸæŠ½è™Ÿ</button>
            <button onclick="pickLuckyPlayer()" style="width:100%; background:var(--secondary); color:#333;">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
        </div>
        
        <div class="admin-grid">
            <div class="admin-card">
                å·²æŠ½è™Ÿç¢¼: <div id="admin-history" style="margin-top:5px;"></div>
            </div>
            <div class="admin-card">
                çµ±è¨ˆ: <br>
                åœ¨ç·š: <span id="stat-online">0</span><br>
                åˆ†æ•¸: <span id="stat-scores" style="font-size:0.7rem;"></span>
            </div>
        </div>

        <div id="admin-pending-area" class="admin-card" style="display:none; border:2px solid var(--secondary);">
            <strong>å¾…å¯©æ ¸è™Ÿç¢¼:</strong>
            <div id="pending-list"></div>
        </div>

        <div class="admin-card" style="flex:1; overflow-y:auto;">
            <table>
                <thead><tr><th>å§“å</th><th>é€£ç·š</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="player-list-body"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" style="background:none; border:1px solid #888; font-size:0.7rem;">ç™»å‡º/è¿”å›ç©å®¶</button>
    </div>

    <div id="lucky-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:99;">
        <div style="background:white; padding:20px; border-radius:15px; width:80%; color:#333;">
            <h3>ğŸŒŸ å¤©é¸ä¹‹äººï¼</h3>
            <p>è«‹è¼¸å…¥ 1-25 è™Ÿï¼š</p>
            <input type="number" id="lucky-num-input" min="1" max="25">
            <button onclick="submitLuckyChoice()" style="width:100%;">é€å‡ºè™Ÿç¢¼</button>
        </div>
    </div>

    <script>
        // --- 1. é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
            authDomain: "yearendbingo.firebaseapp.com",
            projectId: "yearendbingo",
            storageBucket: "yearendbingo.firebasestorage.app",
            messagingSenderId: "563353011392",
            appId: "1:563353011392:web:717976a176bc22a04d5925",
            measurementId: "G-M6EVYSPNJ9"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let myData = { board: [], locked: false, name: "" };
        let gameHistory = [];
        let rollingInterval = null;
        let adminClickCount = 0;

        const winLines = [
            [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
            [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
            [0,6,12,18,24], [4,8,12,16,20]
        ];

        // --- 2. ç©å®¶é‚è¼¯ ---
        async function handleLogin() {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥å§“å");
            
            document.getElementById('btn-login').disabled = true;
            try {
                const userCred = await auth.signInAnonymously();
                currentUser = userCred.user;
                myData.name = name;

                const docRef = db.collection("players").doc(currentUser.uid);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    myData = { ...myData, ...docSnap.data() };
                } else {
                    myData.board = Array.from({length:25}, (_,i)=>i+1).sort(()=>Math.random()-0.5);
                    await docRef.set({
                        name: name, locked: false, maxConsecutive: 0,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                document.getElementById('display-name').innerText = myData.name;
                switchPage('page-game');
                renderBoard();
                startListeners();
                setInterval(() => {
                    db.collection("players").doc(currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(()=>{});
                }, 20000);

            } catch (e) {
                alert("æ¬Šé™éŒ¯èª¤æˆ–ç¶²è·¯å•é¡Œ: " + e.message);
                document.getElementById('btn-login').disabled = false;
            }
        }

        function renderBoard() {
            const grid = document.getElementById('bingo-grid');
            grid.innerHTML = "";
            let winningIndices = new Set();
            
            winLines.forEach(line => {
                if (line.every(idx => gameHistory.includes(myData.board[idx]))) {
                    line.forEach(idx => winningIndices.add(idx));
                }
            });

            myData.board.forEach((num, i) => {
                const div = document.createElement('div');
                div.className = 'cell' + (gameHistory.includes(num) ? ' selected' : '') + (winningIndices.has(i) ? ' bingo-line' : '');
                div.innerText = num;
                grid.appendChild(div);
            });
            document.getElementById('setup-controls').style.display = myData.locked ? 'none' : 'flex';
        }

        async function lockBoard() {
            if(!confirm("é–å®šå¾Œä¸å¯æ›´æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            const bStr = myData.board.join(',');
            try {
                const snap = await db.collection("players").where("boardStr","==",bStr).get();
                if(snap.size > 0) return alert("é€™çµ„è™Ÿç¢¼æœ‰äººé¸éå›‰ï¼Œæ›ä¸€çµ„è©¦è©¦ï¼");
                
                await db.collection("players").doc(currentUser.uid).update({
                    board: myData.board, boardStr: bStr, locked: true
                });
                myData.locked = true;
                renderBoard();
            } catch(e) { alert("é–å®šå¤±æ•—: " + e.message); }
        }

        function generateBoard() {
            myData.board = Array.from({length:25}, (_,i)=>i+1).sort(()=>Math.random()-0.5);
            renderBoard();
        }

        function startListeners() {
            db.collection("game_state").doc("current_game").onSnapshot(doc => {
                const data = doc.data();
                if(!data) return;
                gameHistory = data.history || [];
                
                if(data.isRolling) {
                    if(!rollingInterval) rollingInterval = setInterval(()=> {
                        document.getElementById('current-draw').innerText = Math.floor(Math.random()*25)+1;
                    }, 80);
                } else {
                    clearInterval(rollingInterval);
                    rollingInterval = null;
                    document.getElementById('current-draw').innerText = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
                    renderBoard();
                }

                if(data.luckyUser === myData.name && myData.locked && !data.isRolling) {
                    document.getElementById('lucky-modal').style.display = 'flex';
                } else {
                    document.getElementById('lucky-modal').style.display = 'none';
                }
            });
        }

        async function submitLuckyChoice() {
            const num = parseInt(document.getElementById('lucky-num-input').value);
            if(isNaN(num) || num<1 || num>25 || gameHistory.includes(num)) return alert("ç„¡æ•ˆè™Ÿç¢¼æˆ–å·²é–‹é");
            await db.collection("pending_choices").doc(currentUser.uid).set({
                playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("å·²é€å‡ºï¼Œç­‰å¾…é–‹çï¼");
            document.getElementById('lucky-modal').style.display = 'none';
        }

        // --- 3. ç®¡ç†ç«¯é‚è¼¯ ---
        function handleAdminClick() {
            adminClickCount++;
            if(adminClickCount >= 5) {
                const pw = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼:");
                if(pw === "2025admin") { // é€™è£¡å¯ä»¥è‡ªè¨‚å¯†ç¢¼
                    startAdmin();
                }
                adminClickCount = 0;
            }
        }

        async function startAdmin() {
            switchPage('page-admin');
            // ç›£è½æ‰€æœ‰ç©å®¶
            db.collection("players").onSnapshot(snap => {
                const players = snap.docs.map(d => d.data());
                const now = Date.now();
                const online = players.filter(p => (now - (p.lastSeen?.toMillis?.()||0)) < 30000).length;
                document.getElementById('stat-online').innerText = online;
                
                const tbody = document.getElementById('player-list-body');
                tbody.innerHTML = players.map(p => `<tr><td>${p.name}</td><td>${p.maxConsecutive||0}</td><td>${p.locked?'ğŸ”’':'â³'}</td></tr>`).join('');
            });

            // ç›£è½æ­·å²
            db.collection("game_state").doc("current_game").onSnapshot(doc => {
                const h = doc.data()?.history || [];
                document.getElementById('admin-history').innerHTML = h.map(n=>`<span class="history-tag">${n}</span>`).join('');
            });

            // ç›£è½å¾…å¯©æ ¸
            db.collection("pending_choices").onSnapshot(snap => {
                const list = snap.docs.map(d => ({id:d.id, ...d.data()}));
                const area = document.getElementById('admin-pending-area');
                area.style.display = list.length ? 'block' : 'none';
                document.getElementById('pending-list').innerHTML = list.map(p => `
                    <div style="margin-top:10px;">${p.playerName}: ${p.number} 
                    <button onclick="approveLucky(${p.number}, '${p.id}')" style="padding:4px 8px;">ç¢ºèª</button></div>
                `).join('');
            });
        }

        async function drawNumber() {
            const available = Array.from({length:25},(_,i)=>i+1).filter(n=>!gameHistory.includes(n));
            const newNum = available[Math.floor(Math.random()*available.length)];
            const ref = db.collection("game_state").doc("current_game");
            await ref.update({ isRolling: true });
            setTimeout(async () => {
                await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(newNum), isRolling: false, luckyUser: "" });
            }, 3000);
        }

        async function approveLucky(num, uid) {
            await db.collection("game_state").doc("current_game").update({
                history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: ""
            });
            await db.collection("pending_choices").doc(uid).delete();
        }

        async function pickLuckyPlayer() {
            const snap = await db.collection("players").where("locked","==",true).get();
            const players = snap.docs.map(d => d.data());
            const lucky = players[Math.floor(Math.random()*players.length)];
            if(lucky) await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name });
        }

        function switchPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
