<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v3.1</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{
  --primary:#b71c1c; --accent:#ffb300; --bg:#f4f6f8; --card:#fff;
  --muted:#6b7280; --success:#2e7d32; --danger:#c62828; --shadow:0 6px 18px rgba(0,0,0,0.1);
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Noto Sans TC", system-ui;background:var(--bg);color:#111;overflow-x:hidden}
.container{max-width:980px;margin:18px auto;padding:18px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.hidden{display:none}
.btn{padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer;transition:0.2s}
.btn:active{transform:scale(0.9)}

/* è™Ÿç¢¼çƒå‹•ç•« */
#draw-display.rolling { animation: bounce 0.2s infinite alternate; }
@keyframes bounce { from { transform: scale(1); } to { transform: scale(1.15); } }

/* è³“æœæ ¼å­çš„é–ƒçˆèˆ‡æµå…‰ */
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:420px;margin:10px auto}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:10px;border:1px solid #ddd;font-weight:700;font-size:1.2rem;position:relative;overflow:hidden}
.cell.selected{background:#fff7e6;color:#b25600;border-color:var(--accent)}

/* æµå…‰æ•ˆæœ */
.cell.selected::after {
  content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.6), transparent);
  transform: rotate(45deg); animation: shine 3s infinite;
}
@keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }

.cell.bingo-line{background:var(--success) !important;color:#fff !important;z-index:1;animation: pulse 0.8s infinite;}
@keyframes pulse { 0% { transform:scale(1); box-shadow:0 0 0 0 rgba(46,125,50,0.7); } 70% { transform:scale(1.05); box-shadow:0 0 0 10px rgba(46,125,50,0); } 100% { transform:scale(1); } }

.status-log{max-height:150px;overflow:auto;background:#0f172a;color:#fff;padding:10px;border-radius:8px;font-size:0.8rem}
.history-ball{display:inline-block;width:30px;height:30px;line-height:30px;background:var(--primary);color:white;border-radius:50%;margin:2px;text-align:center;font-size:0.8rem}
</style>
</head>
<body>

<audio id="audio-bingo" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
<audio id="audio-draw" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

<div id="admin-modal" class="modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000">
  <div style="background:white;padding:24px;border-radius:16px;width:300px">
    <h3>ç®¡ç†å“¡ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" style="width:100%;margin-bottom:10px;padding:8px">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" style="width:100%;margin-bottom:10px;padding:8px">
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
  </div>
</div>

<div class="container">
  <div class="header" style="display:flex;justify-content:space-between;align-items:center">
    <div class="title" onclick="triggerAdmin()" style="font-weight:800;cursor:pointer">ğŸ§§ å°¾ç‰™è³“æœ v3.1</div>
    <div id="user-info" style="font-size:0.8rem;color:var(--muted)"></div>
  </div>

  <div id="view-login" class="card">
    <h3>ç©å®¶ç™»å…¥</h3>
    <input id="player-name" type="text" placeholder="è¼¸å…¥å§“å" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ddd">
    <button class="btn primary" style="width:100%;margin-top:12px" onclick="doPlayerLogin()">é€²å…¥</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card" style="text-align:center">
      <h2 id="player-name-display"></h2>
      <div id="draw-display" style="font-size:5rem;font-weight:900;color:var(--primary);margin:10px 0">READY</div>
      <div id="bingo-status" style="color:var(--success);font-weight:bold;height:24px"></div>
      <div id="bingo-grid" class="grid"></div>
      <div id="setup-btns" style="display:flex;gap:10px;justify-content:center;margin-top:15px">
        <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
        <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between">
        <strong>ç®¡ç†è€…æ§åˆ¶å°</strong>
        <span id="admin-lock-indicator"></span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0">
        <button class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll(true)">ğŸ”’ å…¨å“¡é–å®š</button>
        <button class="btn danger" onclick="handleReset()">âš ï¸ é‡ç½®</button>
        <button class="btn" style="background:var(--accent)" onclick="pickLucky()">ğŸŒŸ å¹¸é‹å…’</button>
      </div>
      <div id="drawn-history-list" class="card" style="background:#eee;min-height:40px"></div>
      <div class="status-log" id="status-log"></div>
    </div>
  </div>
</div>

<script>
/* --- æ­¤è™•è«‹å¡«å…¥æ‚¨çš„ Firebase Config --- */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null, myData = {name:"", board:[], locked:false}, gameHistory = [], isAllLockedGlobal = false, hasBingoed = false;

// 1. æ ¸å¿ƒé¡¯ç¤ºå‡½æ•¸
function renderGrid() {
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  const winIdx = new Set(); let winCount = 0;
  lines.forEach(line => {
    if(line.every(i => gameHistory.includes(myData.board[i]))) { line.forEach(i=>winIdx.add(i)); winCount++; }
  });

  myData.board.forEach((num, i) => {
    const div = document.createElement('div');
    div.className = `cell ${gameHistory.includes(num)?'selected':''} ${winIdx.has(i)?'bingo-line':''}`;
    div.innerText = num;
    grid.appendChild(div);
  });

  // è§¸ç™¼è³“æœç‰¹æ•ˆèˆ‡éŸ³æ•ˆ
  if(winCount > 0 && !hasBingoed && (myData.locked || isAllLockedGlobal)) {
    triggerBingoCelebration();
    hasBingoed = true; // é¿å…é‡è¤‡è§¸ç™¼
  }
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
}

function triggerBingoCelebration() {
  document.getElementById('audio-bingo').play().catch(()=>{});
  confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
  document.getElementById('bingo-status').innerText = "ğŸŠ BINGO !! ğŸŠ";
}

// 2. ç®—æ³•ä¿®å¾©ï¼šé€£çºŒé•·åº¦
function calculateMaxConsecutive(board, history) {
  const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
  let max = 0;
  lines.forEach(line => {
    let streak = 0, lineMax = 0;
    line.forEach(i => {
      if(history.includes(board[i])) { streak++; lineMax = Math.max(lineMax, streak); }
      else { streak = 0; }
    });
    max = Math.max(max, lineMax);
  });
  return max;
}

// 3. æŠ½è™Ÿé‚è¼¯
async function drawNewNumber() {
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll(true);
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("å®Œç•¢");

  document.getElementById('audio-draw').play().catch(()=>{});
  await ref.update({ isRolling: true });
  setTimeout(async () => {
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling: false, luckyUser: "" });
  }, 1500);
}

// 4. ç›£è½èˆ‡å•Ÿå‹•
function startApp() {
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data();
    gameHistory = data.history || [];
    isAllLockedGlobal = data.isAllLocked || false;
    
    const display = document.getElementById('draw-display');
    if(data.isRolling) {
      display.classList.add('rolling');
    } else {
      display.classList.remove('rolling');
      const lastNum = gameHistory[gameHistory.length-1];
      display.innerText = lastNum || "READY";
      renderGrid();
    }

    // å¹¸é‹å…’é‚è¼¯ (å«é©—è­‰)
    if(data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
      let num = prompt("ä½ æ˜¯å¤©é¸ä¹‹äººï¼è«‹è¼¸å…¥ 1-25 è™Ÿç¢¼ (ä¸èƒ½é‡è¤‡)ï¼š");
      num = parseInt(num);
      if(num >= 1 && num <= 25 && !gameHistory.includes(num)) {
        db.collection("pending_choices").doc(currentUser.uid).set({ playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        db.collection("game_state").doc("current_game").update({ luckyUser: "" });
      } else { alert("ç„¡æ•ˆè™Ÿç¢¼ï¼"); }
    }
  });

  db.collection("players").onSnapshot(snap => {
    const players = snap.docs.map(d => ({id:d.id, ...d.data()}));
    if(currentUser.uid !== ALLOWED_UID) {
      const me = players.find(p => p.id === currentUser.uid);
      if(me) { myData = me; renderGrid(); }
    }
  });
}

/* è¼”åŠ©å‡½æ•¸ */
function showView(v) { 
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+v).classList.remove('hidden');
}
auth.onAuthStateChanged(user => {
  currentUser = user;
  if(!user) return showView('login');
  if(user.uid === ALLOWED_UID) { showView('admin'); startApp(); }
  else { showView('player'); startApp(); }
});
async function doPlayerLogin() { await auth.signInAnonymously(); }
function reRollBoard() { myData.board = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); renderGrid(); }
async function confirmBoard() { if(confirm("ç¢ºå®šé–å®šï¼Ÿ")) await db.collection("players").doc(currentUser.uid).update({locked:true}); }
async function forceLockAll(s) { const batch = db.batch(); const snap = await db.collection("players").get(); snap.forEach(d=>batch.update(d.ref,{locked:s})); await batch.commit(); await db.collection("game_state").doc("current_game").update({isAllLocked:s}); }
async function handleReset() { if(confirm("é‡ç½®ï¼Ÿ")) { const batch = db.batch(); const snap = await db.collection("players").get(); snap.forEach(d=>batch.update(d.ref,{locked:false})); await batch.set(db.collection("game_state").doc("current_game"), {history:[], isRolling:false, isAllLocked:false}); await batch.commit(); location.reload(); } }
function triggerAdmin() { window.ac = (window.ac||0)+1; if(window.ac>=5) document.getElementById('admin-modal').style.display='flex'; }
async function doAdminLogin() { const e = document.getElementById('admin-email').value, p = document.getElementById('admin-pwd').value; await auth.signInWithEmailAndPassword(e, p); location.reload(); }
</script>
</body>
</html>
