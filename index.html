<!-- 2025 å°¾ç‰™è³“æœç³»çµ± â€” ç®¡ç†å„ªåŒ–ç‰ˆ
     ç‰ˆæ¬¡: v2.4
     è®Šæ›´é‡é»: å·¦å´å®Œå…¨ç§»é™¤ï¼ˆåƒ…é¡¯ç¤ºå³å´ç®¡ç†é¢æ¿ï¼‰ï¼›æ–°å¢ç®¡ç†ç‹€æ…‹é¡¯ç¤ºåˆ—ï¼›é‡ç½®å¾Œè‡ªå‹•ç‚ºå·²ç™»å…¥ç©å®¶é‡å»º players æ–‡ä»¶ï¼›æŠ½è™Ÿå‰å¼·åˆ¶é–å®šæ‰€æœ‰ç©å®¶ç›¤é¢
-->
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.4</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#b71c1c;
  --accent:#ffb300;
  --bg:#f4f6f8;
  --card:#ffffff;
  --muted:#6b7280;
  --success:#2e7d32;
  --danger:#c62828;
  --shadow:0 6px 18px rgba(16,24,40,0.06);
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Noto Sans TC", "Microsoft JhengHei", system-ui;background:linear-gradient(180deg,var(--bg),#ffffff);color:#111}
.container{max-width:900px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.title{font-size:1.25rem;color:var(--primary);cursor:pointer}
.user-info{font-weight:600;color:var(--muted)}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:12px}
.admin-main{display:flex;flex-direction:column;gap:12px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-box{background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);padding:10px;border-radius:10px;text-align:center}
.stat-val{font-weight:800;color:var(--accent);display:block;font-size:1.1rem}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.btn{padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff}
.btn.warn{background:var(--danger);color:#fff}
.btn.ghost{background:#f3f4f6;color:#111}
.small{font-size:0.85rem;color:var(--muted)}
.pending-list{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:#fff}
.status-log{max-height:160px;overflow:auto;padding:10px;border-radius:8px;background:#0f172a;color:#fff;font-size:0.9rem}
.status-item{padding:6px;border-bottom:1px solid rgba(255,255,255,0.06)}
.status-success{color:#b7f5c6}
.status-fail{color:#ffd1d1}
.center{display:flex;align-items:center;justify-content:center}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">ğŸ§§ 2025 è³“æœç³»çµ± ç®¡ç†é¢æ¿ v2.4</div>
    <div id="user-info" class="user-info">æœªç™»å…¥</div>
  </div>

  <div class="admin-main">
    <div class="card">
      <div class="stat-grid">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="small">åœ¨ç·š</span></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="small">ç¸½äººæ•¸</span></div>
      </div>

      <div style="margin-top:10px" class="small">æœ€å¤§ç›¸é„°é€£è™Ÿåˆ†ä½ˆ</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="stat-box" style="flex:1"><span id="cnt-5" class="stat-val">0</span><span class="small">5+</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-4" class="stat-val">0</span><span class="small">4</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-3" class="stat-val">0</span><span class="small">3</span></div>
        <div class="stat-box" style="flex:1"><span id="cnt-2" class="stat-val">0</span><span class="small">2</span></div>
      </div>

      <div style="margin-top:12px;text-align:center;background:linear-gradient(90deg,#fff8e1,#fff);padding:10px;border-radius:10px">
        <div class="small">åŒæ­¥é–‹çè™Ÿ</div>
        <div id="admin-sync-num" style="font-size:2rem;font-weight:800;color:var(--accent)">--</div>
      </div>

      <div class="controls" style="margin-top:12px">
        <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ</button>
        <button id="btn-pick" class="btn" style="background:var(--accent);font-weight:800" onclick="pickLucky()">ğŸŒŸ å¹¸é‹å…’</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">ğŸ“¢ å³æ™‚è³“æœåå–®</div>
      <div id="bingo-alerts" class="pending-list"><div style="color:#9aa0a6">å°šç„¡è³“æœäº‹ä»¶...</div></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">å¾…æ ¸é¸è™Ÿ (<span id="pending-count">0</span>)</div>
      <div id="pending-choices" class="pending-list"></div>
    </div>

    <div class="card">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn warn" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²</button>
        <button class="btn ghost" onclick="location.reload()">é€€å‡ºä¸¦é‡æ•´</button>
      </div>

      <div style="margin-top:12px;font-weight:700;margin-bottom:6px">ç³»çµ±ç‹€æ…‹åˆ—</div>
      <div id="status-log" class="status-log" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- ç®¡ç†ç™»å…¥ Modal -->
<div id="admin-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999">
  <div style="width:320px;background:#fff;padding:18px;border-radius:12px">
    <h3 style="margin:0 0 10px 0">ç®¡ç†å“¡ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" />
    <div style="height:8px"></div>
    <input id="admin-pwd" type="password" placeholder="Password" />
    <div style="height:12px"></div>
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
    <div style="height:8px"></div>
    <button class="btn ghost" style="width:100%" onclick="document.getElementById('admin-modal').style.display='none'">å–æ¶ˆ</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false, boardStr:"", version:0 };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;

const lines = [
  [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
  [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
  [0,6,12,18,24],[4,8,12,16,20]
];

/* ç‹€æ…‹åˆ—å¯«å…¥ */
function logStatus(message, ok = true){
  const el = document.getElementById('status-log');
  if(!el) return;
  const time = new Date().toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'status-item ' + (ok ? 'status-success' : 'status-fail');
  div.innerText = `[${time}] ${message}`;
  el.prepend(div);
  // åŒæ­¥å¯«å…¥ audit_logsï¼ˆé–‹ç™¼ç”¨ï¼›ä¸Šç·šè«‹æ”¹ç”± Cloud Function å¯«å…¥ï¼‰
  try {
    db.collection("audit_logs").add({ action: message, detail: { ok }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  } catch(e){}
}

/* Auth state handler */
auth.onAuthStateChanged(user => {
  currentUser = user;
  if(user){
    document.getElementById('user-info').innerText = (user.email ? user.email : (user.uid === ALLOWED_UID ? "ç®¡ç†è€…æ¨¡å¼" : "å·²ç™»å…¥"));
    startApp();
  } else {
    document.getElementById('user-info').innerText = "æœªç™»å…¥";
  }
});

function triggerAdmin(){
  window.adminClicks = (window.adminClicks||0)+1;
  if(window.adminClicks>=5){
    document.getElementById('admin-modal').style.display='flex';
    window.adminClicks=0;
  }
}

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try{
    const cred = await auth.signInWithEmailAndPassword(email,pwd);
    if(cred.user.uid === ALLOWED_UID){
      document.getElementById('admin-modal').style.display='none';
      document.getElementById('user-info').innerText = "ç®¡ç†è€…æ¨¡å¼";
      currentUser = cred.user;
      logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ", true);
      startApp();
    } else {
      alert("éç®¡ç†å“¡å¸³è™Ÿ");
      logStatus("ç®¡ç†å“¡ç™»å…¥å¤±æ•—ï¼šéç®¡ç†å“¡å¸³è™Ÿ", false);
    }
  } catch(e){
    alert("ç™»å…¥å¤±æ•—");
    logStatus("ç®¡ç†å“¡ç™»å…¥å¤±æ•—ï¼š" + e, false);
  }
}

/* ç›£è½å™¨ç®¡ç† */
let gameStateUnsub = null;
let playersUnsub = null;
let pendingUnsub = null;
let bingoEventsUnsub = null;

function startApp(){
  if(gameStateUnsub) gameStateUnsub();
  if(playersUnsub) playersUnsub();
  if(pendingUnsub) pendingUnsub();
  if(bingoEventsUnsub) bingoEventsUnsub();

  gameStateUnsub = db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, luckyUser:"", status:"waiting" };
    gameHistory = data.history || [];
    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    const syncEl = document.getElementById('admin-sync-num');
    if(syncEl) syncEl.innerText = last;

    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const rand = Math.floor(Math.random()*25)+1;
        if(syncEl) syncEl.innerText = rand;
      }, 80);
    } else {
      if(rollingTimer){ clearInterval(rollingTimer); rollingTimer=null; }
      if(currentUser && currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }
  });

  playersUnsub = db.collection("players").onSnapshot(snap => {
    const list = snap.docs.map(d => ({...d.data(), uid:d.id}));
    allPlayersCache = list;
    document.getElementById('count-total').innerText = list.length;
    const now = Date.now();
    const online = list.filter(p => p.lastSeen && (now - (p.lastSeen.toMillis ? p.lastSeen.toMillis() : new Date(p.lastSeen).getTime())) < 30000).length;
    document.getElementById('count-online').innerText = online;
    if(currentUser && currentUser.uid === ALLOWED_UID) updateConnectedStats();
  });

  if(currentUser && currentUser.uid === ALLOWED_UID){
    pendingUnsub = db.collection("pending_choices").onSnapshot(snap => {
      const div = document.getElementById('pending-choices');
      div.innerHTML = snap.docs.map(d => {
        const p = d.data();
        return `<div style="padding:6px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
          <div><strong>${p.playerName}</strong>ï¼š${p.number}</div>
          <div><button class="btn ghost" onclick="confirmLucky('${d.id}', ${p.number})">é–‹è™Ÿ</button></div>
        </div>`;
      }).join('') || '<div style="color:#9aa0a6">ç„¡å¾…æ ¸é¸è™Ÿ</div>';
      document.getElementById('pending-count').innerText = snap.size;
    });

    bingoEventsUnsub = db.collection("bingo_events").orderBy("timestamp","desc").limit(20).onSnapshot(snap => {
      const container = document.getElementById('bingo-alerts');
      if(snap.empty){ container.innerHTML = '<div style="color:#9aa0a6">å°šç„¡è³“æœäº‹ä»¶...</div>'; return; }
      container.innerHTML = snap.docs.map(d => {
        const data = d.data();
        const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
        return `<div style="padding:8px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between"><div>ğŸ‰ ${data.name}</div><div style="color:#9aa0a6;font-size:0.85rem">${timeStr}</div></div>`;
      }).join('');
    });
  }

  // heartbeat for current user (if player)
  if(currentUser && !currentUser.email){
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
  if(window.heartbeatInterval) clearInterval(window.heartbeatInterval);
  window.heartbeatInterval = setInterval(()=> {
    if(currentUser && !currentUser.email){
      db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
    }
  },15000);
}

/* ç®¡ç†æ“ä½œï¼šå¼·åˆ¶é–å®šæ‰€æœ‰ç©å®¶ï¼ˆåˆ†é è™•ç†ä»¥é¿å… batch é™åˆ¶ï¼‰ */
async function forceLockAllPlayers(){
  try {
    const pageSize = 400; // safe batch size
    let lastDoc = null;
    let totalLocked = 0;
    while(true){
      let q = db.collection("players").orderBy("__name__").limit(pageSize);
      if(lastDoc) q = q.startAfter(lastDoc);
      const snap = await q.get();
      if(snap.empty) break;
      const batch = db.batch();
      snap.docs.forEach(doc => {
        batch.update(doc.ref, { locked: true, version: (doc.data().version || 1) + 1 });
      });
      await batch.commit();
      totalLocked += snap.size;
      lastDoc = snap.docs[snap.docs.length - 1];
      if(snap.size < pageSize) break;
    }
    logStatus(`å¼·åˆ¶é–å®šå®Œæˆï¼šå…±é–å®š ${totalLocked} ä½ç©å®¶`, true);
    return true;
  } catch(e){
    console.error("forceLockAllPlayers error", e);
    logStatus("å¼·åˆ¶é–å®šå¤±æ•—ï¼š" + e, false);
    return false;
  }
}

/* æŠ½è™Ÿï¼šå…ˆå¼·åˆ¶é–å®šæ‰€æœ‰ç©å®¶ï¼Œé–å®šæˆåŠŸå¾ŒåŸ·è¡ŒæŠ½è™Ÿ transaction */
async function drawNewNumber(){
  document.getElementById('btn-draw').disabled = true;
  logStatus("é–‹å§‹æŠ½è™Ÿï¼šå˜—è©¦å¼·åˆ¶é–å®šæ‰€æœ‰ç©å®¶...", true);
  const locked = await forceLockAllPlayers();
  if(!locked){
    document.getElementById('btn-draw').disabled = false;
    return;
  }
  logStatus("æ‰€æœ‰ç©å®¶å·²é–å®šï¼Œé–‹å§‹æŠ½è™Ÿå‹•ç•«", true);

  const ref = db.collection("game_state").doc("current_game");
  const snap = await ref.get();
  const history = snap.data()?.history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!history.includes(n));
  if(!pool.length){
    logStatus("æŠ½è™Ÿå–æ¶ˆï¼šè™Ÿç¢¼å·²æŠ½å®Œ", false);
    document.getElementById('btn-draw').disabled = false;
    return alert("å·²æŠ½å®Œ");
  }
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const pick = pool[Math.floor(Math.random()*pool.length)];
    try {
      await db.runTransaction(async tx=>{
        const s = (await tx.get(ref)).data() || { history:[] };
        if((s.history||[]).includes(pick)) throw "already picked";
        tx.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(pick), isRolling:false, luckyUser:"" });
      });
      logStatus(`æŠ½è™ŸæˆåŠŸï¼šæœ¬æ¬¡é–‹å‡º ${pick}`, true);
    } catch(e){
      console.error("draw transaction failed", e);
      await ref.update({ isRolling:false });
      logStatus("æŠ½è™Ÿå¤±æ•—ï¼š" + e, false);
      alert("æŠ½è™Ÿå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
      document.getElementById('btn-draw').disabled = false;
    }
  }, 1800);
}

/* é‡ç½®ï¼šåˆªé™¤é›†åˆä¸¦ç‚ºç•¶å‰å·²ç™»å…¥ç©å®¶è‡ªå‹•å»ºç«‹ players æ–‡ä»¶ï¼ˆè‹¥ç‚ºç©å®¶ï¼‰ */
async function handleReset(){
  if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸ")) return;
  try {
    const collections = ["players","pending_choices","bingo_events","board_index"];
    for(const coll of collections){
      // åˆ†é åˆªé™¤ç°¡å–®å¯¦ä½œï¼ˆä¸€æ¬¡æŠ“å–ä¸¦åˆªé™¤ï¼Œè‹¥è³‡æ–™é‡å¤§è«‹æ”¹ç‚ºåˆ†é ï¼‰
      const snap = await db.collection(coll).get();
      const batch = db.batch();
      snap.forEach(d=>batch.delete(d.ref));
      await batch.commit();
    }
    await db.collection("game_state").doc("current_game").set({ history:[], isRolling:false, luckyUser:"", status:"waiting" });
    logStatus("é‡ç½®å®Œæˆï¼šgame_state èˆ‡é›†åˆå·²æ¸…ç©º", true);

    // å‰ç«¯ç‹€æ…‹æ¸…ç†
    myData = { name:"", board:[], locked:false, boardStr:"", version:0 };
    gameHistory = [];
    allPlayersCache = [];
    if(rollingTimer){ clearInterval(rollingTimer); rollingTimer = null; }
    startApp();

    // è‹¥ç•¶å‰åˆ†é ç‚ºå·²ç™»å…¥ç©å®¶ï¼ˆéç®¡ç†è€…ï¼‰ï¼Œè‡ªå‹•å»ºç«‹æ–° players æ–‡ä»¶
    if(currentUser && currentUser.uid !== ALLOWED_UID){
      const newBoard = shuffleArray();
      const newBoardStr = newBoard.join(',');
      myData = {
        name: myData.name || ("ç©å®¶" + currentUser.uid.slice(0,6)),
        board: newBoard,
        boardStr: newBoardStr,
        locked: false,
        maxConsecutive: 0,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        version: 1
      };
      await db.collection("players").doc(currentUser.uid).set(myData);
      logStatus("ç‚ºç•¶å‰ç©å®¶è‡ªå‹•å»ºç«‹æ–°ç›¤é¢ä¸¦æ¢å¾©æ›è™Ÿ/é–å®šåŠŸèƒ½", true);
    }
  } catch(e){
    console.error(e);
    logStatus("é‡ç½®å¤±æ•—ï¼š" + e, false);
    alert("é‡ç½®å¤±æ•—ï¼š" + e);
  }
}

/* ç¢ºèªå¹¸é‹è™Ÿç¢¼ï¼ˆç®¡ç†ç«¯ï¼‰ */
async function confirmLucky(docId, num){
  const ref = db.collection("game_state").doc("current_game");
  try{
    await db.runTransaction(async tx=>{
      const s = (await tx.get(ref)).data() || { history:[] };
      if((s.history||[]).includes(num)) throw "è™Ÿç¢¼å·²è¢«æŠ½é";
      tx.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser:"" });
      tx.delete(db.collection("pending_choices").doc(docId));
    });
    logStatus(`ç¢ºèªå¹¸é‹è™Ÿ ${num} æˆåŠŸ`, true);
  } catch(e){
    logStatus("ç¢ºèªå¹¸é‹è™Ÿå¤±æ•—ï¼š" + e, false);
    alert("ç¢ºèªå¤±æ•—ï¼š" + e);
  }
}

/* æŠ½å¹¸é‹å…’ï¼ˆç®¡ç†ç«¯ï¼‰ */
async function pickLucky(){
  try {
    const snap = await db.collection("players").where("locked","==",true).get();
    if(snap.empty) { logStatus("æŠ½å¹¸é‹å…’å¤±æ•—ï¼šç„¡é–å®šç©å®¶", false); return alert("å°šç„¡é–å®šç›¤é¢"); }
    const players = snap.docs.map(d=>({uid:d.id,...d.data()}));
    players.forEach(p=>{
      p.maxConsecutive = p.maxConsecutive || calculateMaxConnected(p.board || [], gameHistory);
    });
    players.sort((a,b)=> (a.maxConsecutive||0) - (b.maxConsecutive||0));
    const candidates = players.slice(0, Math.min(15, players.length));
    const lucky = candidates[Math.floor(Math.random()*candidates.length)];
    await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name || lucky.uid });
    logStatus(`æŠ½å¹¸é‹å…’æˆåŠŸï¼š${lucky.name || lucky.uid}`, true);
    alert("å¤©é¸ä¹‹äººå·²æŠ½ä¸­ï¼š" + (lucky.name || lucky.uid));
  } catch(e){
    logStatus("æŠ½å¹¸é‹å…’å¤±æ•—ï¼š" + e, false);
    alert("æŠ½å¹¸é‹å…’å¤±æ•—ï¼š" + e);
  }
}

/* å·¥å…·å‡½å¼ */
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }

function calculateMaxConnected(board, history){
  const marked = new Set();
  board.forEach((num,idx)=>{ if(history.includes(num)) marked.add(idx); });
  if(marked.size===0) return 0;
  let maxGroupSize=0;
  const visited = new Set();
  for(let i=0;i<25;i++){
    if(marked.has(i) && !visited.has(i)){
      let count=0;
      const stack=[i]; visited.add(i);
      while(stack.length){
        const curr = stack.pop(); count++;
        const r=Math.floor(curr/5), c=curr%5;
        const neighbors=[];
        if(r>0) neighbors.push(curr-5);
        if(r<4) neighbors.push(curr+5);
        if(c>0) neighbors.push(curr-1);
        if(c<4) neighbors.push(curr+1);
        neighbors.forEach(n=>{
          if(marked.has(n) && !visited.has(n)){ visited.add(n); stack.push(n); }
        });
      }
      if(count>maxGroupSize) maxGroupSize=count;
    }
  }
  return maxGroupSize;
}

function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const maxConn = p.maxConsecutive || calculateMaxConnected(p.board || [], gameHistory);
    if(maxConn>=5) counts[5]++;
    else if(maxConn===4) counts[4]++;
    else if(maxConn===3) counts[3]++;
    else if(maxConn===2) counts[2]++;
  });
  document.getElementById('cnt-5').innerText = counts[5];
  document.getElementById('cnt-4').innerText = counts[4];
  document.getElementById('cnt-3').innerText = counts[3];
  document.getElementById('cnt-2').innerText = counts[2];
}
</script>
</body>
</html>
