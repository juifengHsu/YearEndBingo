<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœ - ä½ç½®å”¯ä¸€ç‰ˆ</title>

<!-- Firebase client SDK (compat 9) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{--primary:#d32f2f;--secondary:#ffc107;--bg:#f8f9fa;--success:#2e7d32}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:#333;text-align:center}
.page{display:none;padding:20px}
.page.active{display:block}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;max-width:360px;margin:15px auto;background:#fff;padding:10px;border-radius:12px}
.cell{aspect-ratio:1;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-weight:bold;border-radius:8px;background:#fff}
.cell.selected{background:var(--secondary);color:#b71c1c}
.cell.bingo-line{background:var(--primary);color:#fff}
button{padding:12px 18px;border:none;border-radius:20px;background:var(--primary);color:#fff;cursor:pointer;margin:6px}
button:disabled{background:#ccc;cursor:not-allowed}
.big-number{font-size:4rem;color:var(--primary);min-height:90px;line-height:90px}
.stat-card{background:#fff;padding:12px;border-radius:10px;margin:12px auto;max-width:720px;border:1px solid #ddd}
.small{font-size:0.9rem;color:#666}
.admin-area{position:fixed;top:0;left:0;width:80px;height:80px;z-index:9999}
.lucky-panel{display:none;background:#fff9c4;padding:16px;border-radius:12px;margin-top:12px}
</style>
</head>
<body>

<!-- Admin click area -->
<div class="admin-area" onclick="handleAdminClick()"></div>

<!-- Login Page -->
<div id="page-login" class="page active">
  <h1 style="color:var(--primary)">ğŸ§§ 2025 å°¾ç‰™è³“æœ</h1>
  <input id="username" placeholder="è¼¸å…¥å§“å" style="padding:10px;border-radius:8px;border:1px solid #ccc;width:80%;max-width:300px">
  <br><br>
  <button onclick="joinGame()">ç¢ºèªé€²å…¥</button>
  <p class="small">å‚™è¨»ï¼šæ­¤ç‰ˆæœ¬æ¡ç”¨å…è²» Firestore client-side transactionï¼Œè«‹å‹¿å…¬é–‹ç®¡ç† PINã€‚</p>
</div>

<!-- Game Page -->
<div id="page-game" class="page">
  <div id="user-info" style="font-weight:bold;color:#666"></div>
  <div class="big-number" id="draw-number-player">READY</div>
  <div id="status-text" style="color:var(--primary);font-weight:bold"></div>

  <div class="grid" id="bingo-grid"></div>

  <div id="setup-controls">
    <button onclick="generateBoard()">ğŸ² éš¨æ©Ÿæ›è™Ÿ</button>
    <button onclick="lockBoard()" style="background:var(--success)">ğŸ”’ ä¿å­˜ç›¤é¢</button>
  </div>

  <div id="lucky-panel" class="lucky-panel">
    <p>ğŸŒŸ å¹¸é‹å…’è«‹é¸è™Ÿ (1-25)</p>
    <input id="lucky-input" type="number" min="1" max="25" style="width:80px;text-align:center;padding:8px;border-radius:6px;border:1px solid #ccc">
    <button onclick="submitLuckyNumber()" style="background:orange">é–‹ç</button>
    <div id="lucky-timer" style="margin-top:8px;color:#666"></div>
  </div>
</div>

<!-- Admin Page -->
<div id="page-admin" class="page">
  <h2>ç®¡ç†è€…ä¸»æ§å°</h2>
  <div class="stat-card">
    <div style="font-weight:bold">ğŸ“Š å³æ™‚çµ±è¨ˆ</div>
    <div style="display:flex;justify-content:space-around;margin-top:8px">
      <div><div id="count-total" style="font-weight:bold">0</div><div class="small">å·²è¨»å†Š</div></div>
      <div><div id="count-online" style="font-weight:bold">0</div><div class="small">åœ¨ç·š</div></div>
      <div><div id="count-locked" style="font-weight:bold">0</div><div class="small">å·²é–å®š</div></div>
    </div>
  </div>

  <div class="big-number" id="draw-number-admin">READY</div>
  <button id="btn-draw" onclick="drawRandom()">ğŸ² éš¨æ©ŸæŠ½å–ä¸‹ä¸€å€‹</button>
  <button onclick="pickLuckyUser()" style="background:#ef6c00">ğŸ¯ æŠ½å¹¸é‹å…’é¸è™Ÿ</button>

  <div style="margin-top:12px">
    <label><input id="list-toggle" type="checkbox"> é¡¯ç¤ºç©å®¶æ˜ç´°</label>
  </div>
  <div id="admin-list-view" style="display:none;text-align:left;max-width:720px;margin:12px auto;background:#fff;padding:12px;border-radius:8px;border:1px solid #ddd">
    <div id="list-content"></div>
  </div>

  <button onclick="resetGame()" style="background:#555;margin-top:18px">é‡ç½®æ¸…ç©ºéŠæˆ²</button>
</div>

<script>
/* =========================
   Firebase config - è‹¥è¦ä½¿ç”¨è«‹æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ config
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const GAME_DOC = "current_game";

/* ===== state ===== */
let myName = "", myBoard = [], isLocked = false, drawnHistory = [], rollingInterval = null;
const winConditions = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];

/* ===== helpers ===== */
function setText(id, txt){ const el = document.getElementById(id); if(el) el.innerText = txt; }
function toSortedKey(arr){ return [...arr].sort((a,b)=>a-b).join(','); }

/* ===== score calc (use Set for perf) ===== */
function calculateMaxConsecutive(board, history){
  if(!board || board.length<25) return 0;
  const drawnSet = new Set(history || []);
  let maxGlobal = 0;
  winConditions.forEach(indices=>{
    let cur=0, maxInLine=0;
    indices.forEach(idx=>{
      if(drawnSet.has(board[idx])){ cur++; if(cur>maxInLine) maxInLine=cur; } else cur=0;
    });
    if(maxInLine>maxGlobal) maxGlobal=maxInLine;
  });
  return maxGlobal;
}

/* ===== UI render ===== */
function renderBoard(){
  const container = document.getElementById('bingo-grid');
  container.innerHTML = '';
  myBoard.forEach((num, idx)=>{
    const cell = document.createElement('div');
    cell.className = 'cell' + (drawnHistory.includes(num) ? ' selected' : '');
    cell.innerText = num;
    container.appendChild(cell);
  });
  winConditions.forEach(c=>{
    if(c.every(idx => drawnHistory.includes(myBoard[idx]))){
      c.forEach(idx => container.children[idx].classList.add('bingo-line'));
    }
  });
}

/* ===== client actions ===== */
function generateBoard(){
  if(isLocked) return;
  // ç”¢ç”Ÿ 1..25 çš„äº‚åºæ’åˆ—ï¼ˆä½ç½®æ•æ„Ÿï¼‰
  myBoard = Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5);
  renderBoard();
}

async function joinGame(){
  const name = document.getElementById('username').value.trim();
  if(!name) return alert('è«‹è¼¸å…¥å§“å');
  myName = name;
  localStorage.setItem('bingo_username', myName);

  // è®€å–æ˜¯å¦å·²é–å®š
  const doc = await db.collection('players').doc(myName).get();
  if(doc.exists){
    const d = doc.data();
    if(d.locked){ myBoard = d.board || []; isLocked = true; document.getElementById('setup-controls').style.display='none'; }
  }

  setText('user-info', `ç©å®¶ï¼š${myName}`);
  switchPage('page-game');
  if(!isLocked && myBoard.length===0) generateBoard(); else renderBoard();

  // create or update player with server timestamp via client write
  await db.collection('players').doc(myName).set({ name: myName, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

  // heartbeat every 15s
  setInterval(()=>{ if(myName) db.collection('players').doc(myName).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }); }, 15000);

  initGlobalMonitor();
}

/* ===== lockBoard using position-sensitive key with backward-compat check ===== */
async function lockBoard() {
  if (isLocked) return;
  if (!confirm('ä¿å­˜å¾Œä¸å¯æ›´æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ')) return;

  // ä½ç½®æ•æ„Ÿçš„ keyï¼ˆä¸è¦æ’åºï¼‰
  const boardKey = myBoard.join(',');
  // ä¹ŸåŒæ™‚ç”¢ç”ŸèˆŠç‰ˆçš„æ’åº keyï¼ˆè‹¥ DB ä¹‹å‰ç”¨é sortedKeyï¼Œç•¶ä½œç›¸å®¹æª¢æŸ¥ï¼‰
  const sortedKey = toSortedKey(myBoard);

  const uniqueRef = db.collection('uniqueCards').doc(boardKey);
  const sortedRef = db.collection('uniqueCards').doc(sortedKey); // backward-compat check
  const playerRef = db.collection('players').doc(myName);

  try {
    await db.runTransaction(async (tx) => {
      // æª¢æŸ¥ä½ç½®æ•æ„Ÿ key æ˜¯å¦å­˜åœ¨
      const uSnap = await tx.get(uniqueRef);
      if (uSnap.exists) {
        throw new Error('CARD_COLLISION');
      }
      // æª¢æŸ¥èˆŠçš„æ’åº key æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…èˆŠè³‡æ–™é€ æˆè¡çªï¼‰
      const sSnap = await tx.get(sortedRef);
      if (sSnap.exists) {
        throw new Error('CARD_COLLISION_OLDKEY');
      }

      // è‹¥éƒ½ä¸å­˜åœ¨ï¼Œå»ºç«‹ä½ç½®æ•æ„Ÿçš„ unique doc ä¸¦é–å®šç©å®¶
      tx.set(uniqueRef, { ownerPlayerId: myName, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      tx.set(playerRef, {
        board: myBoard,
        boardStr: boardKey,        // ä½ç½®æ•æ„Ÿå­—ä¸²
        locked: true,
        lockedAt: firebase.firestore.FieldValue.serverTimestamp(),
        maxConsecutive: calculateMaxConsecutive(myBoard, drawnHistory)
      }, { merge: true });
    });
    isLocked = true;
    document.getElementById('setup-controls').style.display = 'none';
    alert('é–å®šæˆåŠŸ');
    renderBoard();
  } catch (err) {
    console.error('lockBoard error', err);
    if (err.message && (err.message.includes('CARD_COLLISION') || err.message.includes('CARD_COLLISION_OLDKEY'))) {
      alert('ç›¤é¢é‡è¤‡ï¼Œç³»çµ±å°‡è‡ªå‹•é‡æ–°ç”¢ç”Ÿæ–°ç›¤é¢');
      generateBoard();
    } else {
      alert('é–å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
}

/* ===== realtime listeners ===== */
function initGlobalMonitor(){
  db.collection('game_state').doc(GAME_DOC).onSnapshot(doc=>{
    const data = doc.data() || {};
    drawnHistory = data.history || [];
    const num = drawnHistory.length>0 ? drawnHistory[drawnHistory.length-1] : 'READY';
    setText('draw-number-player', num);
    setText('draw-number-admin', num);
    renderBoard();
    document.getElementById('lucky-panel').style.display = (data.luckyUser === myName && isLocked) ? 'block' : 'none';
  });

  db.collection('players').onSnapshot(snap=>{
    const players = [];
    snap.forEach(d=>players.push(d.data()));
    const now = Date.now();
    setText('count-total', players.length);
    setText('count-online', players.filter(p => now - (p.lastSeen ? p.lastSeen.toMillis ? p.lastSeen.toMillis() : p.lastSeen : 0) < 30000).length);
    setText('count-locked', players.filter(p => p.locked).length);
    setText('score-5', players.filter(p => (p.maxConsecutive||0) >= 5).length);
    setText('score-4', players.filter(p => (p.maxConsecutive||0) === 4).length);
    setText('score-3', players.filter(p => (p.maxConsecutive||0) === 3).length);

    // admin list
    const locked = players.filter(p => p.locked).sort((a,b)=> (a.maxConsecutive||0) - (b.maxConsecutive||0) || ((a.lockedAt && a.lockedAt.toMillis ? a.lockedAt.toMillis() : a.lockedAt) || 0) - ((b.lockedAt && b.lockedAt.toMillis ? b.lockedAt.toMillis() : b.lockedAt) || 0));
    const weakNames = locked.slice(0,15).map(p=>p.name);
    const listContent = document.getElementById('list-content');
    listContent.innerHTML = '';
    for(let s=5;s>=1;s--){
      const group = locked.filter(p => Math.min(p.maxConsecutive||0,5) === s);
      if(group.length===0) continue;
      const div = document.createElement('div');
      div.style.marginBottom='8px';
      div.innerHTML = `<div style="font-weight:bold">${s>=5?'è½ç‰Œ/è³“æœ':s+' é€£çºŒ'} (${group.length}äºº)</div>`;
      group.forEach(p=>{
        const isWeak = weakNames.includes(p.name);
        const span = document.createElement('span');
        span.style.display='inline-block';
        span.style.background = isWeak ? '#fff9c4' : '#eee';
        span.style.padding='4px 8px';
        span.style.margin='4px';
        span.style.borderRadius='6px';
        span.innerText = p.name + (isWeak ? ' â­' : '');
        div.appendChild(span);
      });
      listContent.appendChild(div);
    }
  });

  document.getElementById('list-toggle').onchange = (e) => {
    document.getElementById('admin-list-view').style.display = e.target.checked ? 'block' : 'none';
  };
}

/* ===== drawRandom using transaction to avoid duplicates ===== */
async function drawRandom() {
  if (!confirm('ç¢ºå®šè¦éš¨æ©ŸæŠ½è™Ÿå—ï¼Ÿ')) return;
  document.getElementById('btn-draw').disabled = true;
  const gRef = db.collection('game_state').doc(GAME_DOC);

  try {
    await db.runTransaction(async (tx) => {
      const gSnap = await tx.get(gRef);
      const history = gSnap.exists ? (gSnap.get('history') || []) : [];
      const remaining = Array.from({length:25}, (_, i) => i + 1).filter(n => !history.includes(n));
      if (remaining.length === 0) throw new Error('NO_MORE_NUMBERS');
      const pick = remaining[Math.floor(Math.random() * remaining.length)];
      tx.set(gRef, {
        history: firebase.firestore.FieldValue.arrayUnion(pick),
        currentBall: pick,
        isRolling: false,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    });
  } catch (err) {
    console.error(err);
    alert('æŠ½è™Ÿå¤±æ•—ï¼š' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
  } finally {
    document.getElementById('btn-draw').disabled = false;
  }
}

/* ===== pickLuckyUser: client reads locked players, then transaction writes luckyUser ===== */
async function pickLuckyUser() {
  try {
    const snap = await db.collection('players').where('locked','==',true).get();
    const players = [];
    snap.forEach(d => {
      const p = d.data();
      players.push({
        name: p.name,
        maxConsecutive: p.maxConsecutive || 0,
        lockedAt: p.lockedAt ? (p.lockedAt.toMillis ? p.lockedAt.toMillis() : p.lockedAt) : 0
      });
    });
    if (players.length === 0) return alert('ç„¡é–å®šç©å®¶');

    players.sort((a,b) => a.maxConsecutive - b.maxConsecutive || a.lockedAt - b.lockedAt);
    const pool = players.slice(0, Math.min(15, players.length));
    const pick = pool[Math.floor(Math.random() * pool.length)];

    const gRef = db.collection('game_state').doc(GAME_DOC);
    await db.runTransaction(async (tx) => {
      tx.set(gRef, { luckyUser: pick.name, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    });
    alert('æŠ½ä¸­ï¼š' + pick.name);
  } catch (err) {
    console.error(err);
    alert('æŠ½é¸å¤±æ•—');
  }
}

/* ===== submitLuckyNumber: transactionally check luckyUser and drawnHistory ===== */
async function submitLuckyNumber() {
  const val = parseInt(document.getElementById('lucky-input').value);
  if (!val || val < 1 || val > 25) return alert('è¼¸å…¥éŒ¯èª¤');
  const gRef = db.collection('game_state').doc(GAME_DOC);

  try {
    await db.runTransaction(async (tx) => {
      const gSnap = await tx.get(gRef);
      const history = gSnap.exists ? (gSnap.get('history') || []) : [];
      const luckyUser = gSnap.exists ? (gSnap.get('luckyUser') || '') : '';
      if (luckyUser !== myName) throw new Error('NOT_LUCKY_USER');
      if (history.includes(val)) throw new Error('ALREADY_DRAWN');
      tx.update(gRef, {
        history: firebase.firestore.FieldValue.arrayUnion(val),
        luckyUser: '',
        currentBall: val,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
      // update player's maxConsecutive
      const pRef = db.collection('players').doc(myName);
      const pSnap = await tx.get(pRef);
      if (pSnap.exists) {
        const board = pSnap.get('board') || [];
        const newDrawn = [...history, val];
        const maxC = calculateMaxConsecutive(board, newDrawn);
        tx.update(pRef, { maxConsecutive: maxC });
      }
    });
    document.getElementById('lucky-input').value = '';
    alert('é–‹çæˆåŠŸ');
  } catch (err) {
    console.error(err);
    if (err.message === 'NOT_LUCKY_USER') alert('ä½ ä¸æ˜¯è¢«æŒ‡å®šçš„å¹¸é‹å…’');
    else if (err.message === 'ALREADY_DRAWN') alert('è©²è™Ÿå·²è¢«é–‹é');
    else alert('æäº¤å¤±æ•—');
  }
}

/* ===== resetGame: batch delete players and uniqueCards, reset game_state ===== */
async function resetGame() {
  if (!confirm('ç¢ºå®šé‡ç½®ï¼Ÿæ­¤æ“ä½œæœƒåˆªé™¤æ‰€æœ‰ç©å®¶è³‡æ–™èˆ‡ç›¤é¢ï¼Œç„¡æ³•å¾©åŸ')) return;
  const pin = prompt('è«‹è¼¸å…¥ç®¡ç† PIN');
  if (pin !== '2025') return alert('PIN éŒ¯èª¤');

  try {
    // delete players
    const playersSnap = await db.collection('players').get();
    const batch = db.batch();
    playersSnap.forEach(d => batch.delete(d.ref));
    // delete uniqueCards
    const ucSnap = await db.collection('uniqueCards').get();
    ucSnap.forEach(d => batch.delete(d.ref));
    // reset game_state
    const gRef = db.collection('game_state').doc(GAME_DOC);
    batch.set(gRef, { history: [], isRolling: false, luckyUser: '', lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });
    await batch.commit();
    localStorage.clear();
    location.reload();
  } catch (err) {
    console.error(err);
    alert('é‡ç½®å¤±æ•—');
  }
}

/* ===== admin reveal via 5 clicks (PIN check client-side minimal) ===== */
let adminClickCount = 0, adminTimer = null;
function handleAdminClick(){
  clearTimeout(adminTimer);
  adminClickCount++;
  adminTimer = setTimeout(()=>{ adminClickCount = 0; }, 3000);
  if(adminClickCount >= 5){
    adminClickCount = 0;
    const pin = prompt('è«‹è¼¸å…¥ç®¡ç† PIN');
    if(pin === '2025') switchPage('page-admin');
    else alert('PIN éŒ¯èª¤');
  }
}

/* ===== page switch and init ===== */
function switchPage(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
window.onload = ()=>{ const s = localStorage.getItem('bingo_username'); if(s) document.getElementById('username').value = s; };

</script>

</body>
</html>
