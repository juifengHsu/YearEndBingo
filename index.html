<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.1 - é•·è€…å„ªåŒ–ç‰ˆ</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
[cite_start]/* æ¡ç”¨ new 9 çš„æ ¸å¿ƒé…è‰²èˆ‡é•·è€…å„ªåŒ–æ¨£å¼ [cite: 415, 417] */
:root {
  --primary: #f45925; [cite_start]/* new 9 äº®æ©˜è‰² [cite: 415] */
  --primary-dark: #d64010;
  --success: #1b5e20; [cite_start]/* æ·±ç¶ è‰²è¦–è¦ºå›é¥‹ [cite: 7, 9] */
  --accent: #ffb300;  [cite_start]/* é‡‘è‰²é€£ç·š [cite: 9] */
  --bg: #f8f6f5;
  --card: #ffffff;
  --text-dark: #1c110d;
  --shadow: 0 8px 24px rgba(244, 89, 37, 0.15);
  --radius: 20px;
}

* { box-sizing: border-box; }
body { 
  margin: 0; 
  font-family: 'Spline Sans', "Noto Sans TC", system-ui, sans-serif; 
  background: var(--bg); 
  color: var(--text-dark);
  line-height: 1.5;
}

[cite_start]/* ç›¤é¢æœ€å¤§åŒ–èˆ‡å®¹å™¨è¨­å®š [cite: 3, 10] */
.container { 
  width: 100%; 
  max-width: 100%; 
  margin: 0 auto; 
  padding: 15px; 
}

.header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 20px;
  padding: 10px;
}

.title { 
  font-size: 1.8rem; [cite_start]/* æ¨™é¡Œæ”¾å¤§ [cite: 4] */
  font-weight: 800; 
  color: var(--primary); 
}

.card { 
  background: var(--card); 
  border-radius: var(--radius); 
  box-shadow: var(--shadow); 
  padding: 24px; 
  margin-bottom: 20px; 
  border: 1px solid #f4eae7;
}

[cite_start]/* æŒ‰éˆ•å„ªåŒ–ï¼šæ»¿ç‰ˆå¯¬åº¦èˆ‡å¤§é»æ“Šå€åŸŸ [cite: 6, 8] */
.btn { 
  display: block;
  width: 100%; 
  padding: 20px; 
  margin-bottom: 12px;
  border-radius: 15px; 
  border: none; 
  font-weight: 800; 
  font-size: 1.5rem; [cite_start]/* å­—é«”æ”¾å¤§ [cite: 4] */
  cursor: pointer; 
  transition: transform 0.1s;
  text-align: center;
}
.btn:active { transform: scale(0.98); }
.btn.primary { background: var(--primary); color: #fff; }
.btn.ghost { background: #f4eae7; color: var(--text-dark); }
.btn.danger { background: #c62828; color: #fff; }

[cite_start]/* è³“æœç›¤é¢ï¼šåœ“å½¢çƒé«”èˆ‡æœ€å¤§åŒ– [cite: 3, 5] */
.grid { 
  display: grid; 
  grid-template-columns: repeat(5, 1fr); 
  gap: 12px; 
  width: 100%; [cite_start]/* å–æ¶ˆ 420px é™åˆ¶ [cite: 3] */
  margin: 20px auto; 
}

.cell { 
  aspect-ratio: 1; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  background: #f4eae7; 
  border-radius: 50%; [cite_start]/* åœ“å½¢çƒé«” [cite: 5] */
  font-weight: 900; 
  font-size: 2rem; [cite_start]/* å­—é«”å€å¢ [cite: 4] */
  color: var(--text-dark);
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

[cite_start]/* é¸ä¸­èˆ‡é€£ç·šç‰¹æ•ˆ [cite: 9] */
.cell.selected { 
  background: var(--success); 
  color: #fff; 
  box-shadow: 0 4px 10px rgba(27, 94, 32, 0.3);
}
.cell.bingo-line { 
  background: var(--accent); 
  color: #fff; 
  border: 4px solid #fff;
  animation: bingo-pop 0.8s infinite alternate; 
}

@keyframes bingo-pop {
  0% { transform: scale(1); }
  100% { transform: scale(1.15); }
}

[cite_start]/* å¤§è™Ÿç¢¼é¡¯ç¤º [cite: 4] */
#draw-display, #admin-sync-num { 
  font-size: 7rem; [cite_start]/* å¤§è™Ÿç¢¼æå‡ [cite: 4] */
  font-weight: 900; 
  color: var(--primary); 
  margin: 10px 0;
}

.hidden { display: none; }

/* ç®¡ç†è€…ä»‹é¢å¾®èª¿ */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.stat-box { background: #fdf2f0; padding: 15px; border-radius: 12px; text-align: center; }
.stat-val { font-size: 2rem; font-weight: 800; color: var(--primary); }

.modal-overlay { 
  position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
  display: none; align-items: center; justify-content: center; z-index: 999; 
}
.modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }
</style>
</head>
<body>

<div id="admin-modal" class="modal-overlay">
  <div class="modal-content">
    <h2 style="text-align:center">ç®¡ç†è€…ç™»å…¥</h2>
    <input id="admin-email" type="email" placeholder="Email" style="width:100%;padding:15px;margin-bottom:15px;font-size:1.2rem;border-radius:10px;border:1px solid #ddd">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" style="width:100%;padding:15px;margin-bottom:15px;font-size:1.2rem;border-radius:10px;border:1px solid #ddd">
    <button class="btn primary" onclick="doAdminLogin()">ç™»å…¥ç³»çµ±</button>
    <button class="btn ghost" onclick="closeAdminModal()">è¿”å›</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ±</div>
    <div id="user-info" style="font-weight:bold; font-size:1.2rem">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="view-login" class="card hidden">
    <h2 style="font-size:2rem; margin-top:0">æ‚¨å¥½ï¼Œè«‹è¼¸å…¥å§“å</h2>
    <input id="player-name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" style="width:100%;padding:20px;font-size:1.5rem;border-radius:10px;border:2px solid var(--primary)" />
    <button class="btn primary" style="margin-top:20px" onclick="doPlayerLogin()">é–‹å§‹ç©éŠæˆ²</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
        <div>
          <div style="font-size:1.5rem;font-weight:800" id="player-name-display"></div>
          <div id="lock-status-label" style="font-size:1.1rem;color:var(--primary);font-weight:bold"></div>
        </div>
        <button class="btn ghost" style="width:auto;padding:10px 20px" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      
      <div style="text-align:center">
        <div id="draw-display">READY</div>
        <div id="bingo-status" style="font-size:1.5rem;height:40px;color:var(--success);font-weight:900"></div>
        
        <div id="bingo-grid" class="grid"></div>
        
        <div id="setup-btns" style="margin-top:20px">
          <button class="btn ghost" onclick="reRollBoard()">ğŸ² éš¨æ©Ÿæ›è™Ÿç¢¼</button>
          <button class="btn primary" onclick="confirmBoard()">ğŸ”’ ç¢ºå®šé€™å€‹ç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:1.5rem;font-weight:bold">ç®¡ç†è€…æ§åˆ¶å°</div>
        <button class="btn ghost" style="width:auto;padding:10px 20px" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      
      <div class="stat-grid" style="margin-top:20px">
        <div class="stat-box"><span id="count-online" class="stat-val">0</span><div style="font-weight:bold">åœ¨ç·š</div></div>
        <div class="stat-box"><span id="count-total" class="stat-val">0</span><div style="font-weight:bold">ç¸½äººæ•¸</div></div>
      </div>

      <div style="margin-top:20px;text-align:center;background:#fff;border:3px solid var(--primary);padding:20px;border-radius:20px">
        <div style="font-size:1.2rem;font-weight:bold">æœ€æ–°è™Ÿç¢¼</div>
        <div id="admin-sync-num">--</div>
        <div id="drawn-history-list" style="margin-top:10px;display:flex;flex-wrap:wrap;justify-content:center;gap:5px"></div>
      </div>

      <div style="margin-top:20px">
        <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½ä¸‹ä¸€å€‹è™Ÿç¢¼</button>
        <button class="btn" style="background:#455a64;color:white" onclick="forceLockAll()">ğŸ”’ å¼·åˆ¶æ‰€æœ‰äººé–å®š</button>
        <button class="btn" style="background:var(--accent);color:#fff" onclick="pickLucky()">ğŸŒŸ æŠ½ä¸€ä½å¹¸é‹å…’é¸è™Ÿ</button>
        <button class="btn danger" onclick="removeAllPlayers()">ğŸ§¹ æ¸…é™¤æ‰€æœ‰ç©å®¶</button>
        <button class="btn ghost" style="border:1px solid #ddd" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ² (é‡æ–°æ›è™Ÿ)</button>
      </div>

      <div class="card" style="margin-top:20px; background:#f9f9f9">
        <div style="font-weight:bold;font-size:1.2rem">ğŸ“¢ å³æ™‚é€šçŸ¥</div>
        <div id="pending-choices" style="color:var(--primary); font-weight:bold; margin-top:10px"></div>
        <div id="bingo-alerts" style="color:var(--success); font-weight:bold; margin-top:5px"></div>
      </div>
    </div>
  </div>
</div>

<script>
[cite_start]// --- ä¿ç•™ Index-0105 çš„æ ¸å¿ƒé‚è¼¯ [cite: 559-824] ---
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;

// ç³»çµ±æ ¸å¿ƒå‡½æ•¸ (åŒ Index-0105)
function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); }
    else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }

  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){
    myData = snap.data();
  } else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  document.getElementById('player-name-display').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
    gameHistory = data.history || [];
    isAllLockedGlobal = data.isAllLocked || false;

    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    
    [cite_start]// æ¸²æŸ“æ­·å²å°çƒ [cite: 634]
    document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span style="display:inline-block;width:35px;height:35px;line-height:35px;background:var(--primary);color:white;border-radius:50%;margin:3px;font-weight:bold;font-size:1rem">${n}</span>`).join('') || "ç­‰å¾…é–‹è™Ÿ";

    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const r = Math.floor(Math.random()*25)+1;
        document.getElementById('draw-display').innerText = r;
        if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = r;
      }, 80);
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      document.getElementById('draw-display').innerText = last;
      if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = last;
      renderGrid();
    }
    
    // å¹¸é‹å…’å°è©±æ¡†å„ªåŒ–
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
      const input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹ 1-25 çš„è™Ÿç¢¼ï¼š`);
      if(input) {
        const num = parseInt(input);
        if(!isNaN(num) && num >= 1 && num <= 25 && !gameHistory.includes(num)) {
          db.collection("pending_choices").doc(currentUser.uid).set({
            playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          db.collection("game_state").doc("current_game").update({ luckyUser: "" });
        } else {
          alert("è™Ÿç¢¼ç„¡æ•ˆæˆ–å·²æŠ½é");
        }
      }
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    document.getElementById('count-total').innerText = allPlayersCache.length;
    document.getElementById('count-online').innerText = allPlayersCache.filter(p => p.lastSeen && (Date.now() - p.lastSeen.toDate()) < 60000).length;
    if(currentUser.uid !== ALLOWED_UID){
      const me = allPlayersCache.find(p => p.id === currentUser.uid);
      if(me && me.locked !== myData.locked) {
        myData.locked = me.locked;
        renderGrid();
      }
    }
  });

  if(currentUser.uid === ALLOWED_UID){
    db.collection("pending_choices").orderBy("timestamp","desc").onSnapshot(snap => {
      document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div>â“ ${d.data().playerName} é¸äº† ${d.data().number} <button style="background:var(--primary);color:#fff;border:none;border-radius:5px;padding:5px 10px" onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
    });
    db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
      document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ <b>${d.data().name}</b> è³“æœäº†ï¼</div>`).join('');
    });
  }
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  const lines = [
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];
  let winLineCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
      line.forEach(i=>winIdx.add(i));
      winLineCount++;
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winLineCount > 0 && myData.locked) {
    document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  }
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'block';
  document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­ (è«‹é»æ“Šé–å®š)";
}

// ç®¡ç†åŠŸèƒ½ (åŒ Index-0105)
async function forceLockAll() {
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}

async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll();
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false, luckyUser: "" });
  }, 1200);
}

async function removeAllPlayers() {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…å—ï¼Ÿ")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
  await batch.commit();
  location.reload();
}

async function handleReset(){
  if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
  await batch.commit();
  location.reload();
}

async function confirmLucky(id, num) {
  await db.collection("game_state").doc("current_game").update({ history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
  await db.collection("pending_choices").doc(id).delete();
}

async function pickLucky() {
  if(allPlayersCache.length === 0) return alert("æ²’äººåƒèˆ‡");
  const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
  await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
  alert("å¹¸é‹å…’æ˜¯ï¼š" + lucky);
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  if(!confirm("ç¢ºå®šé–å®šï¼Ÿé–å®šå¾Œç„¡æ³•æ›´æ›è™Ÿç¢¼ã€‚")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}
function doSignOut(){ auth.signOut(); location.reload(); }

// ç¶­æŒåœ¨ç·šç‹€æ…‹
setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
}, 15000);
</script>
</body>
</html>
