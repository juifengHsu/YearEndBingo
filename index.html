<!-- 2025 å°¾ç‰™è³“æœç³»çµ± â€” ç®¡ç†å„ªåŒ–ç‰ˆ
     ç‰ˆæ¬¡: v2.1
     è®Šæ›´é‡é»: ä¿®æ­£ board å”¯ä¸€æ€§è™•ç† (board_index)ã€pending_choices ä½¿ç”¨ doc id ç‚º uidã€ç®¡ç†ç«¯ PIN èˆ‡å¾Œç«¯æ¬Šé™åˆ†å·¥ã€æ”¹è‰¯ CSS é…è‰²èˆ‡å¯è®€æ€§
-->
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.1</title>

<!-- Firebase compat libs (ä¿ç•™æ‚¨åŸæœ¬ç‰ˆæœ¬) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#b71c1c; /* æ·±ç´… */
  --accent:#ffb300;  /* é‡‘è‰² */
  --bg:#f4f6f8;
  --card:#ffffff;
  --muted:#6b7280;
  --success:#2e7d32;
  --glass: rgba(255,255,255,0.85);
  --shadow: 0 6px 18px rgba(16,24,40,0.06);
  --radius:12px;
  --max-width:1100px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, system-ui, -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif;background:linear-gradient(180deg,var(--bg),#ffffff);color:#111}
.container{max-width:var(--max-width);margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.title{font-size:1.25rem;color:var(--primary);cursor:pointer}
.user-info{font-weight:600;color:var(--muted)}
.layout{display:grid;grid-template-columns:1fr 360px;gap:18px}
@media (max-width:900px){.layout{grid-template-columns:1fr}}

.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.player-area{min-height:460px;text-align:center;padding-top:8px}
.big-number{font-size:4.2rem;font-weight:800;color:var(--primary);height:110px;line-height:110px}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:420px;margin:10px auto}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:#fbfdff;border-radius:10px;border:1px solid #eef2f7;font-weight:700;color:#0f172a}
.cell.selected{background:#fff7e6;color:#b25600;border:1px solid #ffe0b2}
.cell.bingo-line{background:var(--success);color:#fff;animation:pulse 900ms infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

/* admin */
.admin-panel{display:flex;flex-direction:column;gap:12px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-box{background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);padding:10px;border-radius:10px;text-align:center}
.stat-val{font-weight:800;color:var(--accent);display:block;font-size:1.1rem}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.btn{padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff}
.btn.warn{background:#c62828;color:#fff}
.btn.ghost{background:#f3f4f6;color:#111}
.small{font-size:0.85rem;color:var(--muted)}
.pending-list{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:#fff}
.footer-actions{display:flex;gap:8px;margin-top:8px}

/* form */
input[type="text"], input[type="email"], input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 è³“æœç³»çµ± v2.1</div>
    <div id="user-info" class="user-info">æœªç™»å…¥</div>
  </div>

  <div class="layout">
    <!-- ç©å®¶å€ -->
    <div class="card player-area" id="main-content-area">
      <div id="login-form">
        <input id="player-name" type="text" placeholder="è¼¸å…¥çœŸå¯¦å§“åä»¥é€²å ´" />
        <div style="height:10px"></div>
        <button class="btn primary" style="width:100%" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
      </div>

      <div id="game-ui" class="hidden">
        <div id="draw-display" class="big-number">READY</div>
        <div id="bingo-status" class="small" style="height:26px;margin-bottom:8px;color:var(--success);font-weight:700"></div>
        <div id="bingo-grid" class="grid" aria-live="polite"></div>

        <div id="setup-btns" style="margin-top:16px;display:flex;gap:10px;justify-content:center">
          <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†å´æ¬„ -->
    <div id="admin-sidebar" class="admin-panel hidden">
      <div class="card">
        <div class="stat-grid">
          <div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="small">åœ¨ç·š</span></div>
          <div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="small">ç¸½äººæ•¸</span></div>
        </div>

        <div style="margin-top:10px" class="small">æœ€å¤§ç›¸é„°é€£è™Ÿåˆ†ä½ˆ</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div class="stat-box" style="flex:1"><span id="cnt-5" class="stat-val">0</span><span class="small">5+</span></div>
          <div class="stat-box" style="flex:1"><span id="cnt-4" class="stat-val">0</span><span class="small">4</span></div>
          <div class="stat-box" style="flex:1"><span id="cnt-3" class="stat-val">0</span><span class="small">3</span></div>
          <div class="stat-box" style="flex:1"><span id="cnt-2" class="stat-val">0</span><span class="small">2</span></div>
        </div>

        <div style="margin-top:12px;text-align:center;background:linear-gradient(90deg,#fff8e1,#fff);padding:10px;border-radius:10px">
          <div class="small">åŒæ­¥é–‹çè™Ÿ</div>
          <div id="admin-sync-num" style="font-size:2rem;font-weight:800;color:var(--accent)">--</div>
        </div>

        <div class="controls" style="margin-top:12px">
          <button class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ</button>
          <button class="btn" style="background:var(--accent);font-weight:800" onclick="pickLucky()">ğŸŒŸ å¹¸é‹å…’</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">ğŸ“¢ å³æ™‚è³“æœåå–®</div>
        <div id="bingo-alerts" class="pending-list"><div style="color:#9aa0a6">å°šç„¡è³“æœäº‹ä»¶...</div></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">å¾…æ ¸é¸è™Ÿ (<span id="pending-count">0</span>)</div>
        <div id="pending-choices" class="pending-list"></div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn warn" onclick="handleReset()">âš ï¸ é‡ç½®éŠæˆ²</button>
        <button class="btn ghost" onclick="location.reload()">é€€å‡ºä¸¦é‡æ•´</button>
      </div>
    </div>
  </div>
</div>

<!-- ç®¡ç†ç™»å…¥ Modal -->
<div id="admin-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999">
  <div style="width:320px;background:var(--card);padding:18px;border-radius:12px">
    <h3 style="margin:0 0 10px 0">ç®¡ç†å“¡ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" />
    <div style="height:8px"></div>
    <input id="admin-pwd" type="password" placeholder="Password" />
    <div style="height:12px"></div>
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
    <div style="height:8px"></div>
    <button class="btn ghost" style="width:100%" onclick="document.getElementById('admin-modal').style.display='none'">å–æ¶ˆ</button>
  </div>
</div>

<script>
/* Firebase config (ä¿ç•™åŸå§‹) */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false, boardStr:"", version:0 };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;

/* ç›¤é¢è¡Œåˆ—å®šç¾© */
const lines = [
  [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
  [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
  [0,6,12,18,24],[4,8,12,16,20]
];

/* ç™»å…¥æµç¨‹ï¼ˆåŒ¿åï¼‰ */
async function doPlayerLogin(){
  const name = document.getElementById('player-name').value.trim();
  if(!name) return alert("è«‹è¼¸å…¥å§“å");
  const cred = await auth.signInAnonymously();
  currentUser = cred.user;
  // è®€å–ç©å®¶è³‡æ–™ï¼ˆè‹¥ç„¡å‰‡å»ºç«‹ï¼‰
  const docRef = db.collection("players").doc(currentUser.uid);
  const snap = await docRef.get();
  if(snap.exists){
    myData = snap.data();
  } else {
    const board = shuffleArray();
    const boardStr = board.join(',');
    myData = { name, board, boardStr, locked:false, maxConsecutive:0, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), version:1 };
    // å»ºç«‹æ™‚åŒæ™‚å˜—è©¦å»ºç«‹ board_index ä»¥ç¢ºä¿å”¯ä¸€æ€§ï¼ˆç°¡å–®å˜—è©¦ï¼Œå¯¦å‹™æ‡‰ç”¨ transactionï¼‰
    try {
      await db.runTransaction(async tx => {
        const idxRef = db.collection("board_index").doc(boardStr);
        const idxSnap = await tx.get(idxRef);
        if(idxSnap.exists) throw "ç›¤é¢é‡è¤‡";
        tx.set(docRef, myData);
        tx.set(idxRef, { uid: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      });
    } catch(e){
      // è‹¥é‡è¤‡ï¼Œé‡æ–°ç”¢ç”Ÿä¸¦ç›´æ¥å¯«å…¥ï¼ˆå‰ç«¯æç¤ºï¼‰
      alert("ç”¢ç”Ÿåˆ°é‡è¤‡ç›¤é¢ï¼Œå·²è‡ªå‹•é‡è©¦ä¸€æ¬¡");
      myData.board = shuffleArray();
      myData.boardStr = myData.board.join(',');
      await db.collection("players").doc(currentUser.uid).set(myData);
    }
  }
  document.getElementById('login-form').style.display='none';
  document.getElementById('game-ui').classList.remove('hidden');
  document.getElementById('user-info').innerText = myData.name;
  startApp();
}

/* Admin trigger */
function triggerAdmin(){
  window.adminClicks = (window.adminClicks||0)+1;
  if(window.adminClicks>=5){
    document.getElementById('admin-modal').style.display='flex';
    window.adminClicks=0;
  }
}

/* Admin login (email/password) */
async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try{
    const cred = await auth.signInWithEmailAndPassword(email,pwd);
    if(cred.user.uid === ALLOWED_UID){
      document.getElementById('admin-modal').style.display='none';
      document.getElementById('main-content-area').innerHTML = '<div style="padding:80px;color:#9aa0a6">ç®¡ç†è€…æ§åˆ¶ä¸­...</div>';
      document.getElementById('admin-sidebar').classList.remove('hidden');
      document.getElementById('user-info').innerText = "ç®¡ç†è€…æ¨¡å¼";
      currentUser = cred.user;
      startApp();
    } else {
      alert("éç®¡ç†å“¡å¸³è™Ÿ");
    }
  } catch(e){
    alert("ç™»å…¥å¤±æ•—");
  }
}

/* å•Ÿå‹•ç›£è½ */
function startApp(){
  // game_state ç›£è½
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, luckyUser:"", status:"waiting" };
    gameHistory = data.history || [];
    // è™•ç† isRolling å‹•ç•«
    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const rand = Math.floor(Math.random()*25)+1;
        document.getElementById('draw-display').innerText = rand;
        document.getElementById('admin-sync-num').innerText = rand;
      }, 80);
    } else {
      if(rollingTimer){ clearInterval(rollingTimer); rollingTimer=null; }
      const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
      document.getElementById('draw-display').innerText = last;
      document.getElementById('admin-sync-num').innerText = last;
      renderGrid();
      if(currentUser && currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    // å¹¸é‹å…’æç¤ºï¼ˆåƒ…åœ¨ç©å®¶ç«¯ä¸”è¢«é¸ä¸­æ™‚é¡¯ç¤ºï¼‰
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser && currentUser.uid !== ALLOWED_UID){
      const num = prompt("ä½ æ˜¯å¹¸é‹å…’ï¼è«‹è¼¸å…¥ 1-25 é–‹çè™Ÿç¢¼ï¼š");
      if(num){
        // å¯«å…¥ pending_choices/{uid} ç”±ç®¡ç†ç«¯å¯©æ ¸
        db.collection("pending_choices").doc(currentUser.uid).set({
          number: parseInt(num),
          playerName: myData.name,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
  });

  // players ç›£è½ï¼ˆçµ±è¨ˆï¼‰
  db.collection("players").onSnapshot(snap => {
    const list = snap.docs.map(d => ({...d.data(), uid:d.id}));
    allPlayersCache = list;
    document.getElementById('count-total').innerText = list.length;
    const now = Date.now();
    const online = list.filter(p => p.lastSeen && (now - (p.lastSeen.toMillis ? p.lastSeen.toMillis() : new Date(p.lastSeen).getTime())) < 30000).length;
    document.getElementById('count-online').innerText = online;
    if(currentUser && currentUser.uid === ALLOWED_UID) updateConnectedStats();
  });

  // pending_choices ç›£è½ï¼ˆç®¡ç†ç«¯ï¼‰
  if(currentUser && currentUser.uid === ALLOWED_UID){
    db.collection("pending_choices").onSnapshot(snap => {
      const div = document.getElementById('pending-choices');
      div.innerHTML = snap.docs.map(d => {
        const p = d.data();
        return `<div style="padding:6px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
          <div><strong>${p.playerName}</strong>ï¼š${p.number}</div>
          <div><button class="btn ghost" onclick="confirmLucky('${d.id}', ${p.number})">é–‹è™Ÿ</button></div>
        </div>`;
      }).join('') || '<div style="color:#9aa0a6">ç„¡å¾…æ ¸é¸è™Ÿ</div>';
      document.getElementById('pending-count').innerText = snap.size;
    });

    // bingo_events ç›£è½ï¼ˆé¡¯ç¤ºï¼‰
    db.collection("bingo_events").orderBy("timestamp","desc").limit(20).onSnapshot(snap => {
      const container = document.getElementById('bingo-alerts');
      if(snap.empty){ container.innerHTML = '<div style="color:#9aa0a6">å°šç„¡è³“æœäº‹ä»¶...</div>'; return; }
      container.innerHTML = snap.docs.map(d => {
        const data = d.data();
        const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
        return `<div style="padding:8px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between"><div>ğŸ‰ ${data.name}</div><div style="color:#9aa0a6;font-size:0.85rem">${timeStr}</div></div>`;
      }).join('');
    });
  }

  // heartbeat æ›´æ–°ï¼ˆåŒ¿åç©å®¶ï¼‰
  setInterval(()=> {
    if(currentUser && !currentUser.email){
      db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
    }
  },15000);
}

/* render board */
function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  let winCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))){
      winCount++;
      line.forEach(i=>winIdx.add(i));
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell';
    if(gameHistory.includes(num)) div.classList.add('selected');
    if(winIdx.has(i)) div.classList.add('bingo-line');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winCount>0 && myData.locked){
    document.getElementById('bingo-status').innerText = `å·²é€£æˆ ${winCount} æ¢ç·šï¼`;
    // å¯«å…¥ bingo_eventsï¼ˆå»é‡ç”± doc id æ§åˆ¶ï¼‰
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  } else {
    document.getElementById('bingo-status').innerText = '';
  }
  document.getElementById('setup-btns').style.display = myData.locked ? 'none' : 'flex';
}

/* è¨ˆç®—æœ€å¤§é€£é€šï¼ˆæ”¹ç‚ºè¡Œåˆ—é€£çºŒåˆ¤æ–·æˆ–é„°æ¥ç¾¤çµ„çš†å¯ï¼Œé€™è£¡ä¿ç•™é„°æ¥ç¾¤çµ„ï¼‰ */
function calculateMaxConnected(board, history){
  const marked = new Set();
  board.forEach((num,idx)=>{ if(history.includes(num)) marked.add(idx); });
  if(marked.size===0) return 0;
  let maxGroupSize=0;
  const visited = new Set();
  for(let i=0;i<25;i++){
    if(marked.has(i) && !visited.has(i)){
      let count=0;
      const stack=[i]; visited.add(i);
      while(stack.length){
        const curr = stack.pop(); count++;
        const r=Math.floor(curr/5), c=curr%5;
        const neighbors=[];
        if(r>0) neighbors.push(curr-5);
        if(r<4) neighbors.push(curr+5);
        if(c>0) neighbors.push(curr-1);
        if(c<4) neighbors.push(curr+1);
        neighbors.forEach(n=>{
          if(marked.has(n) && !visited.has(n)){ visited.add(n); stack.push(n); }
        });
      }
      if(count>maxGroupSize) maxGroupSize=count;
    }
  }
  return maxGroupSize;
}

/* ç®¡ç†ç«¯çµ±è¨ˆæ›´æ–° */
function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const maxConn = calculateMaxConnected(p.board, gameHistory);
    if(maxConn>=5) counts[5]++;
    else if(maxConn===4) counts[4]++;
    else if(maxConn===3) counts[3]++;
    else if(maxConn===2) counts[2]++;
  });
  document.getElementById('cnt-5').innerText = counts[5];
  document.getElementById('cnt-4').innerText = counts[4];
  document.getElementById('cnt-3').innerText = counts[3];
  document.getElementById('cnt-2').innerText = counts[2];
}

/* æŠ½è™Ÿï¼ˆç®¡ç†ç«¯ï¼‰: ä½¿ç”¨ transaction å¯«å…¥ history ä¸¦æ§åˆ¶ isRolling */
async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  const snap = await ref.get();
  const history = snap.data()?.history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!history.includes(n));
  if(!pool.length) return alert("å·²æŠ½å®Œ");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const pick = pool[Math.floor(Math.random()*pool.length)];
    // ä»¥ transaction ç¢ºä¿ä¸€è‡´æ€§
    await db.runTransaction(async tx=>{
      const s = (await tx.get(ref)).data() || { history:[] };
      if((s.history||[]).includes(pick)) throw "already picked";
      tx.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(pick), isRolling:false, luckyUser:"" });
    });
  }, 1800);
}

/* é‡ç½®ï¼ˆç®¡ç†ç«¯ï¼‰ */
async function handleReset(){
  if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸ")) return;
  // æ‰¹æ¬¡åˆªé™¤ï¼ˆæ³¨æ„ï¼šå¤§é‡è³‡æ–™éœ€åˆ†é è™•ç†ï¼‰
  const collections = ["players","pending_choices","bingo_events","board_index"];
  for(const coll of collections){
    const snap = await db.collection(coll).get();
    const batch = db.batch();
    snap.forEach(d=>batch.delete(d.ref));
    await batch.commit();
  }
  await db.collection("game_state").doc("current_game").set({ history:[], isRolling:false, luckyUser:"", status:"waiting" });
  alert("å·²é‡ç½®");
  location.reload();
}

/* ç®¡ç†ç«¯ç¢ºèªå¹¸é‹å…’è™Ÿç¢¼ï¼ˆTransaction é©—è­‰ä¸é‡è¤‡ï¼‰ */
async function confirmLucky(docId, num){
  const ref = db.collection("game_state").doc("current_game");
  try{
    await db.runTransaction(async tx=>{
      const s = (await tx.get(ref)).data() || { history:[] };
      if((s.history||[]).includes(num)) throw "è™Ÿç¢¼å·²è¢«æŠ½é";
      tx.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser:"" });
      tx.delete(db.collection("pending_choices").doc(docId));
    });
  } catch(e){
    alert("ç¢ºèªå¤±æ•—ï¼š" + e);
  }
}

/* æŠ½å¹¸é‹å…’ï¼ˆç®¡ç†ç«¯ï¼‰: ç¯©é¸ locked ä¸” maxConsecutive æœ€å°çš„å‰ 15 å */
async function pickLucky(){
  const snap = await db.collection("players").where("locked","==",true).get();
  if(snap.empty) return alert("å°šç„¡é–å®šç›¤é¢");
  const players = snap.docs.map(d=>({uid:d.id,...d.data()}));
  // è¨ˆç®— maxConsecutiveï¼ˆè‹¥è³‡æ–™åº«å·²æœ‰å‰‡ä½¿ç”¨ï¼‰
  players.forEach(p=>{
    p.maxConsecutive = p.maxConsecutive || calculateMaxConnected(p.board || [], gameHistory);
  });
  players.sort((a,b)=> (a.maxConsecutive||0) - (b.maxConsecutive||0));
  const candidates = players.slice(0, Math.min(15, players.length));
  const lucky = candidates[Math.floor(Math.random()*candidates.length)];
  await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name || lucky.uid });
  alert("å¤©é¸ä¹‹äººå·²æŠ½ä¸­ï¼š" + (lucky.name || lucky.uid));
}

/* æ›è™Ÿã€é–å®šç›¤é¢ï¼ˆç©å®¶ï¼‰ */
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); myData.boardStr = myData.board.join(','); renderGrid(); }

async function confirmBoard(){
  if(!confirm("é–å®šå¾Œä¸èƒ½æ›´æ›è™Ÿç¢¼ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  // ä½¿ç”¨ transaction å˜—è©¦å»ºç«‹ board_index ä»¥ç¢ºä¿å”¯ä¸€æ€§
  const boardStr = myData.board.join(',');
  const playerRef = db.collection("players").doc(currentUser.uid);
  const idxRef = db.collection("board_index").doc(boardStr);
  try{
    await db.runTransaction(async tx=>{
      const idxSnap = await tx.get(idxRef);
      if(idxSnap.exists) throw "ç›¤é¢é‡è¤‡";
      tx.set(idxRef, { uid: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      tx.update(playerRef, { locked:true, board: myData.board, boardStr: boardStr, version: (myData.version||1)+1 });
    });
    myData.locked = true;
    renderGrid();
  } catch(e){
    alert("é–å®šå¤±æ•—ï¼š" + e);
  }
}
</script>
</body>
</html>
