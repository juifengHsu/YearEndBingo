<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å°¾ç‰™å¤§è³“æœ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --secondary: #ffc107; --bg: #f8f9fa; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); text-align: center; color: #333; }
        .page { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* è³“æœç›¤æ¨£å¼ */
        .grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 6px; max-width: 350px; margin: 20px auto; 
            background: #fff; padding: 10px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .cell { 
            aspect-ratio: 1; border: 1px solid #eee; display: flex; 
            align-items: center; justify-content: center; 
            font-size: 1.4rem; font-weight: bold; border-radius: 6px;
            background: #fff; transition: all 0.3s;
        }
        .cell.selected { background: var(--secondary); color: #b71c1c; transform: scale(0.9); }
        .cell.bingo-line { background: var(--primary); color: white; animation: pulse 1s infinite; }

        button { 
            padding: 15px 30px; font-size: 1.1rem; border: none; border-radius: 30px; 
            background: var(--primary); color: white; cursor: pointer; margin: 10px 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(2px); box-shadow: none; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 250px; margin-bottom: 10px; font-size: 1rem; }

        #draw-number { font-size: 5rem; color: var(--primary); font-weight: bold; min-height: 100px; line-height: 100px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .lucky-tag { color: #ef6c00; font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div onclick="countClicks()" style="position:fixed; top:0; left:0; width:50px; height:50px; z-index:9999; opacity:0;"></div>

    <script>
        let clickCount = 0;
        function countClicks() {
            clickCount++;
            if (clickCount >= 5) {
                showAdmin();
                clickCount = 0;
            }
        }
    </script>

    <div id="page-login" class="page active">
        <h1 style="color:var(--primary)">ğŸ§§ 2025 å°¾ç‰™è³“æœ</h1>
        <p>è«‹è¼¸å…¥å¤§åé–‹å§‹éŠæˆ²</p>
        <input type="text" id="username" placeholder="æ‚¨çš„å§“å (å¦‚: é™³å¤§æ˜)">
        <br>
        <button onclick="joinGame()">é€²å…¥éŠæˆ²</button>
    </div>

    <div id="page-game" class="page">
        <div id="user-info" style="font-weight:bold; margin-bottom:10px;"></div>
        <div id="draw-number">READY</div>
        <div id="status-text">è«‹å…ˆéš¨æ©Ÿè™Ÿç¢¼ä¸¦é»æ“Šä¿å­˜</div>
        
        <div class="grid" id="bingo-grid"></div>

        <div id="setup-controls">
            <button onclick="generateBoard()">éš¨æ©Ÿæ›è™Ÿ</button>
            <button onclick="lockBoard()" style="background:#2e7d32">ä¿å­˜è™Ÿç¢¼</button>
        </div>

        <div id="lucky-panel" style="display:none; background:#fff9c4; padding:20px; border-radius:15px; border:2px dashed #f9a825;">
            <div class="lucky-tag">ğŸŒŸ æ‚¨æ˜¯æœ¬è¼ªå¹¸é‹å…’ï¼</div>
            <p>è«‹æŒ‡å®šä¸€å€‹æœªé–‹éçš„è™Ÿç¢¼ (1-25)ï¼š</p>
            <input type="number" id="lucky-input" min="1" max="25" style="width:100px">
            <button onclick="submitLuckyNumber()" style="background:#f9a825">é€å‡ºè™Ÿç¢¼</button>
        </div>
    </div>

    <div id="page-admin" class="page">
        <h2 style="background: #333; color: white; padding: 10px;">ç®¡ç†è€…ä¸»æ§å°</h2>
        <div id="admin-stats">
            <div>å¯¦éš›åœ¨ç·šï¼š<span id="player-count" style="color:red; font-size:1.5rem;">0</span> äºº</div>
            <div style="font-size: 0.8rem; color: #888;">(ç¸½è¨»å†Šï¼š<span id="total-reg">0</span>)</div>
        </div>
        <button onclick="drawRandom()">ğŸ² éš¨æ©ŸæŠ½å–ä¸‹ä¸€è™Ÿ</button>
        <button onclick="pickLuckyUser()" style="background:#ef6c00">ğŸ¯ æŠ½å¹¸é‹å…’æŒ‡å®š</button>
        <hr>
        <button onclick="resetGame()" style="background:#555; font-size: 0.8rem;">é‡ç½®éŠæˆ²(æ…ç”¨)</button>
        <div id="admin-history" style="margin-top:20px; font-size: 0.9rem; color: #666;"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
            authDomain: "yearendbingo.firebaseapp.com",
            projectId: "yearendbingo",
            storageBucket: "yearendbingo.firebasestorage.app",
            messagingSenderId: "563353011392",
            appId: "1:563353011392:web:717976a176bc22a04d5925",
            measurementId: "G-M6EVYSPNJ9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const GAME_DOC = "current_game";

        let myName = "";
        let myBoard = [];
        let isLocked = false;
        let drawnHistory = [];
        let rollingInterval = null;

        // --- æ”¹å‹• 1: å…¨å±€ç›£è½äººæ•¸ (ä¸è«–æ˜¯èª°ä¸€æ‰“é–‹ç¶²é å°±æœƒåŸ·è¡Œ) ---
        function initGlobalMonitor() {
            db.collection("players").onSnapshot(snap => {
                const now = Date.now();
                let onlineCount = 0;
                let totalReg = snap.size;

                snap.forEach(doc => {
                    const data = doc.data();
                    // åˆ¤å®šåœ¨ç·šï¼šå¦‚æœ lastSeen åœ¨ 30 ç§’å…§æ›´æ–°éï¼Œè¦–ç‚ºåœ¨ç·š
                    if (data.lastSeen && (now - data.lastSeen < 30000)) {
                        onlineCount++;
                    }
                });

                if(document.getElementById('player-count')) {
                    document.getElementById('player-count').innerText = onlineCount;
                }
                if(document.getElementById('total-reg')) {
                    document.getElementById('total-reg').innerText = totalReg;
                }
            });
        }
        initGlobalMonitor();

        // --- æ”¹å‹• 2: å¿ƒè·³æ©Ÿåˆ¶ (ç©å®¶å ±åˆ°) ---
        function startHeartbeat() {
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updatePresence();
            // æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡è³‡æ–™åº«
            setInterval(updatePresence, 10000);
        }

        function updatePresence() {
            if (!myName) return;
            db.collection("players").doc(myName).set({
                name: myName,
                lastSeen: Date.now()
            }, { merge: true });
        }

        async function joinGame() {
            myName = document.getElementById('username').value.trim();
            if (!myName) return alert("è«‹è¼¸å…¥åå­—");
            
            document.getElementById('user-info').innerText = `ç©å®¶ï¼š${myName}`;
            switchPage('page-game');
            generateBoard();
            startListening();
            startHeartbeat(); // å•Ÿå‹•åœ¨ç·šè¿½è¹¤
        }

        function generateBoard() {
            if (isLocked) return;
            const nums = Array.from({length: 25}, (_, i) => i + 1);
            myBoard = nums.sort(() => Math.random() - 0.5);
            renderBoard();
        }

        function renderBoard() {
            const container = document.getElementById('bingo-grid');
            container.innerHTML = "";
            myBoard.forEach((num) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${num}`;
                cell.innerText = num;
                if (drawnHistory.includes(num)) cell.classList.add('selected');
                container.appendChild(cell);
            });
            checkBingo();
        }

        async function lockBoard() {
            if (!confirm("ä¿å­˜å¾Œå°±ä¸èƒ½æ›´æ”¹è™Ÿç¢¼å›‰ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            isLocked = true;
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('status-text').innerText = "ç­‰å¾…é–‹çä¸­...";
            await db.collection("players").doc(myName).set({ 
                name: myName, 
                board: myBoard, 
                locked: true,
                lastSeen: Date.now()
            }, { merge: true });
        }

        function startListening() {
            db.collection("game_state").doc(GAME_DOC).onSnapshot(doc => {
                const data = doc.data();
                if (!data) return;

                if (data.isRolling) {
                    startRollingEffect();
                } else {
                    stopRollingEffect();
                    drawnHistory = data.history || [];
                    const lastNum = drawnHistory[drawnHistory.length - 1];
                    if (lastNum) {
                        document.getElementById('draw-number').innerText = lastNum;
                        if (myBoard.includes(lastNum) && "vibrate" in navigator) navigator.vibrate(200);
                    }
                    renderBoard();
                }
                document.getElementById('lucky-panel').style.display = (data.luckyUser === myName) ? 'block' : 'none';
            });
        }

        function startRollingEffect() {
            if (rollingInterval) return;
            document.getElementById('status-text').innerText = "ğŸ“¢ è™Ÿç¢¼æŠ½å–ä¸­...";
            rollingInterval = setInterval(() => {
                document.getElementById('draw-number').innerText = Math.floor(Math.random() * 25) + 1;
            }, 80);
        }

        function stopRollingEffect() {
            clearInterval(rollingInterval);
            rollingInterval = null;
            document.getElementById('status-text').innerText = "é–‹ççµæœï¼š";
        }

        function checkBingo() {
            const winConditions = [
                [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
                [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
                [0,6,12,18,24],[4,8,12,16,20]
            ];
            let lines = 0;
            winConditions.forEach(indices => {
                if (indices.every(idx => drawnHistory.includes(myBoard[idx]))) {
                    lines++;
                    indices.forEach(idx => {
                        const num = myBoard[idx];
                        const el = document.getElementById(`cell-${num}`);
                        if(el) el.classList.add('bingo-line');
                    });
                }
            });
            if (lines > 0) {
                document.getElementById('status-text').innerText = `ğŸ‰ è³“æœï¼å·²é€£æˆ ${lines} æ¢ç·šï¼`;
            }
        }

        async function drawRandom() {
            await db.collection("game_state").doc(GAME_DOC).update({ isRolling: true, luckyUser: "" });
            setTimeout(async () => {
                const allNums = Array.from({length: 25}, (_, i) => i + 1);
                const remaining = allNums.filter(n => !drawnHistory.includes(n));
                if (remaining.length === 0) return alert("è™Ÿç¢¼å·²æŠ½å®Œ");
                const pick = remaining[Math.floor(Math.random() * remaining.length)];
                await db.collection("game_state").doc(GAME_DOC).update({
                    history: firebase.firestore.FieldValue.arrayUnion(pick),
                    isRolling: false
                });
            }, 2500);
        }

        async function pickLuckyUser() {
            const snap = await db.collection("players").where("locked", "==", true).get();
            const players = [];
            snap.forEach(doc => players.push(doc.id));
            if (players.length === 0) return alert("é‚„æ²’æœ‰ç©å®¶é–å®šè™Ÿç¢¼");
            const lucky = players[Math.floor(Math.random() * players.length)];
            await db.collection("game_state").doc(GAME_DOC).update({ luckyUser: lucky });
            alert(`å¹¸é‹å…’æ˜¯ï¼š${lucky}`);
        }

        async function submitLuckyNumber() {
            const num = parseInt(document.getElementById('lucky-input').value);
            if (isNaN(num) || num < 1 || num > 25 || drawnHistory.includes(num)) return alert("ç„¡æ•ˆæˆ–å·²é–‹é");
            await db.collection("game_state").doc(GAME_DOC).update({
                history: firebase.firestore.FieldValue.arrayUnion(num),
                luckyUser: ""
            });
        }

        async function resetGame() {
            if(!confirm("ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) return;
            await db.collection("game_state").doc(GAME_DOC).set({ history: [], isRolling: false, luckyUser: "" });
            // åŒæ™‚æ¸…é™¤æ‰€æœ‰ç©å®¶çš„é€£ç·šèˆ‡é–å®šç‹€æ…‹ (é¸åš)
            const batch = db.batch();
            const pSnap = await db.collection("players").get();
            pSnap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            location.reload();
        }

        function switchPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        window.showAdmin = () => switchPage('page-admin');
    </script>
</body>
</html>
