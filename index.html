<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.2 - ç‰¹åˆ¥çåŠ å¼·ç‰ˆ</title>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --primary: #f45925;
  --primary-dark: #d64010;
  --bg: #f8f6f5;
  --card: #ffffff;
  --text-main: #1c110d;
  --muted: #6b7280;
  --success: #2e7d32;
  --danger: #d64010;
  --gold: #d4af37;
  --shadow: 0 4px 12px rgba(244, 89, 37, 0.15);
  --radius: 1rem;
}

* { box-sizing: border-box; }
html, body { font-size: 26px; }

body {
  margin: 0;
  font-family: 'Spline Sans', 'Noto Sans TC', system-ui, sans-serif;
  background-color: var(--bg);
  color: var(--text-main);
  line-height: 1.5;
}

.container {
  max-width: 960px;
  padding: 24px 16px;
  margin: 0 auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.title {
  font-size: 1.5rem;
  font-weight: 900;
  color: var(--primary);
  cursor: pointer;
  user-select: none;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #f4eae7;
  padding: 24px;
  margin-bottom: 20px;
}

.hidden { display: none; }
  
.btn {
  padding: 12px 20px;
  border-radius: 9999px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  font-size: 1.2rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn.primary { background: var(--primary); color: #fff; }
.btn.ghost { background: #fff; border: 1px solid #e5e7eb; }
.btn.danger { background: #fee2e2; color: #b91c1c; }
.btn.gold { background: var(--gold); color: white; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3); }

.grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
  margin: 20px 0;
}

.cell {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f4eae7;
  border-radius: 50%;
  font-weight: 800;
  font-size: 1.8rem;
}

.cell.selected { background-color: var(--primary); color: white; }
.cell.bingo-line { background: #2e7d32; color: #fff; animation: pulse 900ms infinite; }

@keyframes pulse {
  0%, 100% { transform: scale(1.05); }
  50% { transform: scale(1.1); }
}

#draw-display {
  font-size: 4.5rem;
  font-weight: 900;
  color: var(--primary);
  height: 110px;
  text-align: center;
  overflow: hidden;
}

/* ç‰¹åˆ¥çé …æ¨£å¼ */
.special-prizes-box {
  margin-top: 20px;
  padding: 15px;
  background: #fffdf0;
  border: 2px solid var(--gold);
  border-radius: 12px;
}
.special-title {
  color: var(--gold);
  font-weight: 800;
  font-size: 1rem;
  margin-bottom: 10px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.prize-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px dashed #eee;
  font-size: 0.95rem;
}
.prize-name { color: var(--muted); }
.winner-name { color: var(--text-main); font-weight: 700; }

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }

@media (max-width: 600px) {
  html, body { font-size: 20px; }
  #draw-display { font-size: 4rem; }
}
</style>
</head>

<body>
<div id="admin-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <input id="admin-email" type="email" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px;">
    <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" style="width:100%; padding:10px; margin-bottom:10px;">
    <button class="btn primary" style="width:100%" onclick="doAdminLogin()">ç™»å…¥</button>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="title" onclick="triggerAdmin()">ğŸ§§ 2025 å°¾ç‰™ç‰¹åˆ¥ç‰ˆ</div>
    <div id="user-info" style="font-size:0.8rem; color:var(--muted)"></div>
  </div>

  <div id="view-login" class="card hidden">
    <h3 style="text-align:center; color:var(--primary)">ç©å®¶ç™»å…¥</h3>
    <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;" />
    <button class="btn primary" style="width:100%; margin-top:15px" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
  </div>

  <div id="view-player" class="hidden">
    <div class="card">
      <div id="player-name-display" style="font-weight:700"></div>
      <div id="draw-display">READY</div>
      <div id="bingo-grid" class="grid"></div>
      <div id="setup-btns" style="display:none; gap:10px; justify-content:center">
        <button class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
        <button class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®š</button>
      </div>
      
      <div id="player-special-box" class="special-prizes-box hidden">
        <div class="special-title">âœ¨ ç‰¹åˆ¥çä¸­çåå–® âœ¨</div>
        <div id="player-special-list"></div>
      </div>
    </div>
  </div>

  <div id="view-admin" class="hidden">
    <div class="card">
      <div style="display:flex; justify-content:space-between">
        <b>ç®¡ç†è€…æ§åˆ¶å°</b>
        <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
      </div>
      <div style="display:flex; gap:10px; margin:15px 0;">
        <div style="flex:1; background:#f0f0f0; padding:10px; border-radius:8px; text-align:center;">
          åœ¨ç·š: <span id="count-online">0</span>
        </div>
        <div style="flex:1; background:#f0f0f0; padding:10px; border-radius:8px; text-align:center;">
          ç¸½æ•¸: <span id="count-total">0</span>
        </div>
      </div>

      <div style="border: 2px solid var(--gold); padding: 15px; border-radius: 12px; margin-top: 15px;">
        <div style="font-weight:800; color:var(--gold); margin-bottom:10px;">ğŸ ç‰¹åˆ¥çæŠ½ç</div>
        <input id="prize-name-input" type="text" placeholder="ä¾‹å¦‚ï¼šé–‹å·¥å¤§ç´…åŒ…" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
        <button class="btn gold" style="width:100%" onclick="pickSpecialPrize()">ğŸŒŸ æŠ½å‡ºæ­¤çé …å¾—ä¸»</button>
        <button class="btn danger" style="width:100%; margin-top:8px; font-size:0.8rem;" onclick="clearSpecialPrizes()">é‡ç½®æ‰€æœ‰ç‰¹åˆ¥ç</button>
      </div>

      <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è³“æœè™Ÿç¢¼</button>
        <button class="btn ghost" onclick="handleReset()">âš ï¸ é‡ç½®è³“æœ</button>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let specialPrizes = [];
let rollingTimer = null;

function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) document.getElementById('admin-modal').style.display = 'flex';
}

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    await auth.signInWithEmailAndPassword(email, pwd);
    document.getElementById('admin-modal').style.display = 'none';
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
  
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){
    myData = snap.data();
  } else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('player-name-display').innerText = "æ­¡è¿ " + myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  ['view-login','view-player','view-admin'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById('view-'+name).classList.remove('hidden');
}

function updateDrawDisplay(text) {
  const el = document.getElementById('draw-display');
  el.innerText = text;
  el.style.fontSize = text.toString().length > 2 ? "2.2rem" : "4.5rem";
}

function startApp(){
  // ç›£è½éŠæˆ²ç‹€æ…‹ (è³“æœæ­·å²ã€å‹•ç•«ã€å¹¸é‹å…’)
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isPickingLucky:false, luckyUser:"", specialPrizes:[] };
    gameHistory = data.history || [];
    specialPrizes = data.specialPrizes || [];
    
    // æ›´æ–°ç‰¹åˆ¥çé¡¯ç¤ºå€
    updateSpecialPrizeUI(specialPrizes);

    if(data.isRolling){
      if(!rollingTimer){
        rollingTimer = setInterval(() => {
          let temp = data.isPickingLucky ? (allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)]?.name || "...") : Math.floor(Math.random()*25)+1;
          updateDrawDisplay(temp);
        }, 80);
      }
    } else {
      clearInterval(rollingTimer); rollingTimer = null;
      updateDrawDisplay(data.luckyUser || (gameHistory.length ? gameHistory[gameHistory.length-1] : "READY"));
      renderGrid();
    }
  });

  // ç›£è½ç©å®¶
  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    if(currentUser.uid === ALLOWED_UID){
      const now = Date.now();
      const online = allPlayersCache.filter(p => p.lastSeen && (now - p.lastSeen.toMillis()) < 300000);
      document.getElementById('count-online').innerText = online.length;
      document.getElementById('count-total').innerText = allPlayersCache.length;
    }
  });
}

// æ›´æ–°ç‰¹åˆ¥ç UI (ç®¡ç†è€…èˆ‡ç©å®¶å…±ç”¨)
function updateSpecialPrizeUI(prizes) {
  const listEl = document.getElementById('player-special-list');
  const boxEl = document.getElementById('player-special-box');
  if(!listEl) return;
  
  if(prizes.length > 0) {
    boxEl.classList.remove('hidden');
    listEl.innerHTML = prizes.map(p => `
      <div class="prize-item">
        <span class="prize-name">${p.prize}</span>
        <span class="winner-name">ğŸŠ ${p.winner}</span>
      </div>
    `).reverse().join(''); // æœ€æ–°çš„åœ¨ä¸Šé¢
  } else {
    boxEl.classList.add('hidden');
    listEl.innerHTML = "";
  }
}

// æŠ½å–ç‰¹åˆ¥ç (ç®¡ç†è€…å°ˆç”¨)
async function pickSpecialPrize() {
  const prizeName = document.getElementById('prize-name-input').value.trim();
  if(!prizeName) return alert("è«‹è¼¸å…¥çé …åç¨±ï¼");
  
  // å–å¾—ç›®å‰ã€Œåœ¨ç·šã€ä¸”ã€Œå°šæœªå¾—éç‰¹åˆ¥çã€çš„äºº
  const now = Date.now();
  const alreadyWon = specialPrizes.map(p => p.winner);
  const pool = allPlayersCache.filter(p => 
    !alreadyWon.includes(p.name) && // æ²’ä¸­é
    p.lastSeen && (now - p.lastSeen.toMillis()) < 300000 // 5åˆ†é˜å…§åœ¨ç·š
  );
  
  if(pool.length === 0) return alert("æŠ½çæ± å·²ç©ºæˆ–ç„¡äººåœ¨ç·šï¼");

  const ref = db.collection("game_state").doc("current_game");
  // å‹•ç•«å•Ÿå‹•
  await ref.update({ isRolling: true, isPickingLucky: true, luckyUser: "" });
  
  setTimeout(async () => {
    const winnerObj = pool[Math.floor(Math.random()*pool.length)];
    const newWinnerEntry = { prize: prizeName, winner: winnerObj.name, timestamp: Date.now() };
    
    await ref.update({
      isRolling: false,
      isPickingLucky: false,
      luckyUser: "ğŸŒŸ " + winnerObj.name,
      specialPrizes: firebase.firestore.FieldValue.arrayUnion(newWinnerEntry)
    });
    
    document.getElementById('prize-name-input').value = "";
    alert(`æ­å–œ ${winnerObj.name} ç²å¾— ${prizeName}ï¼`);
  }, 3000);
}

// æ¸…é™¤ç‰¹åˆ¥ç
async function clearSpecialPrizes() {
  if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç‰¹åˆ¥çåå–®å—ï¼Ÿ")) return;
  await db.collection("game_state").doc("current_game").update({ specialPrizes: [] });
}

// åŸæœ‰è³“æœé‚è¼¯
function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  myData.board.forEach(num => {
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  document.getElementById('setup-btns').style.display = (myData.locked) ? 'none' : 'flex';
}

async function drawNewNumber(){
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!gameHistory.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  const ref = db.collection("game_state").doc("current_game");
  await ref.update({ isRolling: true, isPickingLucky: false, luckyUser: "" });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false });
  }, 1200);
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
async function confirmBoard(){
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}
async function handleReset(){
  if(!confirm("é‡ç½®è³“æœï¼Ÿ")) return;
  await db.collection("game_state").doc("current_game").update({ history:[], luckyUser:"", isRolling:false });
}
function doSignOut(){ auth.signOut(); location.reload(); }

// å¿ƒè·³åŒ…
setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
  }
}, 10000);
</script>
</body>
</html>
