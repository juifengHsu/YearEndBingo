<!-- 2025 å°¾ç‰™è³“æœç³»çµ± â€” ç®¡ç†å„ªåŒ–ç‰ˆ
     ç‰ˆæ¬¡: v2.5
     è®Šæ›´é‡é»: ä¸‰è¦–åœ–è·¯ç”±ï¼ˆLogin / Player / Adminï¼‰ï¼›ä¿®æ­£é‡ç½®èˆ‡æŠ½è™Ÿé–å®šæµç¨‹ï¼›ä¿ç•™ç‹€æ…‹åˆ—
-->
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v2.5</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#b71c1c; --accent:#ffb300; --bg:#f4f6f8; --card:#fff;
  --muted:#6b7280; --success:#2e7d32; --danger:#c62828; --shadow:0 6px 18px rgba(16,24,40,0.06);
  --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Noto Sans TC", "Microsoft JhengHei", system-ui;background:var(--bg);color:#111}
.container{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.title{font-size:1.25rem;color:var(--primary)}
.user-info{font-weight:600;color:var(--muted)}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:12px}
.hidden{display:none}
.center{display:flex;align-items:center;justify-content:center}
.btn{padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.btn.primary{background:var(--primary);color:#fff}
.btn.ghost{background:#f3f4f6;color:#111}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-box{background:linear-gradient(180deg,rgba(0,0,0,0.04),transparent);padding:10px;border-radius:10px;text-align:center}
.stat-val{font-weight:800;color:var(--accent);display:block;font-size:1.1rem}
.pending-list{max-height:220px;overflow:auto;padding:8px;border-radius:8px;background:#fff}
.status-log{max-height:160px;overflow:auto;padding:10px;border-radius:8px;background:#0f172a;color:#fff;font-size:0.9rem}
.status-item{padding:6px;border-bottom:1px solid rgba(255,255,255,0.06)}
.status-success{color:#b7f5c6}
.status-fail{color:#ffd1d1}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:420px;margin:10px auto}
.cell{aspect-ratio:1;display:flex;align-items:center;justify-content:center;background:#fbfdff;border-radius:10px;border:1px solid #eef2f7;font-weight:700}
.cell.selected{background:#fff7e6;color:#b25600}
.cell.bingo-line{background:var(--success);color:#fff;animation:pulse 900ms infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
.small{font-size:0.85rem;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">ğŸ§§ 2025 è³“æœç³»çµ± v2.5</div>
    <div id="user-info" class="user-info">æœªç™»å…¥</div>
  </div>

  <!-- LOGIN è¦–åœ– -->
  <div id="view-login" class="card">
    <h3>ç®¡ç† / ç©å®¶ ç™»å…¥</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <input id="player-name" type="text" placeholder="ç©å®¶ï¼šè¼¸å…¥å§“åï¼ˆåŒ¿åç™»å…¥ï¼‰" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee" />
        <div style="height:8px"></div>
        <button class="btn primary" style="width:100%" onclick="doPlayerLogin()">åŒ¿åé€²å ´ï¼ˆç©å®¶ï¼‰</button>
      </div>
      <div style="flex:1;min-width:220px">
        <input id="admin-email" type="email" placeholder="ç®¡ç†å“¡ Email" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee" />
        <div style="height:8px"></div>
        <input id="admin-pwd" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee" />
        <div style="height:8px"></div>
        <button class="btn ghost" style="width:100%" onclick="doAdminLogin()">ç®¡ç†å“¡ç™»å…¥</button>
      </div>
    </div>
  </div>

  <!-- PLAYER è¦–åœ– -->
  <div id="view-player" class="hidden">
    <div class="card">
      <div id="player-header" style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700" id="player-name-display"></div>
          <div class="small">ç©å®¶é é¢</div>
        </div>
        <div>
          <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
        </div>
      </div>

      <div style="margin-top:12px;text-align:center">
        <div id="draw-display" style="font-size:3.6rem;font-weight:800;color:var(--primary);height:90px;line-height:90px">READY</div>
        <div id="bingo-status" class="small" style="height:26px;margin-bottom:8px;color:var(--success);font-weight:700"></div>
        <div id="bingo-grid" class="grid"></div>
        <div id="setup-btns" style="margin-top:12px;display:flex;gap:10px;justify-content:center">
          <button id="btn-reroll" class="btn ghost" onclick="reRollBoard()">ğŸ² æ›è™Ÿç¢¼</button>
          <button id="btn-lock" class="btn primary" onclick="confirmBoard()">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN è¦–åœ–ï¼ˆä¸»ç•«é¢ï¼‰ -->
  <div id="view-admin" class="hidden">
    <div class="card admin-main">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">ç®¡ç†è€…æ§åˆ¶å°</div>
            <div class="small">ç®¡ç†é é¢</div>
          </div>
          <div>
            <button class="btn ghost" onclick="doSignOut()">ç™»å‡º</button>
          </div>
        </div>

        <div style="margin-top:12px" class="stat-grid">
          <div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="small">åœ¨ç·š</span></div>
          <div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="small">ç¸½äººæ•¸</span></div>
        </div>

        <div style="margin-top:10px" class="small">æœ€å¤§ç›¸é„°é€£è™Ÿåˆ†ä½ˆ</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div class="stat-box" style="flex:1"><span id="cnt-5" class="stat-val">0</span><span class="small">5+</span></div>
          <div class="stat-box" style="flex:1"><span id="cnt-4" class="stat-val">0</span><span class="small">4</span></div>
          <div class="stat-box" style="flex:1"><span id="cnt-3" class="stat-val">0</span><span class="small">3</span></div>
          <div class="stat-box" style="flex:1"><span id="cnt-2" class="stat-val">0</span><span class="small">2</span></div>
        </div>

        <div style="margin-top:12px;text-align:center;background:linear-gradient(90deg,#fff8e1,#fff);padding:10px;border-radius:10px">
          <div class="small">åŒæ­¥é–‹çè™Ÿ</div>
          <div id="admin-sync-num" style="font-size:2rem;font-weight:800;color:var(--accent)">--</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btn-draw" class="btn primary" onclick="drawNewNumber()">ğŸ² æŠ½è™Ÿ</button>
          <button id="btn-pick" class="btn" style="background:var(--accent);font-weight:800" onclick="pickLucky()">ğŸŒŸ å¹¸é‹å…’</button>
          <button class="btn ghost" onclick="handleReset()">âš ï¸ é‡ç½®</button>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:700;margin-bottom:8px">ğŸ“¢ å³æ™‚è³“æœåå–®</div>
        <div id="bingo-alerts" class="pending-list"><div style="color:#9aa0a6">å°šç„¡è³“æœäº‹ä»¶...</div></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">å¾…æ ¸é¸è™Ÿ (<span id="pending-count">0</span>)</div>
        <div id="pending-choices" class="pending-list"></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">ç³»çµ±ç‹€æ…‹åˆ—</div>
        <div id="status-log" class="status-log" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* Firebase config (ä¿ç•™) */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* å…¨åŸŸç‹€æ…‹ */
let currentUser = null;
let myData = { name:"", board:[], locked:false, boardStr:"", version:0 };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;

/* è¡Œåˆ—å®šç¾© */
const lines = [
  [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
  [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
  [0,6,12,18,24],[4,8,12,16,20]
];

/* ç‹€æ…‹åˆ—å¯«å…¥ */
function logStatus(message, ok = true){
  const el = document.getElementById('status-log');
  if(!el) return;
  const time = new Date().toLocaleTimeString();
  const div = document.createElement('div');
  div.className = 'status-item ' + (ok ? 'status-success' : 'status-fail');
  div.innerText = `[${time}] ${message}`;
  el.prepend(div);
  try { db.collection("audit_logs").add({ action: message, detail:{ok}, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e){}
}

/* é¡¯ç¤ºè·¯ç”± */
function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  if(name === 'login') document.getElementById('view-login').classList.remove('hidden');
  if(name === 'player') document.getElementById('view-player').classList.remove('hidden');
  if(name === 'admin') document.getElementById('view-admin').classList.remove('hidden');
}

/* Auth ç›£è½ï¼šæ±ºå®šè·¯ç”± */
auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ document.getElementById('user-info').innerText = "æœªç™»å…¥"; showView('login'); return; }
  // è‹¥ç‚ºç®¡ç†å“¡ UID -> admin
  if(user.uid === ALLOWED_UID){
    document.getElementById('user-info').innerText = "ç®¡ç†è€…æ¨¡å¼";
    showView('admin');
    startApp(); return;
  }
  // ä¸€èˆ¬ç©å®¶ï¼šå˜—è©¦è®€å– players/{uid}ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å»ºç«‹ï¼ˆåŒ¿åç™»å…¥æµç¨‹ï¼‰
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){
    myData = snap.data();
  } else {
    // è‹¥å°šæœªå»ºç«‹ï¼Œå»ºç«‹ä¸€å€‹é è¨­ç›¤é¢ï¼ˆä¸é–å®šï¼‰
    const nameInput = document.getElementById('player-name')?.value?.trim() || ("ç©å®¶" + user.uid.slice(0,6));
    const board = shuffleArray();
    myData = { name: nameInput, board, boardStr: board.join(','), locked:false, maxConsecutive:0, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), version:1 };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name || "å·²ç™»å…¥";
  document.getElementById('player-name-display').innerText = myData.name || "ç©å®¶";
  showView('player');
  startApp();
});

/* ç™»å…¥ / ç™»å‡º */
async function doPlayerLogin(){
  const name = document.getElementById('player-name').value.trim();
  if(!name) return alert("è«‹è¼¸å…¥å§“å");
  try {
    const cred = await auth.signInAnonymously();
    currentUser = cred.user;
    // players doc æœƒåœ¨ onAuthStateChanged è£¡å»ºç«‹æˆ–è®€å–
  } catch(e){ alert("åŒ¿åç™»å…¥å¤±æ•—"); }
}

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID){
      logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ", true);
    } else {
      logStatus("ç®¡ç†å“¡ç™»å…¥å¤±æ•—ï¼šéç®¡ç†å“¡", false);
      alert("éç®¡ç†å“¡å¸³è™Ÿ");
      await auth.signOut();
    }
  } catch(e){
    logStatus("ç®¡ç†å“¡ç™»å…¥å¤±æ•—ï¼š" + e, false);
    alert("ç™»å…¥å¤±æ•—");
  }
}

function doSignOut(){ auth.signOut(); showView('login'); }

/* ç›£è½å™¨ç®¡ç† */
let gameStateUnsub = null;
let playersUnsub = null;
let pendingUnsub = null;
let bingoEventsUnsub = null;

function startApp(){
  if(gameStateUnsub) gameStateUnsub();
  if(playersUnsub) playersUnsub();
  if(pendingUnsub) pendingUnsub();
  if(bingoEventsUnsub) bingoEventsUnsub();

  gameStateUnsub = db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, luckyUser:"", status:"waiting" };
    gameHistory = data.history || [];
    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    const drawEl = document.getElementById('draw-display');
    const syncEl = document.getElementById('admin-sync-num');
    if(drawEl) drawEl.innerText = last;
    if(syncEl) syncEl.innerText = last;
    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const rand = Math.floor(Math.random()*25)+1;
        if(drawEl) drawEl.innerText = rand;
        if(syncEl) syncEl.innerText = rand;
      }, 80);
    } else {
      if(rollingTimer){ clearInterval(rollingTimer); rollingTimer=null; }
      if(myData && myData.board && myData.board.length) renderGrid();
      if(currentUser && currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser && currentUser.uid !== ALLOWED_UID){
      const num = prompt("ä½ æ˜¯å¹¸é‹å…’ï¼è«‹è¼¸å…¥ 1-25 é–‹çè™Ÿç¢¼ï¼š");
      if(num){
        db.collection("pending_choices").doc(currentUser.uid).set({ number: parseInt(num), playerName: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
  });

  playersUnsub = db.collection("players").onSnapshot(snap => {
    const list = snap.docs.map(d => ({...d.data(), uid:d.id}));
    allPlayersCache = list;
    document.getElementById('count-total').innerText = list.length;
    const now = Date.now();
    const online = list.filter(p => p.lastSeen && (now - (p.lastSeen.toMillis ? p.lastSeen.toMillis() : new Date(p.lastSeen).getTime())) < 30000).length;
    document.getElementById('count-online').innerText = online;
    if(currentUser && currentUser.uid === ALLOWED_UID) updateConnectedStats();
    // è‹¥ç©å®¶é é¢ä½† myData ç¼ºæ¿ï¼Œå˜—è©¦è£œè¼‰
    if(currentUser && currentUser.uid !== ALLOWED_UID && (!myData || !myData.board || !myData.board.length)){
      db.collection("players").doc(currentUser.uid).get().then(snap=>{
        if(snap.exists){ myData = snap.data(); document.getElementById('player-name-display').innerText = myData.name; renderGrid(); }
      }).catch(()=>{});
    }
  });

  if(currentUser && currentUser.uid === ALLOWED_UID){
    pendingUnsub = db.collection("pending_choices").onSnapshot(snap => {
      const div = document.getElementById('pending-choices');
      div.innerHTML = snap.docs.map(d => {
        const p = d.data();
        return `<div style="padding:6px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
          <div><strong>${p.playerName}</strong>ï¼š${p.number}</div>
          <div><button class="btn ghost" onclick="confirmLucky('${d.id}', ${p.number})">é–‹è™Ÿ</button></div>
        </div>`;
      }).join('') || '<div style="color:#9aa0a6">ç„¡å¾…æ ¸é¸è™Ÿ</div>';
      document.getElementById('pending-count').innerText = snap.size;
    });

    bingoEventsUnsub = db.collection("bingo_events").orderBy("timestamp","desc").limit(20).onSnapshot(snap => {
      const container = document.getElementById('bingo-alerts');
      if(snap.empty){ container.innerHTML = '<div style="color:#9aa0a6">å°šç„¡è³“æœäº‹ä»¶...</div>'; return; }
      container.innerHTML = snap.docs.map(d => {
        const data = d.data();
        const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
        return `<div style="padding:8px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between"><div>ğŸ‰ ${data.name}</div><div style="color:#9aa0a6;font-size:0.85rem">${timeStr}</div></div>`;
      }).join('');
    });
  }

  // heartbeat for player
  if(currentUser && currentUser.uid !== ALLOWED_UID){
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
  if(window.heartbeatInterval) clearInterval(window.heartbeatInterval);
  window.heartbeatInterval = setInterval(()=> {
    if(currentUser && currentUser.uid !== ALLOWED_UID){
      db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
    }
  },15000);
}

/* PLAYER UI: render board */
function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  let winCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))){
      winCount++;
      line.forEach(i=>winIdx.add(i));
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell';
    if(gameHistory.includes(num)) div.classList.add('selected');
    if(winIdx.has(i)) div.classList.add('bingo-line');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winCount>0 && myData.locked){
    document.getElementById('bingo-status').innerText = `å·²é€£æˆ ${winCount} æ¢ç·šï¼`;
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  } else {
    document.getElementById('bingo-status').innerText = '';
  }
  document.getElementById('setup-btns').style.display = myData.locked ? 'none' : 'flex';
}

/* PLAYER actions */
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); myData.boardStr = myData.board.join(','); renderGrid(); }

async function confirmBoard(){
  if(!confirm("é–å®šå¾Œä¸èƒ½æ›´æ›è™Ÿç¢¼ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  const boardStr = myData.board.join(',');
  const playerRef = db.collection("players").doc(currentUser.uid);
  const idxRef = db.collection("board_index").doc(boardStr);
  try{
    await db.runTransaction(async tx=>{
      const idxSnap = await tx.get(idxRef);
      if(idxSnap.exists) throw "ç›¤é¢é‡è¤‡";
      tx.set(idxRef, { uid: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      tx.set(playerRef, { ...myData, locked:true, board: myData.board, boardStr: boardStr, version: (myData.version||1)+1 }, { merge: true });
    });
    myData.locked = true;
    renderGrid();
    alert("é–å®šæˆåŠŸ");
  } catch(e){
    alert("é–å®šå¤±æ•—ï¼š" + e);
  }
}

/* ç®¡ç†ï¼šåˆ†é æ‰¹æ¬¡å¼·åˆ¶é–å®šæ‰€æœ‰ç©å®¶ */
async function forceLockAllPlayers(){
  try {
    const pageSize = 400;
    let lastDoc = null;
    let totalLocked = 0;
    while(true){
      let q = db.collection("players").orderBy("__name__").limit(pageSize);
      if(lastDoc) q = q.startAfter(lastDoc);
      const snap = await q.get();
      if(snap.empty) break;
      const batch = db.batch();
      snap.docs.forEach(doc => batch.update(doc.ref, { locked: true, version: (doc.data().version || 1) + 1 }));
      await batch.commit();
      totalLocked += snap.size;
      lastDoc = snap.docs[snap.docs.length - 1];
      if(snap.size < pageSize) break;
    }
    logStatus(`å¼·åˆ¶é–å®šå®Œæˆï¼šå…±é–å®š ${totalLocked} ä½ç©å®¶`, true);
    return true;
  } catch(e){
    logStatus("å¼·åˆ¶é–å®šå¤±æ•—ï¼š" + e, false);
    return false;
  }
}

/* ç®¡ç†ï¼šæŠ½è™Ÿï¼ˆå…ˆé–å®šï¼‰ */
async function drawNewNumber(){
  document.getElementById('btn-draw').disabled = true;
  logStatus("é–‹å§‹æŠ½è™Ÿï¼šå˜—è©¦å¼·åˆ¶é–å®šæ‰€æœ‰ç©å®¶...", true);
  const locked = await forceLockAllPlayers();
  if(!locked){ document.getElementById('btn-draw').disabled = false; return; }
  logStatus("æ‰€æœ‰ç©å®¶å·²é–å®šï¼Œé–‹å§‹æŠ½è™Ÿå‹•ç•«", true);

  const ref = db.collection("game_state").doc("current_game");
  const snap = await ref.get();
  const history = snap.data()?.history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!history.includes(n));
  if(!pool.length){ logStatus("æŠ½è™Ÿå–æ¶ˆï¼šè™Ÿç¢¼å·²æŠ½å®Œ", false); document.getElementById('btn-draw').disabled = false; return alert("å·²æŠ½å®Œ"); }
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const pick = pool[Math.floor(Math.random()*pool.length)];
    try {
      await db.runTransaction(async tx=>{
        const s = (await tx.get(ref)).data() || { history:[] };
        if((s.history||[]).includes(pick)) throw "already picked";
        tx.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(pick), isRolling:false, luckyUser:"" });
      });
      logStatus(`æŠ½è™ŸæˆåŠŸï¼šæœ¬æ¬¡é–‹å‡º ${pick}`, true);
    } catch(e){
      await ref.update({ isRolling:false });
      logStatus("æŠ½è™Ÿå¤±æ•—ï¼š" + e, false);
      alert("æŠ½è™Ÿå¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
      document.getElementById('btn-draw').disabled = false;
    }
  }, 1800);
}

/* ç®¡ç†ï¼šé‡ç½®ï¼ˆåˆªé™¤é›†åˆä¸¦ç‚ºç•¶å‰ç©å®¶å»ºç«‹ç›¤é¢ï¼‰ */
async function handleReset(){
  if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸ")) return;
  try {
    const collections = ["players","pending_choices","bingo_events","board_index"];
    for(const coll of collections){
      const snap = await db.collection(coll).get();
      const batch = db.batch();
      snap.forEach(d=>batch.delete(d.ref));
      await batch.commit();
    }
    await db.collection("game_state").doc("current_game").set({ history:[], isRolling:false, luckyUser:"", status:"waiting" });
    logStatus("é‡ç½®å®Œæˆï¼šgame_state èˆ‡é›†åˆå·²æ¸…ç©º", true);

    myData = { name:"", board:[], locked:false, boardStr:"", version:0 };
    gameHistory = [];
    allPlayersCache = [];
    if(rollingTimer){ clearInterval(rollingTimer); rollingTimer = null; }
    startApp();

    if(currentUser && currentUser.uid !== ALLOWED_UID){
      const newBoard = shuffleArray();
      const newBoardStr = newBoard.join(',');
      myData = { name: myData.name || ("ç©å®¶" + currentUser.uid.slice(0,6)), board: newBoard, boardStr: newBoardStr, locked:false, maxConsecutive:0, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), version:1 };
      await db.collection("players").doc(currentUser.uid).set(myData);
      logStatus("ç‚ºç•¶å‰ç©å®¶è‡ªå‹•å»ºç«‹æ–°ç›¤é¢ä¸¦æ¢å¾©æ›è™Ÿ/é–å®šåŠŸèƒ½", true);
      // é¡¯ç¤º player è¦–åœ–
      document.getElementById('player-name-display').innerText = myData.name;
      showView('player');
      renderGrid();
    } else if(currentUser && currentUser.uid === ALLOWED_UID){
      showView('admin');
      logStatus("ç®¡ç†è€…ä¿ç•™ç™»å…¥", true);
    } else {
      showView('login');
    }
  } catch(e){
    logStatus("é‡ç½®å¤±æ•—ï¼š" + e, false);
    alert("é‡ç½®å¤±æ•—ï¼š" + e);
  }
}

/* ç®¡ç†ï¼šç¢ºèªå¹¸é‹è™Ÿ */
async function confirmLucky(docId, num){
  const ref = db.collection("game_state").doc("current_game");
  try{
    await db.runTransaction(async tx=>{
      const s = (await tx.get(ref)).data() || { history:[] };
      if((s.history||[]).includes(num)) throw "è™Ÿç¢¼å·²è¢«æŠ½é";
      tx.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser:"" });
      tx.delete(db.collection("pending_choices").doc(docId));
    });
    logStatus(`ç¢ºèªå¹¸é‹è™Ÿ ${num} æˆåŠŸ`, true);
  } catch(e){
    logStatus("ç¢ºèªå¹¸é‹è™Ÿå¤±æ•—ï¼š" + e, false);
    alert("ç¢ºèªå¤±æ•—ï¼š" + e);
  }
}

/* ç®¡ç†ï¼šæŠ½å¹¸é‹å…’ */
async function pickLucky(){
  try {
    const snap = await db.collection("players").where("locked","==",true).get();
    if(snap.empty) { logStatus("æŠ½å¹¸é‹å…’å¤±æ•—ï¼šç„¡é–å®šç©å®¶", false); return alert("å°šç„¡é–å®šç›¤é¢"); }
    const players = snap.docs.map(d=>({uid:d.id,...d.data()}));
    players.forEach(p=> p.maxConsecutive = p.maxConsecutive || calculateMaxConnected(p.board || [], gameHistory));
    players.sort((a,b)=> (a.maxConsecutive||0) - (b.maxConsecutive||0));
    const candidates = players.slice(0, Math.min(15, players.length));
    const lucky = candidates[Math.floor(Math.random()*candidates.length)];
    await db.collection("game_state").doc("current_game").update({ luckyUser: lucky.name || lucky.uid });
    logStatus(`æŠ½å¹¸é‹å…’æˆåŠŸï¼š${lucky.name || lucky.uid}`, true);
    alert("å¤©é¸ä¹‹äººå·²æŠ½ä¸­ï¼š" + (lucky.name || lucky.uid));
  } catch(e){
    logStatus("æŠ½å¹¸é‹å…’å¤±æ•—ï¼š" + e, false);
    alert("æŠ½å¹¸é‹å…’å¤±æ•—ï¼š" + e);
  }
}

/* å·¥å…·ï¼šè¨ˆç®—æœ€å¤§é€£é€š */
function calculateMaxConnected(board, history){
  const marked = new Set();
  board.forEach((num,idx)=>{ if(history.includes(num)) marked.add(idx); });
  if(marked.size===0) return 0;
  let maxGroupSize=0;
  const visited = new Set();
  for(let i=0;i<25;i++){
    if(marked.has(i) && !visited.has(i)){
      let count=0;
      const stack=[i]; visited.add(i);
      while(stack.length){
        const curr = stack.pop(); count++;
        const r=Math.floor(curr/5), c=curr%5;
        const neighbors=[];
        if(r>0) neighbors.push(curr-5);
        if(r<4) neighbors.push(curr+5);
        if(c>0) neighbors.push(curr-1);
        if(c<4) neighbors.push(curr+1);
        neighbors.forEach(n=>{
          if(marked.has(n) && !visited.has(n)){ visited.add(n); stack.push(n); }
        });
      }
      if(count>maxGroupSize) maxGroupSize=count;
    }
  }
  return maxGroupSize;
}

function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const maxConn = p.maxConsecutive || calculateMaxConnected(p.board || [], gameHistory);
    if(maxConn>=5) counts[5]++;
    else if(maxConn===4) counts[4]++;
    else if(maxConn===3) counts[3]++;
    else if(maxConn===2) counts[2]++;
  });
  document.getElementById('cnt-5').innerText = counts[5];
  document.getElementById('cnt-4').innerText = counts[4];
  document.getElementById('cnt-3').innerText = counts[3];
  document.getElementById('cnt-2').innerText = counts[2];
}
</script>
</body>
</html>
