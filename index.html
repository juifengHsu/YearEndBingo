<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å°¾ç‰™å¤§è³“æœ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #d32f2f; --secondary: #ffc107; --bg: #f8f9fa; --success: #2e7d32; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); text-align: center; color: #333; -webkit-user-select: none; }
        .page { display: none !important; padding: 20px; box-sizing: border-box; }
        .page.active { display: block !important; }

        /* è³“æœç›¤æ¨£å¼ */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; max-width: 350px; margin: 15px auto; background: #fff; padding: 10px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .cell { aspect-ratio: 1; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: bold; border-radius: 8px; background: #fff; position: relative; }
        .cell.selected { background: var(--secondary); color: #b71c1c; }
        .cell.bingo-line { background: var(--primary) !important; color: white !important; transition: 0.3s; z-index: 1; }

        button { padding: 15px 25px; font-size: 1.1rem; border: none; border-radius: 30px; background: var(--primary); color: white; cursor: pointer; margin: 8px 4px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:disabled { background: #ccc !important; cursor: not-allowed; box-shadow: none; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 250px; margin-bottom: 10px; font-size: 1rem; }

        .big-number { font-size: 6rem; color: var(--primary); font-weight: bold; min-height: 130px; line-height: 130px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        
        /* ç®¡ç†ç«¯åå–®å€åŸŸ */
        #admin-list-view { text-align: left; background: white; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #ddd; max-height: 400px; overflow-y: auto; }
        .list-group { margin-bottom: 12px; }
        .list-group-title { font-weight: bold; color: var(--primary); border-bottom: 2px solid #f0f0f0; margin-bottom: 8px; font-size: 1rem; padding-bottom: 4px; }
        .name-tag { display: inline-block; background: #f0f0f0; padding: 6px 10px; border-radius: 6px; margin: 3px; font-size: 0.85rem; }
        .name-tag.weak { background: #fff9c4; border: 1px solid #f9a825; color: #e65100; font-weight: bold; }

        /* Switch æ¨£å¼ */
        .switch-box { margin: 20px 0; background:#fff; padding:15px; border-radius:12px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>

    <div onclick="handleAdminClick()" style="position:fixed; top:0; left:0; width:80px; height:80px; z-index:9999;"></div>

    <div id="page-login" class="page active">
        <h1 style="color:var(--primary); margin-top: 15vh; font-size: 2.5rem;">ğŸ§§ 2025<br>å°¾ç‰™å¤§è³“æœ</h1>
        <p style="color: #666;">è«‹è¼¸å…¥å§“åé€²å…¥éŠæˆ²å®¤</p>
        <input type="text" id="username" placeholder="æ‚¨çš„å§“å">
        <br>
        <button onclick="joinGame()">ç¢ºèªé€²å…¥</button>
    </div>

    <div id="page-game" class="page">
        <div id="user-info" style="font-size: 1rem; margin-bottom: 5px;"></div>
        <div class="big-number" id="draw-number-player">READY</div>
        <div id="status-text" style="color:var(--primary); font-weight:bold; min-height: 24px;"></div>
        
        <div class="grid" id="bingo-grid"></div>

        <div id="setup-controls">
            <button id="btn-re-gen" onclick="generateBoard()">ğŸ² éš¨æ©Ÿæ›è™Ÿ</button>
            <button id="btn-lock" onclick="lockBoard()" style="background:var(--success)">ğŸ”’ ä¿å­˜ç›¤é¢</button>
        </div>

        <div id="lucky-panel" style="display:none; background:#fff9c4; padding:20px; border:3px dashed #f9a825; border-radius:20px; margin-top:15px; animation: bounce 1s infinite;">
            <h3 style="margin:0; color:#e65100;">ğŸŒŸ æ‚¨è¢«é¸ä¸­è½‰é‹ï¼</h3>
            <p style="margin: 10px 0;">è«‹æŒ‡å®šä¸€å€‹é–‹çè™Ÿç¢¼ (1-25)ï¼š</p>
            <input type="number" id="lucky-input" min="1" max="25" style="width:80px; text-align:center; font-size: 1.5rem; font-weight: bold;">
            <br>
            <button onclick="submitLuckyNumber()" style="background:#f9a825; width: 100%;">å³åˆ»é–‹ç</button>
        </div>
    </div>

    <div id="page-admin" class="page">
        <h2 style="background: #333; color: white; padding: 15px; margin: -20px -20px 20px -20px;">ç®¡ç†è€…ä¸»æ§å°</h2>
        <div class="big-number" id="draw-number-admin">READY</div>
        
        <div style="margin-bottom: 20px;">
            <button id="btn-draw" onclick="drawRandom()">ğŸ² éš¨æ©ŸæŠ½å–ä¸‹ä¸€å€‹</button>
            <button onclick="pickLuckyUser()" style="background:#ef6c00">ğŸ¯ æŠ½å‡ºè½‰é‹å¹¸é‹å…’</button>
        </div>
        
        <div class="switch-box">
            <span>é¡¯ç¤ºç©å®¶é€£çºŒæ•¸åå–®</span>
            <label class="switch">
                <input type="checkbox" id="list-toggle" onchange="toggleAdminList()">
                <span class="slider"></span>
            </label>
        </div>

        <div id="admin-list-view" style="display:none;">
            <div id="list-content"></div>
        </div>
        
        <button onclick="resetGame()" style="background:#555; margin-top:50px; font-size:0.8rem; padding: 10px 20px;">é‡ç½®ä¸¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>

    <script>
        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
            authDomain: "yearendbingo.firebaseapp.com",
            projectId: "yearendbingo",
            storageBucket: "yearendbingo.firebasestorage.app",
            messagingSenderId: "563353011392",
            appId: "1:563353011392:web:717976a176bc22a04d5925",
            measurementId: "G-M6EVYSPNJ9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const GAME_DOC = "current_game";

        let myName = "", myBoard = [], isLocked = false, drawnHistory = [], rollingInterval = null;
        const winConditions = [
            [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
            [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
            [0,6,12,18,24],[4,8,12,16,20]
        ];

        // --- æ ¸å¿ƒé€£è²«ç®—æ³• ---
        function calculateMaxConsecutive(board, history) {
            if (!board || board.length < 25) return 0;
            let maxGlobal = 0;
            winConditions.forEach(indices => {
                let currentStreak = 0, maxInLine = 0;
                indices.forEach(idx => {
                    if (history.includes(board[idx])) {
                        currentStreak++;
                        if (currentStreak > maxInLine) maxInLine = currentStreak;
                    } else {
                        currentStreak = 0;
                    }
                });
                if (maxInLine > maxGlobal) maxGlobal = maxInLine;
            });
            return maxGlobal;
        }

        // --- ç™»å…¥èˆ‡è¨˜æ†¶åŠŸèƒ½ ---
        async function joinGame() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return alert("è«‹è¼¸å…¥å§“å");
            myName = nameInput;
            localStorage.setItem('bingo_username', myName);

            // å¾è³‡æ–™åº«æª¢æŸ¥è©²å§“åæ˜¯å¦å·²æœ‰å­˜æª”
            const doc = await db.collection("players").doc(myName).get();
            if (doc.exists) {
                const data = doc.data();
                if (data.locked) {
                    myBoard = data.board;
                    isLocked = true;
                    document.getElementById('setup-controls').style.display = 'none';
                    document.getElementById('status-text').innerText = "ç›¤é¢å·²é–å®šï¼Œç­‰å¾…é–‹çä¸­...";
                }
            }

            document.getElementById('user-info').innerText = `ç›®å‰ç©å®¶ï¼š${myName}`;
            switchPage('page-game');
            if (!isLocked && myBoard.length === 0) generateBoard();
            else renderBoard();

            // æ›´æ–°åœ¨ç·šç‹€æ…‹
            await db.collection("players").doc(myName).set({ name: myName, lastSeen: Date.now() }, { merge: true });
            setInterval(() => { if(myName) db.collection("players").doc(myName).update({ lastSeen: Date.now() }); }, 15000);
            initGlobalMonitor();
        }

        function generateBoard() {
            if (isLocked) return;
            myBoard = Array.from({length: 25}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            renderBoard();
        }

        function renderBoard() {
            const container = document.getElementById('bingo-grid');
            if (!container) return;
            container.innerHTML = "";
            myBoard.forEach(num => {
                const cell = document.createElement('div');
                cell.className = 'cell' + (drawnHistory.includes(num) ? ' selected' : '');
                cell.innerText = num;
                container.appendChild(cell);
            });
            
            // è¦–è¦ºé€£ç·šæª¢æŸ¥
            let bingoCount = 0;
            winConditions.forEach(c => {
                if (c.every(idx => drawnHistory.includes(myBoard[idx]))) {
                    bingoCount++;
                    c.forEach(idx => container.children[idx].classList.add('bingo-line'));
                }
            });
            if (bingoCount > 0) document.getElementById('status-text').innerText = `ğŸŠ è³“æœï¼é”æˆ ${bingoCount} æ¢é€£ç·šï¼`;
        }

        async function lockBoard() {
            if (isLocked) return;
            const bStr = myBoard.join(',');
            // å”¯ä¸€æ€§æ ¡é©—
            const snap = await db.collection("players").where("boardStr", "==", bStr).get();
            if (!snap.empty) { alert("æ­¤ç›¤é¢é †åºå·²è¢«ä»–äººä½¿ç”¨ï¼Œç³»çµ±è‡ªå‹•ç‚ºæ‚¨é‡æ–°æ›è™Ÿ"); return generateBoard(); }
            
            if (!confirm("ä¿å­˜å¾Œä¸å¯æ›´æ”¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            isLocked = true;
            document.getElementById('setup-controls').style.display = 'none';

            const score = calculateMaxConsecutive(myBoard, drawnHistory);
            await db.collection("players").doc(myName).update({
                board: myBoard, boardStr: bStr, locked: true, maxConsecutive: score
            });
            renderBoard();
        }

        // --- å…¨åŸŸåŒæ­¥ç›£è½ ---
        function initGlobalMonitor() {
            db.collection("game_state").doc(GAME_DOC).onSnapshot(doc => {
                const data = doc.data(); if (!data) return;
                drawnHistory = data.history || [];
                
                if (data.isRolling) {
                    startRollingEffect();
                } else {
                    stopRollingEffect();
                    const num = drawnHistory.length > 0 ? drawnHistory[drawnHistory.length - 1] : "READY";
                    document.getElementById('draw-number-player').innerText = num;
                    document.getElementById('draw-number-admin').innerText = num;
                    renderBoard();
                    // é–å®šç‹€æ…‹ä¸‹ï¼Œé–‹çå®Œç«‹åˆ»æ›´æ–°åˆ†æ•¸åˆ° Firebase
                    if (isLocked) {
                        const score = calculateMaxConsecutive(myBoard, drawnHistory);
                        db.collection("players").doc(myName).update({ maxConsecutive: score });
                    }
                }
                
                // è½‰é‹é¢æ¿é‚è¼¯ï¼šå¿…é ˆæ˜¯æœ¬äººã€åå­—ä¸ç‚ºç©ºã€ä¸”å·²é–å®šç›¤é¢
                const isMeLucky = (data.luckyUser === myName && myName !== "" && isLocked === true);
                document.getElementById('lucky-panel').style.display = isMeLucky ? 'block' : 'none';
            });

            // ç›£è½ç©å®¶æ¸…å–® (ä¾›ç®¡ç†è€…åå–®é¡¯ç¤º)
            db.collection("players").onSnapshot(snap => {
                let players = [];
                snap.forEach(d => players.push(d.data()));
                let locked = players.filter(p => p.locked).sort((a,b) => (a.maxConsecutive || 0) - (b.maxConsecutive || 0));
                
                // æ‰¾å‡ºå€™é¸æ±  (é€£çºŒæ•¸æœ€å°çš„å‰ 15 å)
                let weakNames = locked.slice(0, 15).map(p => p.name);

                const listContent = document.getElementById('list-content');
                if (!listContent) return;
                listContent.innerHTML = "";

                // å¾ 5 åˆ†åˆ° 1 åˆ†é¡¯ç¤ºåå–®
                for(let s=5; s>=1; s--) {
                    const group = locked.filter(p => Math.min(p.maxConsecutive || 0, 5) === s);
                    if (group.length === 0) continue;
                    const div = document.createElement('div');
                    div.className = 'list-group';
                    div.innerHTML = `<div class="list-group-title">${s === 5 ? 'è½ç‰Œ / è³“æœå€' : s + ' å€‹è™Ÿç¢¼é€£çºŒ'} (${group.length}äºº)</div>`;
                    group.forEach(p => {
                        const isWeak = weakNames.includes(p.name);
                        div.innerHTML += `<span class="name-tag ${isWeak ? 'weak' : ''}">${p.name}${isWeak ? 'â­' : ''}</span>`;
                    });
                    listContent.appendChild(div);
                }
            });
        }

        // --- ç®¡ç†è€…è¡Œç‚º ---
        function toggleAdminList() {
            const isChecked = document.getElementById('list-toggle').checked;
            document.getElementById('admin-list-view').style.display = isChecked ? 'block' : 'none';
        }

        async function drawRandom() {
            document.getElementById('btn-draw').disabled = true;
            // é–‹å§‹è·‘è™Ÿå‰å…ˆæ¸…ç©ºå¹¸é‹å…’
            await db.collection("game_state").doc(GAME_DOC).update({ isRolling: true, luckyUser: "" });
            
            setTimeout(async () => {
                const rem = Array.from({length: 25}, (_, i) => i + 1).filter(n => !drawnHistory.includes(n));
                if (rem.length === 0) return alert("æ‰€æœ‰è™Ÿç¢¼å·²æŠ½å®Œ");
                const pick = rem[Math.floor(Math.random() * rem.length)];
                
                await db.collection("game_state").doc(GAME_DOC).update({ 
                    history: firebase.firestore.FieldValue.arrayUnion(pick), 
                    isRolling: false 
                });
                document.getElementById('btn-draw').disabled = false;
            }, 2500);
        }

        async function pickLuckyUser() {
            const snap = await db.collection("players").where("locked", "==", true).get();
            let players = []; snap.forEach(d => players.push(d.data()));
            if (players.length === 0) return alert("ç›®å‰å°šç„¡é–å®šç›¤é¢çš„ç©å®¶");
            
            // æŒ‰åˆ†æ•¸å‡åºï¼Œå–å‰ 15 å
            players.sort((a,b) => (a.maxConsecutive || 0) - (b.maxConsecutive || 0));
            const pool = players.slice(0, 15);
            const lucky = pool[Math.floor(Math.random() * pool.length)];
            
            await db.collection("game_state").doc(GAME_DOC).update({ luckyUser: lucky.name });
            alert("å·²é¸ä¸­å¹¸é‹å…’ï¼š " + lucky.name + "ï¼Œè«‹ç­‰å¾…å°æ–¹é¸è™Ÿã€‚");
        }

        async function submitLuckyNumber() {
            const val = parseInt(document.getElementById('lucky-input').value);
            if (!val || val < 1 || val > 25 || drawnHistory.includes(val)) {
                return alert("è«‹è¼¸å…¥ 1-25 ä¹‹é–“ä¸”å°šæœªé–‹å‡ºçš„è™Ÿç¢¼");
            }
            await db.collection("game_state").doc(GAME_DOC).update({ 
                history: firebase.firestore.FieldValue.arrayUnion(val), 
                luckyUser: "" 
            });
            document.getElementById('lucky-input').value = "";
        }

        function startRollingEffect() {
            if (rollingInterval) return;
            rollingInterval = setInterval(() => {
                const n = Math.floor(Math.random() * 25) + 1;
                document.getElementById('draw-number-player').innerText = n;
                document.getElementById('draw-number-admin').innerText = n;
            }, 80);
        }
        function stopRollingEffect() { clearInterval(rollingInterval); rollingInterval = null; }

        // --- ç®¡ç†è€…é€²å…¥é‚è¼¯ ---
        let adminClickCount = 0;
        let adminTimer = null;
        function handleAdminClick() {
            clearTimeout(adminTimer);
            adminClickCount++;
            adminTimer = setTimeout(() => { adminClickCount = 0; }, 4000); // 4ç§’å…§é»å®Œ 5 æ¬¡
            if (adminClickCount >= 5) {
                adminClickCount = 0;
                const p = prompt("è«‹è¼¸å…¥ç®¡ç†è€… PINï¼š");
                if (p === "2025") switchPage('page-admin');
            }
        }

        async function resetGame() {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰ç©å®¶è³‡æ–™èˆ‡é–‹çç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            const batch = db.batch();
            const snap = await db.collection("players").get();
            snap.forEach(d => batch.delete(d.ref));
            // é‡ç½®ç‹€æ…‹æ™‚ç¢ºä¿ luckyUser ç‚ºç©ºå­—ä¸²
            batch.set(db.collection("game_state").doc(GAME_DOC), { 
                history: [], 
                isRolling: false, 
                luckyUser: "" 
            });
            await batch.commit();
            localStorage.clear();
            location.reload();
        }

        function switchPage(id) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
        }
        
        window.onload = () => {
            const savedName = localStorage.getItem('bingo_username');
            if (savedName) document.getElementById('username').value = savedName;
        };
    </script>
</body>
</html>
