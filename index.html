<!DOCTYPE html>
<html class="light" lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <title>2025 å°¾ç‰™è³“æœç³»çµ± - å¤§å­—é•·è¼©ç‰ˆ</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#f45925",
                        "primary-dark": "#d64010",
                        "background-light": "#f8f6f5",
                    },
                    borderRadius: { "xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f6f5;
        }
        /* é‡å°é•·è¼©å„ªåŒ–çš„è¶…å¤§è³“æœæ ¼ */
        .cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; 
            font-weight: 900;
            font-size: 2.2rem; /* æ¥µå¤§å­—é«” */
            background-color: #ffffff; 
            color: #1c110d;
            border: 4px solid #f4eae7;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .cell.selected {
            background-color: #f45925 !important;
            color: white !important;
            border-color: #f45925;
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(244, 89, 37, 0.4);
        }
        .cell.bingo-line {
            background-color: #2e7d32 !important;
            color: white !important;
            animation: big-pulse 1s infinite;
            border-color: #ffffff;
        }
        @keyframes big-pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.15); }
        }
        /* æ­·å²è™Ÿç¢¼çƒ */
        .history-ball {
            width: 50px; height: 50px;
            display: inline-flex; align-items: center; justify-content: center;
            background: #f45925; color: white; border-radius: 50%;
            font-weight: 900; font-size: 1.2rem; margin: 4px;
        }
        .hidden { display: none !important; }
    </style>
</head>

<body class="w-full min-h-screen p-2 sm:p-4">

<div id="admin-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[1000] p-4">
    <div class="bg-white p-8 rounded-[2rem] w-full">
        <h3 class="text-3xl font-black mb-6 text-primary">ç®¡ç†ç™»å…¥</h3>
        <input id="admin-email" type="email" placeholder="å¸³è™Ÿ" class="w-full p-5 mb-4 border-4 border-gray-100 rounded-2xl text-xl">
        <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" class="w-full p-5 mb-6 border-4 border-gray-100 rounded-2xl text-xl">
        <button class="w-full py-6 bg-primary text-white text-2xl font-black rounded-2xl" onclick="doAdminLogin()">ç™»å…¥</button>
        <button class="w-full mt-4 text-gray-400 text-xl font-bold" onclick="closeAdminModal()">é—œé–‰</button>
    </div>
</div>

<div class="w-full flex flex-col gap-4">

    <header class="w-full flex justify-between items-center bg-white p-6 rounded-[1.5rem] shadow-md border-b-4 border-primary">
        <div class="text-3xl font-black text-primary flex items-center gap-2" onclick="triggerAdmin()">
            <span class="material-symbols-outlined !text-4xl">grid_view</span> è³“æœ ğŸ§§
        </div>
        <div id="user-info" class="text-xl font-black text-gray-500 bg-gray-100 px-4 py-2 rounded-full">--</div>
    </header>

    <section id="view-login" class="hidden">
        <div class="bg-white rounded-[2.5rem] p-10 shadow-xl border-4 border-primary/10 text-center">
            <h2 class="text-4xl font-black text-gray-800 mb-6">è«‹è¼¸å…¥å§“å</h2>
            <input id="player-name" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" 
                class="w-full p-6 border-4 border-gray-100 rounded-3xl text-center text-3xl font-black focus:border-primary outline-none mb-8" />
            <button class="w-full py-8 bg-primary text-white font-black text-3xl rounded-[2rem] shadow-xl active:scale-95 transition-all" 
                onclick="doPlayerLogin()">
                é€²å…¥éŠæˆ²
            </button>
        </div>
    </section>

    <section id="view-player" class="hidden flex flex-col gap-4">
        <div class="bg-white rounded-[2.5rem] p-4 shadow-xl border-4 border-gray-100">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-3xl font-black text-gray-800" id="player-name-display">--</h2>
                <button class="p-4 bg-gray-100 rounded-2xl" onclick="doSignOut()"><span class="material-symbols-outlined !text-3xl">logout</span></button>
            </div>

            <div class="bg-primary text-white rounded-[2rem] p-8 text-center mb-6 shadow-inner">
                <p class="text-xl font-bold opacity-80 mb-2 uppercase tracking-widest">ç›®å‰è™Ÿç¢¼</p>
                <div id="draw-display" class="text-[10rem] font-black leading-none py-4">--</div>
                <div id="bingo-status" class="text-3xl font-black bg-white text-green-700 py-2 rounded-full mt-4"></div>
            </div>

            <div id="bingo-grid" class="grid grid-cols-5 gap-2 sm:gap-4"></div>

            <div id="setup-btns" class="mt-10 flex flex-col gap-4">
                <button class="w-full py-8 bg-primary text-white font-black text-3xl rounded-[2rem] shadow-2xl" onclick="confirmBoard()">
                    ğŸ”’ é–å®šè™Ÿç¢¼ (é–‹å§‹å°ç)
                </button>
                <button class="w-full py-6 bg-gray-100 text-gray-500 font-black text-2xl rounded-[2rem]" onclick="reRollBoard()">
                    ğŸ² æ›ä¸€çµ„è™Ÿç¢¼
                </button>
            </div>
            <div id="lock-status-label" class="text-center mt-4 text-2xl font-black text-primary"></div>
        </div>
    </section>

    <section id="view-admin" class="hidden flex flex-col gap-4">
        <div class="bg-zinc-900 text-white rounded-[2.5rem] p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6 text-2xl font-black text-primary">
                <span>ä¸»æ§å°</span>
                <span id="admin-lock-indicator" class="text-lg bg-white/10 px-4 py-1 rounded-full text-white">--</span>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white/5 p-6 rounded-3xl text-center border-2 border-white/10">
                    <span id="count-online" class="block text-5xl font-black text-primary">0</span>
                    <p class="text-lg text-gray-400">åœ¨ç·š</p>
                </div>
                <div class="bg-white/5 p-6 rounded-3xl text-center border-2 border-white/10">
                    <span id="count-total" class="block text-5xl font-black text-primary">0</span>
                    <p class="text-lg text-gray-400">ç¸½äººæ•¸</p>
                </div>
            </div>

            <div class="bg-white/5 rounded-3xl p-8 text-center mb-8 border-4 border-primary/30">
                <div id="admin-sync-num" class="text-[10rem] font-black text-primary leading-none mb-6">--</div>
                <div id="drawn-history-list" class="flex flex-wrap justify-center gap-2 pt-8 border-t border-white/10"></div>
            </div>

            <button id="btn-draw" class="w-full py-10 bg-primary text-white text-5xl font-black rounded-[2.5rem] shadow-2xl mb-6" onclick="drawNewNumber()">
                ğŸ² æŠ½è™Ÿ
            </button>

            <div class="grid grid-cols-2 gap-4">
                <button class="py-6 bg-blue-600 text-2xl font-black rounded-2xl" onclick="forceLockAll()">ğŸ”’ å…¨é–</button>
                <button class="py-6 bg-amber-500 text-2xl font-black rounded-2xl" onclick="pickLucky()">ğŸŒŸ æŠ½äºº</button>
            </div>
            
            <button class="w-full mt-10 py-4 text-red-500 font-bold text-xl border-2 border-red-500/20 rounded-2xl" onclick="handleReset()">é‡ç½®éŠæˆ²</button>
        </div>

        <div class="bg-white rounded-[2rem] p-6 shadow-lg">
            <h4 class="text-2xl font-black mb-4">å³æ™‚é€šçŸ¥</h4>
            <div id="pending-choices" class="space-y-4 mb-4"></div>
            <div id="bingo-alerts" class="space-y-4 mb-4"></div>
        </div>
    </section>

    <footer class="py-20 text-center text-gray-300 font-bold text-lg">
        BINGO MASTER 2025
    </footer>
</div>

<script>
    /* JavaScript é‚è¼¯å®Œå…¨ä¿ç•™ */
    const firebaseConfig = {
        apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
        authDomain: "yearendbingo.firebaseapp.com",
        projectId: "yearendbingo",
        storageBucket: "yearendbingo.firebasestorage.app",
        messagingSenderId: "563353011392",
        appId: "1:563353011392:web:717976a176bc22a04d5925",
        measurementId: "G-M6EVYSPNJ9"
    };
    const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let myData = { name:"", board:[], locked:false };
    let gameHistory = [];
    let allPlayersCache = [];
    let rollingTimer = null;
    let isAllLockedGlobal = false;

    function triggerAdmin() {
        window.ac = (window.ac || 0) + 1;
        if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
    }
    function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

    async function doAdminLogin(){
        const email = document.getElementById('admin-email').value;
        const pwd = document.getElementById('admin-pwd').value;
        try {
            const cred = await auth.signInWithEmailAndPassword(email, pwd);
            if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); }
            else { alert("ç„¡æ¬Šé™"); await auth.signOut(); }
        } catch(e){ alert("å¤±æ•—"); }
    }

    auth.onAuthStateChanged(async user => {
        currentUser = user;
        if(!user){ showView('login'); return; }
        if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }

        const snap = await db.collection("players").doc(user.uid).get();
        if(snap.exists){
            myData = snap.data();
        } else {
            const name = document.getElementById('player-name').value || "è¨ªå®¢";
            myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
            await db.collection("players").doc(user.uid).set(myData);
        }
        document.getElementById('user-info').innerText = myData.name;
        document.getElementById('player-name-display').innerText = myData.name;
        showView('player');
        startApp();
    });

    async function doPlayerLogin(){
        if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
        await auth.signInAnonymously();
    }

    function showView(name){
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-player').classList.add('hidden');
        document.getElementById('view-admin').classList.add('hidden');
        document.getElementById('view-'+name).classList.remove('hidden');
        window.scrollTo(0,0);
    }

    function startApp(){
        db.collection("game_state").doc("current_game").onSnapshot(doc => {
            const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
            gameHistory = data.history || [];
            isAllLockedGlobal = data.isAllLocked || false;

            if(document.getElementById('admin-lock-indicator')) {
                document.getElementById('admin-lock-indicator').innerText = isAllLockedGlobal ? "âœ… å·²é–å®š" : "ğŸ”“ é–‹æ”¾ä¸­";
            }

            const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "--";
            document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="history-ball">${n}</span>`).join('') || "ç­‰å¾…ä¸­";

            if(data.isRolling){
                if(!rollingTimer) rollingTimer = setInterval(()=> {
                    const r = Math.floor(Math.random()*25)+1;
                    document.getElementById('draw-display').innerText = r;
                    if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = r;
                }, 80);
            } else {
                clearInterval(rollingTimer); rollingTimer=null;
                document.getElementById('draw-display').innerText = last;
                if(document.getElementById('admin-sync-num')) document.getElementById('admin-sync-num').innerText = last;
                renderGrid();
            }

            if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
                let num = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹é¸ä¸€å€‹ 1-25 æ²’é–‹éçš„è™Ÿç¢¼ï¼š`);
                if(num) {
                    db.collection("pending_choices").doc(currentUser.uid).set({
                        playerName: myData.name, number: parseInt(num), timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    db.collection("game_state").doc("current_game").update({ luckyUser: "" });
                }
            }
        });

        db.collection("players").onSnapshot(snap => {
            allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
            document.getElementById('count-total').innerText = allPlayersCache.length;
            if(currentUser.uid !== ALLOWED_UID){
                const me = allPlayersCache.find(p => p.id === currentUser.uid);
                if(me && me.locked !== myData.locked) {
                    myData.locked = me.locked;
                    renderGrid();
                }
            }
        });

        if(currentUser.uid === ALLOWED_UID){
            db.collection("pending_choices").onSnapshot(snap => {
                document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div class="p-6 bg-primary/10 rounded-3xl flex justify-between items-center text-2xl font-bold text-primary"><span>â“ ${d.data().playerName} é¸äº† ${d.data().number}</span> <button class="bg-primary text-white px-6 py-2 rounded-full" onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
            });
            db.collection("bingo_events").limit(5).onSnapshot(snap => {
                document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div class="p-6 bg-green-50 rounded-3xl text-green-700 text-2xl font-bold">ğŸ‰ ${d.data().name} è³“æœï¼</div>`).join('');
            });
        }
    }

    function renderGrid(){
        const grid = document.getElementById('bingo-grid');
        if(!grid) return;
        grid.innerHTML = '';
        const winIdx = new Set();
        const lines = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];
        let winLineCount = 0;
        lines.forEach(line => {
            if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
                line.forEach(i=>winIdx.add(i));
                winLineCount++;
            }
        });
        myData.board.forEach((num,i)=>{
            const div = document.createElement('div');
            div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
            div.innerText = num;
            grid.appendChild(div);
        });
        if(winLineCount > 0 && myData.locked) {
            document.getElementById('bingo-status').innerText = `ğŸ† å·²é€£æˆ ${winLineCount} æ¢ç·šï¼`;
            db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }
        document.getElementById('setup-btns').classList.toggle('hidden', (myData.locked || isAllLockedGlobal));
        document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "âœ… è™Ÿç¢¼å·²é–å®šï¼Œç¥æ‚¨ä¸­çï¼" : "ğŸ² è«‹å…ˆè¨­å®šæ‚¨çš„è™Ÿç¢¼";
    }

    async function drawNewNumber(){
        const ref = db.collection("game_state").doc("current_game");
        const snap = await ref.get();
        const hist = snap.data().history || [];
        const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
        if(!pool.length) return alert("æŠ½å®Œå›‰");
        await ref.update({ isRolling:true });
        setTimeout(async ()=>{
            const p = pool[Math.floor(Math.random()*pool.length)];
            await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false });
        }, 1500);
    }

    async function handleReset(){
        if(!confirm("ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) return;
        const batch = db.batch();
        allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
        batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
        await batch.commit();
        location.reload();
    }

    function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
    function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }
    async function confirmBoard(){
        if(!confirm("é–å®šå¾Œä¸èƒ½å†æ›è™Ÿç¢¼å–”ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        await db.collection("players").doc(currentUser.uid).update({ locked:true });
        myData.locked = true; renderGrid();
    }
    function doSignOut(){ auth.signOut(); location.reload(); }
</script>
</body>
</html>
