<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2025 å°¾ç‰™è³“æœç³»çµ± v0.10</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
:root { --primary:#d32f2f; --accent:#ffb300; --bg:#f6f7fb; --card:#ffffff; --success:#2e7d32; --dark:#2c3e50; }
body { margin:0; font-family:system-ui, -apple-system, sans-serif; background:var(--bg); color:#222; }
.container { max-width:1100px; margin:0 auto; padding:15px; }
.layout { display:grid; grid-template-columns: 1fr 340px; gap:20px; }
@media (max-width: 850px) { .layout { grid-template-columns: 1fr; } }
.player-card { background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); text-align:center; min-height: 400px; }
.big-number { font-size:5rem; font-weight:800; color:var(--primary); height:110px; line-height:110px; margin:10px 0; }
.grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:6px; max-width:400px; margin:0 auto; }
.cell { aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:#f8f9fa; border:1px solid #eee; border-radius:8px; font-size:1.3rem; font-weight:bold; }
.cell.selected { background:#fff3e0; color:#e65100; }
.cell.bingo-line { background:var(--success) !important; color:white !important; animation:pulse 1s infinite; }
.admin-panel { display:flex; flex-direction:column; gap:15px; }
.admin-card { background:var(--dark); color:white; padding:15px; border-radius:12px; }
.stat-group { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
.line-stat-group { display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-bottom:10px; }
.stat-box { background:rgba(255,255,255,0.1); padding:8px 5px; border-radius:8px; text-align:center; }
.stat-val { font-size:1.2rem; font-weight:bold; color:var(--accent); display:block; }
.stat-label { font-size: 0.75rem; opacity: 0.8; }
.bingo-alert-list { background:white; color:#333; border-radius:8px; padding:10px; max-height:200px; overflow-y:auto; }
.alert-item { color:var(--primary); font-weight:bold; padding:4px 0; border-bottom:1px solid #eee; font-size:0.9rem; display:flex; justify-content:space-between; }
button { padding:12px; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; }
button:disabled { background:#ccc; }
input { padding:10px; border:1px solid #ddd; border-radius:8px; width:100%; margin-bottom:10px; box-sizing:border-box; }
@keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.03)} 100% {transform:scale(1)} }
</style>
</head>
<body>
<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <h1 id="title" style="margin:0; color:var(--primary); cursor:pointer;">ğŸ§§ 2025 è³“æœç³»çµ± v0.10</h1>
    <div id="user-info" style="font-weight:bold;"></div>
  </div>

  <div class="layout">
    <div class="player-card" id="main-content-area">
      <div id="login-form">
        <input type="text" id="player-name" placeholder="è¼¸å…¥çœŸå¯¦å§“åé€²å ´">
        <button id="enter-btn" style="width:100%">é€²å…¥éŠæˆ²</button>
      </div>

      <div id="game-ui" style="display:none;">
        <div id="draw-display" class="big-number">READY</div>
        <div id="bingo-status" style="height:25px; font-weight:bold; color:var(--success); margin-bottom:10px;"></div>
        <div id="bingo-grid" class="grid"></div>
        <div id="setup-btns" style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
          <button id="reroll-btn" style="background:#6c757d;">ğŸ² æ›è™Ÿç¢¼</button>
          <button id="lock-btn" style="background:var(--success);">ğŸ”’ é–å®šç›¤é¢</button>
        </div>
      </div>
    </div>

    <div id="admin-sidebar" class="admin-panel" style="display:none;">
      <div class="admin-card">
        <div class="stat-group">
          <div class="stat-box"><span id="count-online" class="stat-val">0</span><span class="stat-label">åœ¨ç·š</span></div>
          <div class="stat-box"><span id="count-total" class="stat-val">0</span><span class="stat-label">ç¸½äººæ•¸</span></div>
        </div>

        <div style="font-size:0.8rem; margin-bottom:5px; opacity:0.8;">æœ€å¤§ç›¸é„°é€£è™Ÿäººæ•¸ (åˆ†ä½ˆ)ï¼š</div>
        <div class="line-stat-group">
          <div class="stat-box"><span id="cnt-5" class="stat-val">0</span><span class="stat-label">5+é€£</span></div>
          <div class="stat-box"><span id="cnt-4" class="stat-val">0</span><span class="stat-label">4é€£</span></div>
          <div class="stat-box"><span id="cnt-3" class="stat-val">0</span><span class="stat-label">3é€£</span></div>
          <div class="stat-box"><span id="cnt-2" class="stat-val">0</span><span class="stat-label">2é€£</span></div>
        </div>

        <div style="text-align:center; margin:10px 0; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
          <div style="font-size:0.8rem; opacity:0.7;">åŒæ­¥é–‹çè™Ÿ</div>
          <div id="admin-sync-num" style="font-size:2.5rem; font-weight:bold; color:var(--accent);">--</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <button id="admin-draw" style="background:#e67e22;">ğŸ² æŠ½è™Ÿ</button>
          <button id="admin-pick" style="background:var(--accent); color:#333;">ğŸŒŸ å¹¸é‹å…’</button>
        </div>
      </div>

      <div class="admin-card">
        <div style="font-size:0.9rem; margin-bottom:8px; font-weight:bold;">ğŸ“¢ å³æ™‚è³“æœåå–®</div>
        <div id="bingo-alerts" class="bingo-alert-list">
          <div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>
        </div>
      </div>

      <div class="admin-card" style="background:#444;">
        <div style="font-size:0.8rem; margin-bottom:10px;">å¾…æ ¸é¸è™Ÿ: <span id="pending-count">0</span></div>
        <div id="pending-choices"></div>
      </div>

      <button id="reset-btn" style="background:#c0392b; width:100%;">âš ï¸ é‡ç½®éŠæˆ²</button>
      <button id="reload-btn" style="background:#6c757d; width:100%; margin-top:5px; font-size:0.8rem;">é€€å‡ºä¸¦é‡æ•´</button>
    </div>
  </div>
</div>

<div id="admin-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:999;">
  <div style="background:white; padding:25px; border-radius:15px; width:320px;">
    <h3>ç®¡ç†å“¡ç™»å…¥</h3>
    <input type="email" id="admin-email" placeholder="Email" style="margin-bottom:8px;">
    <input type="password" id="admin-pwd" placeholder="Password" style="margin-bottom:12px;">
    <button id="admin-login" style="width:100%;">ç™»å…¥</button>
    <button id="admin-cancel" style="width:100%; margin-top:8px; background:#999;">å–æ¶ˆ</button>
  </div>
</div>

<script>
/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ---------------- å…¨åŸŸè®Šæ•¸ ---------------- */
let currentUser = null;
let myData = { name:"", board:[], locked:false, boardStr:"", maxConsecutive:0, version:1 };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
const lines = [
  [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
  [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
  [0,6,12,18,24],[4,8,12,16,20]
];

/* ---------------- DOM helpers ---------------- */
function safeGet(id){ return document.getElementById(id) || null; }
function safeSetText(id, text){ const el = safeGet(id); if(el) el.innerText = text; }

/* ---------------- triggerAdmin (å…¨åŸŸ) ---------------- */
function triggerAdmin() {
  window.adminClicks = (window.adminClicks || 0) + 1;
  if(window.adminClicks >= 5) {
    const modal = safeGet('admin-modal');
    if(modal) modal.style.display = 'flex';
    window.adminClicks = 0;
  }
}

/* ç¶å®š title é»æ“Šï¼ˆé¿å… inline onclick å•é¡Œï¼‰ */
document.addEventListener('DOMContentLoaded', () => {
  const title = safeGet('title');
  if(title) title.addEventListener('click', triggerAdmin);
});

/* ---------------- UI äº‹ä»¶ç¶å®š ---------------- */
document.addEventListener('DOMContentLoaded', () => {
  const enterBtn = safeGet('enter-btn');
  if(enterBtn) enterBtn.addEventListener('click', doPlayerLogin);

  const rerollBtn = safeGet('reroll-btn');
  if(rerollBtn) rerollBtn.addEventListener('click', reRollBoard);

  const lockBtn = safeGet('lock-btn');
  if(lockBtn) lockBtn.addEventListener('click', confirmBoard);

  const adminDraw = safeGet('admin-draw');
  if(adminDraw) adminDraw.addEventListener('click', drawNewNumber);

  const adminPick = safeGet('admin-pick');
  if(adminPick) adminPick.addEventListener('click', pickLucky);

  const resetBtn = safeGet('reset-btn');
  if(resetBtn) resetBtn.addEventListener('click', handleReset);

  const reloadBtn = safeGet('reload-btn');
  if(reloadBtn) reloadBtn.addEventListener('click', () => location.reload());

  const adminLogin = safeGet('admin-login');
  if(adminLogin) adminLogin.addEventListener('click', doAdminLogin);

  const adminCancel = safeGet('admin-cancel');
  if(adminCancel) adminCancel.addEventListener('click', () => {
    const modal = safeGet('admin-modal'); if(modal) modal.style.display = 'none';
  });
});

/* ---------------- Player login ---------------- */
async function doPlayerLogin(){
  try {
    const nameInput = safeGet('player-name');
    const name = nameInput ? nameInput.value.trim() : '';
    if(!name) return alert("è«‹è¼¸å…¥å§“å");
    const cred = await auth.signInAnonymously();
    currentUser = cred.user;
    const docRef = db.collection("players").doc(currentUser.uid);
    const snap = await docRef.get();
    if(snap.exists){
      myData = snap.data();
      myData.board = myData.board || shuffleArray();
      myData.boardStr = myData.boardStr || myData.board.join(',');
      myData.maxConsecutive = myData.maxConsecutive || 0;
      myData.version = myData.version || 1;
    } else {
      const board = shuffleArray();
      const boardStr = board.join(',');
      myData = { name: name, board: board, boardStr: boardStr, locked: false, maxConsecutive: 0, version: 1, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
      await docRef.set(myData);
    }
    safeGet('login-form').style.display = 'none';
    safeGet('game-ui').style.display = 'block';
    safeSetText('user-info', myData.name);
    startApp();
  } catch(err) {
    console.error(err);
    alert("ç™»å…¥å¤±æ•—");
  }
}

/* ---------------- Admin login ---------------- */
async function doAdminLogin(){
  try {
    const email = safeGet('admin-email').value;
    const pwd = safeGet('admin-pwd').value;
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID){
      currentUser = cred.user;
      const modal = safeGet('admin-modal'); if(modal) modal.style.display = 'none';
      // éš±è—å·¦å´ç©å®¶å€åŸŸï¼ˆä¸è¦†è“‹ innerHTMLï¼‰
      const main = safeGet('main-content-area'); if(main) main.style.display = 'none';
      const admin = safeGet('admin-sidebar'); if(admin) admin.style.display = 'flex';
      safeSetText('user-info', "ç®¡ç†è€…æ¨¡å¼");
      startApp();
    } else {
      alert("éç®¡ç†è€…å¸³è™Ÿ");
    }
  } catch(e){
    console.error(e);
    alert("ç™»å…¥å¤±æ•—");
  }
}

/* ---------------- App start & listeners ---------------- */
let unsubscribers = [];
function clearListeners(){
  unsubscribers.forEach(fn => { try{ fn(); }catch(e){} });
  unsubscribers = [];
}

function startApp(){
  // å…ˆæ¸…é™¤èˆŠç›£è½ï¼Œé¿å…é‡è¤‡
  clearListeners();

  // game_state ç›£è½ï¼šç„¡æ¢ä»¶æ›´æ–°æŠ½è™Ÿé¡¯ç¤º
  const gsRef = db.collection("game_state").doc("current_game");
  const unsub1 = gsRef.onSnapshot(async doc => {
    const data = doc.data() || {};
    gameHistory = data.history || [];
    updateDrawDisplay(data);
    // è‹¥ isRolling trueï¼Œå•Ÿå‹•å¿«é€Ÿé¡¯ç¤ºï¼›false å‰‡åœæ­¢ä¸¦é¡¯ç¤ºæœ€å¾Œè™Ÿ
    if(data.isRolling){
      startRollingPreview();
    } else {
      stopRollingPreview();
      renderGrid(); // æ›´æ–°æ ¼å­ï¼ˆè‹¥å­˜åœ¨ï¼‰
      if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    // å¹¸é‹å…’å½ˆçª—ï¼ˆè‹¥è¢«é¸ä¸­ä¸”ä¸æ˜¯ç®¡ç†è€…ï¼‰
    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && auth.currentUser && auth.currentUser.uid !== ALLOWED_UID){
      const num = prompt("ä½ æ˜¯å¹¸é‹å…’ï¼è«‹è¼¸å…¥ 1-25 é–‹çè™Ÿç¢¼ï¼š");
      if(num){
        await db.collection("pending_choices").add({
          number: parseInt(num),
          playerName: myData.name,
          uid: currentUser.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection("audit_logs").add({ action: "submit_pending_choice", detail: { uid: currentUser.uid, name: myData.name, number: parseInt(num) }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }
  });
  unsubscribers.push(unsub1);

  // players ç›£è½ï¼ˆçµ±è¨ˆèˆ‡åœ¨ç·šï¼‰
  const unsub2 = db.collection("players").onSnapshot(snap => {
    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    allPlayersCache = list;
    safeSetText('count-total', list.length);
    const now = Date.now();
    const online = list.filter(p => p.lastSeen && (now - (p.lastSeen.toMillis ? p.lastSeen.toMillis() : new Date(p.lastSeen).getTime())) < 30000).length;
    safeSetText('count-online', online);
    if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID) updateConnectedStats();
  });
  unsubscribers.push(unsub2);

  // pending_choices & bingo_events åªåœ¨ç®¡ç†è€…æ¨¡å¼ç›£è½
  if(auth.currentUser && auth.currentUser.uid === ALLOWED_UID){
    const unsub3 = db.collection("pending_choices").onSnapshot(snap => {
      const div = safeGet('pending-choices');
      if(!div) return;
      div.innerHTML = snap.docs.map(d => {
        const p = d.data();
        return `<div style="padding:5px; border-bottom:1px solid #555;">${p.playerName}: ${p.number}
          <button onclick="confirmLucky('${d.id}', ${p.number})" style="padding:2px 5px; font-size:0.7rem;">é–‹è™Ÿ</button></div>`;
      }).join('');
      safeSetText('pending-count', snap.size);
    });
    unsubscribers.push(unsub3);

    const unsub4 = db.collection("bingo_events").orderBy("timestamp","desc").limit(20).onSnapshot(snap => {
      const container = safeGet('bingo-alerts');
      if(!container) return;
      if(snap.empty){ container.innerHTML = '<div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>'; return; }
      container.innerHTML = snap.docs.map(d => {
        const data = d.data();
        const timeStr = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "";
        return `<div class="alert-item"><span>ğŸ‰ ${data.name}</span> <span style="font-size:0.7rem; color:#666;">${timeStr}</span></div>`;
      }).join('');
    });
    unsubscribers.push(unsub4);
  }

  // heartbeat æ›´æ–°
  const hb = setInterval(() => {
    if(currentUser && !currentUser.email){
      db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
    }
  }, 15000);
  unsubscribers.push(() => clearInterval(hb));

  // ç•¶ game_state æ›´æ–°æ™‚ï¼Œç‚ºæ‰€æœ‰å·²é–å®šç©å®¶è¨ˆç®— maxConsecutive ä¸¦å›å¯«ï¼ˆåˆ†æ‰¹ï¼‰
  const unsub5 = gsRef.onSnapshot(async doc => {
    const data = doc.data() || {};
    const history = data.history || [];
    const lockedPlayers = allPlayersCache.filter(p => p.locked);
    if(lockedPlayers.length){
      const batch = db.batch();
      lockedPlayers.forEach(p => {
        const maxC = calcMaxConsecutiveByLines(p.board || [], history);
        const ref = db.collection("players").doc(p.id);
        batch.update(ref, { maxConsecutive: maxC, version: (p.version || 1) + 1 });
      });
      try { await batch.commit(); } catch(e){ console.error("batch commit failed", e); }
    }
  });
  unsubscribers.push(unsub5);
}

/* ---------------- Draw display helpers ---------------- */
function updateDrawDisplay(data){
  const last = (data && data.history && data.history.length) ? data.history[data.history.length-1] : "READY";
  const drawEl = safeGet('draw-display');
  const adminSync = safeGet('admin-sync-num');
  if(drawEl) drawEl.innerText = data.isRolling ? "..." : last;
  if(adminSync) adminSync.innerText = data.isRolling ? "..." : last;
}

function startRollingPreview(){
  if(rollingTimer) return;
  const drawEl = safeGet('draw-display');
  const adminSync = safeGet('admin-sync-num');
  rollingTimer = setInterval(() => {
    const rand = Math.floor(Math.random()*25)+1;
    if(drawEl) drawEl.innerText = rand;
    if(adminSync) adminSync.innerText = rand;
  }, 80);
}

function stopRollingPreview(){
  if(rollingTimer){ clearInterval(rollingTimer); rollingTimer = null; }
}

/* ---------------- Grid rendering ---------------- */
function renderGrid(){
  const grid = safeGet('bingo-grid');
  if(!grid) return; // è‹¥ç®¡ç†è€…éš±è—å·¦å´ï¼Œç›´æ¥è¿”å›
  grid.innerHTML = "";
  if(!myData.board || !myData.board.length) myData.board = shuffleArray();
  const winIdx = new Set();
  let winCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))){
      winCount++;
      line.forEach(idx => winIdx.add(idx));
    }
  });
  myData.board.forEach((num, i) => {
    const div = document.createElement('div');
    div.className = 'cell';
    if(gameHistory.includes(num)) div.classList.add('selected');
    if(winIdx.has(i)) div.classList.add('bingo-line');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winCount > 0 && myData.locked){
    safeSetText('bingo-status', `å·²é€£æˆ ${winCount} æ¢ç·šï¼`);
    // å¯«å…¥ bingo_eventsï¼ˆéé˜»å¡ï¼‰
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  } else {
    safeSetText('bingo-status', "");
  }
  const setup = safeGet('setup-btns');
  if(setup) setup.style.display = myData.locked ? 'none' : 'flex';
}

/* ---------------- Max consecutive by 12 lines ---------------- */
function calcMaxConsecutiveByLines(board, history){
  if(!board || !board.length) return 0;
  let maxLen = 0;
  lines.forEach(line => {
    let cur = 0;
    for(let i=0;i<line.length;i++){
      const num = board[line[i]];
      if(history.includes(num)){
        cur++;
        if(cur > maxLen) maxLen = cur;
      } else {
        cur = 0;
      }
    }
  });
  return maxLen;
}

/* ---------------- Update connected stats ---------------- */
function updateConnectedStats(){
  const counts = { 5:0, 4:0, 3:0, 2:0 };
  allPlayersCache.forEach(p => {
    if(!p.board || !p.locked) return;
    const maxConn = p.maxConsecutive || calcMaxConsecutiveByLines(p.board, gameHistory);
    if(maxConn >= 5) counts[5]++;
    else if(maxConn === 4) counts[4]++;
    else if(maxConn === 3) counts[3]++;
    else if(maxConn === 2) counts[2]++;
  });
  safeSetText('cnt-5', counts[5]);
  safeSetText('cnt-4', counts[4]);
  safeSetText('cnt-3', counts[3]);
  safeSetText('cnt-2', counts[2]);
}

/* ---------------- Draw new number (admin) ---------------- */
async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  try {
    // æ¨™è¨˜ isRolling = true
    await ref.set({ isRolling: true }, { merge: true });
    // ç­‰å¾… 2 ç§’ï¼ˆå‹•ç•«ï¼‰ï¼Œç„¶å¾Œç”¨ transaction å¯«å…¥æ–°è™Ÿç¢¼
    setTimeout(async () => {
      try {
        await db.runTransaction(async t => {
          const snap = await t.get(ref);
          const history = snap.data()?.history || [];
          const pool = Array.from({length:25},(_,i)=>i+1).filter(n => !history.includes(n));
          if(!pool.length) throw new Error("å·²æŠ½å®Œ");
          const pick = pool[Math.floor(Math.random()*pool.length)];
          t.update(ref, { isRolling: false, history: firebase.firestore.FieldValue.arrayUnion(pick) });
          await db.collection("audit_logs").add({ action: "draw_number", detail: { pick }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        });
      } catch(e){
        console.error("draw transaction failed", e);
        // ç¢ºä¿ isRolling è¢«é—œé–‰
        await ref.set({ isRolling: false }, { merge: true });
      }
    }, 2000);
  } catch(e){
    console.error(e);
    alert("æŠ½è™Ÿå¤±æ•—");
  }
}

/* ---------------- Pick lucky (admin) ---------------- */
async function pickLucky(){
  try {
    const snap = await db.collection("players").where("locked","==",true).get();
    if(snap.empty) return alert("é‚„æ²’æœ‰äººé–å®šç›¤é¢");
    const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    arr.sort((a,b) => (a.maxConsecutive||0) - (b.maxConsecutive||0));
    const candidates = arr.slice(0, Math.min(15, arr.length));
    const lucky = candidates[Math.floor(Math.random()*candidates.length)].name;
    await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
    await db.collection("audit_logs").add({ action: "pick_lucky", detail: { lucky }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    alert("å¤©é¸ä¹‹äººå·²æŠ½ä¸­ï¼š" + lucky);
  } catch(e){
    console.error(e);
    alert("æŠ½å¹¸é‹å…’å¤±æ•—");
  }
}

/* ---------------- Confirm lucky (admin) ---------------- */
async function confirmLucky(id, num){
  const ref = db.collection("game_state").doc("current_game");
  const pendingRef = db.collection("pending_choices").doc(id);
  try {
    await db.runTransaction(async t => {
      const snap = await t.get(ref);
      const history = snap.data()?.history || [];
      if(history.includes(num)) throw new Error("è™Ÿç¢¼å·²è¢«æŠ½é");
      t.update(ref, { history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
      t.delete(pendingRef);
    });
    await db.collection("audit_logs").add({ action: "confirm_lucky", detail: { id, num, by: auth.currentUser?.uid || "admin" }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  } catch(e){
    console.error(e);
    alert(e.message || "ç¢ºèªå¤±æ•—");
  }
}

/* ---------------- Confirm board (player) with transaction & board_index ---------------- */
async function confirmBoard(){
  if(!confirm("é–å®šå¾Œä¸èƒ½æ›´æ›è™Ÿç¢¼ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
  if(!currentUser) return alert("æœªç™»å…¥");
  const uid = currentUser.uid;
  const boardStr = myData.board.join(',');
  const boardIndexRef = db.collection("board_index").doc(boardStr);
  const playerRef = db.collection("players").doc(uid);
  try {
    await db.runTransaction(async t => {
      const idxSnap = await t.get(boardIndexRef);
      if(idxSnap.exists) throw new Error("ç›¤é¢é‡è¤‡ï¼Œè«‹é‡æ–°æ›è™Ÿ");
      t.set(boardIndexRef, { uid: uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      t.update(playerRef, { locked: true, board: myData.board, boardStr: boardStr, version: (myData.version||1) + 1 });
    });
    myData.locked = true;
    myData.boardStr = boardStr;
    myData.version = (myData.version||1) + 1;
    await db.collection("audit_logs").add({ action: "lock_board", detail: { uid, boardStr }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    renderGrid();
  } catch(e){
    console.error(e);
    alert(e.message || "é–å®šå¤±æ•—");
  }
}

/* ---------------- Re-roll board (player) ---------------- */
function reRollBoard(){
  myData.board = shuffleArray();
  myData.boardStr = myData.board.join(',');
  renderGrid();
}

/* ---------------- Reset game (admin) ---------------- */
async function handleReset(){
  if(!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) return;
  try {
    // åˆªé™¤é›†åˆï¼ˆæ³¨æ„ï¼šå¤§é‡æ–‡ä»¶æ™‚éœ€åˆ†æ‰¹ï¼‰
    const collections = ["players", "pending_choices", "bingo_events", "audit_logs", "board_index"];
    for(const coll of collections){
      const snap = await db.collection(coll).get();
      const batch = db.batch();
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
    }
    await db.collection("game_state").doc("current_game").set({ history:[], isRolling:false, luckyUser:"", status:"waiting" });
    await db.collection("audit_logs").add({ action: "reset_game", detail: { by: auth.currentUser?.uid || "unknown" }, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    // æ›´æ–°å‰ç«¯ç‹€æ…‹ä½†ä¸ç™»å‡ºç®¡ç†è€…
    allPlayersCache = [];
    gameHistory = [];
    stopRollingPreview();
    // é¡¯ç¤ºç®¡ç†é¢æ¿ï¼ˆè‹¥è¢«éš±è—ï¼‰
    const admin = safeGet('admin-sidebar'); if(admin) admin.style.display = 'flex';
    const main = safeGet('main-content-area'); if(main) main.style.display = 'block';
    // æ¸… UI
    safeSetText('count-online', 0);
    safeSetText('count-total', 0);
    safeSetText('cnt-5', 0);
    safeSetText('cnt-4', 0);
    safeSetText('cnt-3', 0);
    safeSetText('cnt-2', 0);
    safeSetText('pending-count', 0);
    const pendingDiv = safeGet('pending-choices'); if(pendingDiv) pendingDiv.innerHTML = '';
    const bingoDiv = safeGet('bingo-alerts'); if(bingoDiv) bingoDiv.innerHTML = '<div style="color:#999; font-size:0.8rem;">å°šç„¡è³“æœäº‹ä»¶...</div>';
    safeSetText('draw-display', 'READY');
    safeSetText('admin-sync-num', '--');
    alert("æˆåŠŸé‡ç½®ï¼ç®¡ç†è€…ä»ä¿æŒç™»å…¥ç‹€æ…‹ã€‚");
  } catch(e){
    console.error(e);
    alert("é‡ç½®å¤±æ•—");
  }
}

/* ---------------- Utility ---------------- */
function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }

/* ---------------- Expose confirmLucky to global (for inline buttons in admin list) ---------------- */
window.confirmLucky = confirmLucky;

/* ---------------- End of script ---------------- */
</script>
</body>
</html>
