<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bingo æ´»å‹•å…¥å£</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; }
    h2 { margin-top: 24px; }
    input, button { padding: 8px; margin: 6px 0; }
    pre { background: #f6f8fa; padding: 10px; border-radius: 6px; }
    #playerArea, #adminArea { border: 1px solid #ccc; padding: 12px; margin-top: 12px; }
  </style>
</head>
<body>
  <h1>Bingo æ´»å‹•å…¥å£ <small>v1.0.0</small></h1>

  <!-- ç©å®¶åŒ¿åç™»å…¥ -->
  <button id="anonLogin">ç©å®¶åŒ¿åç™»å…¥</button>

  <!-- ç®¡ç†è€…ç™»å…¥ -->
  <h2>ç®¡ç†è€…ç™»å…¥</h2>
  <form id="adminLoginForm">
    <input type="email" id="adminEmail" placeholder="ç®¡ç†è€… Email" required />
    <input type="password" id="adminPassword" placeholder="å¯†ç¢¼" required />
    <button type="submit">ç™»å…¥</button>
  </form>
  <button id="signOutBtn" disabled>ç™»å‡º</button>

  <!-- é¡¯ç¤ºç™»å…¥ç‹€æ…‹ -->
  <h2>ç™»å…¥è³‡è¨Š</h2>
  <pre>
ç‹€æ…‹ï¼š<span id="status">æœªç™»å…¥</span>
UIDï¼š<span id="uid">â€”</span>
éŒ¯èª¤ï¼š<span id="error">â€”</span>
  </pre>

  <!-- ç©å®¶å€åŸŸ -->
  <div id="playerArea" style="display:none;">
    <h2>ç©å®¶ç›¤é¢</h2>
    <button id="saveBoard">å„²å­˜ç›¤é¢</button>
  </div>

  <!-- ç®¡ç†è€…å€åŸŸ -->
  <div id="adminArea" style="display:none;">
    <h2>ç®¡ç†è€…æ§åˆ¶</h2>
    <button id="drawNumber">æŠ½è™Ÿ</button>
    <button id="resetGame">é‡ç½®éŠæˆ²</button>
  </div>

  <script type="module">
    // ğŸ”‘ æ›æˆæ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
      authDomain: "yearendbingo.firebaseapp.com",
      projectId: "yearendbingo",
      storageBucket: "yearendbingo.firebasestorage.app",
      messagingSenderId: "563353011392",
      appId: "1:563353011392:web:717976a176bc22a04d5925",
      measurementId: "G-M6EVYSPNJ9"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      signInAnonymously,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const statusEl = document.getElementById('status');
    const uidEl = document.getElementById('uid');
    const errorEl = document.getElementById('error');
    const playerArea = document.getElementById('playerArea');
    const adminArea = document.getElementById('adminArea');
    const signOutBtn = document.getElementById('signOutBtn');

    function setError(msg) { errorEl.textContent = msg || 'â€”'; }

    // ç©å®¶åŒ¿åç™»å…¥
    document.getElementById('anonLogin').addEventListener('click', async () => {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        setError(e.message);
      }
    });

    // ç®¡ç†è€…ç™»å…¥
    document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        setError(e.message);
      }
    });

    // ç™»å‡º
    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    // ç‹€æ…‹ç›£è½
    onAuthStateChanged(auth, (user) => {
      if (user) {
        statusEl.textContent = "å·²ç™»å…¥";
        uidEl.textContent = user.uid;
        setError('â€”');
        signOutBtn.disabled = false;

        // åˆ¤æ–·æ˜¯å¦ç®¡ç†è€… UID
        if (user.email) {
          adminArea.style.display = "block";
          playerArea.style.display = "none";
        } else {
          playerArea.style.display = "block";
          adminArea.style.display = "none";
        }
      } else {
        statusEl.textContent = "æœªç™»å…¥";
        uidEl.textContent = "â€”";
        signOutBtn.disabled = true;
        playerArea.style.display = "none";
        adminArea.style.display = "none";
      }
    });

    // ç©å®¶å„²å­˜ç›¤é¢
    document.getElementById('saveBoard').addEventListener('click', async () => {
      const uid = auth.currentUser.uid;
      try {
        await setDoc(doc(db, "players", uid), { board: "ç©å®¶çš„ç›¤é¢è³‡æ–™" });
        alert("ç›¤é¢å·²å„²å­˜ï¼");
      } catch (e) {
        setError(e.message);
      }
    });

    // ç®¡ç†è€…æŠ½è™Ÿ
    document.getElementById('drawNumber').addEventListener('click', async () => {
      try {
        await updateDoc(doc(db, "game_state", "current_game"), { lastDraw: Math.floor(Math.random()*75)+1 });
        alert("å·²æŠ½è™Ÿï¼");
      } catch (e) {
        setError(e.message);
      }
    });

    // ç®¡ç†è€…é‡ç½®éŠæˆ²
    document.getElementById('resetGame').addEventListener('click', async () => {
      try {
        await setDoc(doc(db, "game_state", "current_game"), { status: "reset" });
        alert("éŠæˆ²å·²é‡ç½®ï¼");
      } catch (e) {
        setError(e.message);
      }
    });
  </script>
</body>
  <footer style="margin-top:20px; font-size:0.9em; color:#555;"> ç‰ˆæœ¬ï¼šv1.0.0ã€€ï½œã€€æœ€å¾Œæ›´æ–°ï¼š2025-12-29 </footer>
</html>
