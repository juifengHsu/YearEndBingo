<!doctype html>
<html lang="zh-Hant" class="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>2025 å°¾ç‰™è³“æœç³»çµ± v2.9.1 - Master Style</title>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f45925",
                        "primary-dark": "#d64010",
                        "background-light": "#f8f6f5",
                        "surface-light": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Spline Sans", "Noto Sans TC", "sans-serif"],
                        "body": ["Spline Sans", "Noto Sans TC", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <style>
        body { font-family: 'Spline Sans', 'Noto Sans TC', sans-serif; background-color: #f8f6f5; color: #1c110d; }
        
        /* è³“æœæ ¼å­æ¨£å¼ - æ¡ç”¨ new 9 çš„åœ“å½¢è¨­è¨ˆ */
        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px; /* åœ“å½¢ */
            font-weight: 700;
            font-size: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
            background-color: #f4eae7; /* é è¨­èƒŒæ™¯ (inactive) */
            color: #1c110d;
        }
        
        /* å·²æŠ½ä¸­è™Ÿç¢¼æ¨£å¼ (active) */
        .cell.selected {
            background-color: #f45925;
            color: white;
            box-shadow: 0 4px 12px rgba(244, 89, 37, 0.4);
        }

        /* è³“æœé€£ç·šæ¨£å¼ */
        .cell.bingo-line {
            background-color: #2e7d32; /* ç¶ è‰²è¡¨ç¤ºé€£ç·š */
            color: white;
            animation: pulse 900ms infinite;
            border: 4px solid #fff;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        .card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #f4eae7; }
        
        .history-ball {
            display: inline-block;
            width: 36px;
            height: 36px;
            line-height: 36px;
            background: #f4eae7;
            color: #1c110d;
            border-radius: 50%;
            margin: 4px;
            text-align: center;
            font-weight: 700;
            font-size: 0.9rem;
            border: 1px solid #d6cdc9;
        }

        .hidden { display: none !important; }
        
        /* ç®¡ç†å“¡ Log æ¨£å¼ */
        .status-log {
            max-height: 150px;
            overflow: auto;
            padding: 12px;
            border-radius: 12px;
            background: #1c110d;
            color: #f4eae7;
            font-family: monospace;
            font-size: 0.85rem;
        }

        #draw-display {
            font-family: 'Spline Sans', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            color: #f45925;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

<header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-[#f4eae7]">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="size-8 rounded-full bg-primary flex items-center justify-center text-white" onclick="triggerAdmin()">
                <span class="material-symbols-outlined text-[20px]">grid_on</span>
            </div>
            <h1 class="text-xl font-bold tracking-tight">2025 è³“æœç³»çµ± <span class="text-xs font-normal opacity-50">v2.9.1</span></h1>
        </div>
        <div id="user-info" class="text-sm font-bold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">è¼‰å…¥ä¸­...</div>
    </div>
</header>

<main class="flex-grow p-4 md:p-6 max-w-4xl mx-auto w-full">

    <div id="view-login" class="card p-8 mt-10 hidden text-center">
        <h3 class="text-2xl font-bold mb-6">ç©å®¶ç™»å…¥</h3>
        <input id="player-name" type="text" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" class="w-full p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary outline-none mb-4" />
        <button class="w-full py-4 bg-primary text-white rounded-xl font-bold text-lg hover:bg-primary-dark transition-all" onclick="doPlayerLogin()">é€²å…¥éŠæˆ²</button>
    </div>

    <div id="view-player" class="hidden space-y-6">
        <div class="card p-6 flex flex-col md:flex-row items-center justify-between gap-6 overflow-hidden relative">
            <div class="flex items-center gap-6 z-10">
                <div class="flex flex-col">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Latest Number</span>
                    <div id="draw-display">READY</div>
                </div>
                <div class="h-12 w-px bg-gray-200"></div>
                <div class="flex flex-col">
                    <span id="player-name-display" class="text-xl font-bold text-gray-800">ç©å®¶</span>
                    <span id="lock-status-label" class="text-sm text-gray-500 font-medium italic">ğŸ² è¨­å®šä¸­...</span>
                </div>
            </div>
            <button class="px-4 py-2 text-sm font-bold text-gray-400 hover:text-primary transition-colors" onclick="doSignOut()">ç™»å‡ºç³»çµ±</button>
        </div>

        <div class="card p-6 sm:p-10">
            <div id="bingo-status" class="text-center text-lg font-bold text-green-600 mb-4 h-6"></div>
            <div id="bingo-grid" class="grid grid-cols-5 gap-3 sm:gap-4 max-w-[500px] mx-auto">
                </div>
            
            <div id="setup-btns" class="mt-10 flex flex-col sm:flex-row gap-4 justify-center">
                <button class="flex items-center justify-center gap-2 px-8 py-4 rounded-full bg-gray-100 text-gray-700 font-bold hover:bg-gray-200 transition-all" onclick="reRollBoard()">
                    <span class="material-symbols-outlined">shuffle</span> æ›è™Ÿç¢¼
                </button>
                <button class="flex items-center justify-center gap-2 px-8 py-4 rounded-full bg-primary text-white font-bold shadow-lg shadow-primary/30 hover:bg-primary-dark transition-all" onclick="confirmBoard()">
                    <span class="material-symbols-outlined">lock</span> é–å®šç›¤é¢
                </button>
            </div>
        </div>
    </div>

    <div id="view-admin" class="hidden space-y-6">
        <div class="card p-6 bg-[#1c110d] text-white">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">admin_panel_settings</span> æ§åˆ¶å°
                </h3>
                <span id="admin-lock-indicator" class="text-xs px-2 py-1 rounded bg-gray-700">æœªé–å®š</span>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 text-center">
                <div class="bg-white/5 p-4 rounded-xl">
                    <span id="count-online" class="block text-2xl font-black text-primary">0</span>
                    <span class="text-xs text-gray-400">åœ¨ç·š</span>
                </div>
                <div class="bg-white/5 p-4 rounded-xl">
                    <span id="count-total" class="block text-2xl font-black text-primary">0</span>
                    <span class="text-xs text-gray-400">ç¸½äººæ•¸</span>
                </div>
                <div class="bg-white/5 p-4 rounded-xl">
                    <span id="cnt-5" class="block text-2xl font-black text-green-400">0</span>
                    <span class="text-xs text-gray-400">è³“æœ</span>
                </div>
                <div class="bg-white/5 p-4 rounded-xl">
                    <span id="cnt-4" class="block text-2xl font-black text-orange-400">0</span>
                    <span class="text-xs text-gray-400">è½ç‰Œ</span>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <button id="btn-draw" class="w-full py-5 bg-primary rounded-2xl font-black text-xl hover:bg-primary-dark transition-all flex items-center justify-center gap-3 shadow-xl shadow-primary/20" onclick="drawNewNumber()">
                    <span class="material-symbols-outlined animate-bounce">casino</span> éš¨æ©ŸæŠ½è™Ÿ
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button class="py-3 bg-white/10 rounded-xl text-sm font-bold border border-white/10 hover:bg-white/20 transition-all" onclick="forceLockAll()">å¼·åˆ¶é–å®š</button>
                    <button class="py-3 bg-white/10 rounded-xl text-sm font-bold border border-white/10 hover:bg-white/20 transition-all text-yellow-400" onclick="pickLucky()">ğŸŒŸ æŠ½å¹¸é‹å…’</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card p-6">
                <h4 class="text-sm font-bold text-gray-400 uppercase mb-4">æŠ½è™Ÿæ­·å²</h4>
                <div id="drawn-history-list" class="flex flex-wrap gap-1"></div>
            </div>
            <div class="card p-6">
                <h4 class="text-sm font-bold text-gray-400 uppercase mb-4">å³æ™‚é€šçŸ¥</h4>
                <div id="pending-choices" class="text-sm text-primary font-bold space-y-2 mb-4"></div>
                <div id="bingo-alerts" class="text-sm text-green-600 font-bold space-y-2"></div>
            </div>
        </div>
        
        <div class="card p-6">
            <div id="status-log" class="status-log"></div>
            <div class="mt-4 flex gap-2">
                <button class="text-xs text-red-400 underline" onclick="removeAllPlayers()">ç§»é™¤æ‰€æœ‰ç©å®¶</button>
                <button class="text-xs text-gray-400 underline" onclick="handleReset()">é‡ç½®éŠæˆ²</button>
            </div>
        </div>
    </div>
</main>

<div id="admin-modal" class="fixed inset-0 bg-black/80 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl">
        <h3 class="text-xl font-bold mb-6">ç®¡ç†è€…ç™»å…¥</h3>
        <input id="admin-email" type="email" placeholder="Email" class="w-full p-4 rounded-xl border border-gray-200 mb-4" />
        <input id="admin-pwd" type="password" placeholder="å¯†ç¢¼" class="w-full p-4 rounded-xl border border-gray-200 mb-6" />
        <button class="w-full py-4 bg-primary text-white rounded-xl font-bold mb-3" onclick="doAdminLogin()">é©—è­‰æ¬Šé™</button>
        <button class="w-full py-2 text-gray-400 text-sm" onclick="closeAdminModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
// --- æ­¤è™•ç‚º index 0107-2.html çš„åŸå§‹é‚è¼¯ï¼Œå®Œå…¨ä¿ç•™ ---
const firebaseConfig = {
  apiKey: "AIzaSyCLTGzCZUQm2ZzqfdBHk9D4xYpagaVtX7w",
  authDomain: "yearendbingo.firebaseapp.com",
  projectId: "yearendbingo",
  storageBucket: "yearendbingo.firebasestorage.app",
  messagingSenderId: "563353011392",
  appId: "1:563353011392:web:717976a176bc22a04d5925",
  measurementId: "G-M6EVYSPNJ9"
};
const ALLOWED_UID = "z6bA9TzIhPUqXBxSyoIlZGBETwy1";
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;
let myData = { name:"", board:[], locked:false };
let gameHistory = [];
let allPlayersCache = [];
let rollingTimer = null;
let isAllLockedGlobal = false;

function logStatus(msg) {
  const el = document.getElementById('status-log');
  if(!el) return;
  el.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
}

function triggerAdmin() {
  window.ac = (window.ac || 0) + 1;
  if(window.ac >= 5) { document.getElementById('admin-modal').style.display = 'flex'; window.ac = 0; }
}
function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

async function doAdminLogin(){
  const email = document.getElementById('admin-email').value;
  const pwd = document.getElementById('admin-pwd').value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, pwd);
    if(cred.user.uid === ALLOWED_UID) { closeAdminModal(); logStatus("ç®¡ç†å“¡ç™»å…¥æˆåŠŸ"); }
    else { alert("æ¬Šé™ä¸è¶³"); await auth.signOut(); }
  } catch(e){ alert("ç™»å…¥å¤±æ•—"); }
}

auth.onAuthStateChanged(async user => {
  currentUser = user;
  if(!user){ showView('login'); return; }
  if(user.uid === ALLOWED_UID){ showView('admin'); startApp(); return; }
  const snap = await db.collection("players").doc(user.uid).get();
  if(snap.exists){
    myData = snap.data();
  } else {
    const name = document.getElementById('player-name').value || "è¨ªå®¢";
    myData = { name, board: shuffleArray(), locked:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection("players").doc(user.uid).set(myData);
  }
  document.getElementById('user-info').innerText = myData.name;
  document.getElementById('player-name-display').innerText = myData.name;
  showView('player');
  startApp();
});

async function doPlayerLogin(){
  if(!document.getElementById('player-name').value.trim()) return alert("è«‹è¼¸å…¥å§“å");
  await auth.signInAnonymously();
}

function showView(name){
  document.getElementById('view-login').classList.add('hidden');
  document.getElementById('view-player').classList.add('hidden');
  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('view-'+name).classList.remove('hidden');
}

function startApp(){
  db.collection("game_state").doc("current_game").onSnapshot(doc => {
    const data = doc.data() || { history:[], isRolling:false, isAllLocked:false, luckyUser:"" };
    gameHistory = data.history || [];
    isAllLockedGlobal = data.isAllLocked || false;
    
    if(document.getElementById('admin-lock-indicator')) {
      document.getElementById('admin-lock-indicator').innerText = isAllLockedGlobal ? "âœ… å·²é–å®š" : "ğŸ”“ æœªé–å®š";
      document.getElementById('admin-lock-indicator').className = isAllLockedGlobal ? "text-[10px] px-2 py-1 rounded bg-green-500/20 text-green-400" : "text-[10px] px-2 py-1 rounded bg-gray-700 text-gray-400";
    }

    const last = gameHistory.length ? gameHistory[gameHistory.length-1] : "READY";
    document.getElementById('drawn-history-list').innerHTML = gameHistory.map(n => `<span class="history-ball">${n}</span>`).join('') || "ç­‰å¾…é–‹è™Ÿ";
    
    if(data.isRolling){
      if(!rollingTimer) rollingTimer = setInterval(()=> {
        const r = Math.floor(Math.random()*25)+1;
        document.getElementById('draw-display').innerText = r;
      }, 80);
    } else {
      clearInterval(rollingTimer); rollingTimer=null;
      document.getElementById('draw-display').innerText = last;
      renderGrid();
      if(currentUser.uid === ALLOWED_UID) updateConnectedStats();
    }

    if(data.luckyUser && data.luckyUser === myData.name && !data.isRolling && currentUser.uid !== ALLOWED_UID) {
      let valid = false;
      let num;
      while(!valid) {
        const input = prompt(`ã€ğŸŒŸ æ­å–œä½ æ˜¯å¹¸é‹å…’ï¼ã€‘\nè«‹è¼¸å…¥ä¸€å€‹è™Ÿç¢¼ (1-25)ï¼š\n(æ³¨æ„ï¼šä¸èƒ½é‡è¤‡æŠ½éçš„è™Ÿç¢¼)`);
        if(input === null) break;
        num = parseInt(input);
        if(isNaN(num) || num < 1 || num > 25) { alert("éŒ¯èª¤ï¼šè«‹è¼¸å…¥ 1 åˆ° 25 ä¹‹é–“çš„æ•¸å­—ã€‚"); }
        else if(gameHistory.includes(num)) { alert(`${num} å·²ç¶“è¢«æŠ½éå›‰ï¼Œè«‹æ›ä¸€å€‹ã€‚`); }
        else { valid = true; }
      }
      if(valid) {
        db.collection("pending_choices").doc(currentUser.uid).set({
          playerName: myData.name, number: num, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection("game_state").doc("current_game").update({ luckyUser: "" });
      }
    }
  });

  db.collection("players").onSnapshot(snap => {
    allPlayersCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
    document.getElementById('count-total').innerText = allPlayersCache.length;
    document.getElementById('count-online').innerText = allPlayersCache.filter(p => p.lastSeen).length; // ç°¡æ˜“åœ¨ç·šåˆ¤æ–·
    if(currentUser.uid !== ALLOWED_UID){
      const me = allPlayersCache.find(p => p.id === currentUser.uid);
      if(me && me.locked !== myData.locked) {
        myData.locked = me.locked;
        renderGrid();
      }
    }
  });

  if(currentUser.uid === ALLOWED_UID){
    db.collection("pending_choices").orderBy("timestamp","desc").onSnapshot(snap => {
      document.getElementById('pending-choices').innerHTML = snap.docs.map(d => `<div class="bg-primary/10 p-2 rounded-lg flex justify-between items-center"><span>â“ ${d.data().playerName} é¸äº† ${d.data().number}</span> <button class="bg-primary text-white text-xs px-2 py-1 rounded" onclick="confirmLucky('${d.id}', ${d.data().number})">æ¡ç´</button></div>`).join('');
    });
    db.collection("bingo_events").orderBy("timestamp","desc").limit(10).onSnapshot(snap => {
      document.getElementById('bingo-alerts').innerHTML = snap.docs.map(d => `<div>ğŸ‰ <b>${d.data().name}</b> è³“æœäº†ï¼</div>`).join('');
    });
  }
}

function renderGrid(){
  const grid = document.getElementById('bingo-grid');
  if(!grid) return;
  grid.innerHTML = '';
  const winIdx = new Set();
  const lines = [
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];
  let winLineCount = 0;
  lines.forEach(line => {
    if(line.every(idx => gameHistory.includes(myData.board[idx]))) {
      line.forEach(i=>winIdx.add(i));
      winLineCount++;
    }
  });
  myData.board.forEach((num,i)=>{
    const div = document.createElement('div');
    div.className = 'cell ' + (gameHistory.includes(num)?'selected ':'') + (winIdx.has(i)?'bingo-line':'');
    div.innerText = num;
    grid.appendChild(div);
  });
  if(winLineCount > 0 && myData.locked) {
    document.getElementById('bingo-status').innerText = `å·²é”æˆ ${winLineCount} æ¢ç·šï¼`;
    db.collection("bingo_events").doc(currentUser.uid).set({ name: myData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  }
  document.getElementById('setup-btns').style.display = (myData.locked || isAllLockedGlobal) ? 'none' : 'flex';
  document.getElementById('lock-status-label').innerText = (myData.locked || isAllLockedGlobal) ? "ğŸ”’ ç›¤é¢å·²é–å®š" : "ğŸ² è¨­å®šä¸­...";
}

function calculateMaxConsecutive(board, history) {
  const lines = [
    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
    [0,6,12,18,24],[4,8,12,16,20]
  ];
  let globalMax = 0;
  lines.forEach(line => {
    let currentMax = 0;
    let streak = 0;
    line.forEach(index => {
      if(history.includes(board[index])) { streak++; if(streak > currentMax) currentMax = streak; }
      else { streak = 0; }
    });
    if(currentMax > globalMax) globalMax = currentMax;
  });
  return globalMax;
}

function updateConnectedStats(){
  const counts = {5:0,4:0,3:0,2:0};
  allPlayersCache.forEach(p=>{
    if(!p.board || !p.locked) return;
    const max = calculateMaxConsecutive(p.board, gameHistory);
    if(max >= 5) counts[5]++;
    else if(max === 4) counts[4]++;
    else if(max === 3) counts[3]++;
    else if(max === 2) counts[2]++;
  });
  document.getElementById('cnt-5').innerText = counts[5];
  document.getElementById('cnt-4').innerText = counts[4];
}

async function forceLockAll() {
  logStatus("æ­£åœ¨åŸ·è¡Œå…¨å“¡é–å®š...");
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: true }));
  await batch.commit();
  await db.collection("game_state").doc("current_game").update({ isAllLocked: true });
}

async function drawNewNumber(){
  const ref = db.collection("game_state").doc("current_game");
  if(!isAllLockedGlobal) await forceLockAll();
  const snap = await ref.get();
  const hist = snap.data().history || [];
  const pool = Array.from({length:25},(_,i)=>i+1).filter(n=>!hist.includes(n));
  if(!pool.length) return alert("æŠ½å®Œå›‰");
  await ref.update({ isRolling:true });
  setTimeout(async ()=>{
    const p = pool[Math.floor(Math.random()*pool.length)];
    await ref.update({ history: firebase.firestore.FieldValue.arrayUnion(p), isRolling:false, luckyUser: "" });
  }, 1200);
}

async function removeAllPlayers() {
  if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä½¿ç”¨è€…å—ï¼Ÿ")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.delete(db.collection("players").doc(p.id)));
  await batch.commit();
  location.reload();
}

async function handleReset(){
  if(!confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿé€™æœƒæ¢å¾©æ‰€æœ‰äººçš„æ›è™ŸåŠŸèƒ½ã€‚")) return;
  const batch = db.batch();
  allPlayersCache.forEach(p => batch.update(db.collection("players").doc(p.id), { locked: false }));
  const colls = ["pending_choices","bingo_events"];
  for(const c of colls){
    const s = await db.collection(c).get();
    s.forEach(d=>batch.delete(d.ref));
  }
  batch.set(db.collection("game_state").doc("current_game"), { history:[], isRolling:false, isAllLocked:false, luckyUser:"" });
  await batch.commit();
  location.reload();
}

async function confirmLucky(id, num) {
  await db.collection("game_state").doc("current_game").update({ history: firebase.firestore.FieldValue.arrayUnion(num), luckyUser: "" });
  await db.collection("pending_choices").doc(id).delete();
}

async function pickLucky() {
  if(allPlayersCache.length === 0) return alert("æ²’äººåƒèˆ‡");
  const lucky = allPlayersCache[Math.floor(Math.random()*allPlayersCache.length)].name;
  await db.collection("game_state").doc("current_game").update({ luckyUser: lucky });
  alert("å¹¸é‹å…’æ˜¯ï¼š" + lucky);
}

function shuffleArray(){ return Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-0.5); }
function reRollBoard(){ myData.board = shuffleArray(); renderGrid(); }

async function confirmBoard(){
  if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
  await db.collection("players").doc(currentUser.uid).update({ locked:true });
  myData.locked = true; renderGrid();
}

function doSignOut(){ auth.signOut(); location.reload(); }

setInterval(() => {
  if(currentUser && currentUser.uid !== ALLOWED_UID) {
    db.collection("players").doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
  }
}, 15000);
</script>

</body>
</html>
